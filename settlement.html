<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìì ì •ì‚° - Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% ì™„ì „ ì°¨ë‹¨) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        .report-card {
            transition: all 0.2s ease-in-out;
        }
        .report-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .profit-positive {
            background-color: #d1fae5;
            color: #065f46;
        }
        .profit-negative {
            background-color: #fee2e2;
            color: #991b1b;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="systemTitle">
                    Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ
                </h1>

            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='dashboard.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> ëŒ€ì‹œë³´ë“œ
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> ìˆ™ì†Œ ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> ì˜ˆì•½ ê´€ë¦¬
                    </button>

                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> ìˆ˜ìµ ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='investor.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-users mr-1"></i> íˆ¬ìì ê´€ë¦¬
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-calculator mr-1"></i> íˆ¬ìì ì •ì‚°
                    </button>

                    <button onclick="window.location.href='data-migration.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-database mr-1"></i> ë°ì´í„° ê´€ë¦¬
                    </button>
                </div>
            </div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 no-print">
            <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ìì ì„ íƒ *</label>
                    <select id="investorFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">íˆ¬ììë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì •ì‚° ì›” *</label>
                    <select id="monthFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">ì›”ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <!-- ì›” ì˜µì…˜ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="performSettlementSearch()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        ì¡°íšŒ
                    </button>
                    <button onclick="generateInvestorReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>
                        ë¦¬í¬íŠ¸ ìƒì„±
                    </button>
                </div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ì„¹ì…˜ -->
        <div id="reportSection" class="hidden">
            <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="reportTitle">íˆ¬ìì ì •ì‚° ë¦¬í¬íŠ¸</h2>
                        <p class="text-sm text-gray-600" id="reportSubtitle">ì •ì‚° ê¸°ê°„ ë° íˆ¬ìì ì •ë³´</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">ìƒì„±ì¼: <span id="reportDate"></span></p>
                        <p class="text-xs text-gray-500">ë¬¸ì„œë²ˆí˜¸: <span id="reportNumber"></span></p>
                    </div>
                </div>
                
                <!-- íˆ¬ìì ê¸°ë³¸ ì •ë³´ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">íˆ¬ìì ì •ë³´</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ì„±ëª…:</span>
                                <span id="investorName" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ì—°ë½ì²˜:</span>
                                <span id="investorPhone" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ì´ë©”ì¼:</span>
                                <span id="investorEmail" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ì •ì‚°ì¼:</span>
                                <span id="settlementDay" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">íˆ¬ì ì¡°ê±´</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">íˆ¬ì ë¹„ìœ¨:</span>
                                <span id="investorRatio" class="font-medium text-blue-600">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">íšŒì‚¬ ë¹„ìœ¨:</span>
                                <span id="companyRatio" class="font-medium text-green-600">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ë³´ìœ  ìˆ™ì†Œ:</span>
                                <span id="accommodationCount" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë³´ìœ  ìˆ™ì†Œ ëª©ë¡ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-building text-blue-600 mr-2"></i>
                    ë³´ìœ  ìˆ™ì†Œ ëª©ë¡
                </h3>
                <div id="accommodationList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- ìˆ™ì†Œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì›”ë³„ ìˆ˜ìµ í˜„í™© -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-line text-green-600 mr-2"></i>
                    ì›”ë³„ ìˆ˜ìµ í˜„í™© <span class="text-sm font-normal text-gray-500">(ë‹¨ìœ„: THB)</span>
                </h3>
                
                <!-- KPI ì¹´ë“œ -->
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-green-400 to-green-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">ì´ ìˆ˜ìµ</div>
                        <div id="totalRevenue" class="text-xl font-bold">0 THB</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-400 to-red-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">ì´ ì§€ì¶œ</div>
                        <div id="totalExpense" class="text-xl font-bold">0 THB</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">ìˆœìˆ˜ìµ</div>
                        <div id="netProfit" class="text-xl font-bold">0 THB</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-400 to-purple-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">íˆ¬ìì ë°°ë‹¹</div>
                        <div id="investorDividend" class="text-xl font-bold">0 THB</div>
                    </div>
                </div>

                <!-- ìƒì„¸ ìˆ˜ìµ í…Œì´ë¸” -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìˆ™ì†Œ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">êµ¬ë¶„</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í•­ëª©</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë¹„ê³ </th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="revenueTableBody" class="divide-y divide-gray-200">
                            <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì •ì‚° ê³„ì‚°ì„œ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-calculator text-purple-600 mr-2"></i>
                    ì •ì‚° ê³„ì‚°ì„œ <span class="text-sm font-normal text-gray-500">(ë‹¨ìœ„: THB)</span>
                </h3>
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- ìˆ˜ìµ ë¶„ì„ -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-4">ìˆ˜ìµ ë¶„ì„</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ì´ ìˆ™ë°• ìˆ˜ìµ:</span>
                                    <span id="calc_totalRevenue" class="font-medium">0 THB</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ì´ ìš´ì˜ ë¹„ìš©:</span>
                                    <span id="calc_totalExpense" class="font-medium text-red-600">0 THB</span>
                                </div>
                                <div class="border-t pt-2">
                                    <div class="flex justify-between font-semibold">
                                        <span>ìˆœìˆ˜ìµ:</span>
                                        <span id="calc_netProfit" class="text-lg">0 THB</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ë°°ë‹¹ ê³„ì‚° -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-4">ë°°ë‹¹ ê³„ì‚°</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">íˆ¬ìì ì§€ë¶„ (<span id="calc_investorRatio">70</span>%):</span>
                                    <span id="calc_investorShare" class="font-medium text-blue-600">0 THB</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">íšŒì‚¬ ì§€ë¶„ (<span id="calc_companyRatio">30</span>%):</span>
                                    <span id="calc_companyShare" class="font-medium text-green-600">0 THB</span>
                                </div>
                                <div class="border-t pt-2">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>íˆ¬ìì ë°°ë‹¹ê¸ˆ:</span>
                                        <span id="calc_finalDividend" class="text-blue-600">0 THB</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì •ì‚° ìš”ì•½ -->
                    <div class="mt-6 p-4 border-2 border-blue-200 rounded-lg bg-blue-50">
                        <div class="text-center">
                            <h4 class="text-lg font-bold text-blue-800 mb-2">ì´ë²ˆ ë‹¬ ì •ì‚° ê¸ˆì•¡</h4>
                            <div class="text-3xl font-bold text-blue-600" id="finalSettlementAmount">0 THB</div>
                            <p class="text-xs text-blue-600 mt-2">ìœ„ ê¸ˆì•¡ì€ íˆ¬ììë‹˜ê»˜ ì§€ê¸‰ë  ë°°ë‹¹ê¸ˆì…ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div id="noDataMessage" class="bg-white rounded-lg shadow-sm p-8 text-center">
            <i class="fas fa-chart-bar text-gray-300 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-800 mb-2">ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <p class="text-gray-600">íˆ¬ììì™€ ì •ì‚° ì›”ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ë¦¬í¬íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let investors = [];
        let accommodations = [];
        let accountingData = [];

        // ì¹´í…Œê³ ë¦¬ ì •ì˜ (accounting.htmlê³¼ ë™ì¼)
        const categories = {
            income: [
                { value: 'booking', text: 'ì˜ˆì•½ ìˆ˜ì…' },
                { value: 'deposit', text: 'ë³´ì¦ê¸ˆ' },
                { value: 'additional', text: 'ì¶”ê°€ ì„œë¹„ìŠ¤' },
                { value: 'other_income', text: 'ê¸°íƒ€ ìˆ˜ì…' }
            ],
            expense: [
                { value: 'cleaning', text: 'ì²­ì†Œë¹„' },
                { value: 'maintenance', text: 'ìˆ˜ë¦¬/ë³´ìˆ˜' },
                { value: 'supplies', text: 'ìš©í’ˆ êµ¬ì…' },
                { value: 'utilities', text: 'ê³µê³¼ê¸ˆ' },
                { value: 'rent', text: 'ë ŒíŠ¸ë¹„' },
                { value: 'platform_fee', text: 'í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ' },
                { value: 'tax', text: 'ì„¸ê¸ˆ' },
                { value: 'other_expense', text: 'ê¸°íƒ€ ì§€ì¶œ' }
            ]
        };

        // API ê¸°ë³¸ í•¨ìˆ˜ë“¤
        async function fetchTableData(tableName, params = {}) {
            try {
                const queryParams = new URLSearchParams(params).toString();
                const response = await fetch(`tables/${tableName}${queryParams ? '?' + queryParams : ''}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error(`Error fetching ${tableName}:`, error);
                return [];
            }
        }

        // íˆ¬ìì ë°ì´í„°ë¥¼ localStorageì—ì„œ ë¡œë“œ
        // ì‹¤ì œ ì‹œìŠ¤í…œ ë°ì´í„° ë¡œë“œ
        async function loadInvestors() {
            console.log('ğŸ” íˆ¬ìì ë°ì´í„° ë¡œë”© ì‹œì‘...');
            
            try {
                // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ íˆ¬ìì ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const investorData = await firebaseStorage.loadInvestors();
                    investors = investorData || [];
                    console.log('ğŸ“¡ Firebaseì—ì„œ ë¡œë“œëœ íˆ¬ìì:', investors.length + 'ëª…');
                } else {
                    console.log('âš ï¸ Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                const saved = localStorage.getItem('investorData');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    investors = Array.isArray(parsedData) ? parsedData : [];
                    console.log('ğŸ’¾ localStorageì—ì„œ ë¡œë“œëœ íˆ¬ìì:', investors.length + 'ëª…');
                    console.log('ğŸ“‹ íˆ¬ìì ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:', investors.map(inv => ({id: inv.id, name: inv.name})));
                } else {
                    console.log('âŒ localStorageì—ë„ íˆ¬ìì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                    investors = [];
                }
            }
            
            // íˆ¬ìì ë°ì´í„°ì— accommodations ë°°ì—´ ì¶”ê°€ (ìˆ™ì†Œ IDë“¤)
            investors.forEach((investor, index) => {
                if (!investor.accommodations) {
                    // íˆ¬ììë³„ ìˆ™ì†Œ ID ë°°ì—´ì„ ìˆ™ì†Œ ë°ì´í„°ì—ì„œ ì¶”ì¶œ
                    investor.accommodations = accommodations
                        .filter(acc => acc.investorName === investor.name)
                        .map(acc => parseInt(acc.id));
                }
                console.log(`íˆ¬ìì ${index + 1}: ${investor.name} (ID: ${investor.id}) - ìˆ™ì†Œ ${investor.accommodations.length}ê°œ`);
            });
            
            console.log('âœ… íˆ¬ìì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', investors.length + 'ëª…');
            
            if (investors.length === 0) {
                console.log('ğŸš¨ íˆ¬ìì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                console.log('ğŸ’¡ ë¨¼ì € íˆ¬ìì ê´€ë¦¬ì—ì„œ íˆ¬ììë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ
        async function loadAccommodations() {
            try {
                // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const accommodationData = await firebaseStorage.loadAccommodations();
                    accommodations = accommodationData ? accommodationData.map(acc => ({
                        id: parseInt(acc.id),
                        name: acc.accommodationName || acc.name,
                        building: acc.buildingName || 'ì •ë³´ ì—†ìŒ',
                        investorName: acc.investorName || ''
                    })) : [];
                } else {
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                const saved = localStorage.getItem('accommodationData');
                if (saved) {
                    const rawData = JSON.parse(saved);
                    accommodations = rawData.map(acc => ({
                        id: parseInt(acc.id),
                        name: acc.accommodationName || acc.name,
                        building: acc.buildingName || 'ì •ë³´ ì—†ìŒ',
                        investorName: acc.investorName || ''
                    }));
                } else {
                    accommodations = [];
                }
            }
            
            console.log('âœ… ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accommodations.length + 'ê°œ');
        }

        // ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getCategoryText(type, categoryValue) {
            if (!type || !categoryValue || !categories[type]) {
                return categoryValue;
            }
            
            const category = categories[type].find(cat => cat.value === categoryValue);
            return category ? category.text : categoryValue;
        }

        // ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜ (YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ í†µì¼)
        function normalizeDate(dateString) {
            if (!dateString) return null;
            
            // ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš°
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString;
            }
            
            // YYYY-MM-DD HH:mm:ss í˜•ì‹ì¸ ê²½ìš° ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
            if (dateString.includes(' ')) {
                return dateString.split(' ')[0];
            }
            
            // ë‹¤ë¥¸ í˜•ì‹ì¸ ê²½ìš° Date ê°ì²´ë¡œ ë³€í™˜ í›„ ISO í˜•ì‹ìœ¼ë¡œ
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (error) {
                console.warn('ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:', dateString);
            }
            
            return null;
        }

        // íšŒê³„ ë°ì´í„° ë¡œë“œ
        async function loadAccountingData() {
            try {
                // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ íšŒê³„ ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const accountingDataResult = await firebaseStorage.loadAccounting();
                    accountingData = accountingDataResult ? accountingDataResult.map(acc => ({
                        id: acc.id,
                        accommodationId: parseInt(acc.accommodationId),
                        accommodationName: acc.accommodationName,
                        transactionDate: acc.transactionDate || acc.date,
                        description: acc.description,
                        category: acc.category,
                        type: acc.type,
                        amount: parseFloat(acc.amount) || 0
                    })).filter(acc => acc.transactionDate !== null) : [];
                } else {
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                const saved = localStorage.getItem('accountingData');
                if (saved) {
                    const rawData = JSON.parse(saved);
                    accountingData = rawData.map(acc => ({
                        id: acc.id,
                        accommodationId: parseInt(acc.accommodationId),
                        accommodationName: acc.accommodationName,
                        transactionDate: acc.transactionDate || acc.date,
                        description: acc.description,
                        category: acc.category,
                        type: acc.type,
                        amount: parseFloat(acc.amount) || 0
                    })).filter(acc => acc.transactionDate !== null);
                } else {
                    accountingData = [];
                }
            }
            
            console.log('âœ… íšŒê³„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accountingData.length + 'ê±´');
            console.log('ğŸ“… íšŒê³„ ë°ì´í„° ë‚ ì§œ ìƒ˜í”Œ:', accountingData.slice(0, 3).map(acc => ({
                transactionDate: acc.transactionDate,
                description: acc.description,
                amount: acc.amount
            })));
        }

        // ë””ë²„ê¹…ìš© í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        window.testSettlementCalculation = function() {
            console.log('ğŸ§ª ì •ì‚° ê³„ì‚° í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            const investorSelect = document.getElementById('investorFilter');
            const monthSelect = document.getElementById('monthFilter');
            
            console.log('í˜„ì¬ ì„ íƒëœ ê°’:');
            console.log('- íˆ¬ìì:', investorSelect.value);
            console.log('- ì›”:', monthSelect.value);
            console.log('- íˆ¬ìì ë°°ì—´:', investors);
            console.log('- ìˆ™ì†Œ ë°°ì—´:', accommodations);
            console.log('- íšŒê³„ ë°°ì—´:', accountingData);
            
            if (investorSelect.value && monthSelect.value) {
                console.log('ğŸ”„ ìˆ˜ë™ìœ¼ë¡œ ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤í–‰...');
                updateReport();
            } else {
                console.log('âš ï¸ íˆ¬ìì ë˜ëŠ” ì›”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ ì •ì‚° í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ìš°íšŒ (ê°œë°œ ëª¨ë“œ)
            try {
                checkLoginStatus();
                console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì™„ë£Œ');
            } catch (error) {
                console.log('ğŸ”§ ê°œë°œ ëª¨ë“œ: ë¡œê·¸ì¸ ì²´í¬ ìš°íšŒ');
            }
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìë™ ìƒì„± ì œê±°ë¨ - ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš©
            
            try {
                // ì›” ì˜µì…˜ ìƒì„±
                populateMonthOptions();
                
                // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ ì° ìƒëµ
                await initializePage();
                console.log('âœ… ì •ì‚° í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                console.log('ğŸ“ ì‚¬ìš©ìê°€ íˆ¬ììì™€ ì›”ì„ ì„ íƒí•˜ë©´ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.');
                
                // ì´ˆê¸° ìƒíƒœ í™•ì¸ ë° ì•ˆì „í•œ ì„¤ì •
                console.log('ğŸ” ì´ˆê¸° ë°ì´í„° í™•ì¸:');
                console.log('íˆ¬ìì:', investors.length + 'ëª…');
                console.log('ìˆ™ì†Œ:', accommodations.length + 'ê°œ');
                console.log('íšŒê³„:', accountingData.length + 'ê±´');
                
                const investorSelect = document.getElementById('investorFilter');
                const monthSelect = document.getElementById('monthFilter');
                
                // ë°ì´í„°ê°€ ì¶©ë¶„í•  ë•Œë§Œ ìë™ ì„ íƒ
                if (investors.length > 0 && accommodations.length > 0 && accountingData.length > 0) {
                    try {
                        investorSelect.value = investors[0].id;
                        monthSelect.value = '2025-10';
                        
                        console.log('ìë™ ì„ íƒ:', investors[0].name, '2025-10');
                        
                        // 1ì´ˆ í›„ ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸ (ë°ì´í„° ë¡œë”© ì™„ë£Œ ë³´ì¥)
                        setTimeout(() => {
                            try {
                                updateReport();
                                console.log('âœ… ì´ˆê¸° ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ');
                            } catch (error) {
                                console.error('ì´ˆê¸° ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                            }
                        }, 1000);
                    } catch (error) {
                        console.error('ì´ˆê¸° ì„¤ì • ì‹¤íŒ¨:', error);
                    }
                } else {
                    console.log('âš ï¸ ë°ì´í„° ë¶€ì¡±ìœ¼ë¡œ ì´ˆê¸° ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('âŒ ì •ì‚° í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        });



        // ë”ë¯¸ í•¨ìˆ˜ë“¤
        function initializePagePermissions() {
            // í…ŒìŠ¤íŠ¸ìš© ë¹ˆ í•¨ìˆ˜
        }
        
        // ë¡œê·¸ì¸ ì²´í¬ëŠ” auth.jsì—ì„œ ì²˜ë¦¬



        function populateMonthOptions() {
            const monthSelect = document.getElementById('monthFilter');
            const currentDate = new Date();
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
            while (monthSelect.children.length > 1) {
                monthSelect.removeChild(monthSelect.lastChild);
            }
            
            console.log('ğŸ—“ï¸ ì›” ì˜µì…˜ ìƒì„± ì‹œì‘');
            
            // ê¸°ì¤€ ë…„ë„ì™€ ì›” (í˜„ì¬ ê¸°ì¤€)
            const baseYear = currentDate.getFullYear();
            const baseMonth = currentDate.getMonth(); // 0-based (0 = 1ì›”, 11 = 12ì›”)
            const currentMonthValue = `${baseYear}-${String(baseMonth + 1).padStart(2, '0')}`;
            
            console.log(`ê¸°ì¤€ ì •ë³´: ${baseYear}ë…„ ${baseMonth + 1}ì›” (value: ${currentMonthValue})`);
            
            // ê³¼ê±° 12ê°œì›”, í˜„ì¬, ë¯¸ë˜ 12ê°œì›” ìƒì„±
            for (let offset = -12; offset <= 12; offset++) {
                // ë…„ë„ì™€ ì›” ì§ì ‘ ê³„ì‚° (Date ê°ì²´ì˜ ìë™ ì¡°ì • ê¸°ëŠ¥ í™œìš©í•˜ì§€ ì•ŠìŒ)
                let targetYear = baseYear;
                let targetMonth = baseMonth + offset; // 0-based
                
                // ì›”ì´ 0 ë¯¸ë§Œì´ë©´ ì´ì „ ë…„ë„ë¡œ
                while (targetMonth < 0) {
                    targetYear--;
                    targetMonth += 12;
                }
                
                // ì›”ì´ 11 ì´ˆê³¼ë©´ ë‹¤ìŒ ë…„ë„ë¡œ
                while (targetMonth > 11) {
                    targetYear++;
                    targetMonth -= 12;
                }
                
                // YYYY-MM í˜•ì‹ì˜ value ìƒì„±
                const monthValue = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}`;
                const monthLabel = `${targetYear}ë…„ ${targetMonth + 1}ì›”`;
                
                console.log(`ì˜µì…˜: offset=${offset}, value=${monthValue}, label=${monthLabel}`);
                
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthLabel;
                
                // í˜„ì¬ ì›”ì„ ê¸°ë³¸ ì„ íƒìœ¼ë¡œ ì„¤ì •
                if (monthValue === currentMonthValue) {
                    option.selected = true;
                }
                
                monthSelect.appendChild(option);
            }
            
            console.log('âœ… ì›” ì˜µì…˜ ìƒì„± ì™„ë£Œ, ê¸°ë³¸ ì„ íƒ:', currentMonthValue);
        }
        
        // ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ìœ„í•œ storage ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('storage', function(e) {
            if (e.key === 'investorData') {
                loadInvestors().then(() => {
                    populateInvestors();
                });
            }
        });

        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function initializePage() {
            try {
                // ë°ì´í„° ë¡œë“œ - ìˆœì„œ ì¤‘ìš”! ìˆ™ì†Œ ë¨¼ì €, ê·¸ ë‹¤ìŒ íˆ¬ìì
                await loadAccommodations();
                await loadInvestors();
                await loadAccountingData();
                
                // ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš© - ê°€ì§œ ë°ì´í„° ìƒì„±í•˜ì§€ ì•ŠìŒ
                if (investors.length === 0 || accommodations.length === 0 || accountingData.length === 0) {
                    console.log('âš ï¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ìˆ™ì†Œê´€ë¦¬ì™€ ìˆ˜ìµê´€ë¦¬ì—ì„œ ë¨¼ì € ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                
                // UI ì´ˆê¸°í™”
                populateInvestors();
                updateReportDate();
            } catch (error) {
                console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íˆ¬ìì ì˜µì…˜ ì±„ìš°ê¸°
        function populateInvestors() {
            console.log('ğŸ‘¥ íˆ¬ìì ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ì‹œì‘...');
            
            const select = document.getElementById('investorFilter');
            
            if (!select) {
                console.error('âŒ investorFilter ì…€ë ‰íŠ¸ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            console.log('ğŸ“‹ í˜„ì¬ íˆ¬ìì ë°°ì—´:', investors);
            console.log('ğŸ”¢ íˆ¬ìì ìˆ˜:', investors.length + 'ëª…');
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            if (investors.length === 0) {
                console.log('âš ï¸ íˆ¬ìì ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ì„œ ë“œë¡­ë‹¤ìš´ì„ ì±„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                
                // ë°ì´í„° ì—†ìŒ í‘œì‹œë¥¼ ìœ„í•œ ì˜µì…˜ ì¶”ê°€
                const noDataOption = document.createElement('option');
                noDataOption.value = '';
                noDataOption.textContent = 'íˆ¬ìì ë°ì´í„° ì—†ìŒ - íˆ¬ììê´€ë¦¬ì—ì„œ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”';
                noDataOption.disabled = true;
                select.appendChild(noDataOption);
                
                return;
            }
            
            investors.forEach((investor, index) => {
                console.log(`íˆ¬ìì ${index + 1}:`, {
                    id: investor.id,
                    name: investor.name,
                    idType: typeof investor.id,
                    accommodations: investor.accommodations?.length || 0
                });
                
                const option = document.createElement('option');
                option.value = investor.id;
                option.textContent = investor.name || `íˆ¬ìì ${investor.id}`;
                select.appendChild(option);
            });
            
            console.log('âœ… íˆ¬ìì ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ì™„ë£Œ');
            console.log('ğŸ“Š ìµœì¢… ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìˆ˜:', select.options.length);
            console.log('ğŸ“‹ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ëª©ë¡:', Array.from(select.options).map(opt => ({value: opt.value, text: opt.textContent})));
        }

        // ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸
        function updateReport() {
            try {
                const investorIdValue = document.getElementById('investorFilter').value;
                const selectedMonth = document.getElementById('monthFilter').value;
                
                console.log('ğŸ“Š ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘:', investorIdValue, selectedMonth);

                if (!investorIdValue || !selectedMonth) {
                    document.getElementById('reportSection').classList.add('hidden');
                    document.getElementById('noDataMessage').classList.remove('hidden');
                    return;
                }
                
                // ID ë¹„êµë¥¼ ìœ„í•´ ë‘ ê°€ì§€ ë°©ì‹ìœ¼ë¡œ ì‹œë„ (ë¬¸ìì—´ ë° ìˆ«ì)
                const investorId = parseInt(investorIdValue);
                const investor = investors.find(inv => 
                    inv.id == investorIdValue || inv.id === investorId || String(inv.id) === investorIdValue
                );
                
                if (!investor) {
                    console.error('âŒ íˆ¬ììë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', investorIdValue);
                    console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ íˆ¬ììë“¤:', investors.map(inv => ({id: inv.id, name: inv.name})));
                    document.getElementById('reportSection').classList.add('hidden');
                    document.getElementById('noDataMessage').classList.remove('hidden');
                    return;
                }
                
                console.log('âœ… íˆ¬ìì ì°¾ê¸° ì„±ê³µ:', investor.name);
                
                if (!validateReportData(investor, selectedMonth)) {
                    return;
                }

                // ë¦¬í¬íŠ¸ í‘œì‹œ
                document.getElementById('reportSection').classList.remove('hidden');
                document.getElementById('noDataMessage').classList.add('hidden');

                // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
                updateBasicInfo(investor, selectedMonth);

                // ìˆ™ì†Œ ëª©ë¡ ì—…ë°ì´íŠ¸
                updateAccommodationList(investor);

                console.log('ğŸ”„ ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸ ë‹¨ê³„ë³„ ì‹¤í–‰:');
                
                // ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸
                console.log('1ï¸âƒ£ ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘...');
                updateRevenueData(investor, selectedMonth);
                console.log('âœ… ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');

                // ì •ì‚° ê³„ì‚°
                console.log('2ï¸âƒ£ ì •ì‚° ê³„ì‚° ì‹œì‘...');
                calculateSettlement(investor, selectedMonth);
                console.log('âœ… ì •ì‚° ê³„ì‚° ì™„ë£Œ');
                
            } catch (error) {
                console.error('ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                alert('ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateBasicInfo(investor, month) {
            const [year, monthNum] = month.split('-');
            const monthName = `${year}ë…„ ${parseInt(monthNum)}ì›”`;

            document.getElementById('reportTitle').textContent = `${investor.name}ë‹˜ ì •ì‚° ë¦¬í¬íŠ¸`;
            document.getElementById('reportSubtitle').textContent = `${monthName} ì •ì‚° ë‚´ì—­`;

            document.getElementById('investorName').textContent = investor.name;
            document.getElementById('investorPhone').textContent = investor.phone;
            document.getElementById('investorEmail').textContent = investor.email;
            document.getElementById('settlementDay').textContent = `ë§¤ì›” ${investor.settlementDay}ì¼`;
            document.getElementById('investorRatio').textContent = `${investor.investorRatio}%`;
            document.getElementById('companyRatio').textContent = `${investor.companyRatio}%`;
            document.getElementById('accommodationCount').textContent = `${investor.accommodations.length}ê°œ`;


        }

        // ìˆ™ì†Œ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAccommodationList(investor) {
            const container = document.getElementById('accommodationList');
            container.innerHTML = '';
            
            console.log('ìˆ™ì†Œ ëª©ë¡ ì—…ë°ì´íŠ¸:', investor.accommodations);

            investor.accommodations.forEach(accId => {
                const acc = accommodations.find(a => a.id === parseInt(accId));
                console.log(`ìˆ™ì†Œ ID ${accId} ì°¾ê¸°:`, acc);
                
                if (!acc) {
                    // ìˆ™ì†Œ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì •ë³´ë¡œ í‘œì‹œ
                    const div = document.createElement('div');
                    div.className = 'report-card border border-gray-200 rounded-lg p-4';
                    div.innerHTML = `
                        <div class="space-y-2">
                            <div>
                                <span class="text-xs font-medium text-gray-500">ìˆ™ì†Œ ID:</span>
                                <div class="font-medium text-gray-900">${accId}</div>
                            </div>
                            <div>
                                <span class="text-xs font-medium text-gray-500">ìƒíƒœ:</span>
                                <div class="text-sm text-red-600">ìˆ™ì†Œ ì •ë³´ ì—†ìŒ</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                    return;
                }

                const div = document.createElement('div');
                div.className = 'report-card border border-gray-200 rounded-lg p-4';
                div.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <span class="text-xs font-medium text-gray-500">ìˆ™ì†Œëª…:</span>
                            <div class="font-medium text-gray-900">${acc.name}</div>
                        </div>
                        <div>
                            <span class="text-xs font-medium text-gray-500">ê±´ë¬¼ëª…:</span>
                            <div class="text-sm text-gray-600">${acc.building}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateRevenueData(investor, month) {
            console.log('ğŸ” === ì›”ë³„ ë°ì´í„° í•„í„°ë§ ì‹œì‘ ===');
            console.log('ğŸ“Š ìˆ˜ìµ ë°ì´í„° ì—…ë°ì´íŠ¸:', investor.name);
            console.log('ğŸ¯ ì„ íƒëœ ì›”:', month, '(íƒ€ì…:', typeof month, ')');
            
            // íˆ¬ììì˜ ìˆ™ì†Œ ID ë°°ì—´
            const investorAccommodationIds = investor.accommodations || [];
            console.log('ğŸ  íˆ¬ìì ìˆ™ì†Œ IDë“¤:', investorAccommodationIds);
            
            console.log('ğŸ“‹ ì „ì²´ íšŒê³„ ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 3ê°œ):');
            accountingData.slice(0, 3).forEach((item, index) => {
                console.log(`  ${index + 1}. ë‚ ì§œ: ${item.transactionDate}, ìˆ™ì†ŒID: ${item.accommodationId}, íƒ€ì…: ${item.type}, ê¸ˆì•¡: ${item.amount}`);
            });
            
            const monthData = accountingData.filter(item => {
                // transactionDate í•„ë“œ ì‚¬ìš© (ì‹¤ì œ íšŒê³„ ë°ì´í„° êµ¬ì¡°)
                if (!item.transactionDate) {
                    console.warn('âš ï¸ ì˜ëª»ëœ ë‚ ì§œ ë°ì´í„°:', item);
                    return false;
                }
                
                // ì§ì ‘ ë¬¸ìì—´ì—ì„œ YYYY-MM ì¶”ì¶œ (Date ê°ì²´ ì‚¬ìš© ì•ˆí•¨)
                const itemMonth = item.transactionDate.substring(0, 7);
                const isCorrectMonth = itemMonth === month;
                // ìˆ™ì†Œ ID ë§¤ì¹­ - ë¬¸ìì—´ê³¼ ìˆ«ì ëª¨ë‘ ì²˜ë¦¬
                const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                const isInvestorAccommodation = investorAccommodationIds.some(id => 
                    id == itemAccId || parseInt(id) == itemAccId
                );
                
                // ëª¨ë“  í•­ëª©ì— ëŒ€í•´ ìì„¸í•œ ë””ë²„ê¹… ì¶œë ¥
                console.log(`ğŸ“Š ë°ì´í„° ì²´í¬: ë‚ ì§œ=${item.transactionDate}, ì¶”ì¶œì›”=${itemMonth}, ì„ íƒì›”=${month}, ì›”ì¼ì¹˜=${isCorrectMonth}`);
                console.log(`  ìˆ™ì†ŒID=${item.accommodationId}, íˆ¬ìììˆ™ì†Œ=${isInvestorAccommodation}, ìµœì¢…=${isCorrectMonth && isInvestorAccommodation}`);
                
                return isCorrectMonth && isInvestorAccommodation;
            });
            
            console.log('ğŸ¯ === í•„í„°ë§ ê²°ê³¼ ===');
            console.log('í•„í„°ë§ëœ ë°ì´í„° ìˆ˜:', monthData.length + 'ê±´');
            if (monthData.length > 0) {
                console.log('ğŸ“‹ í•„í„°ë§ëœ ë°ì´í„° ìƒì„¸:');
                monthData.forEach((item, index) => {
                    const itemDate = new Date(item.transactionDate);
                    const itemMonth = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                    console.log(`  ${index + 1}. ${item.transactionDate} (${itemMonth}) - ${getCategoryText(item.type, item.category)} - ${item.amount} THB`);
                });
            } else {
                console.log('âŒ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                console.log('ë””ë²„ê¹… ì •ë³´:');
                console.log('- ì„ íƒëœ ì›”:', month);
                console.log('- íˆ¬ìì ìˆ™ì†Œ IDs:', investorAccommodationIds);
                console.log('- ì „ì²´ ë°ì´í„° ìˆ˜:', accountingData.length);
            }

            // KPI ê³„ì‚°
            const incomeItems = monthData.filter(item => item.type === 'income');
            const expenseItems = monthData.filter(item => item.type === 'expense');
            
            const totalRevenue = incomeItems.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = expenseItems.reduce((sum, item) => sum + item.amount, 0);
            const netProfit = totalRevenue - totalExpense;
            const investorDividend = Math.round(netProfit * ((investor.investorRatio || 70) / 100));

            console.log('ğŸ’° KPI ê³„ì‚° ê²°ê³¼:');
            console.log('- ìˆ˜ì… í•­ëª©:', incomeItems.length + 'ê±´');
            console.log('- ì§€ì¶œ í•­ëª©:', expenseItems.length + 'ê±´');
            console.log('- ì´ ìˆ˜ìµ:', totalRevenue.toLocaleString() + ' THB');
            console.log('- ì´ ì§€ì¶œ:', totalExpense.toLocaleString() + ' THB');
            console.log('- ìˆœìˆ˜ìµ:', netProfit.toLocaleString() + ' THB');
            console.log('- íˆ¬ìì ë°°ë‹¹:', investorDividend.toLocaleString() + ' THB');

            // KPI ì¹´ë“œ ì—…ë°ì´íŠ¸ (THB ë‹¨ìœ„ í¬í•¨)
            console.log('ğŸ“Š KPI ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalExpenseEl = document.getElementById('totalExpense');
            const netProfitEl = document.getElementById('netProfit');
            const investorDividendEl = document.getElementById('investorDividend');
            
            console.log('DOM ìš”ì†Œ í™•ì¸:');
            console.log('- totalRevenue ìš”ì†Œ:', totalRevenueEl);
            console.log('- totalExpense ìš”ì†Œ:', totalExpenseEl);
            console.log('- netProfit ìš”ì†Œ:', netProfitEl);
            console.log('- investorDividend ìš”ì†Œ:', investorDividendEl);
            
            if (totalRevenueEl) {
                totalRevenueEl.textContent = `${totalRevenue.toLocaleString()} THB`;
                console.log('âœ… totalRevenue ì—…ë°ì´íŠ¸:', totalRevenueEl.textContent);
            }
            
            if (totalExpenseEl) {
                totalExpenseEl.textContent = `${totalExpense.toLocaleString()} THB`;
                console.log('âœ… totalExpense ì—…ë°ì´íŠ¸:', totalExpenseEl.textContent);
            }
            
            if (netProfitEl) {
                netProfitEl.textContent = `${netProfit.toLocaleString()} THB`;
                console.log('âœ… netProfit ì—…ë°ì´íŠ¸:', netProfitEl.textContent);
            }
            
            if (investorDividendEl) {
                investorDividendEl.textContent = `${investorDividend.toLocaleString()} THB`;
                console.log('âœ… investorDividend ì—…ë°ì´íŠ¸:', investorDividendEl.textContent);
            }

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const tbody = document.getElementById('revenueTableBody');
            tbody.innerHTML = '';

            monthData.sort((a, b) => new Date(a.transactionDate) - new Date(b.transactionDate));

            monthData.forEach(item => {
                const amount = item.amount || 0;
                const isIncome = item.type === 'income';
                
                // ìˆ™ì†Œ ì´ë¦„ ë§¤í•‘ - accommodationNameì´ ì—†ìœ¼ë©´ IDë¡œ ì°¾ê¸°
                let accommodationName = item.accommodationName;
                if (!accommodationName || accommodationName === 'undefined') {
                    const accommodation = accommodations.find(acc => acc.id === item.accommodationId);
                    accommodationName = accommodation ? accommodation.name : `ìˆ™ì†Œ ID ${item.accommodationId}`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${formatDate(item.transactionDate)}</td>
                    <td class="px-4 py-3 text-sm">${accommodationName}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            item.type === 'income' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            ${item.type === 'income' ? 'ìˆ˜ìµ' : 'ë¹„ìš©'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${getCategoryText(item.type, item.category) || item.category || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.description || '-'}</td>
                    <td class="px-4 py-3 text-sm text-right font-semibold ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${item.type === 'income' ? '+' : '-'}${amount.toLocaleString()} THB
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ì •ì‚° ê³„ì‚°
        function calculateSettlement(investor, month) {
            console.log('ğŸ“Š ì •ì‚° ê³„ì‚° ì‹œì‘:', investor.name, month);
            
            // íˆ¬ììì˜ ìˆ™ì†Œ ID ë°°ì—´
            const investorAccommodationIds = investor.accommodations || [];
            console.log('íˆ¬ìì ìˆ™ì†Œ IDs:', investorAccommodationIds);
            
            // í•´ë‹¹ ì›” ë°ì´í„° í•„í„°ë§ (transactionDate ì‚¬ìš©)
            const monthData = accountingData.filter(item => {
                // transactionDate í•„ë“œ ì‚¬ìš©
                if (!item.transactionDate) {
                    console.warn('âš ï¸ ì •ì‚° ê³„ì‚°ì—ì„œ ì˜ëª»ëœ ë‚ ì§œ ë°ì´í„°:', item);
                    return false;
                }
                
                // ì§ì ‘ ë¬¸ìì—´ì—ì„œ YYYY-MM ì¶”ì¶œ (Date ê°ì²´ ì‚¬ìš© ì•ˆí•¨)
                const itemMonth = item.transactionDate.substring(0, 7);
                const isCorrectMonth = itemMonth === month;
                // ìˆ™ì†Œ ID ë§¤ì¹­ - ë¬¸ìì—´ê³¼ ìˆ«ì ëª¨ë‘ ì²˜ë¦¬
                const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                const isInvestorAccommodation = investorAccommodationIds.some(id => 
                    id == itemAccId || parseInt(id) == itemAccId
                );
                
                console.log(`ğŸ’° ì •ì‚°í•„í„°: ë‚ ì§œ=${item.transactionDate}, ì¶”ì¶œì›”=${itemMonth}, ì„ íƒì›”=${month}, ì›”ì¼ì¹˜=${isCorrectMonth}`);
                console.log(`   ìˆ™ì†ŒID=${item.accommodationId}, íˆ¬ìììˆ™ì†Œì¼ì¹˜=${isInvestorAccommodation}, ìµœì¢…=${isCorrectMonth && isInvestorAccommodation}`);
                
                return isCorrectMonth && isInvestorAccommodation;
            });
            
            console.log('í•´ë‹¹ ì›” ë°ì´í„°:', monthData);

            // ìˆ˜ì…ê³¼ ì§€ì¶œ ê³„ì‚°
            const totalRevenue = monthData.filter(item => item.type === 'income').reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = monthData.filter(item => item.type === 'expense').reduce((sum, item) => sum + item.amount, 0);
            const netProfit = totalRevenue - totalExpense;

            console.log('ì´ ìˆ˜ìµ:', totalRevenue, 'ì´ ì§€ì¶œ:', totalExpense, 'ìˆœìˆ˜ìµ:', netProfit);

            const investorShare = Math.round(netProfit * ((investor.investorRatio || 70) / 100));
            const companyShare = netProfit - investorShare;

            // ì •ì‚° ê³„ì‚°ì„œ ì—…ë°ì´íŠ¸ (THB ë‹¨ìœ„ í¬í•¨)
            console.log('ğŸ“Š ì •ì‚° ê³„ì‚°ì„œ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            const calcElements = {
                calc_totalRevenue: document.getElementById('calc_totalRevenue'),
                calc_totalExpense: document.getElementById('calc_totalExpense'),
                calc_netProfit: document.getElementById('calc_netProfit'),
                calc_investorRatio: document.getElementById('calc_investorRatio'),
                calc_companyRatio: document.getElementById('calc_companyRatio'),
                calc_investorShare: document.getElementById('calc_investorShare'),
                calc_companyShare: document.getElementById('calc_companyShare'),
                calc_finalDividend: document.getElementById('calc_finalDividend'),
                finalSettlementAmount: document.getElementById('finalSettlementAmount')
            };
            
            console.log('ì •ì‚° ê³„ì‚°ì„œ DOM ìš”ì†Œ í™•ì¸:', calcElements);
            
            // ê° ìš”ì†Œë¥¼ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            if (calcElements.calc_totalRevenue) calcElements.calc_totalRevenue.textContent = `${totalRevenue.toLocaleString()} THB`;
            if (calcElements.calc_totalExpense) calcElements.calc_totalExpense.textContent = `${totalExpense.toLocaleString()} THB`;
            if (calcElements.calc_netProfit) calcElements.calc_netProfit.textContent = `${netProfit.toLocaleString()} THB`;
            if (calcElements.calc_investorRatio) calcElements.calc_investorRatio.textContent = investor.investorRatio + '%';
            if (calcElements.calc_companyRatio) calcElements.calc_companyRatio.textContent = investor.companyRatio + '%';
            if (calcElements.calc_investorShare) calcElements.calc_investorShare.textContent = `${investorShare.toLocaleString()} THB`;
            if (calcElements.calc_companyShare) calcElements.calc_companyShare.textContent = `${companyShare.toLocaleString()} THB`;
            if (calcElements.calc_finalDividend) calcElements.calc_finalDividend.textContent = `${investorShare.toLocaleString()} THB`;
            if (calcElements.finalSettlementAmount) calcElements.finalSettlementAmount.textContent = `${investorShare.toLocaleString()} THB`;
            
            console.log('âœ… ì •ì‚° ê³„ì‚°ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            console.log('- ì´ìˆ˜ìµ:', totalRevenue.toLocaleString(), 'THB');
            console.log('- ì´ì§€ì¶œ:', totalExpense.toLocaleString(), 'THB');
            console.log('- ìˆœìˆ˜ìµ:', netProfit.toLocaleString(), 'THB');
            console.log('- íˆ¬ìì ë°°ë‹¹:', investorShare.toLocaleString(), 'THB');

            // ìƒ‰ìƒ ì ìš©
            const profitElements = [
                document.getElementById('calc_netProfit'),
                document.getElementById('calc_finalDividend'),
                document.getElementById('finalSettlementAmount')
            ];
            
            profitElements.forEach(element => {
                element.className = element.className.replace(/text-\w+-\d+/g, '');
                element.classList.add(netProfit >= 0 ? 'text-green-600' : 'text-red-600');
            });
        }

        // ë¦¬í¬íŠ¸ ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateReportDate() {
            const now = new Date();
            const reportNumber = `RPT-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
            
            document.getElementById('reportDate').textContent = now.toLocaleDateString('ko-KR');
            document.getElementById('reportNumber').textContent = reportNumber;
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        function performSettlementSearch() {
            console.log('ğŸ” ì •ì‚° ì¡°íšŒ ì‹œì‘...');
            
            const selectedInvestor = document.getElementById('investorFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            
            console.log('ì„ íƒëœ íˆ¬ìì:', selectedInvestor);
            console.log('ì„ íƒëœ ì›”:', selectedMonth);
            console.log('í˜„ì¬ ë°ì´í„° ìƒíƒœ:');
            console.log('- íˆ¬ìì:', investors.length + 'ëª…');
            console.log('- ìˆ™ì†Œ:', accommodations.length + 'ê°œ');
            console.log('- íšŒê³„ ë°ì´í„°:', accountingData.length + 'ê±´');
            
            if (!selectedInvestor) {
                alert('íˆ¬ììë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedMonth) {
                alert('ì •ì‚° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (investors.length === 0) {
                alert('íˆ¬ìì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íˆ¬ìì ê´€ë¦¬ì—ì„œ ë¨¼ì € íˆ¬ììë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (accountingData.length === 0) {
                alert('íšŒê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ìµ ê´€ë¦¬ì—ì„œ ë¨¼ì € ìˆ˜ì…/ì§€ì¶œ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ğŸ“Š updateReport í•¨ìˆ˜ ì‹¤í–‰ ì¤‘...');
            
            // updateReport í•¨ìˆ˜ ì‹¤í–‰í•˜ì—¬ í•˜ë‹¨ì— ì •ì‚° ë¦¬í¬íŠ¸ í‘œì‹œ
            updateReport();
            
            console.log('âœ… ì •ì‚° ì¡°íšŒ ì™„ë£Œ');
        }

        // ë¦¬í¬íŠ¸ ìƒì„± ê¸°ëŠ¥
        function generateInvestorReport() {
            const selectedInvestor = document.getElementById('investorFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            
            if (!selectedInvestor) {
                alert('íˆ¬ììë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedMonth) {
                alert('ì •ì‚° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìƒˆ ì°½ì—ì„œ ë¦¬í¬íŠ¸ í˜ì´ì§€ ì—´ê¸° (URL íŒŒë¼ë¯¸í„°ë¡œ ì •í™•í•œ ë°ì´í„° ì „ë‹¬)
            console.log('ğŸ“Š ë¦¬í¬íŠ¸ ìƒì„± ìš”ì²­:');
            console.log('- ì„ íƒëœ íˆ¬ìì ID:', selectedInvestor);
            console.log('- ì„ íƒëœ ì›”:', selectedMonth);
            
            const reportUrl = `investor-report.html?investor=${encodeURIComponent(selectedInvestor)}&month=${encodeURIComponent(selectedMonth)}`;
            console.log('ğŸ”— ìƒì„±ëœ URL:', reportUrl);
            
            window.open(reportUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
        function validateReportData(investor, month) {
            if (!investor) {
                alert('ì„ íƒëœ íˆ¬ìì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            if (!month) {
                alert('ì •ì‚° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            if (!investor.accommodations || investor.accommodations.length === 0) {
                alert('í•´ë‹¹ íˆ¬ììì˜ ë³´ìœ  ìˆ™ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            return true;
        }

        // THB í†µí™” í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function formatTHB(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '0 THB';
            }
            return `${Math.round(amount).toLocaleString()} THB`;
        }

        // ì¼ê´€ì„±ì„ ìœ„í•œ formatMoney ë³„ì¹­ í•¨ìˆ˜
        function formatMoney(amount) {
            return formatTHB(amount);
        }
    </script>
</body>
</html>