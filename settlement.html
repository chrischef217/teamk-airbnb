<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투자자 정산 - Teamk 공유숙박 관리 시스템</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% 완전 차단) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        .report-card {
            transition: all 0.2s ease-in-out;
        }
        .report-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .profit-positive {
            background-color: #d1fae5;
            color: #065f46;
        }
        .profit-negative {
            background-color: #fee2e2;
            color: #991b1b;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="systemTitle">
                    Teamk 공유숙박 관리 시스템
                </h1>

            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='dashboard.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> 대시보드
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> 숙소 관리
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> 예약 관리
                    </button>

                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> 수익 관리
                    </button>
                    <button onclick="window.location.href='investor.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-users mr-1"></i> 투자자 관리
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-calculator mr-1"></i> 투자자 정산
                    </button>

                    <button onclick="window.location.href='data-migration.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-database mr-1"></i> 데이터 관리
                    </button>
                </div>
            </div>
        </div>

        <!-- 필터 섹션 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 no-print">
            <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">투자자 선택 *</label>
                    <select id="investorFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">투자자를 선택하세요</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">정산 월 *</label>
                    <select id="monthFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">월을 선택하세요</option>
                        <!-- 월 옵션은 JavaScript에서 동적으로 생성됩니다 -->
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="performSettlementSearch()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        조회
                    </button>
                    <button onclick="generateInvestorReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>
                        리포트 생성
                    </button>
                </div>
            </div>
        </div>

        <!-- 리포트 섹션 -->
        <div id="reportSection" class="hidden">
            <!-- 리포트 헤더 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="reportTitle">투자자 정산 리포트</h2>
                        <p class="text-sm text-gray-600" id="reportSubtitle">정산 기간 및 투자자 정보</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">생성일: <span id="reportDate"></span></p>
                        <p class="text-xs text-gray-500">문서번호: <span id="reportNumber"></span></p>
                    </div>
                </div>
                
                <!-- 투자자 기본 정보 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">투자자 정보</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">성명:</span>
                                <span id="investorName" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">연락처:</span>
                                <span id="investorPhone" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">이메일:</span>
                                <span id="investorEmail" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">정산일:</span>
                                <span id="settlementDay" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-3">투자 조건</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">투자 비율:</span>
                                <span id="investorRatio" class="font-medium text-blue-600">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">회사 비율:</span>
                                <span id="companyRatio" class="font-medium text-green-600">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">보유 숙소:</span>
                                <span id="accommodationCount" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 보유 숙소 목록 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-building text-blue-600 mr-2"></i>
                    보유 숙소 목록
                </h3>
                <div id="accommodationList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 숙소 목록이 여기에 표시됩니다 -->
                </div>
            </div>

            <!-- 월별 수익 현황 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-line text-green-600 mr-2"></i>
                    월별 수익 현황 <span class="text-sm font-normal text-gray-500">(단위: THB)</span>
                </h3>
                
                <!-- KPI 카드 -->
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-green-400 to-green-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">총 수익</div>
                        <div id="totalRevenue" class="text-xl font-bold">0 THB</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-400 to-red-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">총 지출</div>
                        <div id="totalExpense" class="text-xl font-bold">0 THB</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">순수익</div>
                        <div id="netProfit" class="text-xl font-bold">0 THB</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-400 to-purple-500 rounded-lg p-4 text-white">
                        <div class="text-sm opacity-90">투자자 배당</div>
                        <div id="investorDividend" class="text-xl font-bold">0 THB</div>
                    </div>
                </div>

                <!-- 상세 수익 테이블 -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">날짜</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">숙소</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">구분</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">항목</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">비고</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">금액</th>
                            </tr>
                        </thead>
                        <tbody id="revenueTableBody" class="divide-y divide-gray-200">
                            <!-- 데이터가 여기에 표시됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 정산 계산서 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-calculator text-purple-600 mr-2"></i>
                    정산 계산서 <span class="text-sm font-normal text-gray-500">(단위: THB)</span>
                </h3>
                
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- 수익 분석 -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-4">수익 분석</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">총 숙박 수익:</span>
                                    <span id="calc_totalRevenue" class="font-medium">0 THB</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">총 운영 비용:</span>
                                    <span id="calc_totalExpense" class="font-medium text-red-600">0 THB</span>
                                </div>
                                <div class="border-t pt-2">
                                    <div class="flex justify-between font-semibold">
                                        <span>순수익:</span>
                                        <span id="calc_netProfit" class="text-lg">0 THB</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 배당 계산 -->
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-4">배당 계산</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">투자자 지분 (<span id="calc_investorRatio">70</span>%):</span>
                                    <span id="calc_investorShare" class="font-medium text-blue-600">0 THB</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">회사 지분 (<span id="calc_companyRatio">30</span>%):</span>
                                    <span id="calc_companyShare" class="font-medium text-green-600">0 THB</span>
                                </div>
                                <div class="border-t pt-2">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>투자자 배당금:</span>
                                        <span id="calc_finalDividend" class="text-blue-600">0 THB</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 정산 요약 -->
                    <div class="mt-6 p-4 border-2 border-blue-200 rounded-lg bg-blue-50">
                        <div class="text-center">
                            <h4 class="text-lg font-bold text-blue-800 mb-2">이번 달 정산 금액</h4>
                            <div class="text-3xl font-bold text-blue-600" id="finalSettlementAmount">0 THB</div>
                            <p class="text-xs text-blue-600 mt-2">위 금액은 투자자님께 지급될 배당금입니다.</p>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- 안내 메시지 -->
        <div id="noDataMessage" class="bg-white rounded-lg shadow-sm p-8 text-center">
            <i class="fas fa-chart-bar text-gray-300 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-800 mb-2">정산 리포트</h3>
            <p class="text-gray-600">투자자와 정산 월을 선택하면 상세 리포트가 표시됩니다.</p>
        </div>
    </div>

    <script>
        // 전역 데이터 저장소
        let investors = [];
        let accommodations = [];
        let accountingData = [];

        // 카테고리 정의 (accounting.html과 동일)
        const categories = {
            income: [
                { value: 'booking', text: '예약 수입' },
                { value: 'deposit', text: '보증금' },
                { value: 'additional', text: '추가 서비스' },
                { value: 'other_income', text: '기타 수입' }
            ],
            expense: [
                { value: 'cleaning', text: '청소비' },
                { value: 'maintenance', text: '수리/보수' },
                { value: 'supplies', text: '용품 구입' },
                { value: 'utilities', text: '공과금' },
                { value: 'rent', text: '렌트비' },
                { value: 'platform_fee', text: '플랫폼 수수료' },
                { value: 'tax', text: '세금' },
                { value: 'other_expense', text: '기타 지출' }
            ]
        };

        // API 기본 함수들
        async function fetchTableData(tableName, params = {}) {
            try {
                const queryParams = new URLSearchParams(params).toString();
                const response = await fetch(`tables/${tableName}${queryParams ? '?' + queryParams : ''}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error(`Error fetching ${tableName}:`, error);
                return [];
            }
        }

        // 투자자 데이터를 localStorage에서 로드
        // 실제 시스템 데이터 로드
        async function loadInvestors() {
            console.log('🔍 투자자 데이터 로딩 시작...');
            
            try {
                // Firebase에서 데이터 로드 시도
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 투자자 데이터 로드 중...');
                    const investorData = await firebaseStorage.loadInvestors();
                    investors = investorData || [];
                    console.log('📡 Firebase에서 로드된 투자자:', investors.length + '명');
                } else {
                    console.log('⚠️ Firebase가 설정되지 않았습니다.');
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 로드 실패, localStorage 폴백:', firebaseError.message);
                const saved = localStorage.getItem('investorData');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    investors = Array.isArray(parsedData) ? parsedData : [];
                    console.log('💾 localStorage에서 로드된 투자자:', investors.length + '명');
                    console.log('📋 투자자 데이터 미리보기:', investors.map(inv => ({id: inv.id, name: inv.name})));
                } else {
                    console.log('❌ localStorage에도 투자자 데이터가 없습니다!');
                    investors = [];
                }
            }
            
            // 투자자 데이터에 accommodations 배열 추가 (숙소 ID들)
            investors.forEach((investor, index) => {
                if (!investor.accommodations) {
                    // 투자자별 숙소 ID 배열을 숙소 데이터에서 추출
                    investor.accommodations = accommodations
                        .filter(acc => acc.investorName === investor.name)
                        .map(acc => parseInt(acc.id));
                }
                console.log(`투자자 ${index + 1}: ${investor.name} (ID: ${investor.id}) - 숙소 ${investor.accommodations.length}개`);
            });
            
            console.log('✅ 투자자 데이터 로드 완료:', investors.length + '명');
            
            if (investors.length === 0) {
                console.log('🚨 투자자 데이터가 없습니다!');
                console.log('💡 먼저 투자자 관리에서 투자자를 등록해주세요.');
            }
        }

        // 숙소 데이터 로드
        async function loadAccommodations() {
            try {
                // Firebase에서 데이터 로드 시도
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 숙소 데이터 로드 중...');
                    const accommodationData = await firebaseStorage.loadAccommodations();
                    accommodations = accommodationData ? accommodationData.map(acc => ({
                        id: parseInt(acc.id),
                        name: acc.accommodationName || acc.name,
                        building: acc.buildingName || '정보 없음',
                        investorName: acc.investorName || ''
                    })) : [];
                } else {
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 로드 실패, localStorage 폴백:', firebaseError.message);
                const saved = localStorage.getItem('accommodationData');
                if (saved) {
                    const rawData = JSON.parse(saved);
                    accommodations = rawData.map(acc => ({
                        id: parseInt(acc.id),
                        name: acc.accommodationName || acc.name,
                        building: acc.buildingName || '정보 없음',
                        investorName: acc.investorName || ''
                    }));
                } else {
                    accommodations = [];
                }
            }
            
            console.log('✅ 숙소 데이터 로드 완료:', accommodations.length + '개');
        }

        // 카테고리 텍스트 가져오기 함수
        function getCategoryText(type, categoryValue) {
            if (!type || !categoryValue || !categories[type]) {
                return categoryValue;
            }
            
            const category = categories[type].find(cat => cat.value === categoryValue);
            return category ? category.text : categoryValue;
        }

        // 날짜 정규화 함수 (YYYY-MM-DD 형식으로 통일)
        function normalizeDate(dateString) {
            if (!dateString) return null;
            
            // 이미 YYYY-MM-DD 형식인 경우
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString;
            }
            
            // YYYY-MM-DD HH:mm:ss 형식인 경우 날짜 부분만 추출
            if (dateString.includes(' ')) {
                return dateString.split(' ')[0];
            }
            
            // 다른 형식인 경우 Date 객체로 변환 후 ISO 형식으로
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (error) {
                console.warn('날짜 변환 실패:', dateString);
            }
            
            return null;
        }

        // 회계 데이터 로드
        async function loadAccountingData() {
            try {
                // Firebase에서 데이터 로드 시도
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 회계 데이터 로드 중...');
                    const accountingDataResult = await firebaseStorage.loadAccounting();
                    accountingData = accountingDataResult ? accountingDataResult.map(acc => ({
                        id: acc.id,
                        accommodationId: parseInt(acc.accommodationId),
                        accommodationName: acc.accommodationName,
                        transactionDate: acc.transactionDate || acc.date,
                        description: acc.description,
                        category: acc.category,
                        type: acc.type,
                        amount: parseFloat(acc.amount) || 0
                    })).filter(acc => acc.transactionDate !== null) : [];
                } else {
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 로드 실패, localStorage 폴백:', firebaseError.message);
                const saved = localStorage.getItem('accountingData');
                if (saved) {
                    const rawData = JSON.parse(saved);
                    accountingData = rawData.map(acc => ({
                        id: acc.id,
                        accommodationId: parseInt(acc.accommodationId),
                        accommodationName: acc.accommodationName,
                        transactionDate: acc.transactionDate || acc.date,
                        description: acc.description,
                        category: acc.category,
                        type: acc.type,
                        amount: parseFloat(acc.amount) || 0
                    })).filter(acc => acc.transactionDate !== null);
                } else {
                    accountingData = [];
                }
            }
            
            console.log('✅ 회계 데이터 로드 완료:', accountingData.length + '건');
            console.log('📅 회계 데이터 날짜 샘플:', accountingData.slice(0, 3).map(acc => ({
                transactionDate: acc.transactionDate,
                description: acc.description,
                amount: acc.amount
            })));
        }

        // 디버깅용 테스트 함수
        window.testSettlementCalculation = function() {
            console.log('🧪 정산 계산 테스트 시작');
            
            const investorSelect = document.getElementById('investorFilter');
            const monthSelect = document.getElementById('monthFilter');
            
            console.log('현재 선택된 값:');
            console.log('- 투자자:', investorSelect.value);
            console.log('- 월:', monthSelect.value);
            console.log('- 투자자 배열:', investors);
            console.log('- 숙소 배열:', accommodations);
            console.log('- 회계 배열:', accountingData);
            
            if (investorSelect.value && monthSelect.value) {
                console.log('🔄 수동으로 리포트 업데이트 실행...');
                updateReport();
            } else {
                console.log('⚠️ 투자자 또는 월이 선택되지 않았습니다.');
            }
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 정산 페이지 초기화 시작');
            
            // 로그인 상태 확인 우회 (개발 모드)
            try {
                checkLoginStatus();
                console.log('✅ 로그인 상태 확인 완료');
            } catch (error) {
                console.log('🔧 개발 모드: 로그인 체크 우회');
            }
            
            // 테스트 데이터 자동 생성 제거됨 - 실제 데이터만 사용
            
            try {
                // 월 옵션 생성
                populateMonthOptions();
                
                // 테스트를 위해 로그인 찍 생략
                await initializePage();
                console.log('✅ 정산 페이지 초기화 완료');
                console.log('📝 사용자가 투자자와 월을 선택하면 리포트가 생성됩니다.');
                
                // 초기 상태 확인 및 안전한 설정
                console.log('🔍 초기 데이터 확인:');
                console.log('투자자:', investors.length + '명');
                console.log('숙소:', accommodations.length + '개');
                console.log('회계:', accountingData.length + '건');
                
                const investorSelect = document.getElementById('investorFilter');
                const monthSelect = document.getElementById('monthFilter');
                
                // 데이터가 충분할 때만 자동 선택
                if (investors.length > 0 && accommodations.length > 0 && accountingData.length > 0) {
                    try {
                        investorSelect.value = investors[0].id;
                        monthSelect.value = '2025-10';
                        
                        console.log('자동 선택:', investors[0].name, '2025-10');
                        
                        // 1초 후 리포트 업데이트 (데이터 로딩 완료 보장)
                        setTimeout(() => {
                            try {
                                updateReport();
                                console.log('✅ 초기 리포트 생성 완료');
                            } catch (error) {
                                console.error('초기 리포트 생성 실패:', error);
                            }
                        }, 1000);
                    } catch (error) {
                        console.error('초기 설정 실패:', error);
                    }
                } else {
                    console.log('⚠️ 데이터 부족으로 초기 리포트를 생성하지 않습니다.');
                }
                
            } catch (error) {
                console.error('❌ 정산 페이지 초기화 실패:', error);
            }
        });



        // 더미 함수들
        function initializePagePermissions() {
            // 테스트용 빈 함수
        }
        
        // 로그인 체크는 auth.js에서 처리



        function populateMonthOptions() {
            const monthSelect = document.getElementById('monthFilter');
            const currentDate = new Date();
            
            // 기존 옵션 제거 (첫 번째 기본 옵션 제외)
            while (monthSelect.children.length > 1) {
                monthSelect.removeChild(monthSelect.lastChild);
            }
            
            console.log('🗓️ 월 옵션 생성 시작');
            
            // 기준 년도와 월 (현재 기준)
            const baseYear = currentDate.getFullYear();
            const baseMonth = currentDate.getMonth(); // 0-based (0 = 1월, 11 = 12월)
            const currentMonthValue = `${baseYear}-${String(baseMonth + 1).padStart(2, '0')}`;
            
            console.log(`기준 정보: ${baseYear}년 ${baseMonth + 1}월 (value: ${currentMonthValue})`);
            
            // 과거 12개월, 현재, 미래 12개월 생성
            for (let offset = -12; offset <= 12; offset++) {
                // 년도와 월 직접 계산 (Date 객체의 자동 조정 기능 활용하지 않음)
                let targetYear = baseYear;
                let targetMonth = baseMonth + offset; // 0-based
                
                // 월이 0 미만이면 이전 년도로
                while (targetMonth < 0) {
                    targetYear--;
                    targetMonth += 12;
                }
                
                // 월이 11 초과면 다음 년도로
                while (targetMonth > 11) {
                    targetYear++;
                    targetMonth -= 12;
                }
                
                // YYYY-MM 형식의 value 생성
                const monthValue = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}`;
                const monthLabel = `${targetYear}년 ${targetMonth + 1}월`;
                
                console.log(`옵션: offset=${offset}, value=${monthValue}, label=${monthLabel}`);
                
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthLabel;
                
                // 현재 월을 기본 선택으로 설정
                if (monthValue === currentMonthValue) {
                    option.selected = true;
                }
                
                monthSelect.appendChild(option);
            }
            
            console.log('✅ 월 옵션 생성 완료, 기본 선택:', currentMonthValue);
        }
        
        // 실시간 동기화를 위한 storage 이벤트 리스너
        window.addEventListener('storage', function(e) {
            if (e.key === 'investorData') {
                loadInvestors().then(() => {
                    populateInvestors();
                });
            }
        });

        // 페이지 초기화
        async function initializePage() {
            try {
                // 데이터 로드 - 순서 중요! 숙소 먼저, 그 다음 투자자
                await loadAccommodations();
                await loadInvestors();
                await loadAccountingData();
                
                // 실제 데이터만 사용 - 가짜 데이터 생성하지 않음
                if (investors.length === 0 || accommodations.length === 0 || accountingData.length === 0) {
                    console.log('⚠️ 데이터가 부족합니다. 숙소관리와 수익관리에서 먼저 데이터를 입력해주세요.');
                }
                
                // UI 초기화
                populateInvestors();
                updateReportDate();
            } catch (error) {
                console.error('페이지 초기화 오류:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 투자자 옵션 채우기
        function populateInvestors() {
            console.log('👥 투자자 드롭다운 채우기 시작...');
            
            const select = document.getElementById('investorFilter');
            
            if (!select) {
                console.error('❌ investorFilter 셀렉트 요소를 찾을 수 없습니다!');
                return;
            }
            
            console.log('📋 현재 투자자 배열:', investors);
            console.log('🔢 투자자 수:', investors.length + '명');
            
            // 기존 옵션 제거 (첫 번째 기본 옵션 제외)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            if (investors.length === 0) {
                console.log('⚠️ 투자자 데이터가 비어있어서 드롭다운을 채울 수 없습니다!');
                
                // 데이터 없음 표시를 위한 옵션 추가
                const noDataOption = document.createElement('option');
                noDataOption.value = '';
                noDataOption.textContent = '투자자 데이터 없음 - 투자자관리에서 먼저 등록하세요';
                noDataOption.disabled = true;
                select.appendChild(noDataOption);
                
                return;
            }
            
            investors.forEach((investor, index) => {
                console.log(`투자자 ${index + 1}:`, {
                    id: investor.id,
                    name: investor.name,
                    idType: typeof investor.id,
                    accommodations: investor.accommodations?.length || 0
                });
                
                const option = document.createElement('option');
                option.value = investor.id;
                option.textContent = investor.name || `투자자 ${investor.id}`;
                select.appendChild(option);
            });
            
            console.log('✅ 투자자 드롭다운 채우기 완료');
            console.log('📊 최종 드롭다운 옵션 수:', select.options.length);
            console.log('📋 드롭다운 옵션 목록:', Array.from(select.options).map(opt => ({value: opt.value, text: opt.textContent})));
        }

        // 리포트 업데이트
        function updateReport() {
            try {
                const investorIdValue = document.getElementById('investorFilter').value;
                const selectedMonth = document.getElementById('monthFilter').value;
                
                console.log('📊 리포트 생성 시작:', investorIdValue, selectedMonth);

                if (!investorIdValue || !selectedMonth) {
                    document.getElementById('reportSection').classList.add('hidden');
                    document.getElementById('noDataMessage').classList.remove('hidden');
                    return;
                }
                
                // ID 비교를 위해 두 가지 방식으로 시도 (문자열 및 숫자)
                const investorId = parseInt(investorIdValue);
                const investor = investors.find(inv => 
                    inv.id == investorIdValue || inv.id === investorId || String(inv.id) === investorIdValue
                );
                
                if (!investor) {
                    console.error('❌ 투자자를 찾을 수 없습니다:', investorIdValue);
                    console.log('📋 사용 가능한 투자자들:', investors.map(inv => ({id: inv.id, name: inv.name})));
                    document.getElementById('reportSection').classList.add('hidden');
                    document.getElementById('noDataMessage').classList.remove('hidden');
                    return;
                }
                
                console.log('✅ 투자자 찾기 성공:', investor.name);
                
                if (!validateReportData(investor, selectedMonth)) {
                    return;
                }

                // 리포트 표시
                document.getElementById('reportSection').classList.remove('hidden');
                document.getElementById('noDataMessage').classList.add('hidden');

                // 기본 정보 업데이트
                updateBasicInfo(investor, selectedMonth);

                // 숙소 목록 업데이트
                updateAccommodationList(investor);

                console.log('🔄 리포트 업데이트 단계별 실행:');
                
                // 수익 데이터 업데이트
                console.log('1️⃣ 수익 데이터 업데이트 시작...');
                updateRevenueData(investor, selectedMonth);
                console.log('✅ 수익 데이터 업데이트 완료');

                // 정산 계산
                console.log('2️⃣ 정산 계산 시작...');
                calculateSettlement(investor, selectedMonth);
                console.log('✅ 정산 계산 완료');
                
            } catch (error) {
                console.error('리포트 업데이트 오류:', error);
                alert('리포트 생성 중 오류가 발생했습니다.');
            }
        }

        // 기본 정보 업데이트
        function updateBasicInfo(investor, month) {
            const [year, monthNum] = month.split('-');
            const monthName = `${year}년 ${parseInt(monthNum)}월`;

            document.getElementById('reportTitle').textContent = `${investor.name}님 정산 리포트`;
            document.getElementById('reportSubtitle').textContent = `${monthName} 정산 내역`;

            document.getElementById('investorName').textContent = investor.name;
            document.getElementById('investorPhone').textContent = investor.phone;
            document.getElementById('investorEmail').textContent = investor.email;
            document.getElementById('settlementDay').textContent = `매월 ${investor.settlementDay}일`;
            document.getElementById('investorRatio').textContent = `${investor.investorRatio}%`;
            document.getElementById('companyRatio').textContent = `${investor.companyRatio}%`;
            document.getElementById('accommodationCount').textContent = `${investor.accommodations.length}개`;


        }

        // 숙소 목록 업데이트
        function updateAccommodationList(investor) {
            const container = document.getElementById('accommodationList');
            container.innerHTML = '';
            
            console.log('숙소 목록 업데이트:', investor.accommodations);

            investor.accommodations.forEach(accId => {
                const acc = accommodations.find(a => a.id === parseInt(accId));
                console.log(`숙소 ID ${accId} 찾기:`, acc);
                
                if (!acc) {
                    // 숙소 정보가 없는 경우 기본 정보로 표시
                    const div = document.createElement('div');
                    div.className = 'report-card border border-gray-200 rounded-lg p-4';
                    div.innerHTML = `
                        <div class="space-y-2">
                            <div>
                                <span class="text-xs font-medium text-gray-500">숙소 ID:</span>
                                <div class="font-medium text-gray-900">${accId}</div>
                            </div>
                            <div>
                                <span class="text-xs font-medium text-gray-500">상태:</span>
                                <div class="text-sm text-red-600">숙소 정보 없음</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                    return;
                }

                const div = document.createElement('div');
                div.className = 'report-card border border-gray-200 rounded-lg p-4';
                div.innerHTML = `
                    <div class="space-y-2">
                        <div>
                            <span class="text-xs font-medium text-gray-500">숙소명:</span>
                            <div class="font-medium text-gray-900">${acc.name}</div>
                        </div>
                        <div>
                            <span class="text-xs font-medium text-gray-500">건물명:</span>
                            <div class="text-sm text-gray-600">${acc.building}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 수익 데이터 업데이트
        function updateRevenueData(investor, month) {
            console.log('🔍 === 월별 데이터 필터링 시작 ===');
            console.log('📊 수익 데이터 업데이트:', investor.name);
            console.log('🎯 선택된 월:', month, '(타입:', typeof month, ')');
            
            // 투자자의 숙소 ID 배열
            const investorAccommodationIds = investor.accommodations || [];
            console.log('🏠 투자자 숙소 ID들:', investorAccommodationIds);
            
            console.log('📋 전체 회계 데이터 샘플 (처음 3개):');
            accountingData.slice(0, 3).forEach((item, index) => {
                console.log(`  ${index + 1}. 날짜: ${item.transactionDate}, 숙소ID: ${item.accommodationId}, 타입: ${item.type}, 금액: ${item.amount}`);
            });
            
            const monthData = accountingData.filter(item => {
                // transactionDate 필드 사용 (실제 회계 데이터 구조)
                if (!item.transactionDate) {
                    console.warn('⚠️ 잘못된 날짜 데이터:', item);
                    return false;
                }
                
                // 직접 문자열에서 YYYY-MM 추출 (Date 객체 사용 안함)
                const itemMonth = item.transactionDate.substring(0, 7);
                const isCorrectMonth = itemMonth === month;
                // 숙소 ID 매칭 - 문자열과 숫자 모두 처리
                const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                const isInvestorAccommodation = investorAccommodationIds.some(id => 
                    id == itemAccId || parseInt(id) == itemAccId
                );
                
                // 모든 항목에 대해 자세한 디버깅 출력
                console.log(`📊 데이터 체크: 날짜=${item.transactionDate}, 추출월=${itemMonth}, 선택월=${month}, 월일치=${isCorrectMonth}`);
                console.log(`  숙소ID=${item.accommodationId}, 투자자숙소=${isInvestorAccommodation}, 최종=${isCorrectMonth && isInvestorAccommodation}`);
                
                return isCorrectMonth && isInvestorAccommodation;
            });
            
            console.log('🎯 === 필터링 결과 ===');
            console.log('필터링된 데이터 수:', monthData.length + '건');
            if (monthData.length > 0) {
                console.log('📋 필터링된 데이터 상세:');
                monthData.forEach((item, index) => {
                    const itemDate = new Date(item.transactionDate);
                    const itemMonth = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                    console.log(`  ${index + 1}. ${item.transactionDate} (${itemMonth}) - ${getCategoryText(item.type, item.category)} - ${item.amount} THB`);
                });
            } else {
                console.log('❌ 조건에 맞는 데이터가 없습니다!');
                console.log('디버깅 정보:');
                console.log('- 선택된 월:', month);
                console.log('- 투자자 숙소 IDs:', investorAccommodationIds);
                console.log('- 전체 데이터 수:', accountingData.length);
            }

            // KPI 계산
            const incomeItems = monthData.filter(item => item.type === 'income');
            const expenseItems = monthData.filter(item => item.type === 'expense');
            
            const totalRevenue = incomeItems.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = expenseItems.reduce((sum, item) => sum + item.amount, 0);
            const netProfit = totalRevenue - totalExpense;
            const investorDividend = Math.round(netProfit * ((investor.investorRatio || 70) / 100));

            console.log('💰 KPI 계산 결과:');
            console.log('- 수입 항목:', incomeItems.length + '건');
            console.log('- 지출 항목:', expenseItems.length + '건');
            console.log('- 총 수익:', totalRevenue.toLocaleString() + ' THB');
            console.log('- 총 지출:', totalExpense.toLocaleString() + ' THB');
            console.log('- 순수익:', netProfit.toLocaleString() + ' THB');
            console.log('- 투자자 배당:', investorDividend.toLocaleString() + ' THB');

            // KPI 카드 업데이트 (THB 단위 포함)
            console.log('📊 KPI 카드 업데이트 시작');
            
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalExpenseEl = document.getElementById('totalExpense');
            const netProfitEl = document.getElementById('netProfit');
            const investorDividendEl = document.getElementById('investorDividend');
            
            console.log('DOM 요소 확인:');
            console.log('- totalRevenue 요소:', totalRevenueEl);
            console.log('- totalExpense 요소:', totalExpenseEl);
            console.log('- netProfit 요소:', netProfitEl);
            console.log('- investorDividend 요소:', investorDividendEl);
            
            if (totalRevenueEl) {
                totalRevenueEl.textContent = `${totalRevenue.toLocaleString()} THB`;
                console.log('✅ totalRevenue 업데이트:', totalRevenueEl.textContent);
            }
            
            if (totalExpenseEl) {
                totalExpenseEl.textContent = `${totalExpense.toLocaleString()} THB`;
                console.log('✅ totalExpense 업데이트:', totalExpenseEl.textContent);
            }
            
            if (netProfitEl) {
                netProfitEl.textContent = `${netProfit.toLocaleString()} THB`;
                console.log('✅ netProfit 업데이트:', netProfitEl.textContent);
            }
            
            if (investorDividendEl) {
                investorDividendEl.textContent = `${investorDividend.toLocaleString()} THB`;
                console.log('✅ investorDividend 업데이트:', investorDividendEl.textContent);
            }

            // 테이블 업데이트
            const tbody = document.getElementById('revenueTableBody');
            tbody.innerHTML = '';

            monthData.sort((a, b) => new Date(a.transactionDate) - new Date(b.transactionDate));

            monthData.forEach(item => {
                const amount = item.amount || 0;
                const isIncome = item.type === 'income';
                
                // 숙소 이름 매핑 - accommodationName이 없으면 ID로 찾기
                let accommodationName = item.accommodationName;
                if (!accommodationName || accommodationName === 'undefined') {
                    const accommodation = accommodations.find(acc => acc.id === item.accommodationId);
                    accommodationName = accommodation ? accommodation.name : `숙소 ID ${item.accommodationId}`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${formatDate(item.transactionDate)}</td>
                    <td class="px-4 py-3 text-sm">${accommodationName}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            item.type === 'income' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            ${item.type === 'income' ? '수익' : '비용'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${getCategoryText(item.type, item.category) || item.category || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.description || '-'}</td>
                    <td class="px-4 py-3 text-sm text-right font-semibold ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${item.type === 'income' ? '+' : '-'}${amount.toLocaleString()} THB
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 정산 계산
        function calculateSettlement(investor, month) {
            console.log('📊 정산 계산 시작:', investor.name, month);
            
            // 투자자의 숙소 ID 배열
            const investorAccommodationIds = investor.accommodations || [];
            console.log('투자자 숙소 IDs:', investorAccommodationIds);
            
            // 해당 월 데이터 필터링 (transactionDate 사용)
            const monthData = accountingData.filter(item => {
                // transactionDate 필드 사용
                if (!item.transactionDate) {
                    console.warn('⚠️ 정산 계산에서 잘못된 날짜 데이터:', item);
                    return false;
                }
                
                // 직접 문자열에서 YYYY-MM 추출 (Date 객체 사용 안함)
                const itemMonth = item.transactionDate.substring(0, 7);
                const isCorrectMonth = itemMonth === month;
                // 숙소 ID 매칭 - 문자열과 숫자 모두 처리
                const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                const isInvestorAccommodation = investorAccommodationIds.some(id => 
                    id == itemAccId || parseInt(id) == itemAccId
                );
                
                console.log(`💰 정산필터: 날짜=${item.transactionDate}, 추출월=${itemMonth}, 선택월=${month}, 월일치=${isCorrectMonth}`);
                console.log(`   숙소ID=${item.accommodationId}, 투자자숙소일치=${isInvestorAccommodation}, 최종=${isCorrectMonth && isInvestorAccommodation}`);
                
                return isCorrectMonth && isInvestorAccommodation;
            });
            
            console.log('해당 월 데이터:', monthData);

            // 수입과 지출 계산
            const totalRevenue = monthData.filter(item => item.type === 'income').reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = monthData.filter(item => item.type === 'expense').reduce((sum, item) => sum + item.amount, 0);
            const netProfit = totalRevenue - totalExpense;

            console.log('총 수익:', totalRevenue, '총 지출:', totalExpense, '순수익:', netProfit);

            const investorShare = Math.round(netProfit * ((investor.investorRatio || 70) / 100));
            const companyShare = netProfit - investorShare;

            // 정산 계산서 업데이트 (THB 단위 포함)
            console.log('📊 정산 계산서 업데이트 시작');
            
            const calcElements = {
                calc_totalRevenue: document.getElementById('calc_totalRevenue'),
                calc_totalExpense: document.getElementById('calc_totalExpense'),
                calc_netProfit: document.getElementById('calc_netProfit'),
                calc_investorRatio: document.getElementById('calc_investorRatio'),
                calc_companyRatio: document.getElementById('calc_companyRatio'),
                calc_investorShare: document.getElementById('calc_investorShare'),
                calc_companyShare: document.getElementById('calc_companyShare'),
                calc_finalDividend: document.getElementById('calc_finalDividend'),
                finalSettlementAmount: document.getElementById('finalSettlementAmount')
            };
            
            console.log('정산 계산서 DOM 요소 확인:', calcElements);
            
            // 각 요소를 안전하게 업데이트
            if (calcElements.calc_totalRevenue) calcElements.calc_totalRevenue.textContent = `${totalRevenue.toLocaleString()} THB`;
            if (calcElements.calc_totalExpense) calcElements.calc_totalExpense.textContent = `${totalExpense.toLocaleString()} THB`;
            if (calcElements.calc_netProfit) calcElements.calc_netProfit.textContent = `${netProfit.toLocaleString()} THB`;
            if (calcElements.calc_investorRatio) calcElements.calc_investorRatio.textContent = investor.investorRatio + '%';
            if (calcElements.calc_companyRatio) calcElements.calc_companyRatio.textContent = investor.companyRatio + '%';
            if (calcElements.calc_investorShare) calcElements.calc_investorShare.textContent = `${investorShare.toLocaleString()} THB`;
            if (calcElements.calc_companyShare) calcElements.calc_companyShare.textContent = `${companyShare.toLocaleString()} THB`;
            if (calcElements.calc_finalDividend) calcElements.calc_finalDividend.textContent = `${investorShare.toLocaleString()} THB`;
            if (calcElements.finalSettlementAmount) calcElements.finalSettlementAmount.textContent = `${investorShare.toLocaleString()} THB`;
            
            console.log('✅ 정산 계산서 업데이트 완료');
            console.log('- 총수익:', totalRevenue.toLocaleString(), 'THB');
            console.log('- 총지출:', totalExpense.toLocaleString(), 'THB');
            console.log('- 순수익:', netProfit.toLocaleString(), 'THB');
            console.log('- 투자자 배당:', investorShare.toLocaleString(), 'THB');

            // 색상 적용
            const profitElements = [
                document.getElementById('calc_netProfit'),
                document.getElementById('calc_finalDividend'),
                document.getElementById('finalSettlementAmount')
            ];
            
            profitElements.forEach(element => {
                element.className = element.className.replace(/text-\w+-\d+/g, '');
                element.classList.add(netProfit >= 0 ? 'text-green-600' : 'text-red-600');
            });
        }

        // 리포트 날짜 업데이트
        function updateReportDate() {
            const now = new Date();
            const reportNumber = `RPT-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*1000).toString().padStart(3,'0')}`;
            
            document.getElementById('reportDate').textContent = now.toLocaleDateString('ko-KR');
            document.getElementById('reportNumber').textContent = reportNumber;
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        // 조회 버튼 클릭 시 실행되는 함수
        function performSettlementSearch() {
            console.log('🔍 정산 조회 시작...');
            
            const selectedInvestor = document.getElementById('investorFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            
            console.log('선택된 투자자:', selectedInvestor);
            console.log('선택된 월:', selectedMonth);
            console.log('현재 데이터 상태:');
            console.log('- 투자자:', investors.length + '명');
            console.log('- 숙소:', accommodations.length + '개');
            console.log('- 회계 데이터:', accountingData.length + '건');
            
            if (!selectedInvestor) {
                alert('투자자를 선택해주세요.');
                return;
            }
            
            if (!selectedMonth) {
                alert('정산 월을 선택해주세요.');
                return;
            }
            
            if (investors.length === 0) {
                alert('투자자 데이터가 없습니다. 투자자 관리에서 먼저 투자자를 등록해주세요.');
                return;
            }
            
            if (accountingData.length === 0) {
                alert('회계 데이터가 없습니다. 수익 관리에서 먼저 수입/지출 데이터를 입력해주세요.');
                return;
            }
            
            console.log('📊 updateReport 함수 실행 중...');
            
            // updateReport 함수 실행하여 하단에 정산 리포트 표시
            updateReport();
            
            console.log('✅ 정산 조회 완료');
        }

        // 리포트 생성 기능
        function generateInvestorReport() {
            const selectedInvestor = document.getElementById('investorFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            
            if (!selectedInvestor) {
                alert('투자자를 선택해주세요.');
                return;
            }
            
            if (!selectedMonth) {
                alert('정산 월을 선택해주세요.');
                return;
            }
            
            // 새 창에서 리포트 페이지 열기 (URL 파라미터로 정확한 데이터 전달)
            console.log('📊 리포트 생성 요청:');
            console.log('- 선택된 투자자 ID:', selectedInvestor);
            console.log('- 선택된 월:', selectedMonth);
            
            const reportUrl = `investor-report.html?investor=${encodeURIComponent(selectedInvestor)}&month=${encodeURIComponent(selectedMonth)}`;
            console.log('🔗 생성된 URL:', reportUrl);
            
            window.open(reportUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // 오류 처리 및 데이터 검증 함수
        function validateReportData(investor, month) {
            if (!investor) {
                alert('선택된 투자자 정보를 찾을 수 없습니다.');
                return false;
            }
            
            if (!month) {
                alert('정산 월을 선택해주세요.');
                return false;
            }
            
            if (!investor.accommodations || investor.accommodations.length === 0) {
                alert('해당 투자자의 보유 숙소 정보가 없습니다.');
                return false;
            }
            
            return true;
        }

        // THB 통화 포맷팅 유틸리티 함수
        function formatTHB(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '0 THB';
            }
            return `${Math.round(amount).toLocaleString()} THB`;
        }

        // 일관성을 위한 formatMoney 별칭 함수
        function formatMoney(amount) {
            return formatTHB(amount);
        }
    </script>
</body>
</html>