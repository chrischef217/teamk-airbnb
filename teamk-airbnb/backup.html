<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 백업 - Teamk 공유숙박 관리 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        .backup-card {
            transition: all 0.2s ease-in-out;
        }
        .backup-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="systemTitle">
                    Teamk 공유숙박 관리 시스템
                </h1>
            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='index.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> <span data-translate="dashboard">대시보드</span>
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> <span data-translate="accommodations">숙소 관리</span>
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> <span data-translate="reservations">예약 관리</span>
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-chart-bar mr-1"></i> <span data-translate="analytics">지표 관리</span>
                    </button>
                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> <span data-translate="accounting">수익 관리</span>
                    </button>
                    <button onclick="window.location.href='investor.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-users mr-1"></i> <span data-translate="investors">투자자 관리</span>
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calculator mr-1"></i> <span data-translate="settlement">투자자 정산</span>
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-download mr-1"></i> <span data-translate="backup">백업</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 페이지 헤더 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                        <span data-translate="backupManagement">데이터 백업 & 복원</span>
                    </h2>
                    <p class="text-gray-600" data-translate="backupManagementSubtitle">전체 시스템 데이터를 안전하게 백업하고 복원합니다</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-xs text-gray-500" data-translate="systemStatus">시스템 상태</div>
                        <div class="text-sm font-semibold text-green-600" data-translate="normal">정상</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 백업 현황 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- 마지막 백업 정보 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-history text-blue-600 mr-2"></i>
                    마지막 백업 현황
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">다운로드 일시:</span>
                        <span id="lastDownloadTime" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">업로드 일시:</span>
                        <span id="lastUploadTime" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">백업 파일:</span>
                        <span class="font-medium text-blue-600">Teamk_백업_데이터.xlsx</span>
                    </div>
                </div>
            </div>

            <!-- 데이터 통계 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-database text-green-600 mr-2"></i>
                    현재 데이터 현황
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">숙소:</span>
                        <span id="accommodationCount" class="font-medium">0개</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">예약:</span>
                        <span id="reservationCount" class="font-medium">0개</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">회계:</span>
                        <span id="accountingCount" class="font-medium">0개</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">투자자:</span>
                        <span id="investorCount" class="font-medium">0개</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 백업 다운로드 섹션 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-download text-green-600 mr-2"></i>
                데이터 백업 다운로드
            </h3>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-green-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-green-800">안전한 백업을 위한 중요 사항</h4>
                        <ul class="text-sm text-green-700 mt-2 space-y-1">
                            <li>• 모든 테이블 데이터가 하나의 엑셀 파일로 다운로드됩니다</li>
                            <li>• 각 테이블은 별도의 워크시트로 구성됩니다</li>
                            <li>• 파일명: Teamk_백업_데이터_YYYYMMDD_HHMMSS.xlsx</li>
                            <li>• 다운로드 후 안전한 위치에 보관하시기 바랍니다</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="downloadBackup()" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    전체 데이터 백업 다운로드
                </button>
                <div class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-clock mr-1"></i>
                    예상 소요시간: 5-10초
                </div>
            </div>
        </div>

        <!-- 백업 복원 섹션 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-upload text-orange-600 mr-2"></i>
                데이터 백업 복원
            </h3>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-red-800">⚠️ 중요한 경고사항</h4>
                        <ul class="text-sm text-red-700 mt-2 space-y-1">
                            <li>• <strong>모든 기존 데이터가 삭제되고 업로드된 데이터로 완전히 교체됩니다</strong></li>
                            <li>• 복원 전 반드시 현재 데이터를 백업하시기 바랍니다</li>
                            <li>• 올바른 엑셀 파일 형식만 업로드해야 합니다</li>
                            <li>• 복원 과정은 되돌릴 수 없습니다</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        백업 파일 선택 (*.xlsx)
                    </label>
                    <input type="file" id="backupFile" accept=".xlsx" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="validateBackupFile()" 
                            class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        파일 검증하기
                    </button>
                    <button onclick="restoreBackup()" id="restoreBtn" disabled
                            class="flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-upload mr-2"></i>
                        데이터 복원 실행
                    </button>
                </div>
            </div>
        </div>

        <!-- 진행 상황 표시 -->
        <div id="progressSection" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-cogs text-blue-600 mr-2"></i>
                처리 진행 상황
            </h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">전체 진행률</span>
                        <span id="progressText" class="text-sm text-gray-500">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div id="progressLog" class="bg-gray-50 rounded p-3 text-sm font-mono text-gray-700 h-32 overflow-y-auto">
                    <!-- 로그 메시지가 여기에 표시됩니다 -->
                </div>
            </div>
        </div>

        <!-- 파일 검증 결과 -->
        <div id="validationResult" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                파일 검증 결과
            </h3>
            <div id="validationContent">
                <!-- 검증 결과가 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let backupData = null;
        let isValidFile = false;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            if (checkLoginStatus(false, true)) {
                initializePage();
            }
        });

        // 페이지 초기화
        async function initializePage() {
            try {
                await loadDataCounts();
                loadBackupHistory();
            } catch (error) {
                console.error('페이지 초기화 오류:', error);
                addLog('페이지 초기화 중 오류가 발생했습니다.', 'error');
            }
        }

        // 데이터 개수 로드
        async function loadDataCounts() {
            try {
                const tables = ['accommodations', 'reservations', 'accounting', 'investors'];
                const counts = {};
                
                for (const table of tables) {
                    const response = await fetch(`tables/${table}`);
                    if (response.ok) {
                        const data = await response.json();
                        counts[table] = data.total || data.data?.length || 0;
                    } else {
                        counts[table] = 0;
                    }
                }

                document.getElementById('accommodationCount').textContent = `${counts.accommodations}개`;
                document.getElementById('reservationCount').textContent = `${counts.reservations}개`;
                document.getElementById('accountingCount').textContent = `${counts.accounting}개`;
                document.getElementById('investorCount').textContent = `${counts.investors}개`;
            } catch (error) {
                console.error('데이터 개수 로드 오류:', error);
            }
        }

        // 백업 기록 로드
        function loadBackupHistory() {
            const lastDownload = localStorage.getItem('lastBackupDownload');
            const lastUpload = localStorage.getItem('lastBackupUpload');
            
            document.getElementById('lastDownloadTime').textContent = 
                lastDownload ? new Date(lastDownload).toLocaleString('ko-KR') : '없음';
            document.getElementById('lastUploadTime').textContent = 
                lastUpload ? new Date(lastUpload).toLocaleString('ko-KR') : '없음';
        }

        // 백업 다운로드
        async function downloadBackup() {
            showProgress();
            updateProgress(0, '백업 다운로드를 시작합니다...');

            try {
                const tables = ['accommodations', 'reservations', 'accounting', 'investors'];
                const workbook = XLSX.utils.book_new();
                let completed = 0;

                for (const tableName of tables) {
                    addLog(`${tableName} 테이블 데이터 가져오는 중...`);
                    
                    const response = await fetch(`tables/${tableName}`);
                    if (!response.ok) {
                        throw new Error(`${tableName} 테이블 로드 실패: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const data = result.data || [];
                    
                    addLog(`${tableName}: ${data.length}개 레코드 처리 중...`);
                    
                    // 데이터 정리 (시스템 필드 제외 및 배열 처리)
                    const cleanData = data.map(row => {
                        const clean = { ...row };
                        delete clean.gs_project_id;
                        delete clean.gs_table_name;
                        
                        // 배열 필드 처리 (investors 테이블의 accommodations)
                        if (tableName === 'investors' && clean.accommodations && Array.isArray(clean.accommodations)) {
                            clean.accommodations = JSON.stringify(clean.accommodations);
                        }
                        
                        return clean;
                    });
                    
                    // 워크시트 생성
                    const worksheet = XLSX.utils.json_to_sheet(cleanData);
                    XLSX.utils.book_append_sheet(workbook, worksheet, tableName);
                    
                    completed++;
                    updateProgress((completed / tables.length) * 100, 
                        `${tableName} 테이블 완료 (${completed}/${tables.length})`);
                }

                // 파일 다운로드
                addLog('엑셀 파일 생성 중...');
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[-:T]/g, '').slice(0, 14);
                const filename = `Teamk_백업_데이터_${timestamp}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                
                // 다운로드 시간 기록
                localStorage.setItem('lastBackupDownload', now.toISOString());
                loadBackupHistory();
                
                addLog(`✅ 백업 완료: ${filename}`, 'success');
                updateProgress(100, '백업 다운로드가 완료되었습니다!');
                
                setTimeout(() => {
                    hideProgress();
                }, 2000);
                
            } catch (error) {
                console.error('백업 다운로드 오류:', error);
                addLog(`❌ 오류: ${error.message}`, 'error');
                updateProgress(0, '백업 다운로드에 실패했습니다.');
            }
        }

        // 파일 검증
        function validateBackupFile() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('파일을 선택해주세요.');
                return;
            }
            
            if (!file.name.endsWith('.xlsx')) {
                alert('엑셀 파일(.xlsx)만 업로드 가능합니다.');
                return;
            }
            
            showProgress();
            updateProgress(0, '파일 검증을 시작합니다...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    validateWorkbook(workbook);
                    
                } catch (error) {
                    console.error('파일 검증 오류:', error);
                    addLog(`❌ 파일 검증 실패: ${error.message}`, 'error');
                    showValidationResult(false, '파일 형식이 올바르지 않습니다.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 워크북 검증
        function validateWorkbook(workbook) {
            const requiredSheets = ['accommodations', 'reservations', 'accounting', 'investors'];
            const validationResult = {
                isValid: true,
                details: []
            };
            
            addLog('워크시트 구조 검증 중...');
            
            // 필수 시트 및 데이터 구조 확인
            const expectedFields = {
                accommodations: ['accommodationName', 'buildingName', 'address', 'roomType', 'capacity'],
                reservations: ['accommodationName', 'guestName', 'checkinDate', 'checkoutDate', 'totalAmount'], 
                accounting: ['accommodationName', 'date', 'description', 'incomeAmount', 'expenseAmount'],
                investors: ['name', 'phone', 'email', 'investorRatio', 'accommodations']
            };
            
            for (const sheetName of requiredSheets) {
                if (!workbook.Sheets[sheetName]) {
                    validationResult.isValid = false;
                    validationResult.details.push(`❌ 필수 워크시트 누락: ${sheetName}`);
                } else {
                    const sheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet);
                    
                    // 레코드 수 확인
                    validationResult.details.push(`✅ ${sheetName}: ${data.length}개 레코드`);
                    addLog(`${sheetName} 워크시트: ${data.length}개 레코드 확인`);
                    
                    // 필드 구조 검증
                    if (data.length > 0 && expectedFields[sheetName]) {
                        const actualFields = Object.keys(data[0]);
                        const missingFields = expectedFields[sheetName].filter(field => !actualFields.includes(field));
                        
                        if (missingFields.length > 0) {
                            validationResult.isValid = false;
                            validationResult.details.push(`❌ ${sheetName} 필수 필드 누락: ${missingFields.join(', ')}`);
                            addLog(`${sheetName} 필수 필드 누락: ${missingFields.join(', ')}`, 'error');
                        } else {
                            validationResult.details.push(`✅ ${sheetName} 필드 구조 정상`);
                        }
                    }
                }
            }
            
            if (validationResult.isValid) {
                backupData = workbook;
                isValidFile = true;
                document.getElementById('restoreBtn').disabled = false;
                addLog('✅ 파일 검증 완료 - 복원 가능', 'success');
                updateProgress(100, '파일 검증이 완료되었습니다!');
            } else {
                isValidFile = false;
                addLog('❌ 파일 검증 실패', 'error');
                updateProgress(0, '파일 검증에 실패했습니다.');
            }
            
            showValidationResult(validationResult.isValid, validationResult.details);
            
            setTimeout(() => {
                hideProgress();
            }, 1000);
        }

        // 백업 복원
        async function restoreBackup() {
            if (!isValidFile || !backupData) {
                alert('먼저 파일을 검증해주세요.');
                return;
            }
            
            const confirmed = confirm(
                '⚠️ 경고: 모든 기존 데이터가 삭제되고 업로드된 데이터로 교체됩니다.\n\n' +
                '이 작업은 되돌릴 수 없습니다. 계속하시겠습니까?'
            );
            
            if (!confirmed) return;
            
            const doubleConfirm = confirm(
                '정말로 모든 데이터를 교체하시겠습니까?\n\n' +
                '현재 데이터를 미리 백업하지 않았다면 지금 취소하고 백업부터 진행하세요.'
            );
            
            if (!doubleConfirm) return;
            
            showProgress();
            updateProgress(0, '데이터 복원을 시작합니다...');
            
            try {
                const tables = ['accommodations', 'reservations', 'accounting', 'investors'];
                let completed = 0;
                
                for (const tableName of tables) {
                    addLog(`${tableName} 테이블 복원 중...`);
                    
                    // 기존 데이터 모두 삭제
                    await clearTable(tableName);
                    
                    // 새 데이터 추가
                    const sheet = backupData.Sheets[tableName];
                    if (sheet) {
                        const data = XLSX.utils.sheet_to_json(sheet);
                        
                        if (data.length > 0) {
                            await restoreTableData(tableName, data);
                            addLog(`${tableName}: ${data.length}개 레코드 복원 완료`);
                        } else {
                            addLog(`${tableName}: 복원할 데이터가 없습니다`);
                        }
                    }
                    
                    completed++;
                    updateProgress((completed / tables.length) * 100, 
                        `${tableName} 테이블 복원 완료 (${completed}/${tables.length})`);
                }
                
                // 복원 완료
                const now = new Date();
                localStorage.setItem('lastBackupUpload', now.toISOString());
                loadBackupHistory();
                await loadDataCounts();
                
                addLog('✅ 모든 데이터 복원 완료!', 'success');
                updateProgress(100, '데이터 복원이 완료되었습니다!');
                
                setTimeout(() => {
                    hideProgress();
                    alert('데이터 복원이 완료되었습니다. 페이지를 새로고침합니다.');
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('백업 복원 오류:', error);
                addLog(`❌ 복원 실패: ${error.message}`, 'error');
                updateProgress(0, '데이터 복원에 실패했습니다.');
            }
        }

        // 테이블 데이터 모두 삭제
        async function clearTable(tableName) {
            const response = await fetch(`tables/${tableName}`);
            if (response.ok) {
                const result = await response.json();
                const records = result.data || [];
                
                for (const record of records) {
                    await fetch(`tables/${tableName}/${record.id}`, {
                        method: 'DELETE'
                    });
                }
            }
        }

        // 테이블 데이터 복원
        async function restoreTableData(tableName, data) {
            for (const record of data) {
                // id 필드 제거 (새로 생성됨)
                const cleanRecord = { ...record };
                delete cleanRecord.id;
                
                // 데이터 타입 복원 처리
                
                // 배열 필드 복원 (investors.accommodations)
                if (tableName === 'investors' && cleanRecord.accommodations && typeof cleanRecord.accommodations === 'string') {
                    try {
                        cleanRecord.accommodations = JSON.parse(cleanRecord.accommodations);
                    } catch (e) {
                        cleanRecord.accommodations = [];
                        addLog(`경고: ${record.name || 'Unknown'} 투자자의 숙소 데이터 복원 실패`, 'warning');
                    }
                }
                
                // 숫자 필드 복원 처리
                const numberFields = {
                    accommodations: ['capacity', 'area', 'monthlyRent', 'deposit', 'maintenanceFee', 'agencyFee'],
                    reservations: ['adults', 'children', 'totalAmount', 'paidAmount'],
                    accounting: ['incomeAmount', 'expenseAmount'],
                    investors: ['settlementDay', 'investorRatio', 'companyRatio']
                };
                
                if (numberFields[tableName]) {
                    for (const field of numberFields[tableName]) {
                        if (cleanRecord[field] !== undefined && cleanRecord[field] !== null) {
                            const num = parseFloat(cleanRecord[field]);
                            cleanRecord[field] = isNaN(num) ? 0 : num;
                        }
                    }
                }
                
                const response = await fetch(`tables/${tableName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cleanRecord)
                });
                
                if (!response.ok) {
                    throw new Error(`${tableName} 데이터 추가 실패: ${response.status}`);
                }
            }
        }

        // 진행 상황 표시/숨기기
        function showProgress() {
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('progressLog').innerHTML = '';
        }

        function hideProgress() {
            document.getElementById('progressSection').classList.add('hidden');
        }

        // 진행률 업데이트
        function updateProgress(percentage, message) {
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${Math.round(percentage)}%`;
            if (message) {
                addLog(message);
            }
        }

        // 로그 추가
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('progressLog');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            let icon = '';
            
            switch (type) {
                case 'success':
                    icon = '✅';
                    break;
                case 'error':
                    icon = '❌';
                    break;
                case 'warning':
                    icon = '⚠️';
                    break;
                default:
                    icon = 'ℹ️';
            }
            
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 검증 결과 표시
        function showValidationResult(isValid, details) {
            const resultDiv = document.getElementById('validationResult');
            const contentDiv = document.getElementById('validationContent');
            
            if (isValid) {
                contentDiv.innerHTML = `
                    <div class="status-success rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-green-800">파일 검증 성공</h4>
                                <p class="text-sm text-green-700 mt-1">백업 파일이 올바른 형식입니다. 데이터 복원을 진행할 수 있습니다.</p>
                                <ul class="text-sm text-green-700 mt-2 space-y-1">
                                    ${Array.isArray(details) ? details.map(detail => `<li>${detail}</li>`).join('') : `<li>${details}</li>`}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="status-error rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-times-circle text-red-600 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-red-800">파일 검증 실패</h4>
                                <p class="text-sm text-red-700 mt-1">백업 파일 형식이 올바르지 않습니다.</p>
                                <ul class="text-sm text-red-700 mt-2 space-y-1">
                                    ${Array.isArray(details) ? details.map(detail => `<li>${detail}</li>`).join('') : `<li>${details}</li>`}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>