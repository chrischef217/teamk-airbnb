<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ - ìˆ™ì†Œê´€ë¦¬</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% ì™„ì „ ì°¨ë‹¨) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        
        /* ëª¨ë‹¬ ìŠ¤í¬ë¡¤ ê°œì„  */
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë” ë‚˜ì€ ìŠ¤í¬ë¡¤ */
        @media (max-height: 700px) {
            .modal-overlay .flex.items-start {
                align-items: flex-start !important;
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .tab-button {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            .tab-button i {
                display: none;
            }
            .modal-content {
                margin: 1rem;
                max-height: 85vh;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-4 sm:mb-6">
            <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 mb-4 sm:mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800 mb-1 sm:mb-2" data-translate="systemTitle">
                        Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ
                    </h1>
                    <div class="language-selector">
                        <select id="languageSelect" onchange="changeLanguage(this.value)" class="text-sm border border-gray-300 rounded px-2 py-1">
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="en">English</option>
                            <option value="th">à¹„à¸—à¸¢</option>
                        </select>
                    </div>
                </div>

            </div>
            
            <!-- Tab Navigation - ëª¨ë°”ì¼ ìµœì í™” -->
            <div class="bg-white rounded-lg shadow-sm mb-4 sm:mb-6">
                <div class="flex flex-wrap border-b overflow-x-auto">
                    <button onclick="window.location.href='dashboard.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-tachometer-alt mr-1"></i><span class="hidden sm:inline" data-translate="dashboard">ëŒ€ì‹œë³´ë“œ</span><span class="sm:hidden" data-translate="dashboard">ëŒ€ì‹œë³´ë“œ</span>
                    </button>
                    <button class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600 whitespace-nowrap">
                        <i class="fas fa-home mr-1"></i><span class="hidden sm:inline" data-translate="accommodations">ìˆ™ì†Œ ê´€ë¦¬</span><span class="sm:hidden" data-translate="accommodations">ìˆ™ì†Œê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-calendar-check mr-1"></i><span class="hidden sm:inline" data-translate="reservations">ì˜ˆì•½ ê´€ë¦¬</span><span class="sm:hidden" data-translate="reservations">ì˜ˆì•½ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-chart-bar mr-1"></i><span class="hidden sm:inline" data-translate="analytics">ì§€í‘œ ê´€ë¦¬</span><span class="sm:hidden" data-translate="analytics">ì§€í‘œê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='accounting.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-coins mr-1"></i><span class="hidden sm:inline" data-translate="accounting">ìˆ˜ìµ ê´€ë¦¬</span><span class="sm:hidden" data-translate="accounting">ìˆ˜ìµê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='investor.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-users mr-1"></i><span class="hidden sm:inline" data-translate="investors">íˆ¬ìì ê´€ë¦¬</span><span class="sm:hidden" data-translate="investors">íˆ¬ìì</span>
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-calculator mr-1"></i><span class="hidden sm:inline" data-translate="settlement">íˆ¬ìì ì •ì‚°</span><span class="sm:hidden" data-translate="settlement">ì •ì‚°</span>
                    </button>

                    <button onclick="window.location.href='data-migration.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-database mr-1"></i><span class="hidden sm:inline">ë°ì´í„° ê´€ë¦¬</span><span class="sm:hidden">ë°ì´í„° ê´€ë¦¬</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <div class="mb-4 sm:mb-0">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-home text-blue-600 mr-2"></i>
                        <span data-translate="accommodationManagement">ìˆ™ì†Œ ê´€ë¦¬</span>
                    </h2>
                    <p class="text-sm sm:text-base text-gray-600" data-translate="accommodationManagementSubtitle">íƒœêµ­ ì—ì–´ë¹„ì•¤ë¹„ ìˆ™ì†Œ í˜„í™© ë° ìš´ì˜ ê´€ë¦¬</p>
                </div>
                <button onclick="openModal('add')" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm sm:text-base">
                    <i class="fas fa-plus mr-2"></i>
                    <span data-translate="addAccommodation">ìƒˆ ìˆ™ì†Œ ë“±ë¡</span>
                </button>
            </div>
        </div>

        <!-- ê²€ìƒ‰ -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 sm:mb-6">
            <div class="relative">
                <input type="text" id="searchInput" data-translate-placeholder="searchAccommodation" placeholder="ìˆ™ì†Œëª… ê²€ìƒ‰..." 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm sm:text-base"
                       onkeyup="searchAccommodations()">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
        </div>

        <!-- ìˆ™ì†Œ ë¦¬ìŠ¤íŠ¸ -->
        <div class="bg-white rounded-lg shadow-sm mb-4 sm:mb-6">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">ìˆ™ì†Œ ëª©ë¡</h3>
            </div>
            <div id="accommodationList" class="divide-y divide-gray-200">
                <!-- ìˆ™ì†Œ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>


    </div>

    <!-- ìˆ™ì†Œ ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="accommodationModal" class="fixed inset-0 z-50 hidden modal-overlay overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col modal-content">
                <div class="flex justify-between items-center p-4 sm:p-6 border-b flex-shrink-0">
                    <h3 id="modalTitle" class="text-lg sm:text-xl font-semibold text-gray-800">ìˆ™ì†Œ ì •ë³´</h3>
                    <div class="flex items-center gap-2">
                        <button id="editButton" onclick="toggleEditMode()" class="text-blue-600 hover:text-blue-800 text-sm sm:text-base">
                            <i class="fas fa-edit mr-1"></i>
                            <span id="editButtonText">ìˆ˜ì •</span>
                        </button>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-lg sm:text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <form id="accommodationForm" class="p-4 sm:p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œëª… *</label>
                            <input type="text" id="accommodationName" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê±´ë¬¼ëª…</label>
                            <input type="text" id="buildingName"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì£¼ì†Œ</label>
                        <textarea id="address" rows="2"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base"></textarea>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì¸µìˆ˜</label>
                            <input type="number" id="floor"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë°©ë²ˆí˜¸</label>
                            <input type="text" id="roomNumber"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‚¤ ê°¯ìˆ˜</label>
                            <input type="number" id="keyCount"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì£¼ì°¨ë°©ë²•</label>
                        <input type="text" id="parkingMethod" placeholder="ì˜ˆ: ë¬´ë£Œì£¼ì°¨, ìœ ë£Œì£¼ì°¨(ì‹œê°„ë‹¹ 50ë°”íŠ¸), ì£¼ì°¨ë¶ˆê°€ ë“±"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-1"></i>íˆ¬ììëª…
                            </label>
                            <input type="text" id="investorName" readonly
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base bg-gray-100 cursor-not-allowed"
                                   placeholder="íˆ¬ìì ê´€ë¦¬ì—ì„œ ì„¤ì •">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì•½ì¼ì</label>
                            <input type="date" id="contractDate"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë³´ì¦ê¸ˆ (THB)</label>
                            <input type="number" id="deposit"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì›”ì„¸ (THB)</label>
                            <input type="number" id="monthlyRent"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì›”ì„¸ ì¼ì</label>
                            <input type="number" id="rentDate" min="1" max="31" placeholder="ì¼"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì—ì´ì „ì‹œ ì´ë¦„</label>
                            <input type="text" id="agencyName"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì—ì´ì „ì‹œ ì—°ë½ì²˜</label>
                            <input type="tel" id="agencyContact"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê¸°íƒ€</label>
                        <textarea id="notes" rows="3"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-external-link-alt mr-1"></i>ì›¹í˜ì´ì§€ URL
                        </label>
                        <input type="url" id="websiteUrl" placeholder="https://www.airbnb.com/rooms/..."
                               class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        <p class="text-xs text-gray-500 mt-1">ì—ì–´ë¹„ì•¤ë¹„, ë¶€í‚¹ë‹·ì»´ ë“± ìˆ™ì†Œ ì˜ˆì•½ í˜ì´ì§€ ë§í¬</p>
                    </div>

                    <div id="buttonGroup" class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" id="saveButton" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm sm:text-base">
                            <i class="fas fa-save mr-2"></i>
                            ì €ì¥
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors text-sm sm:text-base">
                            ì·¨ì†Œ
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸
        // GitHubì—ì„œ íˆ¬ìì ë°ì´í„° ë¡œë“œ
        async function loadInvestorDataFromServer() {
            return await firebaseStorage.loadInvestors();
        }

        // íˆ¬ìì ë°ì´í„° (GitHubì—ì„œ ë¡œë“œ)
        let investors = [];

        // íˆ¬ììëª…ì€ íˆ¬ìì ê´€ë¦¬ì—ì„œë§Œ ì„¤ì • ê°€ëŠ¥ (ì½ê¸° ì „ìš©)
        // populateInvestorSelect í•¨ìˆ˜ ì œê±°ë¨ - ë‹¨ë°©í–¥ ë°ì´í„° íë¦„ êµ¬í˜„

        // ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadAccommodations() {
            // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
            accommodations = await loadAccommodationsFromStorage();
            
            const user = getCurrentUser();
            let filteredAccommodations = accommodations;
            
            // íˆ¬ììì¸ ê²½ìš° ìì‹ ì˜ ìˆ™ì†Œë§Œ í•„í„°ë§
            if (user.userType === 'investor') {
                filteredAccommodations = filterDataByAccess(accommodations, 'accommodationId');
            }
            
            renderAccommodationList(filteredAccommodations);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”„ ìˆ™ì†Œ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
            if (!firebaseStorage.isConfigured()) {
                console.warn('âš ï¸ Firebase ì„¤ì •ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                
                const goToFirebase = confirm(`
ğŸ”¥ Firebase ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤!

PCì™€ ëª¨ë°”ì¼ ê°„ ë°ì´í„° ë™ê¸°í™”ë¥¼ ìœ„í•´ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
Firebase ì—°ë™ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                `);
                
                if (goToFirebase) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
            }

            if (checkLoginStatus()) {
                initializePagePermissions(); // ê¶Œí•œë³„ í˜ì´ì§€ ì„¤ì •
                
                try {
                    console.log('ğŸ“¡ Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                    investors = await firebaseStorage.loadInvestors();
                    accommodations = await loadAccommodationsFromServer();
                    console.log('âœ… íˆ¬ìì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', investors.length + 'ëª…');
                    console.log('âœ… ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accommodations.length + 'ê°œ');
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    
                    // Firebase ì—°ê²° ì‹¤íŒ¨ì‹œ localStorage í´ë°± ì‹œë„
                    try {
                        console.log('ğŸ”„ localStorage í´ë°± ì‹œë„...');
                        const localInvestors = localStorage.getItem('investorData');
                        const localAccommodations = localStorage.getItem('accommodationData');
                        
                        investors = localInvestors ? JSON.parse(localInvestors) : [];
                        accommodations = localAccommodations ? JSON.parse(localAccommodations) : [];
                        
                        console.log('âœ… localStorageì—ì„œ ë°ì´í„° ë¡œë“œ:', accommodations.length + 'ê°œ ìˆ™ì†Œ');
                    } catch (fallbackError) {
                        console.error('âŒ localStorage í´ë°±ë„ ì‹¤íŒ¨:', fallbackError);
                        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase ì—°ë™ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    }
                }
                
                // íˆ¬ìì ì½¤ë³´ë°•ìŠ¤ ì´ˆê¸°í™” ì œê±°ë¨ - ì½ê¸° ì „ìš© í•„ë“œë¡œ ë³€ê²½
                renderAccommodationList(); // ìˆ™ì†Œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                
                console.log('ğŸ‰ ìˆ™ì†Œ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        });

        // ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (Firebase)
        async function loadAccommodationsFromStorage() {
            try {
                return await firebaseStorage.loadAccommodations();
            } catch (error) {
                console.warn('Firebase ë¡œë“œ ì‹¤íŒ¨, localStorage ì‚¬ìš©:', error);
                const saved = localStorage.getItem('accommodationData');
                return saved ? JSON.parse(saved) : [];
            }
        }
        
        // Firebase ì €ì¥ì†Œ í•¨ìˆ˜ë“¤
        async function loadAccommodationsFromServer() {
            return await firebaseStorage.loadAccommodations();
        }

        async function saveAccommodationToServer(accommodationData) {
            console.log('ğŸ’¾ ìˆ™ì†Œ ì €ì¥ ì‹œì‘:', accommodationData.name);
            return await firebaseStorage.saveAccommodation(accommodationData);
        }

        async function updateAccommodationOnServer(id, accommodationData) {
            console.log('ğŸ”„ ìˆ™ì†Œ ìˆ˜ì • ì‹œì‘:', id);
            return await firebaseStorage.updateAccommodation(id, accommodationData);
        }

        async function deleteAccommodationFromServer(id) {
            console.log('ğŸ—‘ï¸ ìˆ™ì†Œ ì‚­ì œ ì‹œì‘:', id);
            return await firebaseStorage.deleteAccommodation(id);
        }
        
        // ìˆ™ì†Œ ë°ì´í„° - Firebaseì—ì„œ ë¡œë“œ
        let accommodations = [];

        let currentMode = 'view'; // 'view', 'edit', 'add'
        let currentId = null;
        let isEditMode = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìˆ™ì†Œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ - ë©”ì¸ DOMContentLoadedì—ì„œ ì²˜ë¦¬ë¨

        // ìˆ™ì†Œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderAccommodationList(filteredData = accommodations) {
            const listContainer = document.getElementById('accommodationList');
            listContainer.innerHTML = '';

            // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
            if (!Array.isArray(filteredData)) {
                console.error('filteredData is not an array:', filteredData);
                filteredData = [];
            }

            filteredData.forEach(accommodation => {
                const listItem = document.createElement('div');
                listItem.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                listItem.onclick = () => openModal('view', accommodation.id);
                
                const websiteButton = accommodation.websiteUrl ? 
                    `<button onclick="event.stopPropagation(); window.open('${accommodation.websiteUrl}', '_blank')" 
                             class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors mr-2" 
                             title="ì›¹í˜ì´ì§€ ë°©ë¬¸">
                        <i class="fas fa-external-link-alt"></i>
                     </button>` : '';
                
                listItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm sm:text-base">${accommodation.accommodationName}</h4>
                            <p class="text-xs sm:text-sm text-gray-500 mt-1">${accommodation.buildingName || '-'}</p>
                        </div>
                        <div class="flex items-center">
                            ${websiteButton}
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(listItem);
            });

            if (filteredData.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-home text-gray-300 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">ë“±ë¡ëœ ìˆ™ì†Œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-gray-500 text-sm mb-4">ìƒˆë¡œìš´ ìˆ™ì†Œë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”.</p>
                        <button onclick="openModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            ìˆ™ì†Œ ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                `;
            }
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function searchAccommodations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = accommodations.filter(accommodation =>
                accommodation.accommodationName.toLowerCase().includes(searchTerm)
            );
            renderAccommodationList(filteredData);
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openModal(mode, id = null) {
            currentMode = mode;
            currentId = id;
            isEditMode = false;
            
            const modal = document.getElementById('accommodationModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('accommodationForm');
            const editButton = document.getElementById('editButton');
            const editButtonText = document.getElementById('editButtonText');
            
            if (mode === 'add') {
                title.textContent = 'ìƒˆ ìˆ™ì†Œ ë“±ë¡';
                form.reset();
                editButton.style.display = 'none';
                isEditMode = true;
            } else if (mode === 'view') {
                const accommodation = accommodations.find(a => String(a.id) === String(id));
                if (accommodation) {
                    title.textContent = 'ìˆ™ì†Œ ì •ë³´';
                    populateForm(accommodation);
                    editButton.style.display = 'block';
                    editButtonText.textContent = 'ìˆ˜ì •';
                    isEditMode = false;
                }
            }
            
            updateFormState();
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        function populateForm(accommodation) {
            document.getElementById('accommodationName').value = accommodation.accommodationName || '';
            document.getElementById('buildingName').value = accommodation.buildingName || '';
            document.getElementById('address').value = accommodation.address || '';
            document.getElementById('floor').value = accommodation.floor || '';
            document.getElementById('roomNumber').value = accommodation.roomNumber || '';
            document.getElementById('keyCount').value = accommodation.keyCount || '';
            document.getElementById('parkingMethod').value = accommodation.parkingMethod || '';
            document.getElementById('investorName').value = accommodation.investorName || '';
            document.getElementById('contractDate').value = accommodation.contractDate || '';
            document.getElementById('deposit').value = accommodation.deposit || '';
            document.getElementById('monthlyRent').value = accommodation.monthlyRent || '';
            document.getElementById('rentDate').value = accommodation.rentDate || '';
            document.getElementById('agencyName').value = accommodation.agencyName || '';
            document.getElementById('agencyContact').value = accommodation.agencyContact || '';
            document.getElementById('notes').value = accommodation.notes || '';
            document.getElementById('websiteUrl').value = accommodation.websiteUrl || '';
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            const modal = document.getElementById('accommodationModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentMode = 'view';
            currentId = null;
            isEditMode = false;
        }
        
        // ìˆ˜ì • ëª¨ë“œ í† ê¸€
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editButtonText = document.getElementById('editButtonText');
            
            if (isEditMode) {
                editButtonText.textContent = 'ì·¨ì†Œ';
            } else {
                editButtonText.textContent = 'ìˆ˜ì •';
                // ì›ë˜ ë°ì´í„°ë¡œ ë³µì›
                const accommodation = accommodations.find(a => a.id === currentId);
                if (accommodation) {
                    populateForm(accommodation);
                }
            }
            
            updateFormState();
        }
        
        // í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateFormState() {
            const form = document.getElementById('accommodationForm');
            const formElements = form.querySelectorAll('input, textarea');
            const saveButton = document.getElementById('saveButton');
            
            const isReadOnly = currentMode === 'view' && !isEditMode;
            
            formElements.forEach(element => {
                element.readOnly = isReadOnly;
                if (isReadOnly) {
                    element.classList.add('bg-gray-50');
                } else {
                    element.classList.remove('bg-gray-50');
                }
            });
            
            // ì €ì¥ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            if (currentMode === 'add' || isEditMode) {
                saveButton.style.display = 'block';
            } else {
                saveButton.style.display = 'none';
            }
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('accommodationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (currentMode === 'view' && !isEditMode) return;
            
            const accommodationData = {
                accommodationName: document.getElementById('accommodationName').value,
                buildingName: document.getElementById('buildingName').value,
                address: document.getElementById('address').value,
                floor: parseInt(document.getElementById('floor').value) || null,
                roomNumber: document.getElementById('roomNumber').value,
                keyCount: parseInt(document.getElementById('keyCount').value) || null,
                parkingMethod: document.getElementById('parkingMethod').value,
                investorName: document.getElementById('investorName').value,
                contractDate: document.getElementById('contractDate').value,
                deposit: parseInt(document.getElementById('deposit').value) || null,
                monthlyRent: parseInt(document.getElementById('monthlyRent').value) || null,
                rentDate: parseInt(document.getElementById('rentDate').value) || null,
                agencyName: document.getElementById('agencyName').value,
                agencyContact: document.getElementById('agencyContact').value,
                notes: document.getElementById('notes').value,
                websiteUrl: document.getElementById('websiteUrl').value
            };
            
            if (currentMode === 'add') {
                // ìƒˆ ìˆ™ì†Œ ì¶”ê°€ (Firebase ì €ì¥)
                try {
                    console.log('ğŸš€ Firebaseì— ìƒˆ ìˆ™ì†Œ ì¶”ê°€ ì¤‘...');
                    const savedAccommodation = await saveAccommodationToServer(accommodationData);
                    console.log('âœ… Firebase ì €ì¥ ì„±ê³µ:', savedAccommodation);
                    
                    accommodations.push(savedAccommodation);
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('accommodationData', JSON.stringify(accommodations));
                    console.log('ğŸ’¾ localStorageì—ë„ ì €ì¥ ì™„ë£Œ:', accommodations.length + 'ê°œ ìˆ™ì†Œ');
                    
                    alert('âœ… ìˆ™ì†Œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                } catch (error) {
                    console.error('âŒ ìˆ™ì†Œ ì¶”ê°€ ì‹¤íŒ¨:', error);
                    alert('ìˆ™ì†Œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            } else if (isEditMode) {
                // ê¸°ì¡´ ìˆ™ì†Œ ìˆ˜ì • (Firebase ì €ì¥)
                try {
                    console.log('ğŸ”„ Firebaseì—ì„œ ìˆ™ì†Œ ìˆ˜ì • ì¤‘, ID:', currentId);
                    
                    const updatedAccommodation = await updateAccommodationOnServer(currentId, accommodationData);
                    console.log('âœ… Firebase ìˆ˜ì • ì„±ê³µ:', updatedAccommodation);
                    
                    const index = accommodations.findIndex(a => String(a.id) === String(currentId));
                    if (index !== -1) {
                        accommodations[index] = updatedAccommodation;
                    }
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('accommodationData', JSON.stringify(accommodations));
                    console.log('ğŸ’¾ localStorageì—ë„ ìˆ˜ì • ì €ì¥ ì™„ë£Œ:', accommodations.length + 'ê°œ ìˆ™ì†Œ');
                    
                    alert('âœ… ìˆ™ì†Œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                } catch (error) {
                    console.error('âŒ ìˆ™ì†Œ ìˆ˜ì • ì‹¤íŒ¨:', error);
                    alert('ìˆ™ì†Œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
                
                // ìˆ˜ì • ë§ˆì³¤ í›„ ì½ê¸° ëª¨ë“œë¡œ ì „í™˜
                isEditMode = false;
                document.getElementById('editButtonText').textContent = 'ìˆ˜ì •';
                updateFormState();
            }
            
            renderAccommodationList();
            
            if (currentMode === 'add') {
                closeModal();
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('accommodationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });


    </script>
</body>
</html>