<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamk 공유숙박 관리 시스템 - 숙소관리</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% 완전 차단) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        
        /* 모달 스크롤 개선 */
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
        
        /* 모바일에서 더 나은 스크롤 */
        @media (max-height: 700px) {
            .modal-overlay .flex.items-start {
                align-items: flex-start !important;
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .tab-button {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            .tab-button i {
                display: none;
            }
            .modal-content {
                margin: 1rem;
                max-height: 85vh;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-4 sm:mb-6">
            <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 mb-4 sm:mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800 mb-1 sm:mb-2" data-translate="systemTitle">
                        Teamk 공유숙박 관리 시스템
                    </h1>
                    <div class="language-selector">
                        <select id="languageSelect" onchange="changeLanguage(this.value)" class="text-sm border border-gray-300 rounded px-2 py-1">
                            <option value="ko">한국어</option>
                            <option value="en">English</option>
                            <option value="th">ไทย</option>
                        </select>
                    </div>
                </div>

            </div>
            
            <!-- Tab Navigation - 모바일 최적화 -->
            <div class="bg-white rounded-lg shadow-sm mb-4 sm:mb-6">
                <div class="flex flex-wrap border-b overflow-x-auto">
                    <button onclick="window.location.href='dashboard.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-tachometer-alt mr-1"></i><span class="hidden sm:inline" data-translate="dashboard">대시보드</span><span class="sm:hidden" data-translate="dashboard">대시보드</span>
                    </button>
                    <button class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600 whitespace-nowrap">
                        <i class="fas fa-home mr-1"></i><span class="hidden sm:inline" data-translate="accommodations">숙소 관리</span><span class="sm:hidden" data-translate="accommodations">숙소관리</span>
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-calendar-check mr-1"></i><span class="hidden sm:inline" data-translate="reservations">예약 관리</span><span class="sm:hidden" data-translate="reservations">예약관리</span>
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-chart-bar mr-1"></i><span class="hidden sm:inline" data-translate="analytics">지표 관리</span><span class="sm:hidden" data-translate="analytics">지표관리</span>
                    </button>
                    <button onclick="window.location.href='accounting.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-coins mr-1"></i><span class="hidden sm:inline" data-translate="accounting">수익 관리</span><span class="sm:hidden" data-translate="accounting">수익관리</span>
                    </button>
                    <button onclick="window.location.href='investor.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-users mr-1"></i><span class="hidden sm:inline" data-translate="investors">투자자 관리</span><span class="sm:hidden" data-translate="investors">투자자</span>
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-calculator mr-1"></i><span class="hidden sm:inline" data-translate="settlement">투자자 정산</span><span class="sm:hidden" data-translate="settlement">정산</span>
                    </button>

                    <button onclick="window.location.href='data-migration.html'" class="tab-button px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-database mr-1"></i><span class="hidden sm:inline">데이터 관리</span><span class="sm:hidden">데이터 관리</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 페이지 헤더 -->
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <div class="mb-4 sm:mb-0">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-home text-blue-600 mr-2"></i>
                        <span data-translate="accommodationManagement">숙소 관리</span>
                    </h2>
                    <p class="text-sm sm:text-base text-gray-600" data-translate="accommodationManagementSubtitle">태국 에어비앤비 숙소 현황 및 운영 관리</p>
                </div>
                <button onclick="openModal('add')" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm sm:text-base">
                    <i class="fas fa-plus mr-2"></i>
                    <span data-translate="addAccommodation">새 숙소 등록</span>
                </button>
            </div>
        </div>

        <!-- 검색 -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 sm:mb-6">
            <div class="relative">
                <input type="text" id="searchInput" data-translate-placeholder="searchAccommodation" placeholder="숙소명 검색..." 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 text-sm sm:text-base"
                       onkeyup="searchAccommodations()">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
        </div>

        <!-- 숙소 리스트 -->
        <div class="bg-white rounded-lg shadow-sm mb-4 sm:mb-6">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">숙소 목록</h3>
            </div>
            <div id="accommodationList" class="divide-y divide-gray-200">
                <!-- 숙소 리스트가 여기에 동적으로 생성됩니다 -->
            </div>
        </div>


    </div>

    <!-- 숙소 상세/수정 모달 -->
    <div id="accommodationModal" class="fixed inset-0 z-50 hidden modal-overlay overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col modal-content">
                <div class="flex justify-between items-center p-4 sm:p-6 border-b flex-shrink-0">
                    <h3 id="modalTitle" class="text-lg sm:text-xl font-semibold text-gray-800">숙소 정보</h3>
                    <div class="flex items-center gap-2">
                        <button id="editButton" onclick="toggleEditMode()" class="text-blue-600 hover:text-blue-800 text-sm sm:text-base">
                            <i class="fas fa-edit mr-1"></i>
                            <span id="editButtonText">수정</span>
                        </button>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-lg sm:text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <form id="accommodationForm" class="p-4 sm:p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">숙소명 *</label>
                            <input type="text" id="accommodationName" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">건물명</label>
                            <input type="text" id="buildingName"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">주소</label>
                        <textarea id="address" rows="2"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base"></textarea>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">층수</label>
                            <input type="number" id="floor"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">방번호</label>
                            <input type="text" id="roomNumber"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">키 갯수</label>
                            <input type="number" id="keyCount"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">주차방법</label>
                        <input type="text" id="parkingMethod" placeholder="예: 무료주차, 유료주차(시간당 50바트), 주차불가 등"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-1"></i>투자자명
                            </label>
                            <input type="text" id="investorName" readonly
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base bg-gray-100 cursor-not-allowed"
                                   placeholder="투자자 관리에서 설정">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">계약일자</label>
                            <input type="date" id="contractDate"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">보증금 (THB)</label>
                            <input type="number" id="deposit"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">월세 (THB)</label>
                            <input type="number" id="monthlyRent"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">월세 일자</label>
                            <input type="number" id="rentDate" min="1" max="31" placeholder="일"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">에이전시 이름</label>
                            <input type="text" id="agencyName"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">에이전시 연락처</label>
                            <input type="tel" id="agencyContact"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">기타</label>
                        <textarea id="notes" rows="3"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-external-link-alt mr-1"></i>웹페이지 URL
                        </label>
                        <input type="url" id="websiteUrl" placeholder="https://www.airbnb.com/rooms/..."
                               class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base">
                        <p class="text-xs text-gray-500 mt-1">에어비앤비, 부킹닷컴 등 숙소 예약 페이지 링크</p>
                    </div>

                    <div id="buttonGroup" class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" id="saveButton" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm sm:text-base">
                            <i class="fas fa-save mr-2"></i>
                            저장
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors text-sm sm:text-base">
                            취소
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 로그인 확인
        // GitHub에서 투자자 데이터 로드
        async function loadInvestorDataFromServer() {
            return await firebaseStorage.loadInvestors();
        }

        // 투자자 데이터 (GitHub에서 로드)
        let investors = [];

        // 투자자명은 투자자 관리에서만 설정 가능 (읽기 전용)
        // populateInvestorSelect 함수 제거됨 - 단방향 데이터 흐름 구현

        // 숙소 데이터 로드 함수
        async function loadAccommodations() {
            // localStorage에서 데이터 로드
            accommodations = await loadAccommodationsFromStorage();
            
            const user = getCurrentUser();
            let filteredAccommodations = accommodations;
            
            // 투자자인 경우 자신의 숙소만 필터링
            if (user.userType === 'investor') {
                filteredAccommodations = filterDataByAccess(accommodations, 'accommodationId');
            }
            
            renderAccommodationList(filteredAccommodations);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔄 숙소 관리 페이지 초기화 시작');
            
            // Firebase 연결 상태 확인
            if (!firebaseStorage.isConfigured()) {
                console.warn('⚠️ Firebase 설정이 되지 않았습니다.');
                
                const goToFirebase = confirm(`
🔥 Firebase 연동이 필요합니다!

PC와 모바일 간 데이터 동기화를 위해 Firebase 설정이 필요합니다.
Firebase 연동 페이지로 이동하시겠습니까?
                `);
                
                if (goToFirebase) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
            }

            if (checkLoginStatus()) {
                initializePagePermissions(); // 권한별 페이지 설정
                
                try {
                    console.log('📡 Firebase에서 데이터 로드 시작...');
                    investors = await firebaseStorage.loadInvestors();
                    accommodations = await loadAccommodationsFromServer();
                    console.log('✅ 투자자 데이터 로드 완료:', investors.length + '명');
                    console.log('✅ 숙소 데이터 로드 완료:', accommodations.length + '개');
                } catch (error) {
                    console.error('❌ 데이터 로드 실패:', error);
                    
                    // Firebase 연결 실패시 localStorage 폴백 시도
                    try {
                        console.log('🔄 localStorage 폴백 시도...');
                        const localInvestors = localStorage.getItem('investorData');
                        const localAccommodations = localStorage.getItem('accommodationData');
                        
                        investors = localInvestors ? JSON.parse(localInvestors) : [];
                        accommodations = localAccommodations ? JSON.parse(localAccommodations) : [];
                        
                        console.log('✅ localStorage에서 데이터 로드:', accommodations.length + '개 숙소');
                    } catch (fallbackError) {
                        console.error('❌ localStorage 폴백도 실패:', fallbackError);
                        alert('데이터를 불러올 수 없습니다. Firebase 연동을 먼저 설정해주세요.');
                    }
                }
                
                // 투자자 콤보박스 초기화 제거됨 - 읽기 전용 필드로 변경
                renderAccommodationList(); // 숙소 리스트 렌더링
                
                console.log('🎉 숙소 관리 페이지 초기화 완료');
            }
        });

        // 숙소 데이터 로드 함수 (Firebase)
        async function loadAccommodationsFromStorage() {
            try {
                return await firebaseStorage.loadAccommodations();
            } catch (error) {
                console.warn('Firebase 로드 실패, localStorage 사용:', error);
                const saved = localStorage.getItem('accommodationData');
                return saved ? JSON.parse(saved) : [];
            }
        }
        
        // Firebase 저장소 함수들
        async function loadAccommodationsFromServer() {
            return await firebaseStorage.loadAccommodations();
        }

        async function saveAccommodationToServer(accommodationData) {
            console.log('💾 숙소 저장 시작:', accommodationData.name);
            return await firebaseStorage.saveAccommodation(accommodationData);
        }

        async function updateAccommodationOnServer(id, accommodationData) {
            console.log('🔄 숙소 수정 시작:', id);
            return await firebaseStorage.updateAccommodation(id, accommodationData);
        }

        async function deleteAccommodationFromServer(id) {
            console.log('🗑️ 숙소 삭제 시작:', id);
            return await firebaseStorage.deleteAccommodation(id);
        }
        
        // 숙소 데이터 - Firebase에서 로드
        let accommodations = [];

        let currentMode = 'view'; // 'view', 'edit', 'add'
        let currentId = null;
        let isEditMode = false;

        // 페이지 로드 시 숙소 리스트 렌더링 - 메인 DOMContentLoaded에서 처리됨

        // 숙소 리스트 렌더링
        function renderAccommodationList(filteredData = accommodations) {
            const listContainer = document.getElementById('accommodationList');
            listContainer.innerHTML = '';

            // 데이터가 배열인지 확인
            if (!Array.isArray(filteredData)) {
                console.error('filteredData is not an array:', filteredData);
                filteredData = [];
            }

            filteredData.forEach(accommodation => {
                const listItem = document.createElement('div');
                listItem.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                listItem.onclick = () => openModal('view', accommodation.id);
                
                const websiteButton = accommodation.websiteUrl ? 
                    `<button onclick="event.stopPropagation(); window.open('${accommodation.websiteUrl}', '_blank')" 
                             class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors mr-2" 
                             title="웹페이지 방문">
                        <i class="fas fa-external-link-alt"></i>
                     </button>` : '';
                
                listItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm sm:text-base">${accommodation.accommodationName}</h4>
                            <p class="text-xs sm:text-sm text-gray-500 mt-1">${accommodation.buildingName || '-'}</p>
                        </div>
                        <div class="flex items-center">
                            ${websiteButton}
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(listItem);
            });

            if (filteredData.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-home text-gray-300 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">등록된 숙소가 없습니다</h3>
                        <p class="text-gray-500 text-sm mb-4">새로운 숙소를 등록해보세요.</p>
                        <button onclick="openModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            숙소 등록하기
                        </button>
                    </div>
                `;
            }
        }

        // 검색 기능
        function searchAccommodations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = accommodations.filter(accommodation =>
                accommodation.accommodationName.toLowerCase().includes(searchTerm)
            );
            renderAccommodationList(filteredData);
        }

        // 모달 열기
        function openModal(mode, id = null) {
            currentMode = mode;
            currentId = id;
            isEditMode = false;
            
            const modal = document.getElementById('accommodationModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('accommodationForm');
            const editButton = document.getElementById('editButton');
            const editButtonText = document.getElementById('editButtonText');
            
            if (mode === 'add') {
                title.textContent = '새 숙소 등록';
                form.reset();
                editButton.style.display = 'none';
                isEditMode = true;
            } else if (mode === 'view') {
                const accommodation = accommodations.find(a => String(a.id) === String(id));
                if (accommodation) {
                    title.textContent = '숙소 정보';
                    populateForm(accommodation);
                    editButton.style.display = 'block';
                    editButtonText.textContent = '수정';
                    isEditMode = false;
                }
            }
            
            updateFormState();
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 폼에 데이터 채우기
        function populateForm(accommodation) {
            document.getElementById('accommodationName').value = accommodation.accommodationName || '';
            document.getElementById('buildingName').value = accommodation.buildingName || '';
            document.getElementById('address').value = accommodation.address || '';
            document.getElementById('floor').value = accommodation.floor || '';
            document.getElementById('roomNumber').value = accommodation.roomNumber || '';
            document.getElementById('keyCount').value = accommodation.keyCount || '';
            document.getElementById('parkingMethod').value = accommodation.parkingMethod || '';
            document.getElementById('investorName').value = accommodation.investorName || '';
            document.getElementById('contractDate').value = accommodation.contractDate || '';
            document.getElementById('deposit').value = accommodation.deposit || '';
            document.getElementById('monthlyRent').value = accommodation.monthlyRent || '';
            document.getElementById('rentDate').value = accommodation.rentDate || '';
            document.getElementById('agencyName').value = accommodation.agencyName || '';
            document.getElementById('agencyContact').value = accommodation.agencyContact || '';
            document.getElementById('notes').value = accommodation.notes || '';
            document.getElementById('websiteUrl').value = accommodation.websiteUrl || '';
        }

        // 모달 닫기
        function closeModal() {
            const modal = document.getElementById('accommodationModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentMode = 'view';
            currentId = null;
            isEditMode = false;
        }
        
        // 수정 모드 토글
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editButtonText = document.getElementById('editButtonText');
            
            if (isEditMode) {
                editButtonText.textContent = '취소';
            } else {
                editButtonText.textContent = '수정';
                // 원래 데이터로 복원
                const accommodation = accommodations.find(a => a.id === currentId);
                if (accommodation) {
                    populateForm(accommodation);
                }
            }
            
            updateFormState();
        }
        
        // 폼 상태 업데이트
        function updateFormState() {
            const form = document.getElementById('accommodationForm');
            const formElements = form.querySelectorAll('input, textarea');
            const saveButton = document.getElementById('saveButton');
            
            const isReadOnly = currentMode === 'view' && !isEditMode;
            
            formElements.forEach(element => {
                element.readOnly = isReadOnly;
                if (isReadOnly) {
                    element.classList.add('bg-gray-50');
                } else {
                    element.classList.remove('bg-gray-50');
                }
            });
            
            // 저장 버튼 표시/숨김
            if (currentMode === 'add' || isEditMode) {
                saveButton.style.display = 'block';
            } else {
                saveButton.style.display = 'none';
            }
        }

        // 폼 제출 처리
        document.getElementById('accommodationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (currentMode === 'view' && !isEditMode) return;
            
            const accommodationData = {
                accommodationName: document.getElementById('accommodationName').value,
                buildingName: document.getElementById('buildingName').value,
                address: document.getElementById('address').value,
                floor: parseInt(document.getElementById('floor').value) || null,
                roomNumber: document.getElementById('roomNumber').value,
                keyCount: parseInt(document.getElementById('keyCount').value) || null,
                parkingMethod: document.getElementById('parkingMethod').value,
                investorName: document.getElementById('investorName').value,
                contractDate: document.getElementById('contractDate').value,
                deposit: parseInt(document.getElementById('deposit').value) || null,
                monthlyRent: parseInt(document.getElementById('monthlyRent').value) || null,
                rentDate: parseInt(document.getElementById('rentDate').value) || null,
                agencyName: document.getElementById('agencyName').value,
                agencyContact: document.getElementById('agencyContact').value,
                notes: document.getElementById('notes').value,
                websiteUrl: document.getElementById('websiteUrl').value
            };
            
            if (currentMode === 'add') {
                // 새 숙소 추가 (Firebase 저장)
                try {
                    console.log('🚀 Firebase에 새 숙소 추가 중...');
                    const savedAccommodation = await saveAccommodationToServer(accommodationData);
                    console.log('✅ Firebase 저장 성공:', savedAccommodation);
                    
                    accommodations.push(savedAccommodation);
                    
                    // localStorage에도 동시 저장
                    localStorage.setItem('accommodationData', JSON.stringify(accommodations));
                    console.log('💾 localStorage에도 저장 완료:', accommodations.length + '개 숙소');
                    
                    alert('✅ 숙소가 성공적으로 등록되었습니다.');
                    
                } catch (error) {
                    console.error('❌ 숙소 추가 실패:', error);
                    alert('숙소 추가 중 오류가 발생했습니다: ' + error.message);
                }
            } else if (isEditMode) {
                // 기존 숙소 수정 (Firebase 저장)
                try {
                    console.log('🔄 Firebase에서 숙소 수정 중, ID:', currentId);
                    
                    const updatedAccommodation = await updateAccommodationOnServer(currentId, accommodationData);
                    console.log('✅ Firebase 수정 성공:', updatedAccommodation);
                    
                    const index = accommodations.findIndex(a => String(a.id) === String(currentId));
                    if (index !== -1) {
                        accommodations[index] = updatedAccommodation;
                    }
                    
                    // localStorage에도 동시 저장
                    localStorage.setItem('accommodationData', JSON.stringify(accommodations));
                    console.log('💾 localStorage에도 수정 저장 완료:', accommodations.length + '개 숙소');
                    
                    alert('✅ 숙소 정보가 성공적으로 수정되었습니다.');
                    
                } catch (error) {
                    console.error('❌ 숙소 수정 실패:', error);
                    alert('숙소 수정 중 오류가 발생했습니다: ' + error.message);
                }
                
                // 수정 마쳤 후 읽기 모드로 전환
                isEditMode = false;
                document.getElementById('editButtonText').textContent = '수정';
                updateFormState();
            }
            
            renderAccommodationList();
            
            if (currentMode === 'add') {
                closeModal();
            }
        });

        // 모달 외부 클릭 시 닫기
        document.getElementById('accommodationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });


    </script>
</body>
</html>