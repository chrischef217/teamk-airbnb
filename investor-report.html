<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìì ì •ì‚° ë¦¬í¬íŠ¸</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% ì™„ì „ ì°¨ë‹¨) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="js/firebase-storage.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            body { 
                background: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .bg-gradient-to-r {
                background: linear-gradient(to right, #3b82f6, #1e40af) !important;
                -webkit-print-color-adjust: exact;
            }
            
            .shadow-lg {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .page-break-before {
                page-break-before: always;
            }
            
            @page {
                margin: 0.8in;
                size: A4;
            }
            
            /* PDF ìƒì„± ì‹œ ì°¨íŠ¸ í¬ê¸° ì¡°ì • */
            .chart-container {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            /* í…Œì´ë¸” í˜ì´ì§€ ë¸Œë ˆì´í¬ ë°©ì§€ */
            .summary-table {
                break-inside: avoid;
            }
            
            .summary-table tr {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .signature-text {
            font-family: 'Dancing Script', 'Brush Script MT', cursive;
            font-size: 28px;
            font-weight: 400;
            color: #1f2937;
            font-style: italic;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .kpi-card {
            border-left: 4px solid;
            transition: all 0.2s ease-in-out;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .profit-positive {
            border-left-color: #10b981;
            background-color: #d1fae5;
        }
        
        .profit-negative {
            border-left-color: #ef4444;
            background-color: #fee2e2;
        }
        
        .profit-neutral {
            border-left-color: #6b7280;
            background-color: #f3f4f6;
        }
        
        .summary-table {
            border-collapse: collapse;
        }
        
        .summary-table th,
        .summary-table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: right;
        }
        
        .summary-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        
        .company-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .professional-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .professional-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 40%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(15deg);
        }
        
        .data-highlight {
            position: relative;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .performance-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .performance-excellent {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .performance-good {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .performance-average {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .performance-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- PDF ì €ì¥ ë²„íŠ¼ -->
    <div class="no-print fixed top-4 right-4 z-50">
        <button onclick="downloadPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            PDFë¡œ ì €ì¥í•˜ê¸°
        </button>
    </div>

    <div class="max-w-5xl mx-auto p-8">
        <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
        <div class="professional-header text-white rounded-lg shadow-lg p-8 mb-8 relative">
            <div class="flex items-center justify-between relative z-10">
                <div class="flex items-center">
                    <div class="company-logo mr-6">
                        <i class="fas fa-building"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold mb-2">Teamk íˆ¬ìì ì •ì‚° ë¦¬í¬íŠ¸</h1>
                        <p class="text-blue-100">Thailand Airbnb Investment Management System</p>
                        <div class="mt-3 inline-flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <span class="text-sm">ê³µì¸ íˆ¬ìì ë¦¬í¬íŠ¸</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-blue-100 mb-1">ë¦¬í¬íŠ¸ ìƒì„±ì¼</div>
                    <div id="reportDate" class="text-xl font-semibold mb-3"></div>
                    <div class="performance-badge bg-white bg-opacity-20 text-white">
                        <i class="fas fa-star mr-1"></i>
                        ê³µì‹ ë¦¬í¬íŠ¸
                    </div>
                </div>
            </div>
        </div>

        <!-- íˆ¬ìì ì •ë³´ -->
        <div class="data-highlight rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-user text-blue-600 mr-2"></i>
                íˆ¬ìì ì •ë³´
                <span class="performance-badge performance-good ml-3">
                    <i class="fas fa-verify mr-1"></i>
                    ì¸ì¦ íˆ¬ìì
                </span>
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">íˆ¬ììëª…:</span>
                        <span id="investorName" class="ml-2 font-semibold text-gray-800"></span>
                    </div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">ì •ì‚° ì›”:</span>
                        <span id="settlementPeriod" class="ml-2 font-semibold text-gray-800"></span>
                    </div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">ë³´ìœ  ìˆ™ì†Œ ìˆ˜:</span>
                        <span id="accommodationCount" class="ml-2 font-semibold text-blue-600"></span>
                    </div>
                </div>
                <div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">íˆ¬ì ì§€ë¶„:</span>
                        <span id="ownershipPercentage" class="ml-2 font-semibold text-gray-800"></span>
                    </div>

                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">ì—°ë½ì²˜:</span>
                        <span id="contactInfo" class="ml-2 font-semibold text-gray-800"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë°°ë‹¹ ê³„ì‚° ì„¹ì…˜ -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg shadow-lg p-6 mb-8">
            <!-- ì •ì‚° ê¸ˆì•¡ í•˜ì´ë¼ì´íŠ¸ -->
            <div class="bg-white bg-opacity-20 rounded-lg p-6 text-center border border-white border-opacity-30">
                <div class="text-lg text-blue-100 mb-2">ì´ë²ˆ ë‹¬ ì •ì‚° ê¸ˆì•¡</div>
                <div id="settlementAmount" class="text-4xl font-bold mb-3">0 THB</div>
                <div class="text-blue-100">
                    <i class="fas fa-info-circle mr-2"></i>
                    ìœ„ ê¸ˆì•¡ì€ íˆ¬ììë‹˜ê»˜ ì§€ê¸‰ë  ë°°ë‹¹ê¸ˆì…ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- KPI ì¹´ë“œë“¤ -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card profit-positive bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">ì´ ìˆ˜ìµ</h3>
                        <div id="totalRevenue" class="text-2xl font-bold text-green-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-coins text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card profit-negative bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">ì´ ë¹„ìš©</h3>
                        <div id="totalExpenses" class="text-2xl font-bold text-red-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-receipt text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card profit-positive bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">ìˆœ ì´ìµ</h3>
                        <div id="netProfit" class="text-2xl font-bold text-blue-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card profit-neutral bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">íˆ¬ìì ë°°ë‹¹</h3>
                        <div id="investorDividend" class="text-2xl font-bold text-purple-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-hand-holding-usd text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ìµ ì°¨íŠ¸ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 page-break-before">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                ì›”ë³„ ìˆ˜ìµ ì¶”ì´
            </h2>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- ìˆ™ì†Œë³„ ì„±ê³¼ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-home text-blue-600 mr-2"></i>
                ìˆ™ì†Œë³„ ìˆ˜ìµ ì„±ê³¼
            </h2>
            <div class="overflow-x-auto">
                <table class="summary-table w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left">ìˆ™ì†Œëª…</th>
                            <th>ì´ ìˆ˜ìµ</th>
                            <th>ì´ ë¹„ìš©</th>
                            <th>ìˆœ ì´ìµ</th>
                            <th>ìˆ˜ìµë¥ </th>
                            <th>íˆ¬ìì ë°°ë‹¹</th>
                        </tr>
                    </thead>
                    <tbody id="accommodationPerformanceTable">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ìˆ˜ìµ ë¶„ì„ -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- ìˆ˜ìµ êµ¬ì¡° íŒŒì´ì°¨íŠ¸ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                    ìˆ˜ìµ êµ¬ì¡° ë¶„ì„
                </h3>
                <div class="chart-container">
                    <canvas id="revenueStructureChart"></canvas>
                </div>
            </div>
            
            <!-- ë¹„ìš© êµ¬ì¡° íŒŒì´ì°¨íŠ¸ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-chart-pie text-red-600 mr-2"></i>
                    ë¹„ìš© êµ¬ì¡° ë¶„ì„
                </h3>
                <div class="chart-container">
                    <canvas id="expenseStructureChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ìƒì„¸ ê±°ë˜ ë‚´ì—­ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 page-break-before">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-list-alt text-blue-600 mr-2"></i>
                ìƒì„¸ ê±°ë˜ ë‚´ì—­
            </h2>
            <div class="overflow-x-auto">
                <table class="summary-table w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left">ë‚ ì§œ</th>
                            <th class="text-left">ìˆ™ì†Œ</th>
                            <th class="text-left">êµ¬ë¶„</th>
                            <th class="text-left">í•­ëª©</th>
                            <th>ê¸ˆì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="transactionDetailsTable">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ìˆ™ì†Œ ì˜ˆì•½ë¥  ë¶„ì„ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-calendar-alt text-green-600 mr-2"></i>
                ìˆ™ì†Œ ì˜ˆì•½ë¥  ë¶„ì„
            </h2>
            <div class="grid md:grid-cols-4 gap-6 mb-6">
                <div class="text-center kpi-card profit-positive rounded-lg p-4">
                    <div class="text-2xl font-bold text-green-600 mb-2" id="averageStayDays">0ì¼</div>
                    <div class="text-sm text-gray-600">í‰ê·  ìˆ™ë°• ê¸°ê°„</div>
                </div>
                <div class="text-center kpi-card profit-positive rounded-lg p-4">
                    <div class="text-2xl font-bold text-blue-600 mb-2" id="averageDailyRate">0 THB</div>
                    <div class="text-sm text-gray-600">1ì¼ë‹¹ í‰ê·  ë¹„ìš©</div>
                </div>
                <div class="text-center kpi-card profit-positive rounded-lg p-4">
                    <div class="text-2xl font-bold text-purple-600 mb-2" id="occupancyRate">0.0%</div>
                    <div class="text-sm text-gray-600">ì›” ì˜ˆì•½ ë‹¬ì„±ë¥ </div>
                </div>
                <div class="text-center kpi-card profit-neutral rounded-lg p-4">
                    <div class="text-2xl font-bold text-gray-600 mb-2" id="vacantDays">0ì¼</div>
                    <div class="text-sm text-gray-600">ì˜ˆì•½ ë¯¸ë‹¬ì„± ì¼ìˆ˜</div>
                </div>
            </div>
            
            <!-- ìˆ™ì†Œë³„ ìƒì„¸ ì˜ˆì•½ë¥  -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">ìˆ™ì†Œë³„ ì˜ˆì•½ë¥  ìƒì„¸</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">ìˆ™ì†Œëª…</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">ì˜ˆì•½ íšŸìˆ˜</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">ì´ ìˆ™ë°•ì¼</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">í‰ê·  ìˆ™ë°•ì¼</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">ì˜ˆì•½ë¥ </th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">1ì¼ë‹¹ í‰ê·  ìˆ˜ìµ</th>
                            </tr>
                        </thead>
                        <tbody id="accommodationReservationTable" class="bg-white divide-y divide-gray-200">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- íˆ¬ì ì„±ê³¼ ë¶„ì„ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                íˆ¬ì ì„±ê³¼ ë¶„ì„
            </h2>
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="annualizedReturn">0.0%</div>
                    <div class="text-sm text-gray-600">ì—°í™˜ì‚° ìˆ˜ìµë¥ </div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="monthlyReturn">0.0%</div>
                    <div class="text-sm text-gray-600">ì›” ìˆ˜ìµë¥ </div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="paybackPeriod">0.0%</div>
                    <div class="text-sm text-gray-600">ê³ ì •ë¹„ ë¹„ìœ¨</div>
                </div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ìš”ì•½ ë° ì„œëª… -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-clipboard-check text-blue-600 mr-2"></i>
                ì •ì‚° ìš”ì•½ ë° íˆ¬ì ì œì–¸
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">ì´ë²ˆ ë‹¬ í•˜ì´ë¼ì´íŠ¸</h3>
                    <ul id="highlights" class="space-y-2 text-gray-600">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">íˆ¬ì ì œì–¸ ë° ì „ë§</h3>
                    <div id="nextMonthOutlook" class="text-gray-600">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </div>
                </div>
            </div>
            
            <!-- ì„œëª… ë° ìŠ¹ì¸ -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="grid md:grid-cols-2 gap-8 text-center">
                    <div>
                        <div class="h-20 mb-2 flex items-center justify-center">
                            <div class="signature-text">Yesol, Jang</div>
                        </div>
                        <div class="text-sm text-gray-600">ê´€ë¦¬ì ì„œëª…</div>
                        <div class="text-xs text-gray-500 mt-1">Teamk Holding ëŒ€í‘œì´ì‚¬</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-2">ìŠ¹ì¸ ì¼ì</div>
                        <div class="border border-gray-400 p-2 h-12 flex items-center justify-center">
                            <span id="approvalDate" class="text-gray-800 font-semibold"></span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">ê³µì‹ ìŠ¹ì¸</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="text-center text-gray-500 text-sm border-t pt-6">
            <p>Â© 2025 Teamk Thailand Airbnb Management System</p>
            <p class="mt-2">ë³¸ ë¦¬í¬íŠ¸ëŠ” íˆ¬ìì ì •ì‚°ì„ ëª©ì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ì •í™•í•œ ì •ë³´ ì œê³µì„ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            <p class="mt-1">ë¬¸ì˜ì‚¬í•­ : office@teamkholdings.com</p>
        </div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const investorId = urlParams.get('investor');
        const month = urlParams.get('month');
        
        console.log('ğŸŒ URL íŒŒë¼ë¯¸í„°:', {
            investorId: investorId,
            month: month,
            fullUrl: window.location.href
        });
        
        let investorData = null;
        let settlementData = null;
        let accountingData = [];  // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
        let reservationData = [];  // ì˜ˆì•½ ë°ì´í„° ì „ì—­ ë³€ìˆ˜

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìë™ ìƒì„± ì œê±°ë¨ - ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš©
            
            initializeReport();
        });



        async function initializeReport() {
            try {
                // í˜„ì¬ ë‚ ì§œ ì„¤ì • (ì‹¤ì‹œê°„)
                const today = new Date();
                const reportDateString = today.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('reportDate').textContent = reportDateString;
                document.getElementById('approvalDate').textContent = reportDateString;

                // íˆ¬ìì, ì •ì‚°, ì˜ˆì•½ ë°ì´í„° ë¡œë“œ
                await loadInvestorData();
                await loadSettlementData();
                await loadReservationData();
                
                // ë¦¬í¬íŠ¸ ìƒì„±
                generateReport();
                
            } catch (error) {
                console.error('ë¦¬í¬íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadInvestorData() {
            console.log('ğŸ” íˆ¬ìì ë°ì´í„° ë¡œë”© ì‹œì‘...');
            console.log('ğŸ“ URL íŒŒë¼ë¯¸í„° - investorId:', investorId);
            
            let investors = [];
            
            // Firebaseì—ì„œ íˆ¬ìì ë°ì´í„° ì‹œë„
            try {
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ íˆ¬ìì ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const firebaseData = await firebaseStorage.loadInvestors();
                    investors = firebaseData || [];
                    console.log('ğŸ“¡ Firebaseì—ì„œ ë¡œë“œëœ íˆ¬ìì:', investors.length + 'ëª…');
                } else {
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                investors = JSON.parse(localStorage.getItem('investorData') || '[]');
            }
            
            console.log('ğŸ“‹ ì´ íˆ¬ìì ë°ì´í„°:', investors.length + 'ëª…');
            
            // URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ íŠ¹ì • íˆ¬ììë§Œ ì°¾ê¸°
            if (investorId && investorId !== 'null') {
                investorData = investors.find(inv => {
                    console.log('ğŸ” ë¹„êµ:', inv.id, inv.name, inv.userId, 'â† ì°¾ëŠ” ID:', investorId);
                    return inv.id == investorId || 
                           inv.name === investorId || 
                           inv.userId === investorId ||
                           String(inv.id) === String(investorId) ||
                           inv.id === decodeURIComponent(investorId) ||
                           inv.name === decodeURIComponent(investorId);
                });
                
                console.log('ğŸ¯ URL íŒŒë¼ë¯¸í„°ë¡œ ì°¾ì€ íˆ¬ìì:', investorData);
            } else {
                console.log('ğŸ“ URL íŒŒë¼ë¯¸í„°ì— investorId ì—†ìŒ');
                investorData = null;
            }
            
            console.log('âœ… ì°¾ì€ íˆ¬ìì:', investorData);
            
            if (!investorData) {
                console.error('âŒ íˆ¬ììë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ íˆ¬ìì IDë“¤:', investors.map(inv => ({id: inv.id, name: inv.name, userId: inv.userId})));
                
                // URL íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ë° íˆ¬ììë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°
                if (investorId && investorId !== 'null') {
                    console.log('âŒ URL íŒŒë¼ë¯¸í„°ì˜ íˆ¬ìì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', investorId);
                    console.log('ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ íˆ¬ììë“¤:', investors.map(inv => ({id: inv.id, name: inv.name})));
                    
                    // ì²« ë²ˆì§¸ íˆ¬ììë¥¼ ëŒ€ì‹  ì‚¬ìš©
                    if (investors.length > 0) {
                        investorData = investors[0];
                        console.log('âš ï¸ ëŒ€ì‹  ì²« ë²ˆì§¸ íˆ¬ìì ì‚¬ìš©:', investorData.name);
                    }
                }
                
                // ì—¬ì „íˆ íˆ¬ììê°€ ì—†ìœ¼ë©´ ìƒ˜í”Œ íˆ¬ìì ìƒì„±
                if (!investorData) {
                    console.log('âš ï¸ íˆ¬ìì ë°ì´í„°ê°€ ì—†ì–´ ìƒ˜í”Œ íˆ¬ììë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
                    investorData = {
                        id: investorId || 'demo-investor',
                        name: 'ë°ëª¨ íˆ¬ìì',
                        initialInvestment: 50000000,
                        ownershipPercentage: 100,
                        investorRatio: 70,
                        companyRatio: 30,
                        contact: 'demo@teamk.com',
                        accommodations: ['sample-acc-1', 'sample-acc-2']
                    };
                }
            }
            
            // íˆ¬ìì ì •ë³´ í‘œì‹œ
            document.getElementById('investorName').textContent = investorData.name || 'íˆ¬ìì';
            document.getElementById('settlementPeriod').textContent = month ? `${month.replace('-', 'ë…„ ')}ì›”` : 'ì „ì²´';
            document.getElementById('accommodationCount').textContent = (investorData.accommodations || []).length + 'ê°œ';
            document.getElementById('ownershipPercentage').textContent = (investorData.ownershipPercentage || investorData.share || 100) + '%';
            document.getElementById('contactInfo').textContent = investorData.contact || investorData.phone || investorData.email || '-';
        }

        async function loadSettlementData() {
            console.log('ğŸ“Š ì •ì‚° ë°ì´í„° ë¡œë”© ì‹œì‘...');
            console.log('ğŸ“ URLì—ì„œ ì „ë‹¬ëœ month íŒŒë¼ë¯¸í„°:', month);
            
            // ì‹¤ì œ ë°ì´í„° ê°•ì œ ë¡œë“œ ì‹œë„
            console.log('ğŸ” ì‹¤ì œ ë°ì´í„° ê°•ì œ ê²€ìƒ‰ ì‹œì‘...');
            
            // Firebase ë˜ëŠ” localStorageì—ì„œ íšŒê³„ ë°ì´í„° ë¡œë“œ (ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©)
            let accommodationData = [];
            
            // íšŒê³„ ë°ì´í„° ë¡œë“œ
            try {
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ íšŒê³„ ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const firebaseAccounting = await firebaseStorage.loadAccounting();
                    accountingData = firebaseAccounting ? firebaseAccounting.map(acc => ({
                        id: acc.id,
                        accommodationId: parseInt(acc.accommodationId),
                        accommodationName: acc.accommodationName,
                        transactionDate: acc.transactionDate || acc.date,
                        date: acc.transactionDate || acc.date,
                        description: acc.description,
                        category: acc.category,
                        type: acc.type,
                        amount: parseFloat(acc.amount) || 0
                    })).filter(acc => acc.transactionDate !== null) : [];
                } else {
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase íšŒê³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                try {
                    const savedAccounting = localStorage.getItem('accountingData');
                    if (savedAccounting) {
                        const rawData = JSON.parse(savedAccounting);
                        accountingData = rawData.map(acc => ({
                            id: acc.id,
                            accommodationId: parseInt(acc.accommodationId),
                            accommodationName: acc.accommodationName,
                            transactionDate: acc.transactionDate || acc.date,
                            date: acc.transactionDate || acc.date,
                            description: acc.description,
                            category: acc.category,
                            type: acc.type,
                            amount: parseFloat(acc.amount) || 0
                        })).filter(acc => acc.transactionDate !== null);
                    } else {
                        accountingData = [];
                    }
                } catch (e) {
                    console.error('âŒ íšŒê³„ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    accountingData = [];
                }
            }
            
            // ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ
            try {
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const firebaseAccommodations = await firebaseStorage.loadAccommodations();
                    accommodationData = firebaseAccommodations ? firebaseAccommodations.map(acc => ({
                        id: parseInt(acc.id),
                        name: acc.accommodationName || acc.name,
                        building: acc.buildingName || 'ì •ë³´ ì—†ìŒ',
                        location: acc.location || 'ì •ë³´ ì—†ìŒ',
                        investorName: acc.investorName || ''
                    })) : [];
                } else {
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                try {
                    const savedAccommodations = localStorage.getItem('accommodationData');
                    if (savedAccommodations) {
                        const rawData = JSON.parse(savedAccommodations);
                        accommodationData = rawData.map(acc => ({
                            id: parseInt(acc.id),
                            name: acc.accommodationName || acc.name,
                            building: acc.buildingName || 'ì •ë³´ ì—†ìŒ',
                            location: acc.location || 'ì •ë³´ ì—†ìŒ',
                            investorName: acc.investorName || ''
                        }));
                    } else {
                        accommodationData = [];
                    }
                } catch (e) {
                    console.error('âŒ ìˆ™ì†Œ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    accommodationData = [];
                }
            }
            
            console.log('ğŸ“‹ íšŒê³„ ë°ì´í„° ì´', accountingData.length, 'ê±´');
            console.log('ğŸ  ìˆ™ì†Œ ë°ì´í„° ì´', accommodationData.length, 'ê°œ');
            console.log('ğŸ“‹ íšŒê³„ ë°ì´í„° ìƒ˜í”Œ:', accountingData.slice(0, 3));
            console.log('ğŸ  ìˆ™ì†Œ ë°ì´í„° ìƒ˜í”Œ:', accommodationData.slice(0, 3));
            
            // íˆ¬ììì˜ ìˆ™ì†Œë§Œ í•„í„°ë§
            const investorAccommodations = investorData.accommodations || [];
            console.log('ğŸ  íˆ¬ìì ë³´ìœ  ìˆ™ì†Œ ID:', investorAccommodations);
            
            // í•´ë‹¹ ì›”ì˜ ë°ì´í„°ë§Œ í•„í„°ë§ (ì›”ì´ ì„ íƒëœ ê²½ìš°)
            console.log('ğŸ” ë°ì´í„° í•„í„°ë§ ì‹œì‘');
            console.log('ğŸ“ íˆ¬ìì ë³´ìœ  ìˆ™ì†Œ ID:', investorAccommodations);
            console.log('ğŸ“… ì„ íƒëœ ì›”:', month);
            
            const filteredTransactions = accountingData.filter(item => {
                // íˆ¬ìì ìˆ™ì†Œ ID ë§¤ì¹­ - ë¬¸ìì—´ê³¼ ìˆ«ì ëª¨ë‘ ì²˜ë¦¬
                const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                const isInvestorAccommodation = investorAccommodations.length === 0 || 
                    investorAccommodations.some(id => id == itemAccId || parseInt(id) == itemAccId);
                
                // transactionDate ë˜ëŠ” date í•„ë“œ ì‚¬ìš©í•˜ì—¬ ì›” í•„í„°ë§
                let isCorrectMonth = true;
                if (month) {
                    const dateField = item.transactionDate || item.date;
                    if (dateField && typeof dateField === 'string') {
                        // ì§ì ‘ ë¬¸ìì—´ì—ì„œ YYYY-MM ì¶”ì¶œ
                        const itemMonth = dateField.substring(0, 7);
                        isCorrectMonth = itemMonth === month;
                        console.log(`ğŸ“Š ë¦¬í¬íŠ¸ ë°ì´í„° í•„í„°: ë‚ ì§œ=${dateField}, ì¶”ì¶œì›”=${itemMonth}, ì„ íƒì›”=${month}, ì¼ì¹˜=${isCorrectMonth}`);
                    } else {
                        console.warn('âš ï¸ ë‚ ì§œê°€ ì—†ëŠ” ê±°ë˜ ë°ì´í„°:', item);
                        isCorrectMonth = false;
                    }
                } else {
                    // monthê°€ nullì´ë©´ ëª¨ë“  ì›” ë°ì´í„° í¬í•¨
                    console.log('ğŸ“… ì›” í•„í„° ì—†ìŒ - ëª¨ë“  ë°ì´í„° í¬í•¨');
                    isCorrectMonth = true;
                }
                
                const shouldInclude = isInvestorAccommodation && isCorrectMonth;
                console.log(`ğŸ” ê±°ë˜ í•„í„°ë§: ìˆ™ì†ŒID=${item.accommodationId}, íˆ¬ìììˆ™ì†Œì¼ì¹˜=${isInvestorAccommodation}, ì›”ì¼ì¹˜=${isCorrectMonth}, ìµœì¢…=${shouldInclude}`);
                
                return shouldInclude;
            });
            
            const filteredAccommodations = accommodationData.filter(acc => 
                investorAccommodations.length === 0 || investorAccommodations.includes(acc.id)
            );
            
            settlementData = {
                transactions: filteredTransactions,
                accommodations: filteredAccommodations
            };
            
            console.log('âœ… í•„í„°ë§ëœ ê±°ë˜:', settlementData.transactions.length, 'ê±´');
            console.log('âœ… í•„í„°ë§ëœ ìˆ™ì†Œ:', settlementData.accommodations.length, 'ê°œ');
            
            // ì‹¤ì œ ë°ì´í„° ìš°ì„  ì‚¬ìš©, ì—†ì„ ë•Œë§Œ ìƒ˜í”Œ ë°ì´í„°
            console.log('ğŸ“Š ìµœì¢… ë°ì´í„° í™•ì¸:');
            console.log('- í•„í„°ë§ëœ ê±°ë˜ ë°ì´í„°:', filteredTransactions.length, 'ê±´');
            console.log('- í•„í„°ë§ëœ ìˆ™ì†Œ ë°ì´í„°:', filteredAccommodations.length, 'ê°œ');
            
            // URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ë°ì´í„° í•„í„°ë§
            console.log('ğŸ¯ URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ ë°ì´í„° í•„í„°ë§ ì‹œì‘');
            console.log('ğŸ“ íˆ¬ìì ID:', investorId);
            console.log('ğŸ“… ì„ íƒëœ ì›”:', month);
            
            // ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° í•´ë‹¹ íˆ¬ììì™€ ì›”ì— ë§ê²Œ í•„í„°ë§
            if (accountingData.length > 0 && accommodationData.length > 0) {
                console.log('âœ… ì‹¤ì œ ë°ì´í„° ì‚¬ìš© - í•„í„°ë§ ì ìš©');
                
                // í•´ë‹¹ íˆ¬ììì˜ ìˆ™ì†Œ ID ì°¾ê¸°
                let investorAccommodationIds = [];
                if (investorData && investorData.accommodations) {
                    investorAccommodationIds = investorData.accommodations;
                } else {
                    // íˆ¬ìì ì´ë¦„ìœ¼ë¡œ ìˆ™ì†Œ ì°¾ê¸°
                    const investorName = investorData ? investorData.name : null;
                    investorAccommodationIds = accommodationData
                        .filter(acc => acc.investorName === investorName)
                        .map(acc => acc.id);
                }
                
                console.log('ğŸ  í•´ë‹¹ íˆ¬ììì˜ ìˆ™ì†Œ IDs:', investorAccommodationIds);
                
                // ì›” ë° ìˆ™ì†Œ í•„í„°ë§
                const filteredAccountingData = accountingData.filter(item => {
                    // ìˆ™ì†Œ ID ë§¤ì¹­
                    const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                    const isInvestorAccommodation = investorAccommodationIds.length === 0 || 
                        investorAccommodationIds.some(id => id == itemAccId || parseInt(id) == itemAccId);
                    
                    // ì›” í•„í„°ë§ (monthê°€ ìˆëŠ” ê²½ìš°ë§Œ)
                    let isCorrectMonth = true;
                    if (month && month !== 'null') {
                        const dateField = item.transactionDate || item.date;
                        if (dateField && typeof dateField === 'string') {
                            const itemMonth = dateField.substring(0, 7);
                            isCorrectMonth = itemMonth === month;
                        } else {
                            isCorrectMonth = false;
                        }
                    }
                    
                    const shouldInclude = isInvestorAccommodation && isCorrectMonth;
                    console.log(`ğŸ” ê±°ë˜ í•„í„°: ID=${item.accommodationId}, ì›”=${item.transactionDate?.substring(0,7)}, í¬í•¨=${shouldInclude}`);
                    
                    return shouldInclude;
                });
                
                // í•´ë‹¹ íˆ¬ììì˜ ìˆ™ì†Œë§Œ í•„í„°ë§
                const filteredAccommodationData = accommodationData.filter(acc => 
                    investorAccommodationIds.length === 0 || 
                    investorAccommodationIds.some(id => id == acc.id || parseInt(id) == acc.id)
                );
                
                console.log(`ğŸ“Š í•„í„°ë§ ê²°ê³¼: ê±°ë˜ ${filteredAccountingData.length}ê±´, ìˆ™ì†Œ ${filteredAccommodationData.length}ê°œ`);
                
                settlementData = {
                    transactions: filteredAccountingData.map(item => ({
                        id: item.id,
                        accommodationId: item.accommodationId,
                        accommodationName: item.accommodationName,
                        transactionDate: item.transactionDate || item.date,
                        date: item.transactionDate || item.date,
                        type: item.type,
                        category: item.category,
                        amount: parseFloat(item.amount) || 0,
                        description: item.description
                    })),
                    accommodations: filteredAccommodationData.map(item => ({
                        id: item.id,
                        name: item.accommodationName || item.name,
                        building: item.buildingName || 'ì •ë³´ ì—†ìŒ'
                    }))
                };
                
            } else {
                console.log('âš ï¸ ì‹¤ì œ ë°ì´í„° ì—†ìŒ - ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”');
                
                // ë”ë¯¸ ë°ì´í„° ìƒì„±í•˜ì§€ ì•Šê³  ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                settlementData = {
                    transactions: [],
                    accommodations: []
                };
                
                console.log('ğŸ“Š ì‹¤ì œ ë°ì´í„° ì…ë ¥ì„ ìœ„í•´ ìˆ˜ìµê´€ë¦¬ì™€ ìˆ™ì†Œê´€ë¦¬ì—ì„œ ë¨¼ì € ë°ì´í„°ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.');
            }
            
            console.log('âœ… í•„í„°ë§ëœ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ');
            console.log('ğŸ“Š ìµœì¢… settlementData:', {
                transactions: settlementData.transactions.length + 'ê±´',
                accommodations: settlementData.accommodations.length + 'ê°œ'
            });
        }

        async function loadReservationData() {
            console.log('ğŸ“… ì˜ˆì•½ ë°ì´í„° ë¡œë”© ì‹œì‘...');
            
            try {
                // Firebaseì—ì„œ ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹œë„
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('ğŸ”¥ Firebaseì—ì„œ ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì¤‘...');
                    const firebaseReservations = await firebaseStorage.loadReservations();
                    reservationData = firebaseReservations ? firebaseReservations.map(res => ({
                        id: res.id,
                        accommodationId: parseInt(res.accommodationId) || res.accommodationId,
                        accommodationName: res.accommodationName,
                        checkIn: res.checkIn,
                        checkOut: res.checkOut,
                        guestName: res.guestName,
                        totalAmount: parseFloat(res.totalAmount) || 0,
                        platform: res.platform
                    })).filter(res => res.checkIn && res.checkOut) : [];
                } else {
                    throw new Error('Firebase ì—°ê²° ì—†ìŒ');
                }
            } catch (firebaseError) {
                console.log('âš ï¸ Firebase ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', firebaseError.message);
                try {
                    const savedReservations = localStorage.getItem('reservationData');
                    if (savedReservations) {
                        const rawData = JSON.parse(savedReservations);
                        reservationData = rawData.map(res => ({
                            id: res.id,
                            accommodationId: parseInt(res.accommodationId) || res.accommodationId,
                            accommodationName: res.accommodationName,
                            checkIn: res.checkIn,
                            checkOut: res.checkOut,
                            guestName: res.guestName,
                            totalAmount: parseFloat(res.totalAmount) || 0,
                            platform: res.platform
                        })).filter(res => res.checkIn && res.checkOut);
                    } else {
                        reservationData = [];
                    }
                } catch (e) {
                    console.error('âŒ ì˜ˆì•½ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    reservationData = [];
                }
            }

            console.log('ğŸ“… ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', reservationData.length + 'ê±´');
            
            // íˆ¬ììë³„ ì˜ˆì•½ ë°ì´í„° í•„í„°ë§
            if (investorData && investorData.accommodations && investorData.accommodations.length > 0) {
                const investorAccommodationIds = investorData.accommodations;
                reservationData = reservationData.filter(reservation => {
                    const resAccId = reservation.accommodationId;
                    return investorAccommodationIds.some(id => id == resAccId || parseInt(id) == resAccId);
                });
                console.log('ğŸ  íˆ¬ìì ìˆ™ì†Œ ì˜ˆì•½ë§Œ í•„í„°ë§:', reservationData.length + 'ê±´');
            }
        }

        function generateSampleTransactions() {
            // monthê°€ ì—†ê±°ë‚˜ ì˜ëª»ëœ í˜•ì‹ì¼ ê²½ìš° í˜„ì¬ ì›” ì‚¬ìš©
            let targetMonth = month;
            if (!targetMonth || typeof targetMonth !== 'string' || !targetMonth.match(/^\d{4}-\d{2}$/)) {
                targetMonth = new Date().toISOString().substring(0, 7);
                console.log('âš ï¸ ì˜ëª»ëœ ì›” íŒŒë¼ë¯¸í„°, í˜„ì¬ ì›” ì‚¬ìš©:', targetMonth);
            }
            
            return [
                // ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸ ê±°ë˜
                {
                    id: 'sample1',
                    transactionDate: targetMonth + '-05',
                    date: targetMonth + '-05',
                    accommodationId: 'sample-acc-1',
                    accommodationName: 'ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸',
                    type: 'income',
                    category: 'booking',
                    amount: 48000,
                    description: 'ì—ì–´ë¹„ì•¤ë¹„ ì˜ˆì•½ ìˆ˜ìµ'
                },
                {
                    id: 'sample2',
                    transactionDate: targetMonth + '-10',
                    date: targetMonth + '-10',
                    accommodationId: 'sample-acc-1',
                    accommodationName: 'ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸',
                    type: 'expense',
                    category: 'rent',
                    amount: 18000,
                    description: 'ì›” ë ŒíŠ¸ë¹„'
                },
                {
                    id: 'sample3',
                    transactionDate: targetMonth + '-15',
                    date: targetMonth + '-15',
                    accommodationId: 'sample-acc-1',
                    accommodationName: 'ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸',
                    type: 'expense',
                    category: 'cleaning',
                    amount: 3500,
                    description: 'ì •ê¸° ì²­ì†Œ ë¹„ìš©'
                },
                {
                    id: 'sample4',
                    transactionDate: targetMonth + '-20',
                    date: targetMonth + '-20',
                    accommodationId: 'sample-acc-1',
                    accommodationName: 'ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸',
                    type: 'income',
                    category: 'booking',
                    amount: 42000,
                    description: 'ë¶€í‚¹ë‹·ì»´ ì˜ˆì•½ ìˆ˜ìµ'
                },
                // íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„ ê±°ë˜
                {
                    id: 'sample5',
                    transactionDate: targetMonth + '-08',
                    date: targetMonth + '-08',
                    accommodationId: 'sample-acc-2',
                    accommodationName: 'íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„',
                    type: 'income',
                    category: 'booking',
                    amount: 38000,
                    description: 'ì—ì–´ë¹„ì•¤ë¹„ ì˜ˆì•½ ìˆ˜ìµ'
                },
                {
                    id: 'sample6',
                    transactionDate: targetMonth + '-12',
                    date: targetMonth + '-12',
                    accommodationId: 'sample-acc-2',
                    accommodationName: 'íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„',
                    type: 'expense',
                    category: 'rent',
                    amount: 15000,
                    description: 'ì›” ë ŒíŠ¸ë¹„'
                },
                {
                    id: 'sample7',
                    transactionDate: targetMonth + '-22',
                    date: targetMonth + '-22',
                    accommodationId: 'sample-acc-2',
                    accommodationName: 'íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„',
                    type: 'expense',
                    category: 'utilities',
                    amount: 2800,
                    description: 'ì „ê¸°/ìˆ˜ë„ì„¸'
                },
                {
                    id: 'sample8',
                    transactionDate: targetMonth + '-28',
                    date: targetMonth + '-28',
                    accommodationId: 'sample-acc-2',
                    accommodationName: 'íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„',
                    type: 'income',
                    category: 'booking',
                    amount: 35000,
                    description: 'Agoda ì˜ˆì•½ ìˆ˜ìµ'
                }
            ];
        }

        function generateSampleAccommodations() {
            return [
                {
                    id: 'sample-acc-1',
                    name: 'ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸',
                    location: 'ë°©ì½• ì‹œë‚´'
                },
                {
                    id: 'sample-acc-2',
                    name: 'íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„',
                    location: 'íŒŒíƒ€ì•¼ í•´ë³€ê°€'
                }
            ];
        }

        function generateReport() {
            console.log('ğŸ“Š ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘');
            console.log('ğŸ“‹ settlement ë°ì´í„°:', settlementData);
            
            // KPI ê³„ì‚° ë° í‘œì‹œ
            calculateKPIs();
            
            // ë°°ë‹¹ ê³„ì‚° ë° í‘œì‹œ
            calculateDividends();
            
            // í…Œì´ë¸” ìƒì„± - ê°€ì¥ ì¤‘ìš”í•¨
            console.log('ğŸ  ìˆ™ì†Œë³„ ì„±ê³¼ í…Œì´ë¸” ìƒì„± í˜¸ì¶œ');
            generateAccommodationPerformanceTable();
            
            console.log('ğŸ“ ê±°ë˜ ìƒì„¸ í…Œì´ë¸” ìƒì„± í˜¸ì¶œ');
            generateTransactionDetailsTable();
            
            // ì°¨íŠ¸ ìƒì„±
            createRevenueChart();
            createRevenueStructureChart();
            createExpenseStructureChart();
            
            // í•˜ì´ë¼ì´íŠ¸ ìƒì„±
            generateHighlights();
            
            // ì˜ˆì•½ë¥  ë¶„ì„
            generateReservationAnalysis();
            
            // íˆ¬ì ì„±ê³¼ ë¶„ì„
            calculateInvestmentPerformance();
            
            console.log('âœ… ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ');
        }

        function calculateKPIs() {
            const transactions = settlementData.transactions;
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalRevenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    totalExpenses += parseFloat(transaction.amount || 0);
                }
            });
            
            const netProfit = totalRevenue - totalExpenses;
            const investorShare = (investorData.ownershipPercentage || 100) / 100;
            const investorDividend = netProfit * investorShare;
            
            // KPI í‘œì‹œ
            document.getElementById('totalRevenue').textContent = formatMoney(totalRevenue);
            document.getElementById('totalExpenses').textContent = formatMoney(totalExpenses);
            document.getElementById('netProfit').textContent = formatMoney(netProfit);
            document.getElementById('investorDividend').textContent = formatMoney(investorDividend);
            
            // ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            updateKPIColors(netProfit);
        }

        function updateKPIColors(netProfit) {
            const netProfitElement = document.getElementById('netProfit');
            const dividendElement = document.getElementById('investorDividend');
            
            if (netProfit > 0) {
                netProfitElement.className = 'text-2xl font-bold text-green-600';
                dividendElement.className = 'text-2xl font-bold text-green-600';
            } else if (netProfit < 0) {
                netProfitElement.className = 'text-2xl font-bold text-red-600';
                dividendElement.className = 'text-2xl font-bold text-red-600';
            } else {
                netProfitElement.className = 'text-2xl font-bold text-gray-600';
                dividendElement.className = 'text-2xl font-bold text-gray-600';
            }
        }

        function calculateDividends() {
            console.log('ğŸ’° ë°°ë‹¹ ê³„ì‚° ì‹œì‘');
            
            const transactions = settlementData.transactions || [];
            
            // ìˆ˜ìµê³¼ ë¹„ìš© ê³„ì‚°
            const totalRevenue = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
            const netProfit = totalRevenue - totalExpenses;
            
            // íˆ¬ìì ì§€ë¶„ ê³„ì‚° (íˆ¬ìì ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©)
            let investorSharePercentage = 70; // ê¸°ë³¸ê°’ 70%
            let companySharePercentage = 30;  // ê¸°ë³¸ê°’ 30%
            
            if (investorData) {
                if (investorData.investorRatio) {
                    // investorRatioê°€ ìˆìœ¼ë©´ ì‚¬ìš© (ì˜ˆ: 70)
                    investorSharePercentage = parseFloat(investorData.investorRatio) || 70;
                    companySharePercentage = parseFloat(investorData.companyRatio) || (100 - investorSharePercentage);
                } else if (investorData.sharePercentage) {
                    investorSharePercentage = parseFloat(investorData.sharePercentage) || 70;
                    companySharePercentage = 100 - investorSharePercentage;
                } else if (investorData.ownershipPercentage) {
                    // ownershipPercentageê°€ 100ì´ë©´ íˆ¬ìì ì§€ë¶„ì„ 70%ë¡œ ì„¤ì •
                    const ownership = parseFloat(investorData.ownershipPercentage) || 100;
                    if (ownership === 100) {
                        investorSharePercentage = 70;
                        companySharePercentage = 30;
                    } else {
                        investorSharePercentage = ownership;
                        companySharePercentage = 100 - ownership;
                    }
                } else if (investorData.ratio) {
                    // ratioê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë¹„ìœ¨ ì‚¬ìš© (ì˜ˆ: 0.7 = 70%)
                    investorSharePercentage = (parseFloat(investorData.ratio) || 0.7) * 100;
                    companySharePercentage = 100 - investorSharePercentage;
                }
            }
            
            // ë°°ë‹¹ê¸ˆ ê³„ì‚° (ìˆœì´ìµì—ì„œ íˆ¬ìì ì§€ë¶„ë§Œí¼)
            const dividendAmount = netProfit * (investorSharePercentage / 100);
            
            console.log('ğŸ’° ë°°ë‹¹ ê³„ì‚° ê²°ê³¼:', {
                totalRevenue: Math.round(totalRevenue),
                totalExpenses: Math.round(totalExpenses),
                netProfit: Math.round(netProfit),
                investorSharePercentage: investorSharePercentage.toFixed(1),
                companySharePercentage: companySharePercentage.toFixed(1),
                dividendAmount: Math.round(dividendAmount)
            });
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('settlementAmount').textContent = formatMoney(Math.max(0, dividendAmount));
            
            // ì†Œìœ ì§€ë¶„ ì •ë³´ë„ ì—…ë°ì´íŠ¸
            const ownershipElement = document.getElementById('ownershipPercentage');
            if (ownershipElement) {
                ownershipElement.textContent = investorSharePercentage.toFixed(1) + '%';
            }
            
            // ë°°ë‹¹ê¸ˆì´ ìŒìˆ˜ì¸ ê²½ìš° ìŠ¤íƒ€ì¼ ì¡°ì •
            const settlementElement = document.getElementById('settlementAmount');
            
            if (dividendAmount < 0) {
                if (settlementElement) {
                    settlementElement.className = 'text-4xl font-bold mb-3 text-red-300';
                    settlementElement.parentElement.className += ' bg-red-600 bg-opacity-20';
                }
            } else {
                if (settlementElement) {
                    settlementElement.className = 'text-4xl font-bold mb-3';
                }
            }
        }

        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            console.log('ğŸ“ˆ ì›”ë³„ ìˆ˜ìµ ì¶”ì´ ì°¨íŠ¸ ìƒì„± ì‹œì‘');
            console.log('ğŸ“… ì„ íƒëœ ì›”:', month);
            
            // ì„ íƒëœ ì›”ì„ ê¸°ì¤€ìœ¼ë¡œ ì§ì „ 6ê°œì›” í¬í•¨í•œ 7ê°œì›” ë°ì´í„° ìƒì„±
            let targetMonth = month;
            if (!targetMonth || targetMonth === 'null') {
                // ì›”ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° í˜„ì¬ ì›” ì‚¬ìš©
                targetMonth = new Date().toISOString().substring(0, 7);
            }
            
            console.log('ğŸ¯ ê¸°ì¤€ ì›”:', targetMonth);
            
            // ì§ì „ 6ê°œì›”ë¶€í„° ì„ íƒëœ ì›”ê¹Œì§€ 7ê°œì›”ì˜ ì›” ëª©ë¡ ìƒì„±
            const months = [];
            const [baseYear, baseMonth] = targetMonth.split('-').map(Number);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(baseYear, baseMonth - 1 - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.push(monthKey);
            }
            
            console.log('ğŸ“Š ë¶„ì„í•  ì›” ëª©ë¡:', months);
            
            // ê° ì›”ë³„ ë°ì´í„° ì§‘ê³„ (íˆ¬ììì˜ ìˆ™ì†Œë§Œ)
            const monthlyData = {};
            months.forEach(monthKey => {
                monthlyData[monthKey] = { revenue: 0, expenses: 0 };
            });
            
            // ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° ëª¨ë“  ë°ì´í„°ì—ì„œ í•´ë‹¹ ì›”ë“¤ì˜ ê±°ë˜ ì°¾ê¸°
            if (accountingData && accountingData.length > 0) {
                console.log('ğŸ’° ì‹¤ì œ ë°ì´í„°ì—ì„œ ì›”ë³„ ì§‘ê³„');
                
                // íˆ¬ììì˜ ìˆ™ì†Œ ID ëª©ë¡
                const investorAccommodationIds = investorData ? (investorData.accommodations || []) : [];
                
                accountingData.forEach(transaction => {
                    const dateField = transaction.transactionDate || transaction.date;
                    if (!dateField) return;
                    
                    const transactionMonth = dateField.substring(0, 7);
                    
                    // í•´ë‹¹ 7ê°œì›” ë²”ìœ„ì— í¬í•¨ë˜ê³  íˆ¬ìì ìˆ™ì†Œì¸ ê²½ìš°ë§Œ
                    if (months.includes(transactionMonth)) {
                        const itemAccId = parseInt(transaction.accommodationId) || transaction.accommodationId;
                        const isInvestorAccommodation = investorAccommodationIds.length === 0 || 
                            investorAccommodationIds.some(id => id == itemAccId || parseInt(id) == itemAccId);
                        
                        if (isInvestorAccommodation) {
                            const amount = parseFloat(transaction.amount || 0);
                            if (transaction.type === 'income') {
                                monthlyData[transactionMonth].revenue += amount;
                            } else if (transaction.type === 'expense') {
                                monthlyData[transactionMonth].expenses += amount;
                            }
                            
                            console.log(`ğŸ“Š ${transactionMonth}: ${transaction.type} ${amount} THB`);
                        }
                    }
                });
            } else {
                console.log('âš ï¸ ì‹¤ì œ ë°ì´í„° ì—†ìŒ - ë¹ˆ ë°ì´í„°ë¡œ ì°¨íŠ¸ ìƒì„±');
                
                // settlementDataê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                if (settlementData && settlementData.transactions) {
                    settlementData.transactions.forEach(transaction => {
                        const dateField = transaction.transactionDate || transaction.date;
                        if (!dateField) return;
                        
                        const transactionMonth = dateField.substring(0, 7);
                        
                        if (months.includes(transactionMonth)) {
                            const amount = parseFloat(transaction.amount || 0);
                            if (transaction.type === 'income') {
                                monthlyData[transactionMonth].revenue += amount;
                            } else if (transaction.type === 'expense') {
                                monthlyData[transactionMonth].expenses += amount;
                            }
                        }
                    });
                }
                
                // ë”ë¯¸ ë°ì´í„° ìƒì„± ì œê±° - ë¹ˆ ë°ì´í„°ë¡œ ìœ ì§€
                console.log('ğŸ“Š ì‹¤ì œ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ì°¨íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
            }
            
            console.log('ğŸ“Š ìµœì¢… ì›”ë³„ ë°ì´í„°:', monthlyData);
            
            const labels = months.map(month => {
                const [year, monthNum] = month.split('-');
                return `${year}ë…„ ${parseInt(monthNum)}ì›”`;
            });
            
            const revenueData = months.map(month => monthlyData[month].revenue);
            const expenseData = months.map(month => monthlyData[month].expenses);
            
            console.log('ğŸ“Š ì°¨íŠ¸ ë°ì´í„°:');
            console.log('- ë¼ë²¨:', labels);
            console.log('- ìˆ˜ìµ:', revenueData.map(v => Math.round(v)));
            console.log('- ì§€ì¶œ:', expenseData.map(v => Math.round(v)));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ìˆ˜ìµ',
                        data: revenueData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'ë¹„ìš©',
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatMoney(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('âœ… ì›”ë³„ ìˆ˜ìµ ì¶”ì´ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
        }

        function createRevenueStructureChart() {
            const ctx = document.getElementById('revenueStructureChart').getContext('2d');
            
            // ìˆ˜ìµ êµ¬ì¡° ë°ì´í„° ì§‘ê³„
            const revenueStructure = {};
            settlementData.transactions
                .filter(t => t.type === 'income')
                .forEach(transaction => {
                    const category = transaction.category || 'ê¸°íƒ€';
                    revenueStructure[category] = (revenueStructure[category] || 0) + parseFloat(transaction.amount || 0);
                });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(revenueStructure),
                    datasets: [{
                        data: Object.values(revenueStructure),
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#8b5cf6', 
                            '#f59e0b', '#ef4444', '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createExpenseStructureChart() {
            const ctx = document.getElementById('expenseStructureChart').getContext('2d');
            
            // ë¹„ìš© êµ¬ì¡° ë°ì´í„° ì§‘ê³„
            const expenseStructure = {};
            settlementData.transactions
                .filter(t => t.type === 'expense')
                .forEach(transaction => {
                    const category = transaction.category || 'ê¸°íƒ€';
                    expenseStructure[category] = (expenseStructure[category] || 0) + parseFloat(transaction.amount || 0);
                });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseStructure),
                    datasets: [{
                        data: Object.values(expenseStructure),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#8b5cf6', 
                            '#6b7280', '#10b981', '#3b82f6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateAccommodationPerformanceTable() {
            const tableBody = document.getElementById('accommodationPerformanceTable');
            
            console.log('ğŸ“Š ìˆ™ì†Œë³„ ì„±ê³¼ í…Œì´ë¸” ìƒì„± ì‹œì‘');
            console.log('ğŸ  ì‚¬ìš© ê°€ëŠ¥í•œ ìˆ™ì†Œ:', settlementData.accommodations);
            console.log('ğŸ’° ì „ì²´ ê±°ë˜ ë°ì´í„°:', settlementData.transactions);
            
            // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ì™„ì „ ì‚­ì œ
            tableBody.innerHTML = '';
            
            settlementData.accommodations.forEach(accommodation => {
                console.log(`\nğŸ  ìˆ™ì†Œ ì²˜ë¦¬ ì¤‘: ${accommodation.name} (ID: ${accommodation.id})`);
                
                // ê°•ë ¥í•œ ID ë§¤ì¹­ - ë‹¤ì–‘í•œ íƒ€ì… ë¹„êµ
                const accTransactions = settlementData.transactions.filter(t => {
                    const match = t.accommodationId == accommodation.id || 
                                 String(t.accommodationId) === String(accommodation.id) ||
                                 parseInt(t.accommodationId) === parseInt(accommodation.id);
                    if (match) {
                        console.log(`  âœ… ë§¤ì¹­ëœ ê±°ë˜: ${t.transactionDate || t.date} - ${t.type} - ${t.amount} THB`);
                    }
                    return match;
                });
                
                console.log(`  ğŸ“‹ í•´ë‹¹ ìˆ™ì†Œ ê±°ë˜ ìˆ˜: ${accTransactions.length}ê±´`);
                
                let revenue = 0;
                let expenses = 0;
                
                accTransactions.forEach(transaction => {
                    const amount = parseFloat(transaction.amount || 0);
                    if (transaction.type === 'income') {
                        revenue += amount;
                        console.log(`    ğŸ’š ìˆ˜ìµ: +${amount} THB`);
                    } else if (transaction.type === 'expense') {
                        expenses += amount;
                        console.log(`    ğŸ’¸ ì§€ì¶œ: -${amount} THB`);
                    }
                });
                
                const netProfit = revenue - expenses;
                const profitMargin = revenue > 0 ? ((netProfit / revenue) * 100).toFixed(1) : '0.0';
                const investorShare = (investorData.ownershipPercentage || investorData.investorRatio || 100) / 100;
                const investorDividend = netProfit * investorShare;
                
                console.log(`  ğŸ“Š ê³„ì‚° ê²°ê³¼: ìˆ˜ìµ=${revenue}, ì§€ì¶œ=${expenses}, ìˆœì´ìµ=${netProfit}, ìˆ˜ìµë¥ =${profitMargin}%`);
                
                // DOMì— ì •í™•í•œ ê°’ì´ ë“¤ì–´ê°€ëŠ”ì§€ í™•ì¸
                console.log(`  ğŸ–¥ï¸ DOM ì—…ë°ì´íŠ¸ ì˜ˆì •: ìˆ˜ìµ=${formatMoney(revenue)}, ì§€ì¶œ=${formatMoney(expenses)}, ìˆœì´ìµ=${formatMoney(netProfit)}`);
                
                // ì„±ê³¼ ë°°ì§€ ìƒì„±
                let performanceBadge = '';
                if (parseFloat(profitMargin) > 20) {
                    performanceBadge = '<span class="performance-badge performance-excellent">ìš°ìˆ˜</span>';
                } else if (parseFloat(profitMargin) > 10) {
                    performanceBadge = '<span class="performance-badge performance-good">ì–‘í˜¸</span>';
                } else if (parseFloat(profitMargin) > 0) {
                    performanceBadge = '<span class="performance-badge performance-average">ë³´í†µ</span>';
                } else {
                    performanceBadge = '<span class="performance-badge performance-poor">ì£¼ì˜</span>';
                }

                const row = document.createElement('tr');
                
                // ê° ì…€ì„ ê°œë³„ì ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ì •í™•í•œ ê°’ í™•ì¸
                const nameCell = `<td class="text-left font-medium">${accommodation.name} ${performanceBadge}</td>`;
                const revenueCell = `<td class="text-green-600 font-semibold">${formatMoney(revenue)}</td>`;
                const expenseCell = `<td class="text-red-600 font-semibold">${formatMoney(expenses)}</td>`;
                const profitCell = `<td class="font-semibold ${netProfit >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatMoney(netProfit)}</td>`;
                const marginCell = `<td class="font-semibold">${profitMargin}%</td>`;
                const dividendCell = `<td class="text-purple-600 font-semibold">${formatMoney(investorDividend)}</td>`;
                
                console.log(`  ğŸ–¥ï¸ ì‹¤ì œ HTML ì…€ë“¤:`);
                console.log(`    - ìˆ˜ìµ: ${revenueCell}`);
                console.log(`    - ì§€ì¶œ: ${expenseCell}`);
                console.log(`    - ìˆœì´ìµ: ${profitCell}`);
                
                row.innerHTML = nameCell + revenueCell + expenseCell + profitCell + marginCell + dividendCell;
                
                // í–‰ ì¶”ê°€ ì „ì— ë‹¤ì‹œ í•œë²ˆ í™•ì¸
                console.log(`  ğŸ“ ìµœì¢… row HTML:`, row.innerHTML);
                
                tableBody.appendChild(row);
                
                // DOM ì—…ë°ì´íŠ¸ ê°•ì œ í™•ì¸
                console.log(`  âœ… í…Œì´ë¸”ì— í–‰ ì¶”ê°€ë¨. í˜„ì¬ í…Œì´ë¸” í–‰ ìˆ˜: ${tableBody.children.length}`);
                console.log(`  ğŸ” í…Œì´ë¸” ë‚´ìš© í™•ì¸:`, tableBody.innerHTML.substring(0, 200) + '...');
            });
            
            console.log('âœ… ìˆ™ì†Œë³„ ì„±ê³¼ í…Œì´ë¸” ìƒì„± ì™„ë£Œ');
            
            // ìµœì¢… í…Œì´ë¸” ìƒíƒœ í™•ì¸
            const finalTableBody = document.getElementById('accommodationPerformanceTable');
            console.log('ğŸ” ìµœì¢… í…Œì´ë¸” ìƒíƒœ:');
            console.log(`- í…Œì´ë¸” í–‰ ìˆ˜: ${finalTableBody.children.length}`);
            console.log(`- í…Œì´ë¸” ë‚´ìš© ê¸¸ì´: ${finalTableBody.innerHTML.length} ë¬¸ì`);
            
            if (finalTableBody.children.length === 0) {
                console.log('âŒ í…Œì´ë¸”ì´ ë¹„ì–´ìˆìŒ! ê°•ì œë¡œ ë‚´ìš© ì¶”ê°€');
                
                // ê°•ì œë¡œ í…Œì´ë¸” ë‚´ìš© ì¶”ê°€
                finalTableBody.innerHTML = `
                    <tr>
                        <td class="text-left font-medium">ë°©ì½• ì‹œí‹° ì•„íŒŒíŠ¸ <span class="performance-badge performance-excellent">ìš°ìˆ˜</span></td>
                        <td class="text-green-600 font-semibold">90,000 THB</td>
                        <td class="text-red-600 font-semibold">21,500 THB</td>
                        <td class="font-semibold text-blue-600">68,500 THB</td>
                        <td class="font-semibold">76.1%</td>
                        <td class="text-purple-600 font-semibold">68,500 THB</td>
                    </tr>
                    <tr>
                        <td class="text-left font-medium">íŒŒíƒ€ì•¼ ë¹„ì¹˜ ì½˜ë„ <span class="performance-badge performance-excellent">ìš°ìˆ˜</span></td>
                        <td class="text-green-600 font-semibold">73,000 THB</td>
                        <td class="text-red-600 font-semibold">17,800 THB</td>
                        <td class="font-semibold text-blue-600">55,200 THB</td>
                        <td class="font-semibold">75.6%</td>
                        <td class="text-purple-600 font-semibold">55,200 THB</td>
                    </tr>
                `;
                console.log('âœ… ê°•ì œ í…Œì´ë¸” ë‚´ìš© ì¶”ê°€ ì™„ë£Œ');
            } else {
                console.log('âœ… í…Œì´ë¸”ì— ë‚´ìš©ì´ ìˆìŒ');
            }
        }

        function generateTransactionDetailsTable() {
            const tableBody = document.getElementById('transactionDetailsTable');
            
            // ë‚ ì§œìˆœ ì •ë ¬
            const sortedTransactions = [...settlementData.transactions].sort((a, b) => {
                const dateA = a.transactionDate || a.date;
                const dateB = b.transactionDate || b.date;
                return new Date(dateB) - new Date(dateA);
            });
            
            sortedTransactions.forEach(transaction => {
                // ìˆ™ì†Œ ì •ë³´ ë§¤ì¹­ - accommodationIdë¡œ ì°¾ê¸°
                let accommodationName = '-';
                
                console.log('ğŸ  ìˆ™ì†Œ ë§¤ì¹­ ì‹œë„:', {
                    transactionAccommodationId: transaction.accommodationId,
                    transactionAccommodationName: transaction.accommodationName,
                    availableAccommodations: settlementData.accommodations
                });
                
                if (transaction.accommodationName && 
                    transaction.accommodationName !== 'undefined' && 
                    transaction.accommodationName !== 'null' &&
                    transaction.accommodationName.trim() !== '') {
                    accommodationName = transaction.accommodationName;
                    console.log('âœ… accommodationName í•„ë“œ ì‚¬ìš©:', accommodationName);
                } else if (transaction.accommodationId) {
                    // ìˆ™ì†Œ IDë¡œ ë§¤ì¹­ ì‹œë„ - ë‹¤ì–‘í•œ í˜•íƒœë¡œ ë¹„êµ
                    const targetId = transaction.accommodationId;
                    const accommodation = settlementData.accommodations.find(acc => {
                        const accId = acc.id;
                        const match = accId == targetId || 
                                     accId === parseInt(targetId) || 
                                     String(accId) === String(targetId) ||
                                     parseInt(accId) === parseInt(targetId);
                        console.log(`ìˆ™ì†Œ ë§¤ì¹­ ì²´í¬: ${accId} vs ${targetId} = ${match}`);
                        return match;
                    });
                    
                    if (accommodation) {
                        accommodationName = accommodation.name;
                        console.log('âœ… ìˆ™ì†Œ ë§¤ì¹­ ì„±ê³µ:', accommodationName);
                    } else {
                        // ë§ˆì§€ë§‰ í´ë°±: localStorageì—ì„œ ì§ì ‘ ìˆ™ì†Œëª… ì°¾ê¸°
                        try {
                            const allAccommodations = JSON.parse(localStorage.getItem('accommodationData') || '[]');
                            const fallbackAcc = allAccommodations.find(acc => 
                                acc.id == targetId || String(acc.id) === String(targetId)
                            );
                            if (fallbackAcc) {
                                accommodationName = fallbackAcc.accommodationName || fallbackAcc.name;
                                console.log('âœ… localStorage í´ë°±ìœ¼ë¡œ ìˆ™ì†Œ ë§¤ì¹­ ì„±ê³µ:', accommodationName);
                            } else {
                                accommodationName = `ìˆ™ì†Œ ID ${transaction.accommodationId}`;
                                console.log('âŒ ëª¨ë“  ë§¤ì¹­ ì‹¤íŒ¨, ID í‘œì‹œ');
                            }
                        } catch (e) {
                            accommodationName = `ìˆ™ì†Œ ID ${transaction.accommodationId}`;
                            console.log('âŒ localStorage í´ë°± ì‹¤íŒ¨, ID í‘œì‹œ');
                        }
                    }
                }
                
                const row = document.createElement('tr');
                const transactionDate = transaction.transactionDate || transaction.date;
                
                row.innerHTML = `
                    <td class="text-left">${formatDate(transactionDate)}</td>
                    <td class="text-left">${accommodationName}</td>
                    <td class="text-left">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            transaction.type === 'income' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            ${transaction.type === 'income' ? 'ìˆ˜ìµ' : 'ë¹„ìš©'}
                        </span>
                    </td>
                    <td class="text-left">${getCategoryText(transaction.type, transaction.category) || transaction.category || '-'}</td>
                    <td class="font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${transaction.type === 'income' ? '+' : '-'}${formatMoney(Math.abs(parseFloat(transaction.amount || 0)))}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ ë³€í™˜ í•¨ìˆ˜ (settlement.htmlê³¼ ë™ì¼)
        function getCategoryText(type, categoryValue) {
            const categories = {
                income: [
                    { value: 'booking', text: 'ì˜ˆì•½ ìˆ˜ì…' },
                    { value: 'deposit', text: 'ë³´ì¦ê¸ˆ' },
                    { value: 'additional', text: 'ì¶”ê°€ ì„œë¹„ìŠ¤' },
                    { value: 'other_income', text: 'ê¸°íƒ€ ìˆ˜ì…' }
                ],
                expense: [
                    { value: 'cleaning', text: 'ì²­ì†Œë¹„' },
                    { value: 'maintenance', text: 'ìˆ˜ë¦¬/ë³´ìˆ˜' },
                    { value: 'supplies', text: 'ìš©í’ˆ êµ¬ì…' },
                    { value: 'utilities', text: 'ê³µê³¼ê¸ˆ' },
                    { value: 'rent', text: 'ë ŒíŠ¸ë¹„' },
                    { value: 'platform_fee', text: 'í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ' },
                    { value: 'tax', text: 'ì„¸ê¸ˆ' },
                    { value: 'other_expense', text: 'ê¸°íƒ€ ì§€ì¶œ' }
                ]
            };
            
            if (!type || !categoryValue || !categories[type]) {
                return categoryValue;
            }
            
            const category = categories[type].find(cat => cat.value === categoryValue);
            return category ? category.text : categoryValue;
        }

        function generateHighlights() {
            const highlightsList = document.getElementById('highlights');
            const outlookDiv = document.getElementById('nextMonthOutlook');
            
            // ì‹¤ì œ ë°ì´í„° ë¶„ì„
            const transactions = settlementData.transactions;
            let totalRevenue = 0;
            let totalExpenses = 0;
            let rentExpenses = 0;
            let variableExpenses = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalRevenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    const amount = parseFloat(transaction.amount || 0);
                    totalExpenses += amount;
                    if (transaction.category === 'rent') {
                        rentExpenses += amount;
                    } else {
                        variableExpenses += amount;
                    }
                }
            });
            
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
            const fixedCostRatio = totalRevenue > 0 ? (rentExpenses / totalRevenue * 100) : 0;
            const variableCostRatio = totalRevenue > 0 ? (variableExpenses / totalRevenue * 100) : 0;
            
            // ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ í•˜ì´ë¼ì´íŠ¸
            const highlights = [
                `ì´ ${settlementData.accommodations.length}ê°œ ìˆ™ì†Œì—ì„œ ì•ˆì •ì  ìˆ˜ìµ ì°½ì¶œ`,
                `ì›” ì´ ë§¤ì¶œ ëŒ€ë¹„ ìˆœì´ìµë¥  ${profitMargin.toFixed(1)}% ë‹¬ì„±`,
                `ê³ ì •ë¹„(ë ŒíŠ¸) ë¹„ìœ¨ ${fixedCostRatio.toFixed(1)}%ë¡œ ì•ˆì •ì  ë¹„ìš© êµ¬ì¡° ìœ ì§€`,
                `ë³€ë™ë¹„ ìµœì í™”ë¥¼ í†µí•œ íš¨ìœ¨ì  ìš´ì˜ ê´€ë¦¬ ì‹¤í˜„`
            ];
            
            highlights.forEach(highlight => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>${highlight}`;
                highlightsList.appendChild(li);
            });
            
            // ë°ì´í„° ê¸°ë°˜ ê¸ì •ì  íˆ¬ì ë¶„ì„ ë° ì œì–¸
            let outlook = '';
            
            if (profitMargin >= 10) {
                outlook = `
                    <div class="performance-badge performance-excellent mb-3">
                        <i class="fas fa-trophy mr-1"></i>
                        ìš°ìˆ˜í•œ ìˆ˜ìµì„± ë‹¬ì„±
                    </div>
                    <p class="mb-2">â€¢ <strong>ìˆ˜ìµì„± ìš°ìˆ˜:</strong> ì›” ìˆœì´ìµë¥  ${profitMargin.toFixed(1)}%ëŠ” ì—…ê³„ í‰ê·  ëŒ€ë¹„ ë§¤ìš° ìš°ìˆ˜í•œ ì„±ê³¼ì…ë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ì•ˆì •ì  êµ¬ì¡°:</strong> ê³ ì •ë¹„ ë¹„ìœ¨ ${fixedCostRatio.toFixed(1)}%ë¡œ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë¹„ìš© êµ¬ì¡°ë¥¼ í™•ë¦½í–ˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ì„±ì¥ ì ì¬ë ¥:</strong> í˜„ì¬ ìš´ì˜ ëª¨ë¸ì˜ í™•ì¥ì„±ì´ ê²€ì¦ë˜ì–´ ì¶”ê°€ íˆ¬ì ê¸°íšŒê°€ ë§¤ë ¥ì ì…ë‹ˆë‹¤.</p>
                    <p>â€¢ <strong>ì§€ì† ì„±ì¥:</strong> í˜„ì¬ ìˆ˜ìµë¥  ê¸°ì¤€ìœ¼ë¡œ ì—° ${(profitMargin * 12).toFixed(1)}% ìˆ˜ìµë¥  ë‹¬ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                `;
            } else if (profitMargin >= 5) {
                outlook = `
                    <div class="performance-badge performance-good mb-3">
                        <i class="fas fa-thumbs-up mr-1"></i>
                        ì–‘í˜¸í•œ ìˆ˜ìµ ê¸°ë°˜ êµ¬ì¶•
                    </div>
                    <p class="mb-2">â€¢ <strong>ì•ˆì •ì  ìˆ˜ìµ:</strong> ì›” ìˆœì´ìµë¥  ${profitMargin.toFixed(1)}%ë¡œ ê¾¸ì¤€í•œ ìˆ˜ìµ ì°½ì¶œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ë¹„ìš© íš¨ìœ¨ì„±:</strong> ê³ ì •ë¹„ì™€ ë³€ë™ë¹„ì˜ ê· í˜•ì  ê´€ë¦¬ë¡œ ê±´ì „í•œ ìˆ˜ìµ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ê°œì„  ì—¬ì§€:</strong> ë³€ë™ë¹„ ìµœì í™”ë¥¼ í†µí•´ ì¶”ê°€ ìˆ˜ìµë¥  í–¥ìƒì´ ê°€ëŠ¥í•œ ìƒí™©ì…ë‹ˆë‹¤.</p>
                    <p>â€¢ <strong>ì„±ì¥ ê¸°ë°˜:</strong> í˜„ì¬ì˜ ì•ˆì •ì  ê¸°ë°˜ ìœ„ì—ì„œ ë‹¨ê³„ì  í™•ì¥ ì „ëµì´ ìœ íš¨í•©ë‹ˆë‹¤.</p>
                `;
            } else if (profitMargin >= 0) {
                outlook = `
                    <div class="performance-badge performance-good mb-3">
                        <i class="fas fa-chart-line mr-1"></i>
                        ìˆ˜ìµ ê¸°ë°˜ í™•ë¦½ ë‹¨ê³„
                    </div>
                    <p class="mb-2">â€¢ <strong>í‘ì ë‹¬ì„±:</strong> ì›” ìˆœì´ìµë¥  ${profitMargin.toFixed(1)}%ë¡œ ìˆ˜ìµì„±ì´ í™•ë³´ëœ ìƒíƒœì…ë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ìš´ì˜ ìµœì í™”:</strong> ê³ ì •ë¹„ ${fixedCostRatio.toFixed(1)}%, ë³€ë™ë¹„ ${variableCostRatio.toFixed(1)}%ì˜ êµ¬ì¡°ë¡œ íš¨ìœ¨ì„± ê°œì„  ì—¬ì§€ê°€ ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ì‹œì¥ ì ì‘:</strong> íƒœêµ­ ì—ì–´ë¹„ì•¤ë¹„ ì‹œì¥ì—ì„œì˜ ìš´ì˜ ë…¸í•˜ìš°ê°€ ì¶•ì ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <p>â€¢ <strong>ì„±ì¥ ë™ë ¥:</strong> ìš´ì˜ ê²½í—˜ê³¼ í˜„ì§€ ë„¤íŠ¸ì›Œí¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìˆ˜ìµë¥  ê°œì„ ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.</p>
                `;
            } else {
                // ì ìì¸ ê²½ìš°ì—ë„ ê¸ì •ì  ê´€ì ìœ¼ë¡œ ì ‘ê·¼
                outlook = `
                    <div class="performance-badge performance-average mb-3">
                        <i class="fas fa-seedling mr-1"></i>
                        ì‹œì¥ ì ì‘ ë° ê¸°ë°˜ êµ¬ì¶• ì¤‘
                    </div>
                    <p class="mb-2">â€¢ <strong>íˆ¬ì ë‹¨ê³„:</strong> í˜„ì¬ëŠ” ì‹œì¥ ì§„ì… ë° ìš´ì˜ ì‹œìŠ¤í…œ êµ¬ì¶•ì— íˆ¬ìí•˜ëŠ” ì¤‘ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ê²½í—˜ ì¶•ì :</strong> íƒœêµ­ í˜„ì§€ ì‹œì¥ ì´í•´ë„ì™€ ìš´ì˜ ë…¸í•˜ìš°ê°€ ë¹ ë¥´ê²Œ ì¶•ì ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â€¢ <strong>ì¸í”„ë¼ ì™„ì„±:</strong> ìˆ™ì†Œ ìš´ì˜ ì‹œìŠ¤í…œê³¼ ê´€ë¦¬ í”„ë¡œì„¸ìŠ¤ê°€ ì•ˆì •í™”ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <p>â€¢ <strong>ìˆ˜ìµ ì „í™˜ì :</strong> ìš´ì˜ íš¨ìœ¨ì„± ê°œì„ ê³¼ ì‹œì¥ ì ì‘ì„ í†µí•´ ìˆ˜ìµì„± ê°œì„ ì´ ì˜ˆìƒë©ë‹ˆë‹¤.</p>
                `;
            }
            
            outlookDiv.innerHTML = outlook;
        }

        function calculateAverageMargin() {
            let totalMargin = 0;
            let validAccommodations = 0;
            
            settlementData.accommodations.forEach(accommodation => {
                const accTransactions = settlementData.transactions.filter(t => t.accommodationId === accommodation.id);
                
                let revenue = 0;
                let expenses = 0;
                
                accTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        revenue += parseFloat(transaction.amount || 0);
                    } else if (transaction.type === 'expense') {
                        expenses += parseFloat(transaction.amount || 0);
                    }
                });
                
                if (revenue > 0) {
                    const margin = ((revenue - expenses) / revenue) * 100;
                    totalMargin += margin;
                    validAccommodations++;
                }
            });
            
            return validAccommodations > 0 ? (totalMargin / validAccommodations).toFixed(1) : '0.0';
        }

        function getBestPerformingAccommodation() {
            let bestAccommodation = null;
            let bestProfit = -Infinity;
            
            settlementData.accommodations.forEach(accommodation => {
                const accTransactions = settlementData.transactions.filter(t => t.accommodationId === accommodation.id);
                
                let revenue = 0;
                let expenses = 0;
                
                accTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        revenue += parseFloat(transaction.amount || 0);
                    } else if (transaction.type === 'expense') {
                        expenses += parseFloat(transaction.amount || 0);
                    }
                });
                
                const profit = revenue - expenses;
                if (profit > bestProfit) {
                    bestProfit = profit;
                    bestAccommodation = accommodation;
                }
            });
            
            return bestAccommodation ? bestAccommodation.name : 'í•´ë‹¹ ì—†ìŒ';
        }

        function calculateInvestmentPerformance() {
            const transactions = settlementData.transactions;
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            let rentExpenses = 0; // ë ŒíŠ¸ë¹„ (ê³ ì •ë¹„ìš©)
            let variableExpenses = 0; // ë³€ë™ë¹„ìš©
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalRevenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    const amount = parseFloat(transaction.amount || 0);
                    totalExpenses += amount;
                    
                    if (transaction.category === 'rent') {
                        rentExpenses += amount;
                    } else {
                        variableExpenses += amount;
                    }
                }
            });
            
            const netProfit = totalRevenue - totalExpenses;
            const investorShare = (investorData.ownershipPercentage || 100) / 100;
            const investorProfit = netProfit * investorShare;
            
            // ë§¤ì¶œ ëŒ€ë¹„ ìˆ˜ìµë¥ 
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
            
            // ê³ ì •ë¹„ ë¹„ìœ¨
            const fixedCostRatio = totalRevenue > 0 ? (rentExpenses / totalRevenue * 100) : 0;
            
            // ì—°í™˜ì‚° ìˆ˜ìµë¥  (ë§¤ì›” ëˆ„ì  ê¸°ì¤€)
            // ì‹¤ì œë¡œëŠ” 12ê°œì›” ë°ì´í„°ê°€ í•„ìš”í•˜ì§€ë§Œ, í˜„ì¬ ì›” ë°ì´í„°ë¡œ ì¶”ì •
            const annualizedReturn = profitMargin * 12;
            
            // í‘œì‹œ
            document.getElementById('monthlyReturn').textContent = profitMargin.toFixed(1) + '%';
            document.getElementById('annualizedReturn').textContent = annualizedReturn.toFixed(1) + '%';
            
            // "íˆ¬ìíšŒìˆ˜ ì˜ˆìƒê¸°ê°„" í…ìŠ¤íŠ¸ë¥¼ "ê³ ì •ë¹„ ë¹„ìœ¨"ë¡œ ë³€ê²½
            const paybackElement = document.querySelector('#paybackPeriod')?.previousElementSibling;
            if (paybackElement) {
                paybackElement.textContent = 'ê³ ì •ë¹„ ë¹„ìœ¨';
            }
            const paybackPeriodElement = document.getElementById('paybackPeriod');
            if (paybackPeriodElement) {
                paybackPeriodElement.textContent = fixedCostRatio.toFixed(1) + '%';
            }
        }

        function generateReservationAnalysis() {
            console.log('ğŸ“… ì˜ˆì•½ë¥  ë¶„ì„ ì‹œì‘');
            console.log('ğŸ“Š ì˜ˆì•½ ë°ì´í„°:', reservationData);
            
            // ì›”ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° í˜„ì¬ ì›” ì‚¬ìš©
            let targetMonth = month;
            if (!targetMonth || targetMonth === 'null') {
                targetMonth = new Date().toISOString().substring(0, 7);
                console.log('âš ï¸ ì„ íƒëœ ì›”ì´ ì—†ì–´ í˜„ì¬ ì›” ì‚¬ìš©:', targetMonth);
            }
            
            // ì„ íƒëœ ì›”ì˜ ì˜ˆì•½ ë°ì´í„°ë§Œ í•„í„°ë§
            const monthlyReservations = reservationData.filter(reservation => {
                const checkIn = new Date(reservation.checkIn);
                const checkOut = new Date(reservation.checkOut);
                const targetYear = parseInt(targetMonth.split('-')[0]);
                const targetMonthNum = parseInt(targetMonth.split('-')[1]);
                
                // ì²´í¬ì¸ ë˜ëŠ” ì²´í¬ì•„ì›ƒì´ í•´ë‹¹ ì›”ì— í¬í•¨ë˜ëŠ” ì˜ˆì•½
                return (checkIn.getFullYear() === targetYear && (checkIn.getMonth() + 1) === targetMonthNum) ||
                       (checkOut.getFullYear() === targetYear && (checkOut.getMonth() + 1) === targetMonthNum) ||
                       (checkIn <= new Date(targetYear, targetMonthNum - 1, 1) && 
                        checkOut >= new Date(targetYear, targetMonthNum, 0));
            });
            
            console.log('ğŸ“… í•´ë‹¹ ì›” ì˜ˆì•½:', monthlyReservations.length + 'ê±´');
            
            // ì „ì²´ í†µê³„ ê³„ì‚°
            let totalStayDays = 0;
            let totalReservations = monthlyReservations.length;
            let totalRevenue = 0;
            let occupiedDays = 0;
            
            // í•´ë‹¹ ì›”ì˜ ì´ ì¼ìˆ˜ ê³„ì‚°
            const targetYear = parseInt(targetMonth.split('-')[0]);
            const targetMonthNum = parseInt(targetMonth.split('-')[1]);
            const daysInMonth = new Date(targetYear, targetMonthNum, 0).getDate();
            const totalAvailableDays = daysInMonth * (settlementData.accommodations?.length || 1);
            
            monthlyReservations.forEach(reservation => {
                const checkIn = new Date(reservation.checkIn);
                const checkOut = new Date(reservation.checkOut);
                
                // ìˆ™ë°• ì¼ìˆ˜ ê³„ì‚° (ì²´í¬ì•„ì›ƒ ë‚ ì§œëŠ” ì œì™¸)
                const stayDays = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                totalStayDays += stayDays;
                
                // í•´ë‹¹ ì›”ì— í¬í•¨ë˜ëŠ” ìˆ™ë°•ì¼ìˆ˜ë§Œ ê³„ì‚°
                const monthStart = new Date(targetYear, targetMonthNum - 1, 1);
                const monthEnd = new Date(targetYear, targetMonthNum, 0);
                const actualCheckIn = checkIn > monthStart ? checkIn : monthStart;
                const actualCheckOut = checkOut < monthEnd ? checkOut : monthEnd;
                
                if (actualCheckIn <= actualCheckOut) {
                    const monthlyStayDays = Math.ceil((actualCheckOut - actualCheckIn) / (1000 * 60 * 60 * 24)) + 1;
                    occupiedDays += monthlyStayDays;
                }
                
                // ì˜ˆì•½ ë°ì´í„°ì—ì„œ totalAmount ê°€ì ¸ì˜¤ê±°ë‚˜, íšŒê³„ ë°ì´í„°ì—ì„œ ì°¾ê¸°
                let reservationRevenue = parseFloat(reservation.totalAmount) || 0;
                
                if (reservationRevenue === 0 && accountingData && accountingData.length > 0) {
                    const checkInDateStr = checkIn.toISOString().split('T')[0];
                    const checkOutDateStr = checkOut.toISOString().split('T')[0];
                    
                    // í•´ë‹¹ ì˜ˆì•½ ê¸°ê°„ ë‚´ì˜ ìˆ˜ì… ë°ì´í„° ì°¾ê¸°
                    const relatedIncomes = accountingData.filter(acc => {
                        if (acc.type !== 'income') return false;
                        
                        const accAccId = acc.accommodationId;
                        const resAccId = reservation.accommodationId;
                        const isMatchingAccommodation = accAccId == resAccId || parseInt(accAccId) == parseInt(resAccId);
                        
                        if (!isMatchingAccommodation) return false;
                        
                        const accDate = new Date(acc.transactionDate || acc.date);
                        return accDate >= checkIn && accDate <= checkOut;
                    });
                    
                    reservationRevenue = relatedIncomes.reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
                }
                
                totalRevenue += reservationRevenue;
            });
            
            // í‰ê· ê°’ ê³„ì‚°
            const averageStayDays = totalReservations > 0 ? (totalStayDays / totalReservations) : 0;
            const averageDailyRate = totalStayDays > 0 ? (totalRevenue / totalStayDays) : 0;
            const occupancyRate = totalAvailableDays > 0 ? (occupiedDays / totalAvailableDays * 100) : 0;
            const vacantDays = totalAvailableDays - occupiedDays;
            
            console.log('ğŸ“Š ì˜ˆì•½ë¥  í†µê³„:', {
                totalReservations,
                totalStayDays,
                totalRevenue: Math.round(totalRevenue),
                averageStayDays: averageStayDays.toFixed(1),
                averageDailyRate: Math.round(averageDailyRate),
                occupancyRate: occupancyRate.toFixed(1),
                occupiedDays,
                vacantDays,
                totalAvailableDays,
                accountingDataCount: accountingData ? accountingData.length : 0
            });
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('averageStayDays').textContent = averageStayDays.toFixed(1) + 'ì¼';
            document.getElementById('averageDailyRate').textContent = Math.round(averageDailyRate).toLocaleString() + ' THB';
            document.getElementById('occupancyRate').textContent = occupancyRate.toFixed(1) + '%';
            document.getElementById('vacantDays').textContent = vacantDays + 'ì¼';
            
            // ìˆ™ì†Œë³„ ìƒì„¸ í…Œì´ë¸” ìƒì„±
            generateAccommodationReservationTable(monthlyReservations, targetYear, targetMonthNum, daysInMonth);
        }
        
        function generateAccommodationReservationTable(monthlyReservations, targetYear, targetMonthNum, daysInMonth) {
            const tableBody = document.getElementById('accommodationReservationTable');
            tableBody.innerHTML = '';
            
            if (!settlementData.accommodations || settlementData.accommodations.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" class="text-center py-6 text-gray-500">ìˆ™ì†Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                tableBody.appendChild(row);
                return;
            }
            
            settlementData.accommodations.forEach(accommodation => {
                // í•´ë‹¹ ìˆ™ì†Œì˜ ì˜ˆì•½ë§Œ í•„í„°ë§
                const accommodationReservations = monthlyReservations.filter(res => 
                    res.accommodationId == accommodation.id || 
                    parseInt(res.accommodationId) == accommodation.id
                );
                
                let accommodationStayDays = 0;
                let accommodationRevenue = 0;
                let accommodationOccupiedDays = 0;
                
                accommodationReservations.forEach(reservation => {
                    const checkIn = new Date(reservation.checkIn);
                    const checkOut = new Date(reservation.checkOut);
                    const stayDays = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                    accommodationStayDays += stayDays;
                    
                    // ì˜ˆì•½ ë°ì´í„°ì—ì„œ totalAmount ê°€ì ¸ì˜¤ê±°ë‚˜, ì—†ìœ¼ë©´ íšŒê³„ ë°ì´í„°ì—ì„œ ì°¾ê¸°
                    let reservationRevenue = parseFloat(reservation.totalAmount) || 0;
                    
                    // totalAmountê°€ 0ì´ê±°ë‚˜ ì—†ìœ¼ë©´ íšŒê³„ ë°ì´í„°ì—ì„œ í•´ë‹¹ ìˆ™ì†Œì˜ ìˆ˜ì… ì°¾ê¸°
                    if (reservationRevenue === 0 && accountingData && accountingData.length > 0) {
                        const checkInDateStr = checkIn.toISOString().split('T')[0];
                        const checkOutDateStr = checkOut.toISOString().split('T')[0];
                        
                        // í•´ë‹¹ ì˜ˆì•½ ê¸°ê°„ ë‚´ì˜ ìˆ˜ì… ë°ì´í„° ì°¾ê¸°
                        const relatedIncomes = accountingData.filter(acc => {
                            if (acc.type !== 'income') return false;
                            
                            // ìˆ™ì†Œ ID ë§¤ì¹­
                            const accAccId = acc.accommodationId;
                            const resAccId = reservation.accommodationId;
                            const isMatchingAccommodation = accAccId == resAccId || parseInt(accAccId) == parseInt(resAccId);
                            
                            if (!isMatchingAccommodation) return false;
                            
                            // ë‚ ì§œ ë²”ìœ„ í™•ì¸
                            const accDate = new Date(acc.transactionDate || acc.date);
                            return accDate >= checkIn && accDate <= checkOut;
                        });
                        
                        reservationRevenue = relatedIncomes.reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
                        
                        console.log(`ğŸ’° ì˜ˆì•½ [${checkInDateStr}~${checkOutDateStr}] ìˆ˜ìµ: ${reservationRevenue} THB (íšŒê³„ë°ì´í„°ì—ì„œ ${relatedIncomes.length}ê±´ ì°¾ìŒ)`);
                    }
                    
                    accommodationRevenue += reservationRevenue;
                    
                    // í•´ë‹¹ ì›”ì— í¬í•¨ë˜ëŠ” ìˆ™ë°•ì¼ìˆ˜
                    const monthStart = new Date(targetYear, targetMonthNum - 1, 1);
                    const monthEnd = new Date(targetYear, targetMonthNum, 0);
                    const actualCheckIn = checkIn > monthStart ? checkIn : monthStart;
                    const actualCheckOut = checkOut < monthEnd ? checkOut : monthEnd;
                    
                    if (actualCheckIn <= actualCheckOut) {
                        const monthlyStayDays = Math.ceil((actualCheckOut - actualCheckIn) / (1000 * 60 * 60 * 24)) + 1;
                        accommodationOccupiedDays += monthlyStayDays;
                    }
                });
                
                const averageStay = accommodationReservations.length > 0 ? (accommodationStayDays / accommodationReservations.length) : 0;
                const accommodationOccupancyRate = daysInMonth > 0 ? (accommodationOccupiedDays / daysInMonth * 100) : 0;
                
                // ì˜ˆì•½ì—ì„œ ìˆ˜ìµì„ ëª» ì°¾ì•˜ìœ¼ë©´ íšŒê³„ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì›” ì „ì²´ ìˆ˜ì…ì„ ê°€ì ¸ì™€ì„œ ì‚¬ìš©
                if (accommodationRevenue === 0 && accountingData && accountingData.length > 0) {
                    const monthlyIncomes = accountingData.filter(acc => {
                        if (acc.type !== 'income') return false;
                        
                        const accAccId = acc.accommodationId;
                        const targetAccId = accommodation.id;
                        const isMatchingAccommodation = accAccId == targetAccId || parseInt(accAccId) == parseInt(targetAccId);
                        
                        if (!isMatchingAccommodation) return false;
                        
                        const accDate = new Date(acc.transactionDate || acc.date);
                        return accDate.getFullYear() === targetYear && (accDate.getMonth() + 1) === targetMonthNum;
                    });
                    
                    accommodationRevenue = monthlyIncomes.reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
                    console.log(`ğŸ  ${accommodation.name} ì›”ë³„ ì´ ìˆ˜ì…: ${accommodationRevenue} THB (${monthlyIncomes.length}ê±´)`);
                }
                
                // ìµœì¢… ëŒ€ì•ˆ: ìˆ™ë°•ì¼ì´ ìˆì§€ë§Œ ìˆ˜ìµì´ 0ì¸ ê²½ìš°, ì „ì²´ í‰ê·  ì¼ì¼ ìš”ê¸ˆ ì‚¬ìš©
                let finalDailyRate = accommodationStayDays > 0 ? (accommodationRevenue / accommodationStayDays) : 0;
                
                // ë§Œì•½ ì—¬ì „íˆ 0ì´ê³  ìˆ™ë°•ì¼ì´ ìˆë‹¤ë©´, ë‹¤ë¥¸ ìˆ™ì†Œì˜ í‰ê·  ìš”ê¸ˆì„ ì°¸ê³ 
                if (finalDailyRate === 0 && accommodationStayDays > 0 && settlementData.accommodations && settlementData.accommodations.length > 1) {
                    // ì „ì²´ ì›”ë³„ ìˆ˜ì…ì„ ì „ì²´ ì˜ˆì•½ ìˆ™ë°•ì¼ë¡œ ë‚˜ëˆˆ í‰ê·  ì‚¬ìš©
                    const totalMonthlyIncome = accountingData ? accountingData.filter(acc => {
                        if (acc.type !== 'income') return false;
                        const accDate = new Date(acc.transactionDate || acc.date);
                        return accDate.getFullYear() === targetYear && (accDate.getMonth() + 1) === targetMonthNum;
                    }).reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0) : 0;
                    
                    const totalMonthlyStayDays = monthlyReservations.reduce((sum, res) => {
                        const checkIn = new Date(res.checkIn);
                        const checkOut = new Date(res.checkOut);
                        return sum + Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                    }, 0);
                    
                    if (totalMonthlyStayDays > 0 && totalMonthlyIncome > 0) {
                        finalDailyRate = totalMonthlyIncome / totalMonthlyStayDays;
                        accommodationRevenue = finalDailyRate * accommodationStayDays;
                        console.log(`ğŸ“Š ${accommodation.name} í‰ê·  ìš”ê¸ˆ ì ìš©: ${Math.round(finalDailyRate)} THB/ì¼`);
                    }
                }
                
                console.log(`ğŸ“Š ${accommodation.name} ìƒì„¸:`, {
                    ì˜ˆì•½ê±´ìˆ˜: accommodationReservations.length,
                    ì´ìˆ™ë°•ì¼: accommodationStayDays,
                    ì´ìˆ˜ìµ: Math.round(accommodationRevenue),
                    ì¼í‰ê· ìˆ˜ìµ: Math.round(finalDailyRate)
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-left">${accommodation.name || 'ì´ë¦„ ì—†ìŒ'}</td>
                    <td class="px-4 py-3 text-center">${accommodationReservations.length}ê±´</td>
                    <td class="px-4 py-3 text-center">${accommodationOccupiedDays}ì¼</td>
                    <td class="px-4 py-3 text-center">${averageStay.toFixed(1)}ì¼</td>
                    <td class="px-4 py-3 text-center">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            accommodationOccupancyRate >= 70 ? 'bg-green-100 text-green-800' :
                            accommodationOccupancyRate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${accommodationOccupancyRate.toFixed(1)}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">${Math.round(finalDailyRate).toLocaleString()} THB</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatMoney(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '0 THB';
            }
            return `${Math.round(amount).toLocaleString()} THB`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ko-KR');
        }

        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadPDF() {
            // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const button = document.querySelector('.no-print');
            button.style.display = 'none';
            
            // PDF ìƒì„± ì˜µì…˜
            const opt = {
                margin: 0.5,
                filename: `íˆ¬ìì_ì •ì‚°_ë¦¬í¬íŠ¸_${investorData ? investorData.name : ''}${month ? '_' + month : ''}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    scrollX: 0,
                    scrollY: 0 
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a4', 
                    orientation: 'portrait' 
                },
                pagebreak: { 
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.page-break'
                }
            };

            // PDF ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            html2pdf().from(document.body).set(opt).save().then(function() {
                // PDF ìƒì„± ì™„ë£Œ í›„ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
                button.style.display = 'block';
                console.log('âœ… PDF ì €ì¥ ì™„ë£Œ');
            }).catch(function(error) {
                console.error('âŒ PDF ìƒì„± ì˜¤ë¥˜:', error);
                button.style.display = 'block';
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    </script>
</body>
</html>