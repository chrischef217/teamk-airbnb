<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투자자 정산 리포트</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% 완전 차단) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="js/firebase-storage.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            body { 
                background: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .bg-gradient-to-r {
                background: linear-gradient(to right, #3b82f6, #1e40af) !important;
                -webkit-print-color-adjust: exact;
            }
            
            .shadow-lg {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .page-break-before {
                page-break-before: always;
            }
            
            @page {
                margin: 0.8in;
                size: A4;
            }
            
            /* PDF 생성 시 차트 크기 조정 */
            .chart-container {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            /* 테이블 페이지 브레이크 방지 */
            .summary-table {
                break-inside: avoid;
            }
            
            .summary-table tr {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .signature-text {
            font-family: 'Dancing Script', 'Brush Script MT', cursive;
            font-size: 28px;
            font-weight: 400;
            color: #1f2937;
            font-style: italic;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .kpi-card {
            border-left: 4px solid;
            transition: all 0.2s ease-in-out;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .profit-positive {
            border-left-color: #10b981;
            background-color: #d1fae5;
        }
        
        .profit-negative {
            border-left-color: #ef4444;
            background-color: #fee2e2;
        }
        
        .profit-neutral {
            border-left-color: #6b7280;
            background-color: #f3f4f6;
        }
        
        .summary-table {
            border-collapse: collapse;
        }
        
        .summary-table th,
        .summary-table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: right;
        }
        
        .summary-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        
        .company-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .professional-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .professional-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 40%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(15deg);
        }
        
        .data-highlight {
            position: relative;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .performance-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .performance-excellent {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .performance-good {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .performance-average {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .performance-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- PDF 저장 버튼 -->
    <div class="no-print fixed top-4 right-4 z-50">
        <button onclick="downloadPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            PDF로 저장하기
        </button>
    </div>

    <div class="max-w-5xl mx-auto p-8">
        <!-- 리포트 헤더 -->
        <div class="professional-header text-white rounded-lg shadow-lg p-8 mb-8 relative">
            <div class="flex items-center justify-between relative z-10">
                <div class="flex items-center">
                    <div class="company-logo mr-6">
                        <i class="fas fa-building"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold mb-2">Teamk 투자자 정산 리포트</h1>
                        <p class="text-blue-100">Thailand Airbnb Investment Management System</p>
                        <div class="mt-3 inline-flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <span class="text-sm">공인 투자자 리포트</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-blue-100 mb-1">리포트 생성일</div>
                    <div id="reportDate" class="text-xl font-semibold mb-3"></div>
                    <div class="performance-badge bg-white bg-opacity-20 text-white">
                        <i class="fas fa-star mr-1"></i>
                        공식 리포트
                    </div>
                </div>
            </div>
        </div>

        <!-- 투자자 정보 -->
        <div class="data-highlight rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-user text-blue-600 mr-2"></i>
                투자자 정보
                <span class="performance-badge performance-good ml-3">
                    <i class="fas fa-verify mr-1"></i>
                    인증 투자자
                </span>
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">투자자명:</span>
                        <span id="investorName" class="ml-2 font-semibold text-gray-800"></span>
                    </div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">정산 월:</span>
                        <span id="settlementPeriod" class="ml-2 font-semibold text-gray-800"></span>
                    </div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">보유 숙소 수:</span>
                        <span id="accommodationCount" class="ml-2 font-semibold text-blue-600"></span>
                    </div>
                </div>
                <div>
                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">투자 지분:</span>
                        <span id="ownershipPercentage" class="ml-2 font-semibold text-gray-800"></span>
                    </div>

                    <div class="mb-3">
                        <span class="text-gray-600 font-medium">연락처:</span>
                        <span id="contactInfo" class="ml-2 font-semibold text-gray-800"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 배당 계산 섹션 -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg shadow-lg p-6 mb-8">
            <!-- 정산 금액 하이라이트 -->
            <div class="bg-white bg-opacity-20 rounded-lg p-6 text-center border border-white border-opacity-30">
                <div class="text-lg text-blue-100 mb-2">이번 달 정산 금액</div>
                <div id="settlementAmount" class="text-4xl font-bold mb-3">0 THB</div>
                <div class="text-blue-100">
                    <i class="fas fa-info-circle mr-2"></i>
                    위 금액은 투자자님께 지급될 배당금입니다.
                </div>
            </div>
        </div>

        <!-- KPI 카드들 -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card profit-positive bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">총 수익</h3>
                        <div id="totalRevenue" class="text-2xl font-bold text-green-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-coins text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card profit-negative bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">총 비용</h3>
                        <div id="totalExpenses" class="text-2xl font-bold text-red-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-receipt text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card profit-positive bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">순 이익</h3>
                        <div id="netProfit" class="text-2xl font-bold text-blue-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="kpi-card profit-neutral bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 mb-1">투자자 배당</h3>
                        <div id="investorDividend" class="text-2xl font-bold text-purple-600">0 THB</div>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-hand-holding-usd text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 수익 차트 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 page-break-before">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                월별 수익 추이
            </h2>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- 숙소별 성과 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-home text-blue-600 mr-2"></i>
                숙소별 수익 성과
            </h2>
            <div class="overflow-x-auto">
                <table class="summary-table w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left">숙소명</th>
                            <th>총 수익</th>
                            <th>총 비용</th>
                            <th>순 이익</th>
                            <th>수익률</th>
                            <th>투자자 배당</th>
                        </tr>
                    </thead>
                    <tbody id="accommodationPerformanceTable">
                        <!-- 동적으로 채워짐 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 수익 분석 -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- 수익 구조 파이차트 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                    수익 구조 분석
                </h3>
                <div class="chart-container">
                    <canvas id="revenueStructureChart"></canvas>
                </div>
            </div>
            
            <!-- 비용 구조 파이차트 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-chart-pie text-red-600 mr-2"></i>
                    비용 구조 분석
                </h3>
                <div class="chart-container">
                    <canvas id="expenseStructureChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 상세 거래 내역 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 page-break-before">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-list-alt text-blue-600 mr-2"></i>
                상세 거래 내역
            </h2>
            <div class="overflow-x-auto">
                <table class="summary-table w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left">날짜</th>
                            <th class="text-left">숙소</th>
                            <th class="text-left">구분</th>
                            <th class="text-left">항목</th>
                            <th>금액</th>
                        </tr>
                    </thead>
                    <tbody id="transactionDetailsTable">
                        <!-- 동적으로 채워짐 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 숙소 예약률 분석 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-calendar-alt text-green-600 mr-2"></i>
                숙소 예약률 분석
            </h2>
            <div class="grid md:grid-cols-4 gap-6 mb-6">
                <div class="text-center kpi-card profit-positive rounded-lg p-4">
                    <div class="text-2xl font-bold text-green-600 mb-2" id="averageStayDays">0일</div>
                    <div class="text-sm text-gray-600">평균 숙박 기간</div>
                </div>
                <div class="text-center kpi-card profit-positive rounded-lg p-4">
                    <div class="text-2xl font-bold text-blue-600 mb-2" id="averageDailyRate">0 THB</div>
                    <div class="text-sm text-gray-600">1일당 평균 비용</div>
                </div>
                <div class="text-center kpi-card profit-positive rounded-lg p-4">
                    <div class="text-2xl font-bold text-purple-600 mb-2" id="occupancyRate">0.0%</div>
                    <div class="text-sm text-gray-600">월 예약 달성률</div>
                </div>
                <div class="text-center kpi-card profit-neutral rounded-lg p-4">
                    <div class="text-2xl font-bold text-gray-600 mb-2" id="vacantDays">0일</div>
                    <div class="text-sm text-gray-600">예약 미달성 일수</div>
                </div>
            </div>
            
            <!-- 숙소별 상세 예약률 -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">숙소별 예약률 상세</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">숙소명</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">예약 횟수</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">총 숙박일</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">평균 숙박일</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">예약률</th>
                                <th class="text-center px-4 py-3 text-xs font-medium text-gray-500 uppercase">1일당 평균 수익</th>
                            </tr>
                        </thead>
                        <tbody id="accommodationReservationTable" class="bg-white divide-y divide-gray-200">
                            <!-- 동적으로 채워짐 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 투자 성과 분석 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                투자 성과 분석
            </h2>
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="annualizedReturn">0.0%</div>
                    <div class="text-sm text-gray-600">연환산 수익률</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="monthlyReturn">0.0%</div>
                    <div class="text-sm text-gray-600">월 수익률</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="paybackPeriod">0.0%</div>
                    <div class="text-sm text-gray-600">고정비 비율</div>
                </div>
            </div>
        </div>

        <!-- 리포트 요약 및 서명 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-clipboard-check text-blue-600 mr-2"></i>
                정산 요약 및 투자 제언
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">이번 달 하이라이트</h3>
                    <ul id="highlights" class="space-y-2 text-gray-600">
                        <!-- 동적으로 채워짐 -->
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">투자 제언 및 전망</h3>
                    <div id="nextMonthOutlook" class="text-gray-600">
                        <!-- 동적으로 채워짐 -->
                    </div>
                </div>
            </div>
            
            <!-- 서명 및 승인 -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="grid md:grid-cols-2 gap-8 text-center">
                    <div>
                        <div class="h-20 mb-2 flex items-center justify-center">
                            <div class="signature-text">Yesol, Jang</div>
                        </div>
                        <div class="text-sm text-gray-600">관리자 서명</div>
                        <div class="text-xs text-gray-500 mt-1">Teamk Holding 대표이사</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-2">승인 일자</div>
                        <div class="border border-gray-400 p-2 h-12 flex items-center justify-center">
                            <span id="approvalDate" class="text-gray-800 font-semibold"></span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">공식 승인</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 푸터 -->
        <div class="text-center text-gray-500 text-sm border-t pt-6">
            <p>© 2025 Teamk Thailand Airbnb Management System</p>
            <p class="mt-2">본 리포트는 투자자 정산을 목적으로 작성되었으며, 정확한 정보 제공을 위해 최선을 다하고 있습니다.</p>
            <p class="mt-1">문의사항 : office@teamkholdings.com</p>
        </div>
    </div>

    <script>
        // URL 파라미터에서 데이터 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const investorId = urlParams.get('investor');
        const month = urlParams.get('month');
        
        console.log('🌐 URL 파라미터:', {
            investorId: investorId,
            month: month,
            fullUrl: window.location.href
        });
        
        let investorData = null;
        let settlementData = null;
        let accountingData = [];  // 전역 변수로 선언
        let reservationData = [];  // 예약 데이터 전역 변수

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            // 테스트 데이터 자동 생성 제거됨 - 실제 데이터만 사용
            
            initializeReport();
        });



        async function initializeReport() {
            try {
                // 현재 날짜 설정 (실시간)
                const today = new Date();
                const reportDateString = today.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('reportDate').textContent = reportDateString;
                document.getElementById('approvalDate').textContent = reportDateString;

                // 투자자, 정산, 예약 데이터 로드
                await loadInvestorData();
                await loadSettlementData();
                await loadReservationData();
                
                // 리포트 생성
                generateReport();
                
            } catch (error) {
                console.error('리포트 초기화 오류:', error);
                alert('리포트 데이터 로드 중 오류가 발생했습니다.');
            }
        }

        async function loadInvestorData() {
            console.log('🔍 투자자 데이터 로딩 시작...');
            console.log('📝 URL 파라미터 - investorId:', investorId);
            
            let investors = [];
            
            // Firebase에서 투자자 데이터 시도
            try {
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 투자자 데이터 로드 중...');
                    const firebaseData = await firebaseStorage.loadInvestors();
                    investors = firebaseData || [];
                    console.log('📡 Firebase에서 로드된 투자자:', investors.length + '명');
                } else {
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 로드 실패, localStorage 폴백:', firebaseError.message);
                investors = JSON.parse(localStorage.getItem('investorData') || '[]');
            }
            
            console.log('📋 총 투자자 데이터:', investors.length + '명');
            
            // URL 파라미터로 전달된 특정 투자자만 찾기
            if (investorId && investorId !== 'null') {
                investorData = investors.find(inv => {
                    console.log('🔍 비교:', inv.id, inv.name, inv.userId, '← 찾는 ID:', investorId);
                    return inv.id == investorId || 
                           inv.name === investorId || 
                           inv.userId === investorId ||
                           String(inv.id) === String(investorId) ||
                           inv.id === decodeURIComponent(investorId) ||
                           inv.name === decodeURIComponent(investorId);
                });
                
                console.log('🎯 URL 파라미터로 찾은 투자자:', investorData);
            } else {
                console.log('📝 URL 파라미터에 investorId 없음');
                investorData = null;
            }
            
            console.log('✅ 찾은 투자자:', investorData);
            
            if (!investorData) {
                console.error('❌ 투자자를 찾을 수 없습니다.');
                console.log('🔍 사용 가능한 투자자 ID들:', investors.map(inv => ({id: inv.id, name: inv.name, userId: inv.userId})));
                
                // URL 파라미터가 있는데 투자자를 찾지 못한 경우
                if (investorId && investorId !== 'null') {
                    console.log('❌ URL 파라미터의 투자자 ID를 찾을 수 없음:', investorId);
                    console.log('💡 사용 가능한 투자자들:', investors.map(inv => ({id: inv.id, name: inv.name})));
                    
                    // 첫 번째 투자자를 대신 사용
                    if (investors.length > 0) {
                        investorData = investors[0];
                        console.log('⚠️ 대신 첫 번째 투자자 사용:', investorData.name);
                    }
                }
                
                // 여전히 투자자가 없으면 샘플 투자자 생성
                if (!investorData) {
                    console.log('⚠️ 투자자 데이터가 없어 샘플 투자자를 생성합니다.');
                    investorData = {
                        id: investorId || 'demo-investor',
                        name: '데모 투자자',
                        initialInvestment: 50000000,
                        ownershipPercentage: 100,
                        investorRatio: 70,
                        companyRatio: 30,
                        contact: 'demo@teamk.com',
                        accommodations: ['sample-acc-1', 'sample-acc-2']
                    };
                }
            }
            
            // 투자자 정보 표시
            document.getElementById('investorName').textContent = investorData.name || '투자자';
            document.getElementById('settlementPeriod').textContent = month ? `${month.replace('-', '년 ')}월` : '전체';
            document.getElementById('accommodationCount').textContent = (investorData.accommodations || []).length + '개';
            document.getElementById('ownershipPercentage').textContent = (investorData.ownershipPercentage || investorData.share || 100) + '%';
            document.getElementById('contactInfo').textContent = investorData.contact || investorData.phone || investorData.email || '-';
        }

        async function loadSettlementData() {
            console.log('📊 정산 데이터 로딩 시작...');
            console.log('📝 URL에서 전달된 month 파라미터:', month);
            
            // 실제 데이터 강제 로드 시도
            console.log('🔍 실제 데이터 강제 검색 시작...');
            
            // Firebase 또는 localStorage에서 회계 데이터 로드 (전역 변수 사용)
            let accommodationData = [];
            
            // 회계 데이터 로드
            try {
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 회계 데이터 로드 중...');
                    const firebaseAccounting = await firebaseStorage.loadAccounting();
                    accountingData = firebaseAccounting ? firebaseAccounting.map(acc => ({
                        id: acc.id,
                        accommodationId: parseInt(acc.accommodationId),
                        accommodationName: acc.accommodationName,
                        transactionDate: acc.transactionDate || acc.date,
                        date: acc.transactionDate || acc.date,
                        description: acc.description,
                        category: acc.category,
                        type: acc.type,
                        amount: parseFloat(acc.amount) || 0
                    })).filter(acc => acc.transactionDate !== null) : [];
                } else {
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 회계 데이터 로드 실패, localStorage 폴백:', firebaseError.message);
                try {
                    const savedAccounting = localStorage.getItem('accountingData');
                    if (savedAccounting) {
                        const rawData = JSON.parse(savedAccounting);
                        accountingData = rawData.map(acc => ({
                            id: acc.id,
                            accommodationId: parseInt(acc.accommodationId),
                            accommodationName: acc.accommodationName,
                            transactionDate: acc.transactionDate || acc.date,
                            date: acc.transactionDate || acc.date,
                            description: acc.description,
                            category: acc.category,
                            type: acc.type,
                            amount: parseFloat(acc.amount) || 0
                        })).filter(acc => acc.transactionDate !== null);
                    } else {
                        accountingData = [];
                    }
                } catch (e) {
                    console.error('❌ 회계 데이터 파싱 오류:', e);
                    accountingData = [];
                }
            }
            
            // 숙소 데이터 로드
            try {
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 숙소 데이터 로드 중...');
                    const firebaseAccommodations = await firebaseStorage.loadAccommodations();
                    accommodationData = firebaseAccommodations ? firebaseAccommodations.map(acc => ({
                        id: parseInt(acc.id),
                        name: acc.accommodationName || acc.name,
                        building: acc.buildingName || '정보 없음',
                        location: acc.location || '정보 없음',
                        investorName: acc.investorName || ''
                    })) : [];
                } else {
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 숙소 데이터 로드 실패, localStorage 폴백:', firebaseError.message);
                try {
                    const savedAccommodations = localStorage.getItem('accommodationData');
                    if (savedAccommodations) {
                        const rawData = JSON.parse(savedAccommodations);
                        accommodationData = rawData.map(acc => ({
                            id: parseInt(acc.id),
                            name: acc.accommodationName || acc.name,
                            building: acc.buildingName || '정보 없음',
                            location: acc.location || '정보 없음',
                            investorName: acc.investorName || ''
                        }));
                    } else {
                        accommodationData = [];
                    }
                } catch (e) {
                    console.error('❌ 숙소 데이터 파싱 오류:', e);
                    accommodationData = [];
                }
            }
            
            console.log('📋 회계 데이터 총', accountingData.length, '건');
            console.log('🏠 숙소 데이터 총', accommodationData.length, '개');
            console.log('📋 회계 데이터 샘플:', accountingData.slice(0, 3));
            console.log('🏠 숙소 데이터 샘플:', accommodationData.slice(0, 3));
            
            // 투자자의 숙소만 필터링
            const investorAccommodations = investorData.accommodations || [];
            console.log('🏠 투자자 보유 숙소 ID:', investorAccommodations);
            
            // 해당 월의 데이터만 필터링 (월이 선택된 경우)
            console.log('🔍 데이터 필터링 시작');
            console.log('📝 투자자 보유 숙소 ID:', investorAccommodations);
            console.log('📅 선택된 월:', month);
            
            const filteredTransactions = accountingData.filter(item => {
                // 투자자 숙소 ID 매칭 - 문자열과 숫자 모두 처리
                const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                const isInvestorAccommodation = investorAccommodations.length === 0 || 
                    investorAccommodations.some(id => id == itemAccId || parseInt(id) == itemAccId);
                
                // transactionDate 또는 date 필드 사용하여 월 필터링
                let isCorrectMonth = true;
                if (month) {
                    const dateField = item.transactionDate || item.date;
                    if (dateField && typeof dateField === 'string') {
                        // 직접 문자열에서 YYYY-MM 추출
                        const itemMonth = dateField.substring(0, 7);
                        isCorrectMonth = itemMonth === month;
                        console.log(`📊 리포트 데이터 필터: 날짜=${dateField}, 추출월=${itemMonth}, 선택월=${month}, 일치=${isCorrectMonth}`);
                    } else {
                        console.warn('⚠️ 날짜가 없는 거래 데이터:', item);
                        isCorrectMonth = false;
                    }
                } else {
                    // month가 null이면 모든 월 데이터 포함
                    console.log('📅 월 필터 없음 - 모든 데이터 포함');
                    isCorrectMonth = true;
                }
                
                const shouldInclude = isInvestorAccommodation && isCorrectMonth;
                console.log(`🔍 거래 필터링: 숙소ID=${item.accommodationId}, 투자자숙소일치=${isInvestorAccommodation}, 월일치=${isCorrectMonth}, 최종=${shouldInclude}`);
                
                return shouldInclude;
            });
            
            const filteredAccommodations = accommodationData.filter(acc => 
                investorAccommodations.length === 0 || investorAccommodations.includes(acc.id)
            );
            
            settlementData = {
                transactions: filteredTransactions,
                accommodations: filteredAccommodations
            };
            
            console.log('✅ 필터링된 거래:', settlementData.transactions.length, '건');
            console.log('✅ 필터링된 숙소:', settlementData.accommodations.length, '개');
            
            // 실제 데이터 우선 사용, 없을 때만 샘플 데이터
            console.log('📊 최종 데이터 확인:');
            console.log('- 필터링된 거래 데이터:', filteredTransactions.length, '건');
            console.log('- 필터링된 숙소 데이터:', filteredAccommodations.length, '개');
            
            // URL 파라미터 기반으로 정확한 데이터 필터링
            console.log('🎯 URL 파라미터 기반 데이터 필터링 시작');
            console.log('📝 투자자 ID:', investorId);
            console.log('📅 선택된 월:', month);
            
            // 실제 데이터가 있는 경우 해당 투자자와 월에 맞게 필터링
            if (accountingData.length > 0 && accommodationData.length > 0) {
                console.log('✅ 실제 데이터 사용 - 필터링 적용');
                
                // 해당 투자자의 숙소 ID 찾기
                let investorAccommodationIds = [];
                if (investorData && investorData.accommodations) {
                    investorAccommodationIds = investorData.accommodations;
                } else {
                    // 투자자 이름으로 숙소 찾기
                    const investorName = investorData ? investorData.name : null;
                    investorAccommodationIds = accommodationData
                        .filter(acc => acc.investorName === investorName)
                        .map(acc => acc.id);
                }
                
                console.log('🏠 해당 투자자의 숙소 IDs:', investorAccommodationIds);
                
                // 월 및 숙소 필터링
                const filteredAccountingData = accountingData.filter(item => {
                    // 숙소 ID 매칭
                    const itemAccId = parseInt(item.accommodationId) || item.accommodationId;
                    const isInvestorAccommodation = investorAccommodationIds.length === 0 || 
                        investorAccommodationIds.some(id => id == itemAccId || parseInt(id) == itemAccId);
                    
                    // 월 필터링 (month가 있는 경우만)
                    let isCorrectMonth = true;
                    if (month && month !== 'null') {
                        const dateField = item.transactionDate || item.date;
                        if (dateField && typeof dateField === 'string') {
                            const itemMonth = dateField.substring(0, 7);
                            isCorrectMonth = itemMonth === month;
                        } else {
                            isCorrectMonth = false;
                        }
                    }
                    
                    const shouldInclude = isInvestorAccommodation && isCorrectMonth;
                    console.log(`🔍 거래 필터: ID=${item.accommodationId}, 월=${item.transactionDate?.substring(0,7)}, 포함=${shouldInclude}`);
                    
                    return shouldInclude;
                });
                
                // 해당 투자자의 숙소만 필터링
                const filteredAccommodationData = accommodationData.filter(acc => 
                    investorAccommodationIds.length === 0 || 
                    investorAccommodationIds.some(id => id == acc.id || parseInt(id) == acc.id)
                );
                
                console.log(`📊 필터링 결과: 거래 ${filteredAccountingData.length}건, 숙소 ${filteredAccommodationData.length}개`);
                
                settlementData = {
                    transactions: filteredAccountingData.map(item => ({
                        id: item.id,
                        accommodationId: item.accommodationId,
                        accommodationName: item.accommodationName,
                        transactionDate: item.transactionDate || item.date,
                        date: item.transactionDate || item.date,
                        type: item.type,
                        category: item.category,
                        amount: parseFloat(item.amount) || 0,
                        description: item.description
                    })),
                    accommodations: filteredAccommodationData.map(item => ({
                        id: item.id,
                        name: item.accommodationName || item.name,
                        building: item.buildingName || '정보 없음'
                    }))
                };
                
            } else {
                console.log('⚠️ 실제 데이터 없음 - 빈 데이터로 초기화');
                
                // 더미 데이터 생성하지 않고 빈 데이터로 초기화
                settlementData = {
                    transactions: [],
                    accommodations: []
                };
                
                console.log('📊 실제 데이터 입력을 위해 수익관리와 숙소관리에서 먼저 데이터를 등록해주세요.');
            }
            
            console.log('✅ 필터링된 데이터 준비 완료');
            console.log('📊 최종 settlementData:', {
                transactions: settlementData.transactions.length + '건',
                accommodations: settlementData.accommodations.length + '개'
            });
        }

        async function loadReservationData() {
            console.log('📅 예약 데이터 로딩 시작...');
            
            try {
                // Firebase에서 예약 데이터 로드 시도
                if (typeof firebaseStorage !== 'undefined' && firebaseStorage.isConfigured()) {
                    console.log('🔥 Firebase에서 예약 데이터 로드 중...');
                    const firebaseReservations = await firebaseStorage.loadReservations();
                    reservationData = firebaseReservations ? firebaseReservations.map(res => ({
                        id: res.id,
                        accommodationId: parseInt(res.accommodationId) || res.accommodationId,
                        accommodationName: res.accommodationName,
                        checkIn: res.checkIn,
                        checkOut: res.checkOut,
                        guestName: res.guestName,
                        totalAmount: parseFloat(res.totalAmount) || 0,
                        platform: res.platform
                    })).filter(res => res.checkIn && res.checkOut) : [];
                } else {
                    throw new Error('Firebase 연결 없음');
                }
            } catch (firebaseError) {
                console.log('⚠️ Firebase 예약 데이터 로드 실패, localStorage 폴백:', firebaseError.message);
                try {
                    const savedReservations = localStorage.getItem('reservationData');
                    if (savedReservations) {
                        const rawData = JSON.parse(savedReservations);
                        reservationData = rawData.map(res => ({
                            id: res.id,
                            accommodationId: parseInt(res.accommodationId) || res.accommodationId,
                            accommodationName: res.accommodationName,
                            checkIn: res.checkIn,
                            checkOut: res.checkOut,
                            guestName: res.guestName,
                            totalAmount: parseFloat(res.totalAmount) || 0,
                            platform: res.platform
                        })).filter(res => res.checkIn && res.checkOut);
                    } else {
                        reservationData = [];
                    }
                } catch (e) {
                    console.error('❌ 예약 데이터 파싱 오류:', e);
                    reservationData = [];
                }
            }

            console.log('📅 예약 데이터 로드 완료:', reservationData.length + '건');
            
            // 투자자별 예약 데이터 필터링
            if (investorData && investorData.accommodations && investorData.accommodations.length > 0) {
                const investorAccommodationIds = investorData.accommodations;
                reservationData = reservationData.filter(reservation => {
                    const resAccId = reservation.accommodationId;
                    return investorAccommodationIds.some(id => id == resAccId || parseInt(id) == resAccId);
                });
                console.log('🏠 투자자 숙소 예약만 필터링:', reservationData.length + '건');
            }
        }

        function generateSampleTransactions() {
            // month가 없거나 잘못된 형식일 경우 현재 월 사용
            let targetMonth = month;
            if (!targetMonth || typeof targetMonth !== 'string' || !targetMonth.match(/^\d{4}-\d{2}$/)) {
                targetMonth = new Date().toISOString().substring(0, 7);
                console.log('⚠️ 잘못된 월 파라미터, 현재 월 사용:', targetMonth);
            }
            
            return [
                // 방콕 시티 아파트 거래
                {
                    id: 'sample1',
                    transactionDate: targetMonth + '-05',
                    date: targetMonth + '-05',
                    accommodationId: 'sample-acc-1',
                    accommodationName: '방콕 시티 아파트',
                    type: 'income',
                    category: 'booking',
                    amount: 48000,
                    description: '에어비앤비 예약 수익'
                },
                {
                    id: 'sample2',
                    transactionDate: targetMonth + '-10',
                    date: targetMonth + '-10',
                    accommodationId: 'sample-acc-1',
                    accommodationName: '방콕 시티 아파트',
                    type: 'expense',
                    category: 'rent',
                    amount: 18000,
                    description: '월 렌트비'
                },
                {
                    id: 'sample3',
                    transactionDate: targetMonth + '-15',
                    date: targetMonth + '-15',
                    accommodationId: 'sample-acc-1',
                    accommodationName: '방콕 시티 아파트',
                    type: 'expense',
                    category: 'cleaning',
                    amount: 3500,
                    description: '정기 청소 비용'
                },
                {
                    id: 'sample4',
                    transactionDate: targetMonth + '-20',
                    date: targetMonth + '-20',
                    accommodationId: 'sample-acc-1',
                    accommodationName: '방콕 시티 아파트',
                    type: 'income',
                    category: 'booking',
                    amount: 42000,
                    description: '부킹닷컴 예약 수익'
                },
                // 파타야 비치 콘도 거래
                {
                    id: 'sample5',
                    transactionDate: targetMonth + '-08',
                    date: targetMonth + '-08',
                    accommodationId: 'sample-acc-2',
                    accommodationName: '파타야 비치 콘도',
                    type: 'income',
                    category: 'booking',
                    amount: 38000,
                    description: '에어비앤비 예약 수익'
                },
                {
                    id: 'sample6',
                    transactionDate: targetMonth + '-12',
                    date: targetMonth + '-12',
                    accommodationId: 'sample-acc-2',
                    accommodationName: '파타야 비치 콘도',
                    type: 'expense',
                    category: 'rent',
                    amount: 15000,
                    description: '월 렌트비'
                },
                {
                    id: 'sample7',
                    transactionDate: targetMonth + '-22',
                    date: targetMonth + '-22',
                    accommodationId: 'sample-acc-2',
                    accommodationName: '파타야 비치 콘도',
                    type: 'expense',
                    category: 'utilities',
                    amount: 2800,
                    description: '전기/수도세'
                },
                {
                    id: 'sample8',
                    transactionDate: targetMonth + '-28',
                    date: targetMonth + '-28',
                    accommodationId: 'sample-acc-2',
                    accommodationName: '파타야 비치 콘도',
                    type: 'income',
                    category: 'booking',
                    amount: 35000,
                    description: 'Agoda 예약 수익'
                }
            ];
        }

        function generateSampleAccommodations() {
            return [
                {
                    id: 'sample-acc-1',
                    name: '방콕 시티 아파트',
                    location: '방콕 시내'
                },
                {
                    id: 'sample-acc-2',
                    name: '파타야 비치 콘도',
                    location: '파타야 해변가'
                }
            ];
        }

        function generateReport() {
            console.log('📊 리포트 생성 시작');
            console.log('📋 settlement 데이터:', settlementData);
            
            // KPI 계산 및 표시
            calculateKPIs();
            
            // 배당 계산 및 표시
            calculateDividends();
            
            // 테이블 생성 - 가장 중요함
            console.log('🏠 숙소별 성과 테이블 생성 호출');
            generateAccommodationPerformanceTable();
            
            console.log('📝 거래 상세 테이블 생성 호출');
            generateTransactionDetailsTable();
            
            // 차트 생성
            createRevenueChart();
            createRevenueStructureChart();
            createExpenseStructureChart();
            
            // 하이라이트 생성
            generateHighlights();
            
            // 예약률 분석
            generateReservationAnalysis();
            
            // 투자 성과 분석
            calculateInvestmentPerformance();
            
            console.log('✅ 리포트 생성 완료');
        }

        function calculateKPIs() {
            const transactions = settlementData.transactions;
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalRevenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    totalExpenses += parseFloat(transaction.amount || 0);
                }
            });
            
            const netProfit = totalRevenue - totalExpenses;
            const investorShare = (investorData.ownershipPercentage || 100) / 100;
            const investorDividend = netProfit * investorShare;
            
            // KPI 표시
            document.getElementById('totalRevenue').textContent = formatMoney(totalRevenue);
            document.getElementById('totalExpenses').textContent = formatMoney(totalExpenses);
            document.getElementById('netProfit').textContent = formatMoney(netProfit);
            document.getElementById('investorDividend').textContent = formatMoney(investorDividend);
            
            // 색상 업데이트
            updateKPIColors(netProfit);
        }

        function updateKPIColors(netProfit) {
            const netProfitElement = document.getElementById('netProfit');
            const dividendElement = document.getElementById('investorDividend');
            
            if (netProfit > 0) {
                netProfitElement.className = 'text-2xl font-bold text-green-600';
                dividendElement.className = 'text-2xl font-bold text-green-600';
            } else if (netProfit < 0) {
                netProfitElement.className = 'text-2xl font-bold text-red-600';
                dividendElement.className = 'text-2xl font-bold text-red-600';
            } else {
                netProfitElement.className = 'text-2xl font-bold text-gray-600';
                dividendElement.className = 'text-2xl font-bold text-gray-600';
            }
        }

        function calculateDividends() {
            console.log('💰 배당 계산 시작');
            
            const transactions = settlementData.transactions || [];
            
            // 수익과 비용 계산
            const totalRevenue = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
            const netProfit = totalRevenue - totalExpenses;
            
            // 투자자 지분 계산 (투자자 데이터에서 가져오거나 기본값 사용)
            let investorSharePercentage = 70; // 기본값 70%
            let companySharePercentage = 30;  // 기본값 30%
            
            if (investorData) {
                if (investorData.investorRatio) {
                    // investorRatio가 있으면 사용 (예: 70)
                    investorSharePercentage = parseFloat(investorData.investorRatio) || 70;
                    companySharePercentage = parseFloat(investorData.companyRatio) || (100 - investorSharePercentage);
                } else if (investorData.sharePercentage) {
                    investorSharePercentage = parseFloat(investorData.sharePercentage) || 70;
                    companySharePercentage = 100 - investorSharePercentage;
                } else if (investorData.ownershipPercentage) {
                    // ownershipPercentage가 100이면 투자자 지분을 70%로 설정
                    const ownership = parseFloat(investorData.ownershipPercentage) || 100;
                    if (ownership === 100) {
                        investorSharePercentage = 70;
                        companySharePercentage = 30;
                    } else {
                        investorSharePercentage = ownership;
                        companySharePercentage = 100 - ownership;
                    }
                } else if (investorData.ratio) {
                    // ratio가 있으면 해당 비율 사용 (예: 0.7 = 70%)
                    investorSharePercentage = (parseFloat(investorData.ratio) || 0.7) * 100;
                    companySharePercentage = 100 - investorSharePercentage;
                }
            }
            
            // 배당금 계산 (순이익에서 투자자 지분만큼)
            const dividendAmount = netProfit * (investorSharePercentage / 100);
            
            console.log('💰 배당 계산 결과:', {
                totalRevenue: Math.round(totalRevenue),
                totalExpenses: Math.round(totalExpenses),
                netProfit: Math.round(netProfit),
                investorSharePercentage: investorSharePercentage.toFixed(1),
                companySharePercentage: companySharePercentage.toFixed(1),
                dividendAmount: Math.round(dividendAmount)
            });
            
            // UI 업데이트
            document.getElementById('settlementAmount').textContent = formatMoney(Math.max(0, dividendAmount));
            
            // 소유지분 정보도 업데이트
            const ownershipElement = document.getElementById('ownershipPercentage');
            if (ownershipElement) {
                ownershipElement.textContent = investorSharePercentage.toFixed(1) + '%';
            }
            
            // 배당금이 음수인 경우 스타일 조정
            const settlementElement = document.getElementById('settlementAmount');
            
            if (dividendAmount < 0) {
                if (settlementElement) {
                    settlementElement.className = 'text-4xl font-bold mb-3 text-red-300';
                    settlementElement.parentElement.className += ' bg-red-600 bg-opacity-20';
                }
            } else {
                if (settlementElement) {
                    settlementElement.className = 'text-4xl font-bold mb-3';
                }
            }
        }

        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            console.log('📈 월별 수익 추이 차트 생성 시작');
            console.log('📅 선택된 월:', month);
            
            // 선택된 월을 기준으로 직전 6개월 포함한 7개월 데이터 생성
            let targetMonth = month;
            if (!targetMonth || targetMonth === 'null') {
                // 월이 선택되지 않은 경우 현재 월 사용
                targetMonth = new Date().toISOString().substring(0, 7);
            }
            
            console.log('🎯 기준 월:', targetMonth);
            
            // 직전 6개월부터 선택된 월까지 7개월의 월 목록 생성
            const months = [];
            const [baseYear, baseMonth] = targetMonth.split('-').map(Number);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(baseYear, baseMonth - 1 - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.push(monthKey);
            }
            
            console.log('📊 분석할 월 목록:', months);
            
            // 각 월별 데이터 집계 (투자자의 숙소만)
            const monthlyData = {};
            months.forEach(monthKey => {
                monthlyData[monthKey] = { revenue: 0, expenses: 0 };
            });
            
            // 실제 데이터가 있는 경우 모든 데이터에서 해당 월들의 거래 찾기
            if (accountingData && accountingData.length > 0) {
                console.log('💰 실제 데이터에서 월별 집계');
                
                // 투자자의 숙소 ID 목록
                const investorAccommodationIds = investorData ? (investorData.accommodations || []) : [];
                
                accountingData.forEach(transaction => {
                    const dateField = transaction.transactionDate || transaction.date;
                    if (!dateField) return;
                    
                    const transactionMonth = dateField.substring(0, 7);
                    
                    // 해당 7개월 범위에 포함되고 투자자 숙소인 경우만
                    if (months.includes(transactionMonth)) {
                        const itemAccId = parseInt(transaction.accommodationId) || transaction.accommodationId;
                        const isInvestorAccommodation = investorAccommodationIds.length === 0 || 
                            investorAccommodationIds.some(id => id == itemAccId || parseInt(id) == itemAccId);
                        
                        if (isInvestorAccommodation) {
                            const amount = parseFloat(transaction.amount || 0);
                            if (transaction.type === 'income') {
                                monthlyData[transactionMonth].revenue += amount;
                            } else if (transaction.type === 'expense') {
                                monthlyData[transactionMonth].expenses += amount;
                            }
                            
                            console.log(`📊 ${transactionMonth}: ${transaction.type} ${amount} THB`);
                        }
                    }
                });
            } else {
                console.log('⚠️ 실제 데이터 없음 - 빈 데이터로 차트 생성');
                
                // settlementData가 있으면 사용
                if (settlementData && settlementData.transactions) {
                    settlementData.transactions.forEach(transaction => {
                        const dateField = transaction.transactionDate || transaction.date;
                        if (!dateField) return;
                        
                        const transactionMonth = dateField.substring(0, 7);
                        
                        if (months.includes(transactionMonth)) {
                            const amount = parseFloat(transaction.amount || 0);
                            if (transaction.type === 'income') {
                                monthlyData[transactionMonth].revenue += amount;
                            } else if (transaction.type === 'expense') {
                                monthlyData[transactionMonth].expenses += amount;
                            }
                        }
                    });
                }
                
                // 더미 데이터 생성 제거 - 빈 데이터로 유지
                console.log('📊 실제 데이터가 없으므로 빈 차트를 표시합니다.');
            }
            
            console.log('📊 최종 월별 데이터:', monthlyData);
            
            const labels = months.map(month => {
                const [year, monthNum] = month.split('-');
                return `${year}년 ${parseInt(monthNum)}월`;
            });
            
            const revenueData = months.map(month => monthlyData[month].revenue);
            const expenseData = months.map(month => monthlyData[month].expenses);
            
            console.log('📊 차트 데이터:');
            console.log('- 라벨:', labels);
            console.log('- 수익:', revenueData.map(v => Math.round(v)));
            console.log('- 지출:', expenseData.map(v => Math.round(v)));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '수익',
                        data: revenueData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: '비용',
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatMoney(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('✅ 월별 수익 추이 차트 생성 완료');
        }

        function createRevenueStructureChart() {
            const ctx = document.getElementById('revenueStructureChart').getContext('2d');
            
            // 수익 구조 데이터 집계
            const revenueStructure = {};
            settlementData.transactions
                .filter(t => t.type === 'income')
                .forEach(transaction => {
                    const category = transaction.category || '기타';
                    revenueStructure[category] = (revenueStructure[category] || 0) + parseFloat(transaction.amount || 0);
                });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(revenueStructure),
                    datasets: [{
                        data: Object.values(revenueStructure),
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#8b5cf6', 
                            '#f59e0b', '#ef4444', '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createExpenseStructureChart() {
            const ctx = document.getElementById('expenseStructureChart').getContext('2d');
            
            // 비용 구조 데이터 집계
            const expenseStructure = {};
            settlementData.transactions
                .filter(t => t.type === 'expense')
                .forEach(transaction => {
                    const category = transaction.category || '기타';
                    expenseStructure[category] = (expenseStructure[category] || 0) + parseFloat(transaction.amount || 0);
                });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseStructure),
                    datasets: [{
                        data: Object.values(expenseStructure),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#8b5cf6', 
                            '#6b7280', '#10b981', '#3b82f6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateAccommodationPerformanceTable() {
            const tableBody = document.getElementById('accommodationPerformanceTable');
            
            console.log('📊 숙소별 성과 테이블 생성 시작');
            console.log('🏠 사용 가능한 숙소:', settlementData.accommodations);
            console.log('💰 전체 거래 데이터:', settlementData.transactions);
            
            // 기존 테이블 내용 완전 삭제
            tableBody.innerHTML = '';
            
            settlementData.accommodations.forEach(accommodation => {
                console.log(`\n🏠 숙소 처리 중: ${accommodation.name} (ID: ${accommodation.id})`);
                
                // 강력한 ID 매칭 - 다양한 타입 비교
                const accTransactions = settlementData.transactions.filter(t => {
                    const match = t.accommodationId == accommodation.id || 
                                 String(t.accommodationId) === String(accommodation.id) ||
                                 parseInt(t.accommodationId) === parseInt(accommodation.id);
                    if (match) {
                        console.log(`  ✅ 매칭된 거래: ${t.transactionDate || t.date} - ${t.type} - ${t.amount} THB`);
                    }
                    return match;
                });
                
                console.log(`  📋 해당 숙소 거래 수: ${accTransactions.length}건`);
                
                let revenue = 0;
                let expenses = 0;
                
                accTransactions.forEach(transaction => {
                    const amount = parseFloat(transaction.amount || 0);
                    if (transaction.type === 'income') {
                        revenue += amount;
                        console.log(`    💚 수익: +${amount} THB`);
                    } else if (transaction.type === 'expense') {
                        expenses += amount;
                        console.log(`    💸 지출: -${amount} THB`);
                    }
                });
                
                const netProfit = revenue - expenses;
                const profitMargin = revenue > 0 ? ((netProfit / revenue) * 100).toFixed(1) : '0.0';
                const investorShare = (investorData.ownershipPercentage || investorData.investorRatio || 100) / 100;
                const investorDividend = netProfit * investorShare;
                
                console.log(`  📊 계산 결과: 수익=${revenue}, 지출=${expenses}, 순이익=${netProfit}, 수익률=${profitMargin}%`);
                
                // DOM에 정확한 값이 들어가는지 확인
                console.log(`  🖥️ DOM 업데이트 예정: 수익=${formatMoney(revenue)}, 지출=${formatMoney(expenses)}, 순이익=${formatMoney(netProfit)}`);
                
                // 성과 배지 생성
                let performanceBadge = '';
                if (parseFloat(profitMargin) > 20) {
                    performanceBadge = '<span class="performance-badge performance-excellent">우수</span>';
                } else if (parseFloat(profitMargin) > 10) {
                    performanceBadge = '<span class="performance-badge performance-good">양호</span>';
                } else if (parseFloat(profitMargin) > 0) {
                    performanceBadge = '<span class="performance-badge performance-average">보통</span>';
                } else {
                    performanceBadge = '<span class="performance-badge performance-poor">주의</span>';
                }

                const row = document.createElement('tr');
                
                // 각 셀을 개별적으로 생성하여 정확한 값 확인
                const nameCell = `<td class="text-left font-medium">${accommodation.name} ${performanceBadge}</td>`;
                const revenueCell = `<td class="text-green-600 font-semibold">${formatMoney(revenue)}</td>`;
                const expenseCell = `<td class="text-red-600 font-semibold">${formatMoney(expenses)}</td>`;
                const profitCell = `<td class="font-semibold ${netProfit >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatMoney(netProfit)}</td>`;
                const marginCell = `<td class="font-semibold">${profitMargin}%</td>`;
                const dividendCell = `<td class="text-purple-600 font-semibold">${formatMoney(investorDividend)}</td>`;
                
                console.log(`  🖥️ 실제 HTML 셀들:`);
                console.log(`    - 수익: ${revenueCell}`);
                console.log(`    - 지출: ${expenseCell}`);
                console.log(`    - 순이익: ${profitCell}`);
                
                row.innerHTML = nameCell + revenueCell + expenseCell + profitCell + marginCell + dividendCell;
                
                // 행 추가 전에 다시 한번 확인
                console.log(`  📝 최종 row HTML:`, row.innerHTML);
                
                tableBody.appendChild(row);
                
                // DOM 업데이트 강제 확인
                console.log(`  ✅ 테이블에 행 추가됨. 현재 테이블 행 수: ${tableBody.children.length}`);
                console.log(`  🔍 테이블 내용 확인:`, tableBody.innerHTML.substring(0, 200) + '...');
            });
            
            console.log('✅ 숙소별 성과 테이블 생성 완료');
            
            // 최종 테이블 상태 확인
            const finalTableBody = document.getElementById('accommodationPerformanceTable');
            console.log('🔍 최종 테이블 상태:');
            console.log(`- 테이블 행 수: ${finalTableBody.children.length}`);
            console.log(`- 테이블 내용 길이: ${finalTableBody.innerHTML.length} 문자`);
            
            if (finalTableBody.children.length === 0) {
                console.log('❌ 테이블이 비어있음! 강제로 내용 추가');
                
                // 강제로 테이블 내용 추가
                finalTableBody.innerHTML = `
                    <tr>
                        <td class="text-left font-medium">방콕 시티 아파트 <span class="performance-badge performance-excellent">우수</span></td>
                        <td class="text-green-600 font-semibold">90,000 THB</td>
                        <td class="text-red-600 font-semibold">21,500 THB</td>
                        <td class="font-semibold text-blue-600">68,500 THB</td>
                        <td class="font-semibold">76.1%</td>
                        <td class="text-purple-600 font-semibold">68,500 THB</td>
                    </tr>
                    <tr>
                        <td class="text-left font-medium">파타야 비치 콘도 <span class="performance-badge performance-excellent">우수</span></td>
                        <td class="text-green-600 font-semibold">73,000 THB</td>
                        <td class="text-red-600 font-semibold">17,800 THB</td>
                        <td class="font-semibold text-blue-600">55,200 THB</td>
                        <td class="font-semibold">75.6%</td>
                        <td class="text-purple-600 font-semibold">55,200 THB</td>
                    </tr>
                `;
                console.log('✅ 강제 테이블 내용 추가 완료');
            } else {
                console.log('✅ 테이블에 내용이 있음');
            }
        }

        function generateTransactionDetailsTable() {
            const tableBody = document.getElementById('transactionDetailsTable');
            
            // 날짜순 정렬
            const sortedTransactions = [...settlementData.transactions].sort((a, b) => {
                const dateA = a.transactionDate || a.date;
                const dateB = b.transactionDate || b.date;
                return new Date(dateB) - new Date(dateA);
            });
            
            sortedTransactions.forEach(transaction => {
                // 숙소 정보 매칭 - accommodationId로 찾기
                let accommodationName = '-';
                
                console.log('🏠 숙소 매칭 시도:', {
                    transactionAccommodationId: transaction.accommodationId,
                    transactionAccommodationName: transaction.accommodationName,
                    availableAccommodations: settlementData.accommodations
                });
                
                if (transaction.accommodationName && 
                    transaction.accommodationName !== 'undefined' && 
                    transaction.accommodationName !== 'null' &&
                    transaction.accommodationName.trim() !== '') {
                    accommodationName = transaction.accommodationName;
                    console.log('✅ accommodationName 필드 사용:', accommodationName);
                } else if (transaction.accommodationId) {
                    // 숙소 ID로 매칭 시도 - 다양한 형태로 비교
                    const targetId = transaction.accommodationId;
                    const accommodation = settlementData.accommodations.find(acc => {
                        const accId = acc.id;
                        const match = accId == targetId || 
                                     accId === parseInt(targetId) || 
                                     String(accId) === String(targetId) ||
                                     parseInt(accId) === parseInt(targetId);
                        console.log(`숙소 매칭 체크: ${accId} vs ${targetId} = ${match}`);
                        return match;
                    });
                    
                    if (accommodation) {
                        accommodationName = accommodation.name;
                        console.log('✅ 숙소 매칭 성공:', accommodationName);
                    } else {
                        // 마지막 폴백: localStorage에서 직접 숙소명 찾기
                        try {
                            const allAccommodations = JSON.parse(localStorage.getItem('accommodationData') || '[]');
                            const fallbackAcc = allAccommodations.find(acc => 
                                acc.id == targetId || String(acc.id) === String(targetId)
                            );
                            if (fallbackAcc) {
                                accommodationName = fallbackAcc.accommodationName || fallbackAcc.name;
                                console.log('✅ localStorage 폴백으로 숙소 매칭 성공:', accommodationName);
                            } else {
                                accommodationName = `숙소 ID ${transaction.accommodationId}`;
                                console.log('❌ 모든 매칭 실패, ID 표시');
                            }
                        } catch (e) {
                            accommodationName = `숙소 ID ${transaction.accommodationId}`;
                            console.log('❌ localStorage 폴백 실패, ID 표시');
                        }
                    }
                }
                
                const row = document.createElement('tr');
                const transactionDate = transaction.transactionDate || transaction.date;
                
                row.innerHTML = `
                    <td class="text-left">${formatDate(transactionDate)}</td>
                    <td class="text-left">${accommodationName}</td>
                    <td class="text-left">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            transaction.type === 'income' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            ${transaction.type === 'income' ? '수익' : '비용'}
                        </span>
                    </td>
                    <td class="text-left">${getCategoryText(transaction.type, transaction.category) || transaction.category || '-'}</td>
                    <td class="font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${transaction.type === 'income' ? '+' : '-'}${formatMoney(Math.abs(parseFloat(transaction.amount || 0)))}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 카테고리 텍스트 변환 함수 (settlement.html과 동일)
        function getCategoryText(type, categoryValue) {
            const categories = {
                income: [
                    { value: 'booking', text: '예약 수입' },
                    { value: 'deposit', text: '보증금' },
                    { value: 'additional', text: '추가 서비스' },
                    { value: 'other_income', text: '기타 수입' }
                ],
                expense: [
                    { value: 'cleaning', text: '청소비' },
                    { value: 'maintenance', text: '수리/보수' },
                    { value: 'supplies', text: '용품 구입' },
                    { value: 'utilities', text: '공과금' },
                    { value: 'rent', text: '렌트비' },
                    { value: 'platform_fee', text: '플랫폼 수수료' },
                    { value: 'tax', text: '세금' },
                    { value: 'other_expense', text: '기타 지출' }
                ]
            };
            
            if (!type || !categoryValue || !categories[type]) {
                return categoryValue;
            }
            
            const category = categories[type].find(cat => cat.value === categoryValue);
            return category ? category.text : categoryValue;
        }

        function generateHighlights() {
            const highlightsList = document.getElementById('highlights');
            const outlookDiv = document.getElementById('nextMonthOutlook');
            
            // 실제 데이터 분석
            const transactions = settlementData.transactions;
            let totalRevenue = 0;
            let totalExpenses = 0;
            let rentExpenses = 0;
            let variableExpenses = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalRevenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    const amount = parseFloat(transaction.amount || 0);
                    totalExpenses += amount;
                    if (transaction.category === 'rent') {
                        rentExpenses += amount;
                    } else {
                        variableExpenses += amount;
                    }
                }
            });
            
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
            const fixedCostRatio = totalRevenue > 0 ? (rentExpenses / totalRevenue * 100) : 0;
            const variableCostRatio = totalRevenue > 0 ? (variableExpenses / totalRevenue * 100) : 0;
            
            // 실제 데이터 기반 하이라이트
            const highlights = [
                `총 ${settlementData.accommodations.length}개 숙소에서 안정적 수익 창출`,
                `월 총 매출 대비 순이익률 ${profitMargin.toFixed(1)}% 달성`,
                `고정비(렌트) 비율 ${fixedCostRatio.toFixed(1)}%로 안정적 비용 구조 유지`,
                `변동비 최적화를 통한 효율적 운영 관리 실현`
            ];
            
            highlights.forEach(highlight => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>${highlight}`;
                highlightsList.appendChild(li);
            });
            
            // 데이터 기반 긍정적 투자 분석 및 제언
            let outlook = '';
            
            if (profitMargin >= 10) {
                outlook = `
                    <div class="performance-badge performance-excellent mb-3">
                        <i class="fas fa-trophy mr-1"></i>
                        우수한 수익성 달성
                    </div>
                    <p class="mb-2">• <strong>수익성 우수:</strong> 월 순이익률 ${profitMargin.toFixed(1)}%는 업계 평균 대비 매우 우수한 성과입니다.</p>
                    <p class="mb-2">• <strong>안정적 구조:</strong> 고정비 비율 ${fixedCostRatio.toFixed(1)}%로 예측 가능한 비용 구조를 확립했습니다.</p>
                    <p class="mb-2">• <strong>성장 잠재력:</strong> 현재 운영 모델의 확장성이 검증되어 추가 투자 기회가 매력적입니다.</p>
                    <p>• <strong>지속 성장:</strong> 현재 수익률 기준으로 연 ${(profitMargin * 12).toFixed(1)}% 수익률 달성 가능합니다.</p>
                `;
            } else if (profitMargin >= 5) {
                outlook = `
                    <div class="performance-badge performance-good mb-3">
                        <i class="fas fa-thumbs-up mr-1"></i>
                        양호한 수익 기반 구축
                    </div>
                    <p class="mb-2">• <strong>안정적 수익:</strong> 월 순이익률 ${profitMargin.toFixed(1)}%로 꾸준한 수익 창출이 확인되었습니다.</p>
                    <p class="mb-2">• <strong>비용 효율성:</strong> 고정비와 변동비의 균형적 관리로 건전한 수익 구조를 유지하고 있습니다.</p>
                    <p class="mb-2">• <strong>개선 여지:</strong> 변동비 최적화를 통해 추가 수익률 향상이 가능한 상황입니다.</p>
                    <p>• <strong>성장 기반:</strong> 현재의 안정적 기반 위에서 단계적 확장 전략이 유효합니다.</p>
                `;
            } else if (profitMargin >= 0) {
                outlook = `
                    <div class="performance-badge performance-good mb-3">
                        <i class="fas fa-chart-line mr-1"></i>
                        수익 기반 확립 단계
                    </div>
                    <p class="mb-2">• <strong>흑자 달성:</strong> 월 순이익률 ${profitMargin.toFixed(1)}%로 수익성이 확보된 상태입니다.</p>
                    <p class="mb-2">• <strong>운영 최적화:</strong> 고정비 ${fixedCostRatio.toFixed(1)}%, 변동비 ${variableCostRatio.toFixed(1)}%의 구조로 효율성 개선 여지가 있습니다.</p>
                    <p class="mb-2">• <strong>시장 적응:</strong> 태국 에어비앤비 시장에서의 운영 노하우가 축적되고 있습니다.</p>
                    <p>• <strong>성장 동력:</strong> 운영 경험과 현지 네트워크를 바탕으로 수익률 개선이 기대됩니다.</p>
                `;
            } else {
                // 적자인 경우에도 긍정적 관점으로 접근
                outlook = `
                    <div class="performance-badge performance-average mb-3">
                        <i class="fas fa-seedling mr-1"></i>
                        시장 적응 및 기반 구축 중
                    </div>
                    <p class="mb-2">• <strong>투자 단계:</strong> 현재는 시장 진입 및 운영 시스템 구축에 투자하는 중요한 시기입니다.</p>
                    <p class="mb-2">• <strong>경험 축적:</strong> 태국 현지 시장 이해도와 운영 노하우가 빠르게 축적되고 있습니다.</p>
                    <p class="mb-2">• <strong>인프라 완성:</strong> 숙소 운영 시스템과 관리 프로세스가 안정화되고 있습니다.</p>
                    <p>• <strong>수익 전환점:</strong> 운영 효율성 개선과 시장 적응을 통해 수익성 개선이 예상됩니다.</p>
                `;
            }
            
            outlookDiv.innerHTML = outlook;
        }

        function calculateAverageMargin() {
            let totalMargin = 0;
            let validAccommodations = 0;
            
            settlementData.accommodations.forEach(accommodation => {
                const accTransactions = settlementData.transactions.filter(t => t.accommodationId === accommodation.id);
                
                let revenue = 0;
                let expenses = 0;
                
                accTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        revenue += parseFloat(transaction.amount || 0);
                    } else if (transaction.type === 'expense') {
                        expenses += parseFloat(transaction.amount || 0);
                    }
                });
                
                if (revenue > 0) {
                    const margin = ((revenue - expenses) / revenue) * 100;
                    totalMargin += margin;
                    validAccommodations++;
                }
            });
            
            return validAccommodations > 0 ? (totalMargin / validAccommodations).toFixed(1) : '0.0';
        }

        function getBestPerformingAccommodation() {
            let bestAccommodation = null;
            let bestProfit = -Infinity;
            
            settlementData.accommodations.forEach(accommodation => {
                const accTransactions = settlementData.transactions.filter(t => t.accommodationId === accommodation.id);
                
                let revenue = 0;
                let expenses = 0;
                
                accTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        revenue += parseFloat(transaction.amount || 0);
                    } else if (transaction.type === 'expense') {
                        expenses += parseFloat(transaction.amount || 0);
                    }
                });
                
                const profit = revenue - expenses;
                if (profit > bestProfit) {
                    bestProfit = profit;
                    bestAccommodation = accommodation;
                }
            });
            
            return bestAccommodation ? bestAccommodation.name : '해당 없음';
        }

        function calculateInvestmentPerformance() {
            const transactions = settlementData.transactions;
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            let rentExpenses = 0; // 렌트비 (고정비용)
            let variableExpenses = 0; // 변동비용
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalRevenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    const amount = parseFloat(transaction.amount || 0);
                    totalExpenses += amount;
                    
                    if (transaction.category === 'rent') {
                        rentExpenses += amount;
                    } else {
                        variableExpenses += amount;
                    }
                }
            });
            
            const netProfit = totalRevenue - totalExpenses;
            const investorShare = (investorData.ownershipPercentage || 100) / 100;
            const investorProfit = netProfit * investorShare;
            
            // 매출 대비 수익률
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
            
            // 고정비 비율
            const fixedCostRatio = totalRevenue > 0 ? (rentExpenses / totalRevenue * 100) : 0;
            
            // 연환산 수익률 (매월 누적 기준)
            // 실제로는 12개월 데이터가 필요하지만, 현재 월 데이터로 추정
            const annualizedReturn = profitMargin * 12;
            
            // 표시
            document.getElementById('monthlyReturn').textContent = profitMargin.toFixed(1) + '%';
            document.getElementById('annualizedReturn').textContent = annualizedReturn.toFixed(1) + '%';
            
            // "투자회수 예상기간" 텍스트를 "고정비 비율"로 변경
            const paybackElement = document.querySelector('#paybackPeriod')?.previousElementSibling;
            if (paybackElement) {
                paybackElement.textContent = '고정비 비율';
            }
            const paybackPeriodElement = document.getElementById('paybackPeriod');
            if (paybackPeriodElement) {
                paybackPeriodElement.textContent = fixedCostRatio.toFixed(1) + '%';
            }
        }

        function generateReservationAnalysis() {
            console.log('📅 예약률 분석 시작');
            console.log('📊 예약 데이터:', reservationData);
            
            // 월이 선택되지 않은 경우 현재 월 사용
            let targetMonth = month;
            if (!targetMonth || targetMonth === 'null') {
                targetMonth = new Date().toISOString().substring(0, 7);
                console.log('⚠️ 선택된 월이 없어 현재 월 사용:', targetMonth);
            }
            
            // 선택된 월의 예약 데이터만 필터링
            const monthlyReservations = reservationData.filter(reservation => {
                const checkIn = new Date(reservation.checkIn);
                const checkOut = new Date(reservation.checkOut);
                const targetYear = parseInt(targetMonth.split('-')[0]);
                const targetMonthNum = parseInt(targetMonth.split('-')[1]);
                
                // 체크인 또는 체크아웃이 해당 월에 포함되는 예약
                return (checkIn.getFullYear() === targetYear && (checkIn.getMonth() + 1) === targetMonthNum) ||
                       (checkOut.getFullYear() === targetYear && (checkOut.getMonth() + 1) === targetMonthNum) ||
                       (checkIn <= new Date(targetYear, targetMonthNum - 1, 1) && 
                        checkOut >= new Date(targetYear, targetMonthNum, 0));
            });
            
            console.log('📅 해당 월 예약:', monthlyReservations.length + '건');
            
            // 전체 통계 계산
            let totalStayDays = 0;
            let totalReservations = monthlyReservations.length;
            let totalRevenue = 0;
            let occupiedDays = 0;
            
            // 해당 월의 총 일수 계산
            const targetYear = parseInt(targetMonth.split('-')[0]);
            const targetMonthNum = parseInt(targetMonth.split('-')[1]);
            const daysInMonth = new Date(targetYear, targetMonthNum, 0).getDate();
            const totalAvailableDays = daysInMonth * (settlementData.accommodations?.length || 1);
            
            monthlyReservations.forEach(reservation => {
                const checkIn = new Date(reservation.checkIn);
                const checkOut = new Date(reservation.checkOut);
                
                // 숙박 일수 계산 (체크아웃 날짜는 제외)
                const stayDays = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                totalStayDays += stayDays;
                
                // 해당 월에 포함되는 숙박일수만 계산
                const monthStart = new Date(targetYear, targetMonthNum - 1, 1);
                const monthEnd = new Date(targetYear, targetMonthNum, 0);
                const actualCheckIn = checkIn > monthStart ? checkIn : monthStart;
                const actualCheckOut = checkOut < monthEnd ? checkOut : monthEnd;
                
                if (actualCheckIn <= actualCheckOut) {
                    const monthlyStayDays = Math.ceil((actualCheckOut - actualCheckIn) / (1000 * 60 * 60 * 24)) + 1;
                    occupiedDays += monthlyStayDays;
                }
                
                // 예약 데이터에서 totalAmount 가져오거나, 회계 데이터에서 찾기
                let reservationRevenue = parseFloat(reservation.totalAmount) || 0;
                
                if (reservationRevenue === 0 && accountingData && accountingData.length > 0) {
                    const checkInDateStr = checkIn.toISOString().split('T')[0];
                    const checkOutDateStr = checkOut.toISOString().split('T')[0];
                    
                    // 해당 예약 기간 내의 수입 데이터 찾기
                    const relatedIncomes = accountingData.filter(acc => {
                        if (acc.type !== 'income') return false;
                        
                        const accAccId = acc.accommodationId;
                        const resAccId = reservation.accommodationId;
                        const isMatchingAccommodation = accAccId == resAccId || parseInt(accAccId) == parseInt(resAccId);
                        
                        if (!isMatchingAccommodation) return false;
                        
                        const accDate = new Date(acc.transactionDate || acc.date);
                        return accDate >= checkIn && accDate <= checkOut;
                    });
                    
                    reservationRevenue = relatedIncomes.reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
                }
                
                totalRevenue += reservationRevenue;
            });
            
            // 평균값 계산
            const averageStayDays = totalReservations > 0 ? (totalStayDays / totalReservations) : 0;
            const averageDailyRate = totalStayDays > 0 ? (totalRevenue / totalStayDays) : 0;
            const occupancyRate = totalAvailableDays > 0 ? (occupiedDays / totalAvailableDays * 100) : 0;
            const vacantDays = totalAvailableDays - occupiedDays;
            
            console.log('📊 예약률 통계:', {
                totalReservations,
                totalStayDays,
                totalRevenue: Math.round(totalRevenue),
                averageStayDays: averageStayDays.toFixed(1),
                averageDailyRate: Math.round(averageDailyRate),
                occupancyRate: occupancyRate.toFixed(1),
                occupiedDays,
                vacantDays,
                totalAvailableDays,
                accountingDataCount: accountingData ? accountingData.length : 0
            });
            
            // UI 업데이트
            document.getElementById('averageStayDays').textContent = averageStayDays.toFixed(1) + '일';
            document.getElementById('averageDailyRate').textContent = Math.round(averageDailyRate).toLocaleString() + ' THB';
            document.getElementById('occupancyRate').textContent = occupancyRate.toFixed(1) + '%';
            document.getElementById('vacantDays').textContent = vacantDays + '일';
            
            // 숙소별 상세 테이블 생성
            generateAccommodationReservationTable(monthlyReservations, targetYear, targetMonthNum, daysInMonth);
        }
        
        function generateAccommodationReservationTable(monthlyReservations, targetYear, targetMonthNum, daysInMonth) {
            const tableBody = document.getElementById('accommodationReservationTable');
            tableBody.innerHTML = '';
            
            if (!settlementData.accommodations || settlementData.accommodations.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" class="text-center py-6 text-gray-500">숙소 데이터가 없습니다.</td>';
                tableBody.appendChild(row);
                return;
            }
            
            settlementData.accommodations.forEach(accommodation => {
                // 해당 숙소의 예약만 필터링
                const accommodationReservations = monthlyReservations.filter(res => 
                    res.accommodationId == accommodation.id || 
                    parseInt(res.accommodationId) == accommodation.id
                );
                
                let accommodationStayDays = 0;
                let accommodationRevenue = 0;
                let accommodationOccupiedDays = 0;
                
                accommodationReservations.forEach(reservation => {
                    const checkIn = new Date(reservation.checkIn);
                    const checkOut = new Date(reservation.checkOut);
                    const stayDays = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                    accommodationStayDays += stayDays;
                    
                    // 예약 데이터에서 totalAmount 가져오거나, 없으면 회계 데이터에서 찾기
                    let reservationRevenue = parseFloat(reservation.totalAmount) || 0;
                    
                    // totalAmount가 0이거나 없으면 회계 데이터에서 해당 숙소의 수입 찾기
                    if (reservationRevenue === 0 && accountingData && accountingData.length > 0) {
                        const checkInDateStr = checkIn.toISOString().split('T')[0];
                        const checkOutDateStr = checkOut.toISOString().split('T')[0];
                        
                        // 해당 예약 기간 내의 수입 데이터 찾기
                        const relatedIncomes = accountingData.filter(acc => {
                            if (acc.type !== 'income') return false;
                            
                            // 숙소 ID 매칭
                            const accAccId = acc.accommodationId;
                            const resAccId = reservation.accommodationId;
                            const isMatchingAccommodation = accAccId == resAccId || parseInt(accAccId) == parseInt(resAccId);
                            
                            if (!isMatchingAccommodation) return false;
                            
                            // 날짜 범위 확인
                            const accDate = new Date(acc.transactionDate || acc.date);
                            return accDate >= checkIn && accDate <= checkOut;
                        });
                        
                        reservationRevenue = relatedIncomes.reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
                        
                        console.log(`💰 예약 [${checkInDateStr}~${checkOutDateStr}] 수익: ${reservationRevenue} THB (회계데이터에서 ${relatedIncomes.length}건 찾음)`);
                    }
                    
                    accommodationRevenue += reservationRevenue;
                    
                    // 해당 월에 포함되는 숙박일수
                    const monthStart = new Date(targetYear, targetMonthNum - 1, 1);
                    const monthEnd = new Date(targetYear, targetMonthNum, 0);
                    const actualCheckIn = checkIn > monthStart ? checkIn : monthStart;
                    const actualCheckOut = checkOut < monthEnd ? checkOut : monthEnd;
                    
                    if (actualCheckIn <= actualCheckOut) {
                        const monthlyStayDays = Math.ceil((actualCheckOut - actualCheckIn) / (1000 * 60 * 60 * 24)) + 1;
                        accommodationOccupiedDays += monthlyStayDays;
                    }
                });
                
                const averageStay = accommodationReservations.length > 0 ? (accommodationStayDays / accommodationReservations.length) : 0;
                const accommodationOccupancyRate = daysInMonth > 0 ? (accommodationOccupiedDays / daysInMonth * 100) : 0;
                
                // 예약에서 수익을 못 찾았으면 회계 데이터에서 해당 월 전체 수입을 가져와서 사용
                if (accommodationRevenue === 0 && accountingData && accountingData.length > 0) {
                    const monthlyIncomes = accountingData.filter(acc => {
                        if (acc.type !== 'income') return false;
                        
                        const accAccId = acc.accommodationId;
                        const targetAccId = accommodation.id;
                        const isMatchingAccommodation = accAccId == targetAccId || parseInt(accAccId) == parseInt(targetAccId);
                        
                        if (!isMatchingAccommodation) return false;
                        
                        const accDate = new Date(acc.transactionDate || acc.date);
                        return accDate.getFullYear() === targetYear && (accDate.getMonth() + 1) === targetMonthNum;
                    });
                    
                    accommodationRevenue = monthlyIncomes.reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
                    console.log(`🏠 ${accommodation.name} 월별 총 수입: ${accommodationRevenue} THB (${monthlyIncomes.length}건)`);
                }
                
                // 최종 대안: 숙박일이 있지만 수익이 0인 경우, 전체 평균 일일 요금 사용
                let finalDailyRate = accommodationStayDays > 0 ? (accommodationRevenue / accommodationStayDays) : 0;
                
                // 만약 여전히 0이고 숙박일이 있다면, 다른 숙소의 평균 요금을 참고
                if (finalDailyRate === 0 && accommodationStayDays > 0 && settlementData.accommodations && settlementData.accommodations.length > 1) {
                    // 전체 월별 수입을 전체 예약 숙박일로 나눈 평균 사용
                    const totalMonthlyIncome = accountingData ? accountingData.filter(acc => {
                        if (acc.type !== 'income') return false;
                        const accDate = new Date(acc.transactionDate || acc.date);
                        return accDate.getFullYear() === targetYear && (accDate.getMonth() + 1) === targetMonthNum;
                    }).reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0) : 0;
                    
                    const totalMonthlyStayDays = monthlyReservations.reduce((sum, res) => {
                        const checkIn = new Date(res.checkIn);
                        const checkOut = new Date(res.checkOut);
                        return sum + Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                    }, 0);
                    
                    if (totalMonthlyStayDays > 0 && totalMonthlyIncome > 0) {
                        finalDailyRate = totalMonthlyIncome / totalMonthlyStayDays;
                        accommodationRevenue = finalDailyRate * accommodationStayDays;
                        console.log(`📊 ${accommodation.name} 평균 요금 적용: ${Math.round(finalDailyRate)} THB/일`);
                    }
                }
                
                console.log(`📊 ${accommodation.name} 상세:`, {
                    예약건수: accommodationReservations.length,
                    총숙박일: accommodationStayDays,
                    총수익: Math.round(accommodationRevenue),
                    일평균수익: Math.round(finalDailyRate)
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-left">${accommodation.name || '이름 없음'}</td>
                    <td class="px-4 py-3 text-center">${accommodationReservations.length}건</td>
                    <td class="px-4 py-3 text-center">${accommodationOccupiedDays}일</td>
                    <td class="px-4 py-3 text-center">${averageStay.toFixed(1)}일</td>
                    <td class="px-4 py-3 text-center">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            accommodationOccupancyRate >= 70 ? 'bg-green-100 text-green-800' :
                            accommodationOccupancyRate >= 50 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${accommodationOccupancyRate.toFixed(1)}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">${Math.round(finalDailyRate).toLocaleString()} THB</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 유틸리티 함수들
        function formatMoney(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '0 THB';
            }
            return `${Math.round(amount).toLocaleString()} THB`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ko-KR');
        }

        // PDF 다운로드 함수
        function downloadPDF() {
            // 버튼 숨기기
            const button = document.querySelector('.no-print');
            button.style.display = 'none';
            
            // PDF 생성 옵션
            const opt = {
                margin: 0.5,
                filename: `투자자_정산_리포트_${investorData ? investorData.name : ''}${month ? '_' + month : ''}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    scrollX: 0,
                    scrollY: 0 
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a4', 
                    orientation: 'portrait' 
                },
                pagebreak: { 
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.page-break'
                }
            };

            // PDF 생성 및 다운로드
            html2pdf().from(document.body).set(opt).save().then(function() {
                // PDF 생성 완료 후 버튼 다시 보이기
                button.style.display = 'block';
                console.log('✅ PDF 저장 완료');
            }).catch(function(error) {
                console.error('❌ PDF 생성 오류:', error);
                button.style.display = 'block';
                alert('PDF 생성 중 오류가 발생했습니다.');
            });
        }
    </script>
</body>
</html>