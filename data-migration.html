<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 마이그레이션 - Firebase</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-database mr-3 text-blue-600"></i>
                    데이터 마이그레이션 도구
                </h1>
                <p class="text-gray-600">localStorage에 저장된 기존 데이터를 Firebase로 이전합니다.</p>
                <p class="text-sm text-blue-600 mt-2">📱 <strong>Firebase 연동 후 PC와 모바일 간 실시간 동기화!</strong></p>
            </div>
        </div>

        <!-- 연결 상태 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-wifi mr-2 text-green-600"></i>
                Firebase 연결 상태
            </h2>
            <div id="connectionStatus" class="space-y-2">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-gray-400 mr-3" id="statusIndicator"></span>
                    <span id="statusText" class="text-gray-600">확인 중...</span>
                </div>
                <div id="connectionDetails" class="text-sm text-gray-500 ml-6 hidden"></div>
            </div>
        </div>

        <!-- 데이터 현황 -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- 로컬 데이터 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-hard-drive mr-2 text-gray-600"></i>
                    로컬 데이터 (localStorage)
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">투자자</span>
                        <span id="localInvestorCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">숙소</span>
                        <span id="localAccommodationCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">예약</span>
                        <span id="localReservationCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">회계</span>
                        <span id="localAccountingCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                </div>
            </div>

            <!-- Firebase 데이터 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fab fa-google mr-2 text-orange-600"></i>
                    Firebase 데이터
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">투자자</span>
                        <span id="firebaseInvestorCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">숙소</span>
                        <span id="firebaseAccommodationCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">예약</span>
                        <span id="firebaseReservationCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">회계</span>
                        <span id="firebaseAccountingCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 마이그레이션 작업 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-exchange-alt mr-2 text-blue-600"></i>
                데이터 마이그레이션
            </h2>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="migrateInvestors()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-users mr-2"></i>
                    투자자 마이그레이션
                </button>

                <button onclick="migrateAccommodations()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-home mr-2"></i>
                    숙소 마이그레이션
                </button>

                <button onclick="migrateReservations()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-calendar-check mr-2"></i>
                    예약 마이그레이션
                </button>

                <button onclick="migrateAccounting()" 
                        class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-coins mr-2"></i>
                    회계 마이그레이션
                </button>
            </div>

            <div class="mt-6 pt-4 border-t">
                <button onclick="migrateAll()" 
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-4 rounded-lg font-medium transition-all transform hover:scale-105">
                    <i class="fas fa-rocket mr-2"></i>
                    🚀 전체 데이터 마이그레이션
                </button>
            </div>
        </div>

        <!-- 로그 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-list mr-2 text-gray-600"></i>
                    마이그레이션 로그
                </h2>
                <button onclick="clearLog()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-trash mr-1"></i>
                    로그 지우기
                </button>
            </div>
            <div id="migrationLog" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">마이그레이션 로그가 여기에 표시됩니다...</div>
            </div>
        </div>

        <!-- 뒤로가기 버튼 -->
        <div class="mt-8 text-center">
            <button onclick="window.location.href='index.html'" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                메인 페이지로 돌아가기
            </button>
        </div>
    </div>

    <script>
        // 페이지 로드시 실행
        document.addEventListener('DOMContentLoaded', async function() {
            await checkConnectionStatus();
            await checkLocalData();
            await checkFirebaseData();
        });

        // Firebase 연결 상태 확인
        async function checkConnectionStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const connectionDetails = document.getElementById('connectionDetails');

            if (!firebaseStorage.isConfigured()) {
                statusText.textContent = '❌ Firebase 설정 필요';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-400 mr-3';
                connectionDetails.textContent = 'Firebase 연동을 먼저 설정해주세요.';
                connectionDetails.classList.remove('hidden');
                return;
            }

            statusText.textContent = '연결 테스트 중...';
            statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 mr-3';

            const result = await firebaseStorage.testConnection();
            
            if (result.success) {
                statusText.textContent = '✅ Firebase 연결됨';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-400 mr-3';
                connectionDetails.textContent = result.message;
            } else {
                statusText.textContent = '❌ 연결 실패';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-400 mr-3';
                connectionDetails.textContent = result.error;
            }
            connectionDetails.classList.remove('hidden');
        }

        // 로컬 데이터 확인
        async function checkLocalData() {
            const investorData = JSON.parse(localStorage.getItem('investorData') || '[]');
            const accommodationData = JSON.parse(localStorage.getItem('accommodationData') || '[]');
            const reservationData = JSON.parse(localStorage.getItem('reservationData') || '[]');
            const accountingData = JSON.parse(localStorage.getItem('accountingData') || '[]');

            document.getElementById('localInvestorCount').textContent = `${investorData.length}명`;
            document.getElementById('localAccommodationCount').textContent = `${accommodationData.length}개`;
            document.getElementById('localReservationCount').textContent = `${reservationData.length}건`;
            document.getElementById('localAccountingCount').textContent = `${accountingData.length}건`;
        }

        // Firebase 데이터 확인
        async function checkFirebaseData() {
            try {
                if (!firebaseStorage.isConfigured()) {
                    document.getElementById('firebaseInvestorCount').textContent = '설정 필요';
                    document.getElementById('firebaseAccommodationCount').textContent = '설정 필요';
                    document.getElementById('firebaseReservationCount').textContent = '설정 필요';
                    document.getElementById('firebaseAccountingCount').textContent = '설정 필요';
                    return;
                }

                const investors = await firebaseStorage.loadInvestors();
                const accommodations = await firebaseStorage.loadAccommodations();
                const reservations = await firebaseStorage.loadReservations();
                const accounting = await firebaseStorage.loadAccounting();

                document.getElementById('firebaseInvestorCount').textContent = `${investors.length}명`;
                document.getElementById('firebaseAccommodationCount').textContent = `${accommodations.length}개`;
                document.getElementById('firebaseReservationCount').textContent = `${reservations.length}건`;
                document.getElementById('firebaseAccountingCount').textContent = `${accounting.length}건`;

            } catch (error) {
                log('Firebase 데이터 확인 중 오류: ' + error.message, 'error');
            }
        }

        // 투자자 마이그레이션
        async function migrateInvestors() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('investorData') || '[]');
            
            if (localData.length === 0) {
                log('마이그레이션할 투자자 데이터가 없습니다.', 'warning');
                return;
            }

            log(`투자자 ${localData.length}명 Firebase로 마이그레이션 시작...`, 'info');

            for (const investor of localData) {
                try {
                    await firebaseStorage.saveInvestor(investor);
                    log(`✅ 투자자 "${investor.name}" 마이그레이션 성공`, 'success');
                } catch (error) {
                    log(`❌ 투자자 "${investor.name}" 마이그레이션 오류: ${error.message}`, 'error');
                }
            }

            log('투자자 마이그레이션 완료!', 'success');
            await checkFirebaseData();
        }

        // 숙소 마이그레이션
        async function migrateAccommodations() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('accommodationData') || '[]');
            
            if (localData.length === 0) {
                log('마이그레이션할 숙소 데이터가 없습니다.', 'warning');
                return;
            }

            log(`숙소 ${localData.length}개 Firebase로 마이그레이션 시작...`, 'info');

            for (const accommodation of localData) {
                try {
                    await firebaseStorage.saveAccommodation(accommodation);
                    log(`✅ 숙소 "${accommodation.name}" 마이그레이션 성공`, 'success');
                } catch (error) {
                    log(`❌ 숙소 "${accommodation.name}" 마이그레이션 오류: ${error.message}`, 'error');
                }
            }

            log('숙소 마이그레이션 완료!', 'success');
            await checkFirebaseData();
        }

        // 예약 마이그레이션
        async function migrateReservations() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('reservationData') || '[]');
            
            if (localData.length === 0) {
                log('마이그레이션할 예약 데이터가 없습니다.', 'warning');
                return;
            }

            log(`예약 ${localData.length}건 Firebase로 마이그레이션 시작...`, 'info');

            for (const reservation of localData) {
                try {
                    await firebaseStorage.saveReservation(reservation);
                    log(`✅ 예약 마이그레이션 성공 (ID: ${reservation.id})`, 'success');
                } catch (error) {
                    log(`❌ 예약 마이그레이션 오류: ${error.message}`, 'error');
                }
            }

            log('예약 마이그레이션 완료!', 'success');
            await checkFirebaseData();
        }

        // 회계 마이그레이션
        async function migrateAccounting() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('accountingData') || '[]');
            
            if (localData.length === 0) {
                log('마이그레이션할 회계 데이터가 없습니다.', 'warning');
                return;
            }

            log(`회계 ${localData.length}건 Firebase로 마이그레이션 시작...`, 'info');

            for (const accounting of localData) {
                try {
                    await firebaseStorage.saveAccounting(accounting);
                    log(`✅ 회계 마이그레이션 성공 (ID: ${accounting.id})`, 'success');
                } catch (error) {
                    log(`❌ 회계 마이그레이션 오류: ${error.message}`, 'error');
                }
            }

            log('회계 마이그레이션 완료!', 'success');
            await checkFirebaseData();
        }

        // 전체 마이그레이션
        async function migrateAll() {
            if (!confirm('전체 데이터를 Firebase로 마이그레이션하시겠습니까?\\n\\n이 작업은 몇 분이 소요될 수 있습니다.')) {
                return;
            }

            log('=== 🚀 전체 데이터 마이그레이션 시작 ===', 'info');
            
            await migrateInvestors();
            await migrateAccommodations();
            await migrateReservations();
            await migrateAccounting();
            
            log('=== ✅ 전체 데이터 마이그레이션 완료! ===', 'success');
            log('이제 PC와 모바일에서 데이터가 실시간 동기화됩니다! 🎉', 'success');
        }

        // 로그 출력
        function log(message, type = 'info') {
            const logContainer = document.getElementById('migrationLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };

            const logEntry = document.createElement('div');
            logEntry.className = `${colors[type]} mb-1`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 로그 지우기
        function clearLog() {
            document.getElementById('migrationLog').innerHTML = '<div class="text-gray-500">마이그레이션 로그가 여기에 표시됩니다...</div>';
        }
    </script>
</body>
</html>