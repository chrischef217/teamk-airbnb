<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 마이그레이션 - Firebase</title>
    <!-- Service Worker 완전 차단 (최우선 로드) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-database mr-3 text-blue-600"></i>
                            데이터 관리 도구
                        </h1>
                        <p class="text-gray-600">Firebase 연동, 데이터 마이그레이션, 백업 관리를 통합 제공합니다.</p>
                        <p class="text-sm text-blue-600 mt-2">📱 <strong>Firebase 연동 후 PC와 모바일 간 실시간 동기화!</strong></p>
                    </div>
                    <a href="firebase-setup.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center">
                        <i class="fas fa-cog mr-2"></i>
                        데이터베이스 설정
                    </a>
                </div>
            </div>
        </div>

        <!-- 연결 상태 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-wifi mr-2 text-green-600"></i>
                Firebase 연결 상태
            </h2>
            <div id="connectionStatus" class="space-y-2">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-gray-400 mr-3" id="statusIndicator"></span>
                    <span id="statusText" class="text-gray-600">확인 중...</span>
                </div>
                <div id="connectionDetails" class="text-sm text-gray-500 ml-6 hidden"></div>
            </div>
        </div>

        <!-- 데이터 현황 -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- 로컬 데이터 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-hard-drive mr-2 text-gray-600"></i>
                    로컬 데이터 (localStorage)
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">투자자</span>
                        <span id="localInvestorCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">숙소</span>
                        <span id="localAccommodationCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">예약</span>
                        <span id="localReservationCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <span class="text-gray-700">회계</span>
                        <span id="localAccountingCount" class="font-semibold text-blue-600">확인 중...</span>
                    </div>
                </div>
            </div>

            <!-- Firebase 데이터 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fab fa-google mr-2 text-orange-600"></i>
                    Firebase 데이터
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">투자자</span>
                        <span id="firebaseInvestorCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">숙소</span>
                        <span id="firebaseAccommodationCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">예약</span>
                        <span id="firebaseReservationCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded">
                        <span class="text-gray-700">회계</span>
                        <span id="firebaseAccountingCount" class="font-semibold text-orange-600">확인 중...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 마이그레이션 작업 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-exchange-alt mr-2 text-blue-600"></i>
                데이터 마이그레이션
            </h2>

            <div class="text-center space-y-4">
                <button onclick="migrateLocalToFirebase()" 
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-4 rounded-lg font-medium transition-all transform hover:scale-105">
                    <i class="fas fa-upload mr-2"></i>
                    📤 로컬 → Firebase 마이그레이션
                </button>
                
                <button onclick="migrateFirebaseToLocal()" 
                        class="w-full bg-gradient-to-r from-green-800 to-green-600 hover:from-green-900 hover:to-green-700 text-white px-8 py-4 rounded-lg font-medium transition-all transform hover:scale-105">
                    <i class="fas fa-download mr-2"></i>
                    📥 Firebase → 로컬 마이그레이션
                </button>
                
                <button onclick="clearLocalDataOnly()" 
                        class="w-full bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-lg font-medium transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>
                    🗑️ 로컬 데이터 (localStorage)만 삭제
                </button>
            </div>
        </div>

        <!-- 로그 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-list mr-2 text-gray-600"></i>
                    마이그레이션 로그
                </h2>
                <button onclick="clearLog()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-trash mr-1"></i>
                    로그 지우기
                </button>
            </div>
            <div id="migrationLog" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">마이그레이션 로그가 여기에 표시됩니다...</div>
            </div>
        </div>

        <!-- 백업 & 복원 섹션 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                데이터 백업 & 복원
            </h2>

            <!-- 백업 현황 -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- 마지막 백업 정보 -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-history text-blue-600 mr-2"></i>
                        마지막 백업 현황
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">다운로드 일시:</span>
                            <span id="lastDownloadTime" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">백업 파일:</span>
                            <span class="font-medium text-blue-600">Teamk_백업_데이터.xlsx</span>
                        </div>
                    </div>
                </div>

                <!-- 데이터 통계 -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-database text-green-600 mr-2"></i>
                        현재 데이터 현황
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">숙소:</span>
                            <span id="accommodationCountBackup" class="font-medium">0개</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">회계:</span>
                            <span id="accountingCountBackup" class="font-medium">0개</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">투자자:</span>
                            <span id="investorCountBackup" class="font-medium">0개</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 백업 다운로드 -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-green-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-green-800">백업 파일 다운로드</h4>
                        <ul class="text-sm text-green-700 mt-2 space-y-1">
                            <li>• 모든 테이블 데이터가 하나의 엑셀 파일로 다운로드됩니다</li>
                            <li>• 각 테이블은 별도의 워크시트로 구성됩니다</li>
                            <li>• 파일명: Teamk_백업_데이터_YYYYMMDD_HHMMSS.xlsx</li>
                            <li>• 다운로드 후 안전한 위치에 보관하시기 바랍니다</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button onclick="downloadBackup()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg font-medium transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    전체 데이터 백업 다운로드
                </button>
            </div>

            <!-- 진행 상황 표시 -->
            <div id="backupProgress" class="mt-4 hidden">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">백업 진행 상황</span>
                    <span id="progressText" class="text-sm text-gray-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 데이터 복원 섹션 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-upload text-orange-600 mr-2"></i>
                데이터 백업 복원 (업로드)
            </h2>

            <!-- 경고 메시지 -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-red-800">⚠️ 데이터 복원 시 주의사항</h4>
                        <ul class="text-sm text-red-700 mt-2 space-y-1">
                            <li>• <strong>기존 데이터가 모두 삭제되고 백업 파일의 데이터로 교체됩니다</strong></li>
                            <li>• 복원 작업은 되돌릴 수 없으니 신중히 결정해주세요</li>
                            <li>• 백업 파일은 이 시스템에서 다운로드한 Excel 파일만 지원됩니다</li>
                            <li>• 복원 전 현재 데이터를 백업하시길 권장합니다</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 파일 업로드 섹션 -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-yellow-600 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-yellow-800">지원 파일 형식</h4>
                        <ul class="text-sm text-yellow-700 mt-2 space-y-1">
                            <li>• Excel 파일 (.xlsx) - 이 시스템에서 다운로드한 백업 파일</li>
                            <li>• 파일 크기 제한: 최대 10MB</li>
                            <li>• 필요한 워크시트: 숙소관리, 수익관리, 투자자관리</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 파일 선택 및 업로드 -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-4">
                <div class="text-center">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <div class="mb-4">
                        <input type="file" id="backupFileInput" accept=".xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">
                        <label for="backupFileInput" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center">
                            <i class="fas fa-folder-open mr-2"></i>
                            백업 파일 선택
                        </label>
                    </div>
                    <p class="text-sm text-gray-500">
                        또는 파일을 이 영역으로 드래그하세요
                    </p>
                </div>
            </div>

            <!-- 선택된 파일 정보 -->
            <div id="selectedFileInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-file-excel text-green-600 mr-3"></i>
                        <div>
                            <div id="fileName" class="font-medium text-gray-800"></div>
                            <div id="fileSize" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                    <button onclick="clearSelectedFile()" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- 복원 버튼 -->
            <div class="text-center">
                <button id="restoreButton" onclick="restoreData()" disabled 
                        class="bg-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-8 py-4 rounded-lg font-medium transition-colors">
                    <i class="fas fa-upload mr-2"></i>
                    데이터 복원 실행 (기존 데이터 삭제 후 복원)
                </button>
            </div>

            <!-- 복원 진행 상황 -->
            <div id="restoreProgress" class="mt-4 hidden">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">복원 진행 상황</span>
                    <span id="restoreProgressText" class="text-sm text-gray-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="restoreProgressBar" class="bg-red-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="restoreStatus" class="mt-2 text-sm text-gray-600"></div>
            </div>
        </div>

        <!-- 뒤로가기 버튼 -->
        <div class="mt-8 text-center">
            <button onclick="window.location.href='index.html'" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                메인 페이지로 돌아가기
            </button>
        </div>
    </div>

    <script>
        // 페이지 로드시 실행
        document.addEventListener('DOMContentLoaded', async function() {
            await checkConnectionStatus();
            await checkLocalData();
            await checkFirebaseData();
        });

        // Firebase 연결 상태 확인
        async function checkConnectionStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const connectionDetails = document.getElementById('connectionDetails');

            if (!firebaseStorage.isConfigured()) {
                statusText.textContent = '❌ Firebase 설정 필요';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-400 mr-3';
                connectionDetails.textContent = 'Firebase 연동을 먼저 설정해주세요.';
                connectionDetails.classList.remove('hidden');
                return;
            }

            statusText.textContent = '연결 테스트 중...';
            statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 mr-3';

            const result = await firebaseStorage.testConnection();
            
            if (result.success) {
                statusText.textContent = '✅ Firebase 연결됨';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-400 mr-3';
                connectionDetails.textContent = result.message;
            } else {
                statusText.textContent = '❌ 연결 실패';
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-400 mr-3';
                connectionDetails.textContent = result.error;
            }
            connectionDetails.classList.remove('hidden');
        }

        // 로컬 데이터 확인
        async function checkLocalData() {
            const investorData = JSON.parse(localStorage.getItem('investorData') || '[]');
            const accommodationData = JSON.parse(localStorage.getItem('accommodationData') || '[]');
            const reservationData = JSON.parse(localStorage.getItem('reservationData') || '[]');
            const accountingData = JSON.parse(localStorage.getItem('accountingData') || '[]');

            document.getElementById('localInvestorCount').textContent = `${investorData.length}명`;
            document.getElementById('localAccommodationCount').textContent = `${accommodationData.length}개`;
            document.getElementById('localReservationCount').textContent = `${reservationData.length}건`;
            document.getElementById('localAccountingCount').textContent = `${accountingData.length}건`;
        }

        // Firebase 데이터 확인
        async function checkFirebaseData() {
            try {
                if (!firebaseStorage.isConfigured()) {
                    document.getElementById('firebaseInvestorCount').textContent = '설정 필요';
                    document.getElementById('firebaseAccommodationCount').textContent = '설정 필요';
                    document.getElementById('firebaseReservationCount').textContent = '설정 필요';
                    document.getElementById('firebaseAccountingCount').textContent = '설정 필요';
                    return;
                }

                const investors = await firebaseStorage.loadInvestors();
                const accommodations = await firebaseStorage.loadAccommodations();
                const reservations = await firebaseStorage.loadReservations();
                const accounting = await firebaseStorage.loadAccounting();

                document.getElementById('firebaseInvestorCount').textContent = `${investors.length}명`;
                document.getElementById('firebaseAccommodationCount').textContent = `${accommodations.length}개`;
                document.getElementById('firebaseReservationCount').textContent = `${reservations.length}건`;
                document.getElementById('firebaseAccountingCount').textContent = `${accounting.length}건`;

            } catch (error) {
                log('Firebase 데이터 확인 중 오류: ' + error.message, 'error');
            }
        }



        // 로컬 → Firebase 마이그레이션
        async function migrateLocalToFirebase() {
            // 비밀번호 확인
            const password = prompt('🔒 보안 확인\\n\\n관리자 비밀번호를 입력하세요:');
            if (password !== '881114') {
                alert('❌ 비밀번호가 올바르지 않습니다.');
                log('❌ 로컬→Firebase 마이그레이션 접근 거부: 잘못된 비밀번호', 'error');
                return;
            }

            if (!confirm('로컬 데이터를 Firebase로 업로드하시겠습니까?\\n\\n이 작업은 몇 분이 소요될 수 있습니다.\\n\\n⚠️ Firebase의 기존 데이터는 덮어쓰기됩니다.')) {
                return;
            }

            log('=== 📤 로컬 → Firebase 마이그레이션 시작 ===', 'info');
            
            await migrateLocalInvestorsToFirebase();
            await migrateLocalAccommodationsToFirebase();
            await migrateLocalReservationsToFirebase();
            await migrateLocalAccountingToFirebase();
            
            log('=== ✅ 로컬 → Firebase 마이그레이션 완료! ===', 'success');
            log('로컬 데이터가 Firebase로 성공적으로 업로드되었습니다! 🎉', 'success');
            
            // 데이터 현황 업데이트
            await checkLocalData();
            await checkFirebaseData();
        }

        // Firebase → 로컬 마이그레이션
        async function migrateFirebaseToLocal() {
            // 비밀번호 확인
            const password = prompt('🔒 보안 확인\\n\\n관리자 비밀번호를 입력하세요:');
            if (password !== '881114') {
                alert('❌ 비밀번호가 올바르지 않습니다.');
                log('❌ Firebase→로컬 마이그레이션 접근 거부: 잘못된 비밀번호', 'error');
                return;
            }

            if (!confirm('Firebase 데이터를 로컬로 다운로드하시겠습니까?\\n\\n이 작업은 몇 분이 소요될 수 있습니다.\\n\\n⚠️ 로컬의 기존 데이터는 덮어쓰기됩니다.')) {
                return;
            }

            log('=== 📥 Firebase → 로컬 마이그레이션 시작 ===', 'info');
            
            await migrateFirebaseInvestorsToLocal();
            await migrateFirebaseAccommodationsToLocal();
            await migrateFirebaseReservationsToLocal();
            await migrateFirebaseAccountingToLocal();
            
            log('=== ✅ Firebase → 로컬 마이그레이션 완료! ===', 'success');
            log('Firebase 데이터가 로컬로 성공적으로 다운로드되었습니다! 🎉', 'success');
            
            // 데이터 현황 업데이트
            await checkLocalData();
            await checkFirebaseData();
        }

        // 로컬 → Firebase 개별 마이그레이션 함수들
        async function migrateLocalInvestorsToFirebase() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('investorData') || '[]');
            log(`📊 로컬 투자자 데이터: ${localData.length}명`, 'info');

            if (localData.length > 0) {
                log(`📤 로컬 투자자 → Firebase: ${localData.length}명 업로드 중...`, 'info');
                for (const investor of localData) {
                    try {
                        await firebaseStorage.saveInvestor(investor);
                        log(`✅ "${investor.name}" Firebase 저장 완료`, 'success');
                    } catch (error) {
                        log(`❌ "${investor.name}" Firebase 저장 실패: ${error.message}`, 'error');
                    }
                }
            } else {
                log('📊 로컬에 투자자 데이터가 없습니다.', 'warning');
            }

            log('🎉 투자자 로컬→Firebase 마이그레이션 완료!', 'success');
        }

        async function migrateLocalAccommodationsToFirebase() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('accommodationData') || '[]');
            log(`🏠 로컬 숙소 데이터: ${localData.length}개`, 'info');

            if (localData.length > 0) {
                log(`📤 로컬 숙소 → Firebase: ${localData.length}개 업로드 중...`, 'info');
                for (const accommodation of localData) {
                    try {
                        await firebaseStorage.saveAccommodation(accommodation);
                        log(`✅ "${accommodation.name}" Firebase 저장 완료`, 'success');
                    } catch (error) {
                        log(`❌ "${accommodation.name}" Firebase 저장 실패: ${error.message}`, 'error');
                    }
                }
            } else {
                log('🏠 로컬에 숙소 데이터가 없습니다.', 'warning');
            }

            log('🎉 숙소 로컬→Firebase 마이그레이션 완료!', 'success');
        }

        async function migrateLocalReservationsToFirebase() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('reservationData') || '[]');
            log(`📅 로컬 예약 데이터: ${localData.length}건`, 'info');

            if (localData.length > 0) {
                log(`📤 로컬 예약 → Firebase: ${localData.length}건 업로드 중...`, 'info');
                for (const reservation of localData) {
                    try {
                        await firebaseStorage.saveReservation(reservation);
                        log(`✅ 예약 Firebase 저장 완료 (ID: ${reservation.id})`, 'success');
                    } catch (error) {
                        log(`❌ 예약 Firebase 저장 실패: ${error.message}`, 'error');
                    }
                }
            } else {
                log('📅 로컬에 예약 데이터가 없습니다.', 'warning');
            }

            log('🎉 예약 로컬→Firebase 마이그레이션 완료!', 'success');
        }

        async function migrateLocalAccountingToFirebase() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('accountingData') || '[]');
            log(`💰 로컬 회계 데이터: ${localData.length}건`, 'info');

            if (localData.length > 0) {
                log(`📤 로컬 회계 → Firebase: ${localData.length}건 업로드 중...`, 'info');
                for (const accounting of localData) {
                    try {
                        await firebaseStorage.saveAccounting(accounting);
                        log(`✅ 회계 Firebase 저장 완료 (ID: ${accounting.id})`, 'success');
                    } catch (error) {
                        log(`❌ 회계 Firebase 저장 실패: ${error.message}`, 'error');
                    }
                }
            } else {
                log('💰 로컬에 회계 데이터가 없습니다.', 'warning');
            }

            log('🎉 회계 로컬→Firebase 마이그레이션 완료!', 'success');
        }

        // Firebase → 로컬 개별 마이그레이션 함수들
        async function migrateFirebaseInvestorsToLocal() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            try {
                const firebaseData = await firebaseStorage.loadInvestors();
                log(`📊 Firebase 투자자 데이터: ${firebaseData.length}명`, 'info');

                if (firebaseData.length > 0) {
                    log(`📥 Firebase 투자자 → 로컬: ${firebaseData.length}명 다운로드 중...`, 'info');
                    localStorage.setItem('investorData', JSON.stringify(firebaseData));
                    log(`✅ 투자자 데이터 로컬 저장 완료: ${firebaseData.length}명`, 'success');
                } else {
                    log('📊 Firebase에 투자자 데이터가 없습니다.', 'warning');
                }
            } catch (error) {
                log(`❌ Firebase 투자자 데이터 로드 실패: ${error.message}`, 'error');
            }

            log('🎉 투자자 Firebase→로컬 마이그레이션 완료!', 'success');
        }

        async function migrateFirebaseAccommodationsToLocal() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            try {
                const firebaseData = await firebaseStorage.loadAccommodations();
                log(`🏠 Firebase 숙소 데이터: ${firebaseData.length}개`, 'info');

                if (firebaseData.length > 0) {
                    log(`📥 Firebase 숙소 → 로컬: ${firebaseData.length}개 다운로드 중...`, 'info');
                    localStorage.setItem('accommodationData', JSON.stringify(firebaseData));
                    log(`✅ 숙소 데이터 로컬 저장 완료: ${firebaseData.length}개`, 'success');
                } else {
                    log('🏠 Firebase에 숙소 데이터가 없습니다.', 'warning');
                }
            } catch (error) {
                log(`❌ Firebase 숙소 데이터 로드 실패: ${error.message}`, 'error');
            }

            log('🎉 숙소 Firebase→로컬 마이그레이션 완료!', 'success');
        }

        async function migrateFirebaseReservationsToLocal() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            try {
                const firebaseData = await firebaseStorage.loadReservations();
                log(`📅 Firebase 예약 데이터: ${firebaseData.length}건`, 'info');

                if (firebaseData.length > 0) {
                    log(`📥 Firebase 예약 → 로컬: ${firebaseData.length}건 다운로드 중...`, 'info');
                    localStorage.setItem('reservationData', JSON.stringify(firebaseData));
                    log(`✅ 예약 데이터 로컬 저장 완료: ${firebaseData.length}건`, 'success');
                } else {
                    log('📅 Firebase에 예약 데이터가 없습니다.', 'warning');
                }
            } catch (error) {
                log(`❌ Firebase 예약 데이터 로드 실패: ${error.message}`, 'error');
            }

            log('🎉 예약 Firebase→로컬 마이그레이션 완료!', 'success');
        }

        async function migrateFirebaseAccountingToLocal() {
            if (!firebaseStorage.isConfigured()) {
                log('❌ Firebase 설정이 필요합니다.', 'error');
                return;
            }

            try {
                const firebaseData = await firebaseStorage.loadAccounting();
                log(`💰 Firebase 회계 데이터: ${firebaseData.length}건`, 'info');

                if (firebaseData.length > 0) {
                    log(`📥 Firebase 회계 → 로컬: ${firebaseData.length}건 다운로드 중...`, 'info');
                    localStorage.setItem('accountingData', JSON.stringify(firebaseData));
                    log(`✅ 회계 데이터 로컬 저장 완료: ${firebaseData.length}건`, 'success');
                } else {
                    log('💰 Firebase에 회계 데이터가 없습니다.', 'warning');
                }
            } catch (error) {
                log(`❌ Firebase 회계 데이터 로드 실패: ${error.message}`, 'error');
            }

            log('🎉 회계 Firebase→로컬 마이그레이션 완료!', 'success');
        }

        // 로컬 데이터만 삭제
        async function clearLocalDataOnly() {
            // 비밀번호 확인
            const password = prompt('🔒 보안 확인\\n\\n관리자 비밀번호를 입력하세요:');
            if (password !== '881114') {
                alert('❌ 비밀번호가 올바르지 않습니다.');
                log('❌ 로컬 데이터 삭제 접근 거부: 잘못된 비밀번호', 'error');
                return;
            }

            const confirmMessage = '⚠️ 경고!\\n\\n로컬 저장소(localStorage)의 모든 데이터가 삭제됩니다.\\n\\n삭제될 데이터:\\n• 투자자 데이터\\n• 숙소 데이터\\n• 예약 데이터\\n• 회계 데이터\\n\\nFirebase 데이터는 그대로 유지됩니다.\\n\\n정말로 삭제하시겠습니까?';
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // 한 번 더 확인
            if (!confirm('정말 확실하신가요? 로컬 데이터는 완전히 삭제됩니다!')) {
                return;
            }

            log('=== 🗑️ 로컬 데이터 삭제 시작 ===', 'warning');

            try {
                // 삭제 전 현재 데이터 개수 확인
                const investorData = JSON.parse(localStorage.getItem('investorData') || '[]');
                const accommodationData = JSON.parse(localStorage.getItem('accommodationData') || '[]');
                const reservationData = JSON.parse(localStorage.getItem('reservationData') || '[]');
                const accountingData = JSON.parse(localStorage.getItem('accountingData') || '[]');

                log(`📊 삭제 예정: 투자자 ${investorData.length}명, 숙소 ${accommodationData.length}개, 예약 ${reservationData.length}건, 회계 ${accountingData.length}건`, 'info');

                // 긴급 백업 생성
                const emergencyBackup = {
                    investorData: investorData,
                    accommodationData: accommodationData,
                    reservationData: reservationData,
                    accountingData: accountingData,
                    timestamp: new Date().toISOString(),
                    reason: 'manual_local_data_clear'
                };
                localStorage.setItem('emergency_backup_manual_clear', JSON.stringify(emergencyBackup));
                log('🔒 긴급 백업 생성 완료', 'info');

                // 로컬 데이터 삭제
                localStorage.removeItem('investorData');
                log('✅ 투자자 데이터 삭제 완료', 'success');

                localStorage.removeItem('accommodationData');
                log('✅ 숙소 데이터 삭제 완료', 'success');

                localStorage.removeItem('reservationData');
                log('✅ 예약 데이터 삭제 완료', 'success');

                localStorage.removeItem('accountingData');
                log('✅ 회계 데이터 삭제 완료', 'success');

                // 화면 업데이트
                await checkLocalData();

                log('=== ✅ 로컬 데이터 삭제 완료! ===', 'success');
                log('💡 Firebase 데이터는 그대로 유지됩니다.', 'info');
                log('🔄 Firebase에서 데이터를 다시 불러오려면 각 페이지를 새로고침하세요.', 'info');

                // 성공 알림
                alert('✅ 로컬 데이터 삭제가 완료되었습니다!\\n\\nFirebase 데이터는 그대로 유지됩니다.\\n각 페이지를 새로고침하면 Firebase에서 데이터가 다시 로드됩니다.');

            } catch (error) {
                log('❌ 로컬 데이터 삭제 중 오류: ' + error.message, 'error');
                console.error('로컬 데이터 삭제 오류:', error);
            }
        }

        // 로그 출력
        function log(message, type = 'info') {
            const logContainer = document.getElementById('migrationLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };

            const logEntry = document.createElement('div');
            logEntry.className = `${colors[type]} mb-1`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 로그 지우기
        function clearLog() {
            document.getElementById('migrationLog').innerHTML = '<div class="text-gray-500">마이그레이션 로그가 여기에 표시됩니다...</div>';
        }

        // 백업 기능들
        function updateDataCounts() {
            try {
                const accommodations = JSON.parse(localStorage.getItem('accommodationData') || '[]');
                const accounting = JSON.parse(localStorage.getItem('accountingData') || '[]');
                const investors = JSON.parse(localStorage.getItem('investorData') || '[]');

                document.getElementById('accommodationCountBackup').textContent = accommodations.length + '개';
                document.getElementById('accountingCountBackup').textContent = accounting.length + '개';
                document.getElementById('investorCountBackup').textContent = investors.length + '개';
            } catch (error) {
                console.error('데이터 카운트 업데이트 실패:', error);
            }
        }

        function downloadBackup() {
            // 비밀번호 확인
            const password = prompt('🔒 보안 확인\\n\\n관리자 비밀번호를 입력하세요:');
            if (password !== '881114') {
                alert('❌ 비밀번호가 올바르지 않습니다.');
                log('❌ 전체 데이터 백업 다운로드 접근 거부: 잘못된 비밀번호', 'error');
                return;
            }

            const progress = document.getElementById('backupProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progress.classList.remove('hidden');
            
            try {
                // 진행률 업데이트 함수
                function updateProgress(percentage) {
                    progressBar.style.width = `${percentage}%`;
                    progressText.textContent = `${Math.round(percentage)}%`;
                }

                updateProgress(10);
                
                // localStorage에서 데이터 로드
                const accommodations = JSON.parse(localStorage.getItem('accommodationData') || '[]');
                const accounting = JSON.parse(localStorage.getItem('accountingData') || '[]');
                const investors = JSON.parse(localStorage.getItem('investorData') || '[]');
                
                updateProgress(30);

                // 워크북 생성
                const wb = XLSX.utils.book_new();

                // 숙소 데이터 시트
                if (accommodations.length > 0) {
                    const ws_accommodations = XLSX.utils.json_to_sheet(accommodations);
                    XLSX.utils.book_append_sheet(wb, ws_accommodations, "숙소관리");
                }
                
                updateProgress(50);

                // 회계 데이터 시트
                if (accounting.length > 0) {
                    const ws_accounting = XLSX.utils.json_to_sheet(accounting);
                    XLSX.utils.book_append_sheet(wb, ws_accounting, "수익관리");
                }
                
                updateProgress(70);

                // 투자자 데이터 시트
                if (investors.length > 0) {
                    const ws_investors = XLSX.utils.json_to_sheet(investors);
                    XLSX.utils.book_append_sheet(wb, ws_investors, "투자자관리");
                }

                updateProgress(90);

                // 파일명 생성
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '').slice(0, -5);
                const filename = `Teamk_백업_데이터_${timestamp}.xlsx`;

                // 파일 다운로드
                XLSX.writeFile(wb, filename);
                
                updateProgress(100);

                // 마지막 다운로드 시간 업데이트
                document.getElementById('lastDownloadTime').textContent = now.toLocaleString();
                
                // 성공 메시지
                setTimeout(() => {
                    progress.classList.add('hidden');
                    log('✅ 백업 파일 다운로드 완료: ' + filename, 'success');
                    updateProgress(0);
                }, 1000);

            } catch (error) {
                console.error('백업 다운로드 실패:', error);
                log('❌ 백업 다운로드 실패: ' + error.message, 'error');
                progress.classList.add('hidden');
                updateProgress(0);
            }
        }

        // 파일 선택 처리
        let selectedFile = null;

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 파일 형식 체크
            if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                alert('Excel 파일(.xlsx, .xls)만 지원됩니다.');
                return;
            }

            // 파일 크기 체크 (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('파일 크기는 10MB 이하만 지원됩니다.');
                return;
            }

            selectedFile = file;
            showSelectedFileInfo(file);
        }

        function showSelectedFileInfo(file) {
            const fileInfo = document.getElementById('selectedFileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const restoreButton = document.getElementById('restoreButton');

            fileName.textContent = file.name;
            fileSize.textContent = `크기: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            
            fileInfo.classList.remove('hidden');
            restoreButton.disabled = false;
            restoreButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
        }

        function clearSelectedFile() {
            selectedFile = null;
            document.getElementById('backupFileInput').value = '';
            document.getElementById('selectedFileInfo').classList.add('hidden');
            
            const restoreButton = document.getElementById('restoreButton');
            restoreButton.disabled = true;
            restoreButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
        }

        // 드래그 앤 드롭 지원
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.querySelector('.border-dashed');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('backupFileInput').files = files;
                    handleFileSelect({ target: { files: files } });
                }
            });
        });

        // 데이터 복원 함수
        async function restoreData() {
            if (!selectedFile) {
                alert('복원할 파일을 먼저 선택해주세요.');
                return;
            }

            // 비밀번호 확인
            const password = prompt('🔒 보안 확인\\n\\n관리자 비밀번호를 입력하세요:');
            if (password !== '881114') {
                alert('❌ 비밀번호가 올바르지 않습니다.');
                log('❌ 데이터 복원 접근 거부: 잘못된 비밀번호', 'error');
                return;
            }

            // 최종 확인
            const confirmMessage = `⚠️ 경고!\n\n현재 저장된 모든 데이터가 삭제되고, 선택한 백업 파일의 데이터로 교체됩니다.\n\n파일명: ${selectedFile.name}\n\n정말로 복원하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // 한 번 더 확인
            if (!confirm('정말 확실하신가요? 기존 데이터는 완전히 사라집니다!')) {
                return;
            }

            const progress = document.getElementById('restoreProgress');
            const progressBar = document.getElementById('restoreProgressBar');
            const progressText = document.getElementById('restoreProgressText');
            const statusText = document.getElementById('restoreStatus');
            const restoreButton = document.getElementById('restoreButton');

            // UI 업데이트
            progress.classList.remove('hidden');
            restoreButton.disabled = true;

            try {
                // 진행률 업데이트 함수
                function updateRestoreProgress(percentage, status) {
                    progressBar.style.width = `${percentage}%`;
                    progressText.textContent = `${Math.round(percentage)}%`;
                    statusText.textContent = status;
                }

                updateRestoreProgress(10, '파일 읽기 중...');
                
                // 파일 읽기
                const data = await readExcelFile(selectedFile);
                updateRestoreProgress(30, '데이터 파싱 중...');

                // 기존 데이터 백업 (혹시 모를 복구를 위해)
                const backupData = {
                    accommodations: JSON.parse(localStorage.getItem('accommodationData') || '[]'),
                    accounting: JSON.parse(localStorage.getItem('accountingData') || '[]'),
                    investors: JSON.parse(localStorage.getItem('investorData') || '[]'),
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('emergency_backup_before_restore', JSON.stringify(backupData));
                
                updateRestoreProgress(50, '기존 데이터 삭제 중...');

                // 기존 데이터 삭제
                localStorage.removeItem('accommodationData');
                localStorage.removeItem('accountingData');
                localStorage.removeItem('investorData');

                updateRestoreProgress(70, '새 데이터 복원 중...');

                // 새 데이터 저장
                if (data.accommodations && data.accommodations.length > 0) {
                    localStorage.setItem('accommodationData', JSON.stringify(data.accommodations));
                }
                if (data.accounting && data.accounting.length > 0) {
                    localStorage.setItem('accountingData', JSON.stringify(data.accounting));
                }
                if (data.investors && data.investors.length > 0) {
                    localStorage.setItem('investorData', JSON.stringify(data.investors));
                }

                updateRestoreProgress(90, '데이터 검증 중...');

                // 복원된 데이터 검증
                const restoredAccommodations = JSON.parse(localStorage.getItem('accommodationData') || '[]');
                const restoredAccounting = JSON.parse(localStorage.getItem('accountingData') || '[]');
                const restoredInvestors = JSON.parse(localStorage.getItem('investorData') || '[]');

                updateRestoreProgress(100, '복원 완료!');

                // 성공 메시지
                const successMessage = `✅ 데이터 복원이 완료되었습니다!\n\n복원된 데이터:\n• 숙소: ${restoredAccommodations.length}개\n• 회계: ${restoredAccounting.length}건\n• 투자자: ${restoredInvestors.length}명\n\n페이지를 새로고침하여 확인해보세요.`;
                alert(successMessage);

                log('✅ 데이터 복원 완료: ' + selectedFile.name, 'success');
                log(`📊 복원된 데이터: 숙소 ${restoredAccommodations.length}개, 회계 ${restoredAccounting.length}건, 투자자 ${restoredInvestors.length}명`, 'success');

                // 데이터 카운트 업데이트
                updateDataCounts();

                // UI 초기화
                clearSelectedFile();

                // 2초 후 페이지 새로고침
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error('데이터 복원 실패:', error);
                log('❌ 데이터 복원 실패: ' + error.message, 'error');
                alert('데이터 복원 중 오류가 발생했습니다: ' + error.message);
                
                // 긴급 복구 시도 (기존 데이터 복원)
                try {
                    const emergencyBackup = localStorage.getItem('emergency_backup_before_restore');
                    if (emergencyBackup) {
                        const backupData = JSON.parse(emergencyBackup);
                        if (backupData.accommodations) localStorage.setItem('accommodationData', JSON.stringify(backupData.accommodations));
                        if (backupData.accounting) localStorage.setItem('accountingData', JSON.stringify(backupData.accounting));
                        if (backupData.investors) localStorage.setItem('investorData', JSON.stringify(backupData.investors));
                        log('🔄 기존 데이터로 긴급 복구 완료', 'warning');
                    }
                } catch (recoveryError) {
                    console.error('긴급 복구 실패:', recoveryError);
                }
            } finally {
                progress.classList.add('hidden');
                restoreButton.disabled = false;
                updateRestoreProgress(0, '');
            }
        }

        // Excel 파일 읽기 함수
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        const result = {};

                        // 숙소관리 시트
                        if (workbook.SheetNames.includes('숙소관리')) {
                            const accommodationSheet = workbook.Sheets['숙소관리'];
                            result.accommodations = XLSX.utils.sheet_to_json(accommodationSheet);
                        }

                        // 수익관리 시트
                        if (workbook.SheetNames.includes('수익관리')) {
                            const accountingSheet = workbook.Sheets['수익관리'];
                            result.accounting = XLSX.utils.sheet_to_json(accountingSheet);
                        }

                        // 투자자관리 시트
                        if (workbook.SheetNames.includes('투자자관리')) {
                            const investorSheet = workbook.Sheets['투자자관리'];
                            result.investors = XLSX.utils.sheet_to_json(investorSheet);
                        }

                        resolve(result);
                    } catch (error) {
                        reject(new Error('Excel 파일을 읽는 중 오류가 발생했습니다: ' + error.message));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('파일을 읽을 수 없습니다.'));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 페이지 로드 시 데이터 카운트 업데이트
        document.addEventListener('DOMContentLoaded', function() {
            updateDataCounts();
            
            // 주기적으로 데이터 카운트 업데이트
            setInterval(updateDataCounts, 5000);
        });
    </script>
</body>
</html>