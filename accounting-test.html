<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒê³„ê´€ë¦¬ í•„í„° í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">íšŒê³„ê´€ë¦¬ í•„í„° ì¡°íšŒ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- íˆ¬ìì ì„ íƒ ë° ì¡°íšŒ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ìì ì„ íƒ</label>
                    <select id="selectedInvestor" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">íˆ¬ììë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="searchBtn" onclick="performSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                        <i class="fas fa-search mr-2"></i>
                        ì¡°íšŒ
                    </button>
                </div>
            </div>
        </div>

        <!-- í•„í„° ì˜µì…˜ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì›”ë³„ í•„í„°</label>
                    <select id="monthFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">ì „ì²´ ì›”</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ í•„í„°</label>
                    <select id="accommodationFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">ì „ì²´ ìˆ™ì†Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ë¶„ í•„í„°</label>
                    <select id="typeFilter" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="">ì „ì²´</option>
                        <option value="income">ìˆ˜ì…</option>
                        <option value="expense">ì§€ì¶œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì •ë ¬</label>
                    <select id="accountingSortBy" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <option value="date_desc">ë‚ ì§œ (ìµœì‹ ìˆœ)</option>
                        <option value="date_asc">ë‚ ì§œ (ì˜¤ë˜ëœìˆœ)</option>
                        <option value="amount_desc">ê¸ˆì•¡ (ë†’ì€ìˆœ)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- íˆ¬ìì ìš”ì•½ ì •ë³´ -->
        <div id="investorSummary" class="bg-white rounded-lg shadow p-6 mb-6" style="display: none;">
            <h3 class="text-lg font-semibold mb-4" id="investorInfo">íˆ¬ìì ì •ë³´</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">ì´ ìˆ˜ì…</div>
                    <div class="text-xl font-bold text-blue-600" id="summaryTotalIncome">0 THB</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">ì´ ì§€ì¶œ</div>
                    <div class="text-xl font-bold text-red-600" id="summaryTotalExpense">0 THB</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">ìˆœ ìˆ˜ìµ</div>
                    <div class="text-xl font-bold text-green-600" id="summaryNetProfit">0 THB</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">íˆ¬ìì ë°°ë¶„</div>
                    <div class="text-xl font-bold text-purple-600" id="summaryInvestorShare">0 THB</div>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">íšŒê³„ ë‚´ì—­</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìˆ™ì†Œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">êµ¬ë¶„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê¸ˆì•¡</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody id="accountingTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë””ë²„ê·¸ ì •ë³´ -->
        <div class="bg-gray-100 rounded-lg p-4 mt-6">
            <h4 class="font-semibold mb-2">ë””ë²„ê·¸ ì •ë³´</h4>
            <div id="debugInfo" class="text-sm text-gray-600">
                í˜ì´ì§€ ë¡œë”© ì¤‘...
            </div>
        </div>
    </div>

    <script>
        // === ì „ì—­ ë³€ìˆ˜ ===
        let accountingData = [];
        let accommodations = [];
        let investors = [];

        // === ìƒ˜í”Œ ë°ì´í„° ìƒì„± ===
        function generateSampleData() {
            console.log('ğŸ”§ ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì‹œì‘');
            
            // ìƒ˜í”Œ ìˆ™ì†Œ ë°ì´í„°
            accommodations = [
                { id: 'acc1', accommodationName: 'Beach Villa A' },
                { id: 'acc2', accommodationName: 'Mountain Lodge B' },
                { id: 'acc3', accommodationName: 'City Apartment C' }
            ];
            
            // ìƒ˜í”Œ íˆ¬ìì ë°ì´í„°
            investors = [
                { 
                    id: 'inv1', 
                    name: 'ê¹€íˆ¬ì', 
                    accommodations: ['acc1', 'acc2'],
                    investorRatio: 70 
                },
                { 
                    id: 'inv2', 
                    name: 'ë°•ìë³¸', 
                    accommodations: ['acc3'],
                    investorRatio: 60 
                }
            ];
            
            // ìƒ˜í”Œ íšŒê³„ ë°ì´í„°
            const now = new Date();
            accountingData = [
                {
                    id: 'acc_1',
                    accommodationId: 'acc1',
                    type: 'income',
                    category: 'accommodation',
                    amount: 120000,
                    transactionDate: new Date(now.getTime() - 7*24*60*60*1000).toISOString(),
                    description: 'ìˆ™ë°• ìˆ˜ì…'
                },
                {
                    id: 'acc_2',
                    accommodationId: 'acc1',
                    type: 'expense',
                    category: 'maintenance',
                    amount: 25000,
                    transactionDate: new Date(now.getTime() - 5*24*60*60*1000).toISOString(),
                    description: 'ì²­ì†Œë¹„'
                },
                {
                    id: 'acc_3',
                    accommodationId: 'acc2',
                    type: 'income',
                    category: 'accommodation',
                    amount: 95000,
                    transactionDate: new Date(now.getTime() - 3*24*60*60*1000).toISOString(),
                    description: 'ìˆ™ë°• ìˆ˜ì…'
                },
                {
                    id: 'acc_4',
                    accommodationId: 'acc3',
                    type: 'income',
                    category: 'accommodation',
                    amount: 80000,
                    transactionDate: new Date(now.getTime() - 1*24*60*60*1000).toISOString(),
                    description: 'ìˆ™ë°• ìˆ˜ì…'
                },
                {
                    id: 'acc_5',
                    accommodationId: 'acc2',
                    type: 'expense',
                    category: 'maintenance',
                    amount: 15000,
                    transactionDate: new Date(now.getTime() - 2*24*60*60*1000).toISOString(),
                    description: 'ìˆ˜ë¦¬ë¹„'
                }
            ];
            
            console.log('âœ… ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì™„ë£Œ:', accountingData.length + 'ê±´');
        }

        // === í•„í„°ë§ í•¨ìˆ˜ ===
        function getFilteredAccountingData() {
            let filtered = [...accountingData];
            
            // ì„ íƒëœ íˆ¬ìì í•„í„°
            const selectedInvestorId = document.getElementById('selectedInvestor').value;
            if (selectedInvestorId) {
                const investor = investors.find(inv => inv.id === selectedInvestorId);
                if (investor && investor.accommodations) {
                    filtered = filtered.filter(item => 
                        investor.accommodations.includes(item.accommodationId)
                    );
                }
            }
            
            // ì›”ë³„ í•„í„°
            const monthFilter = document.getElementById('monthFilter').value;
            if (monthFilter) {
                filtered = filtered.filter(item => {
                    const date = new Date(item.transactionDate);
                    const itemMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return itemMonth === monthFilter;
                });
            }
            
            // ìˆ™ì†Œ í•„í„°
            const accommodationFilter = document.getElementById('accommodationFilter').value;
            if (accommodationFilter) {
                filtered = filtered.filter(item => item.accommodationId === accommodationFilter);
            }
            
            // êµ¬ë¶„ í•„í„°
            const typeFilter = document.getElementById('typeFilter').value;
            if (typeFilter) {
                filtered = filtered.filter(item => item.type === typeFilter);
            }
            
            // ì •ë ¬
            const sortBy = document.getElementById('accountingSortBy').value;
            switch (sortBy) {
                case 'date_desc':
                    filtered.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));
                    break;
                case 'date_asc':
                    filtered.sort((a, b) => new Date(a.transactionDate) - new Date(b.transactionDate));
                    break;
                case 'amount_desc':
                    filtered.sort((a, b) => b.amount - a.amount);
                    break;
            }
            
            return filtered;
        }

        // === UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ ===
        function populateInvestorSelect() {
            const select = document.getElementById('selectedInvestor');
            select.innerHTML = '<option value="">íˆ¬ììë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            investors.forEach(investor => {
                const option = document.createElement('option');
                option.value = investor.id;
                option.textContent = investor.name;
                select.appendChild(option);
            });
        }

        function populateFilterOptions() {
            // ì›”ë³„ í•„í„°
            const monthFilter = document.getElementById('monthFilter');
            const months = [...new Set(accountingData.map(item => {
                const date = new Date(item.transactionDate);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            monthFilter.innerHTML = '<option value="">ì „ì²´ ì›”</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${month.split('-')[0]}ë…„ ${month.split('-')[1]}ì›”`;
                monthFilter.appendChild(option);
            });

            // ìˆ™ì†Œ í•„í„°
            const accommodationFilter = document.getElementById('accommodationFilter');
            accommodationFilter.innerHTML = '<option value="">ì „ì²´ ìˆ™ì†Œ</option>';
            
            accommodations.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.accommodationName;
                accommodationFilter.appendChild(option);
            });
        }

        function updateInvestorSummary() {
            const selectedInvestorId = document.getElementById('selectedInvestor').value;
            const summaryDiv = document.getElementById('investorSummary');
            
            if (!selectedInvestorId) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            summaryDiv.style.display = 'block';
            
            const investor = investors.find(inv => inv.id === selectedInvestorId);
            if (!investor) return;
            
            // íˆ¬ìì ì •ë³´ í‘œì‹œ
            document.getElementById('investorInfo').textContent = `${investor.name} íˆ¬ìì | ë³´ìœ  ìˆ™ì†Œ: ${investor.accommodations.length}ê°œ`;
            
            // í•´ë‹¹ íˆ¬ììì˜ ìˆ™ì†Œ ë°ì´í„° í•„í„°ë§
            const investorData = accountingData.filter(item => 
                investor.accommodations && investor.accommodations.includes(item.accommodationId)
            );
            
            // ìˆ˜ì…/ì§€ì¶œ ê³„ì‚°
            const totalIncome = investorData.filter(item => item.type === 'income').reduce((sum, item) => sum + (item.amount || 0), 0);
            const totalExpense = investorData.filter(item => item.type === 'expense').reduce((sum, item) => sum + (item.amount || 0), 0);
            const netProfit = totalIncome - totalExpense;
            const investorShare = Math.round(netProfit * ((investor.investorRatio || 70) / 100));
            
            // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('summaryTotalIncome').textContent = totalIncome.toLocaleString() + ' THB';
            document.getElementById('summaryTotalExpense').textContent = totalExpense.toLocaleString() + ' THB';
            document.getElementById('summaryNetProfit').textContent = netProfit.toLocaleString() + ' THB';
            document.getElementById('summaryInvestorShare').textContent = investorShare.toLocaleString() + ' THB';
        }

        function renderAccountingTable() {
            const tableBody = document.getElementById('accountingTableBody');
            const filteredData = getFilteredAccountingData();
            
            console.log('ğŸ“‹ í…Œì´ë¸” ë Œë”ë§:', filteredData.length + 'ê±´');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = '';
            filteredData.forEach(item => {
                const accommodation = accommodations.find(acc => acc.id === item.accommodationId);
                const accommodationName = accommodation ? accommodation.accommodationName : 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const typeClass = item.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeText = item.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
                
                row.innerHTML = `
                    <td class="px-6 py-4">${formatDate(item.transactionDate)}</td>
                    <td class="px-6 py-4">${accommodationName}</td>
                    <td class="px-6 py-4">
                        <span class="font-medium ${typeClass}">${typeText}</span>
                    </td>
                    <td class="px-6 py-4 font-medium">${item.amount.toLocaleString()} THB</td>
                    <td class="px-6 py-4">${item.description}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <div>íšŒê³„ ë°ì´í„°: ${accountingData.length}ê±´</div>
                <div>ìˆ™ì†Œ ë°ì´í„°: ${accommodations.length}ê°œ</div>
                <div>íˆ¬ìì ë°ì´í„°: ${investors.length}ëª…</div>
                <div>ë§ˆì§€ë§‰ ì¡°íšŒ: ${new Date().toLocaleTimeString()}</div>
            `;
        }

        // === ë©”ì¸ ì¡°íšŒ í•¨ìˆ˜ ===
        function performSearch() {
            console.log('ğŸ” ì¡°íšŒ ì‹œì‘...');
            
            const selectedInvestorId = document.getElementById('selectedInvestor').value;
            console.log('ì„ íƒëœ íˆ¬ìì ID:', selectedInvestorId);
            
            // íˆ¬ìì ìš”ì•½ ì—…ë°ì´íŠ¸
            updateInvestorSummary();
            
            // í…Œì´ë¸” ë Œë”ë§
            renderAccountingTable();
            
            // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
            updateDebugInfo();
            
            console.log('âœ… ì¡°íšŒ ì™„ë£Œ');
        }

        // ìë™ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        window.autoTest = function() {
            console.log('ğŸ¤– ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            // ì²« ë²ˆì§¸ íˆ¬ìì ì„ íƒ
            const investorSelect = document.getElementById('selectedInvestor');
            if (investorSelect.options.length > 1) {
                investorSelect.selectedIndex = 1; // ì²« ë²ˆì§¸ íˆ¬ìì ì„ íƒ
                console.log('ğŸ‘¤ íˆ¬ìì ì„ íƒ:', investorSelect.value);
                
                // ì¡°íšŒ ì‹¤í–‰
                performSearch();
                
                setTimeout(() => {
                    // ì •ë ¬ ë³€ê²½ í…ŒìŠ¤íŠ¸
                    document.getElementById('accountingSortBy').value = 'amount_desc';
                    performSearch();
                    console.log('ğŸ’° ê¸ˆì•¡ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í…ŒìŠ¤íŠ¸');
                    
                    setTimeout(() => {
                        // êµ¬ë¶„ í•„í„° í…ŒìŠ¤íŠ¸
                        document.getElementById('typeFilter').value = 'income';
                        performSearch();
                        console.log('ğŸ“ˆ ìˆ˜ì…ë§Œ í•„í„°ë§ í…ŒìŠ¤íŠ¸');
                    }, 1000);
                }, 1000);
            }
        };
        
        // í˜ì´ì§€ ë¡œë“œ í›„ 3ì´ˆ ë’¤ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        setTimeout(() => {
            console.log('â° ìë™ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
            window.autoTest();
        }, 3000);

        // === í˜ì´ì§€ ì´ˆê¸°í™” ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
            generateSampleData();
            
            // UI ì´ˆê¸°í™”
            populateInvestorSelect();
            populateFilterOptions();
            
            // ì´ˆê¸° ë°ì´í„° í‘œì‹œ
            renderAccountingTable();
            updateDebugInfo();
            
            console.log('âœ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // === ì „ì—­ ë””ë²„ê·¸ í•¨ìˆ˜ ===
        window.debugTest = function() {
            console.log('=== ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ ===');
            console.log('accountingData:', accountingData);
            console.log('accommodations:', accommodations);
            console.log('investors:', investors);
            console.log('í•„í„°ë§ëœ ë°ì´í„°:', getFilteredAccountingData());
        };
    </script>
</body>
</html>