<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìì ê´€ë¦¬ - Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .ratio-input {
            transition: all 0.2s ease-in-out;
        }
        .ratio-input:focus {
            ring-2 ring-blue-500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="systemTitle">
                    Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ
                </h1>

            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='dashboard.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> <span data-translate="dashboard">ëŒ€ì‹œë³´ë“œ</span>
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> <span data-translate="accommodations">ìˆ™ì†Œ ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> <span data-translate="reservations">ì˜ˆì•½ ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-chart-bar mr-1"></i> <span data-translate="analytics">ì§€í‘œ ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> <span data-translate="accounting">ìˆ˜ìµ ê´€ë¦¬</span>
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-users mr-1"></i> <span data-translate="investors">íˆ¬ìì ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calculator mr-1"></i> <span data-translate="settlement">íˆ¬ìì ì •ì‚°</span>
                    </button>

                    <button onclick="window.location.href='backup.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-download mr-1"></i> <span data-translate="backup">ë°±ì—…</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- íˆ¬ìì ê´€ë¦¬ í—¤ë” -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2" data-translate="investorManagement">íˆ¬ìì ê´€ë¦¬</h2>
                    <p class="text-sm text-gray-600" data-translate="investorManagementSubtitle">íˆ¬ìì ì •ë³´ ë° ìˆ˜ìµ ë°°ë¶„ ë¹„ìœ¨ ê´€ë¦¬</p>
                </div>
                <button onclick="window.openModal && window.openModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    <span data-translate="addInvestor">ìƒˆ íˆ¬ìì ì¶”ê°€</span>
                </button>
            </div>
        </div>

        <!-- íˆ¬ìì ëª©ë¡ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800" data-translate="investorList">
                    íˆ¬ìì ëª©ë¡
                </h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íˆ¬ìì ì •ë³´</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">íˆ¬ì ë¹„ìœ¨</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ë³´ìœ  ìˆ™ì†Œ</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">íˆ¬ì ì •ë³´</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="investorTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- íˆ¬ìì ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- íˆ¬ìì ëª¨ë‹¬ -->
    <div id="investorModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content">
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">íˆ¬ìì ì •ë³´</h3>
                    <div class="flex items-center gap-2">
                        <button id="editButton" onclick="window.toggleEditMode && window.toggleEditMode()" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit mr-1"></i>
                            <span id="editButtonText">ìˆ˜ì •</span>
                        </button>
                        <button onclick="window.closeModal && window.closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <form id="investorForm" class="p-6 space-y-6">
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">ê¸°ë³¸ ì •ë³´</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì•„ì´ë”” *</label>
                                <input type="text" id="userId" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ *</label>
                                <input type="text" id="password" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ *</label>
                                <input type="text" id="investorName" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                                <input type="tel" id="phone" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ ì£¼ì†Œ *</label>
                                <input type="email" id="email" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                        </div>
                    </div>

                    <!-- íˆ¬ì ì •ë³´ -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">íˆ¬ì ì •ë³´</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ìì¼ì *</label>
                                <input type="date" id="investmentDate" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì •ì‚°ì¼ (ë§¤ì›”)</label>
                                <input type="number" id="settlementDay" min="1" max="31" placeholder="ì˜ˆ: 15ì¼"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">ë§¤ì›” ì •ì‚°ì¼ (1-31ì¼)</p>
                            </div>
                        </div>
                    </div>

                    <!-- ìˆ˜ìµ ë°°ë¶„ ë¹„ìœ¨ -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">ìˆ˜ìµ ë°°ë¶„ ë¹„ìœ¨</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ìì ë¹„ìœ¨ (%)</label>
                                    <input type="number" id="investorRatio" min="0" max="100" value="70" 
                                           class="ratio-input w-full border border-gray-300 rounded-md px-3 py-2"
                                           oninput="updateCompanyRatio()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">íšŒì‚¬ ë¹„ìœ¨ (%)</label>
                                    <input type="number" id="companyRatio" min="0" max="100" value="30" readonly
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                íˆ¬ìì ë¹„ìœ¨ì„ ì¡°ì •í•˜ë©´ íšŒì‚¬ ë¹„ìœ¨ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>

                    <!-- ë³´ìœ  ìˆ™ì†Œ -->
                    <div id="accommodationsSection">
                        <h4 class="text-lg font-medium text-gray-800 mb-4">ë³´ìœ  ìˆ™ì†Œ</h4>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ ì„ íƒ</label>
                                <select id="accommodationSelect" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <button type="button" onclick="window.addAccommodation && window.addAccommodation()" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                                </button>
                            </div>
                            <div id="selectedAccommodations" class="space-y-2">
                                <!-- ì„ íƒëœ ìˆ™ì†Œ ëª©ë¡ -->
                            </div>
                        </div>
                    </div>

                    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                    <div id="buttonGroup" class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" id="saveButton" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            ì €ì¥
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            ì·¨ì†Œ
                        </button>
                        <button type="button" id="deleteButton" onclick="window.deleteInvestor && window.deleteInvestor()" class="sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash mr-2"></i>
                            ì‚­ì œ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ìˆ™ì†Œ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="accommodationDetailModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">ìˆ™ì†Œ ìƒì„¸ ì •ë³´</h3>
                    <button onclick="window.closeAccommodationDetailModal && window.closeAccommodationDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="accommodationDetailContent" class="p-6">
                    <!-- ìˆ™ì†Œ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentMode = 'view';
        let currentId = null;
        let isEditMode = false;
        // ê°„ë‹¨í•œ ì €ì¥ í•¨ìˆ˜
        function saveInvestorData() {
            localStorage.setItem('investorData', JSON.stringify(investorData));
            console.log('ğŸ’¾ ì €ì¥ì™„ë£Œ:', investorData.length + 'ëª…');
        }

        // localStorageì—ì„œ íˆ¬ìì ë°ì´í„° ë¡œë“œ ë˜ëŠ” ë¹ˆ ë°°ì—´
        let investorData = JSON.parse(localStorage.getItem('investorData') || '[]');
        let selectedAccommodations = [];

        // ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        function loadAccommodationsFromStorage() {
            const saved = localStorage.getItem('accommodationData');
            if (saved) {
                return JSON.parse(saved);
            }
            return [];
        }

        // ìˆ™ì†Œ ëª©ë¡ - localStorageì—ì„œ ë¡œë“œ
        let accommodations = loadAccommodationsFromStorage();

        // ìƒ˜í”Œ íˆ¬ìì ë°ì´í„° - ì œê±°ë¨ (ì‚¬ìš©ìê°€ ì§ì ‘ ë“±ë¡)

        // ë””ë²„ê·¸/í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™•ì¸
        function isTestMode() {
            return window.location.search.includes('test=true') || 
                   window.location.hostname === 'localhost' ||
                   !sessionStorage.getItem('userType');
        }

        // í…ŒìŠ¤íŠ¸ ëª¨ë“œìš© ê°€ì§œ ë¡œê·¸ì¸ ì„¤ì •
        function setupTestMode() {
            if (!sessionStorage.getItem('userType')) {
                console.log('ğŸ”§ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì„ì‹œ ê´€ë¦¬ì ì„¸ì…˜ ìƒì„±');
                sessionStorage.setItem('userType', 'admin');
                sessionStorage.setItem('userId', 'admin_test');
                sessionStorage.setItem('userName', 'í…ŒìŠ¤íŠ¸ê´€ë¦¬ì');
            }
        }

        // ë‹¨ìˆœí•œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™•ì¸ ë° ì„¤ì •
            if (isTestMode()) {
                setupTestMode();
            }
            
            if (checkLoginStatus()) {
                initializePagePermissions();
                
                // ìƒ˜í”Œ ë°ì´í„° ìë™ ì´ˆê¸°í™” ì œê±°ë¨ - ë¹ˆ ìƒíƒœë¡œ ì‹œì‘
                
                populateAccommodationSelect();
                renderInvestorTable();
                
                // ìˆ™ì†Œ ë°ì´í„° ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œ ìˆ™ì†Œê°€ ì¶”ê°€/ìˆ˜ì •ëœ ê²½ìš°)
                window.addEventListener('storage', function(e) {
                    if (e.key === 'accommodationData') {
                        accommodations = loadAccommodationsFromStorage();
                        populateAccommodationSelect();
                    }
                });
            }
        });

        // íˆ¬ìì í…Œì´ë¸” ë Œë”ë§
        function renderInvestorTable() {
            const tableBody = document.getElementById('investorTableBody');
            tableBody.innerHTML = '';

            if (investorData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-users text-gray-300 text-3xl mb-3 block"></i>
                            ë“±ë¡ëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            investorData.forEach(investor => {
                const investorAccommodations = investor.accommodations.map(id => 
                    accommodations.find(acc => acc.id === id)
                ).filter(acc => acc);

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => window.openModal && window.openModal('view', investor.id);

                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${investor.name}</div>
                                <div class="text-sm text-gray-500">${investor.email}</div>
                                <div class="text-xs text-gray-400">${investor.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${investor.investorRatio}%
                            </div>
                            <div class="text-gray-400">:</div>
                            <div class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
                                ${investor.companyRatio}%
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                ${investorAccommodations.length}ê°œ
                            </span>
                            <button onclick="event.stopPropagation(); window.showAccommodationList && window.showAccommodationList(${investor.id})" 
                                    class="text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-right">
                        <div class="text-sm text-gray-900">íˆ¬ìì¼: ${formatDate(investor.investmentDate)}</div>
                        <div class="text-sm text-gray-500">ì •ì‚°ì¼: ${investor.settlementDay ? `ë§¤ì›” ${investor.settlementDay}ì¼` : 'ë¯¸ì •'}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="event.stopPropagation(); window.openModal && window.openModal('view', ${investor.id})" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // ìˆ™ì†Œ select ì˜µì…˜ ì±„ìš°ê¸°
        function populateAccommodationSelect() {
            const select = document.getElementById('accommodationSelect');
            select.innerHTML = '<option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            accommodations.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.accommodationName} - ${acc.buildingName || ''}`;
                select.appendChild(option);
            });
        }

        // íšŒì‚¬ ë¹„ìœ¨ ìë™ ê³„ì‚°
        function updateCompanyRatio() {
            const investorRatio = parseInt(document.getElementById('investorRatio').value) || 0;
            const companyRatio = 100 - investorRatio;
            document.getElementById('companyRatio').value = companyRatio;
        }

        // ìˆ™ì†Œ ì¶”ê°€
        window.addAccommodation = function() {
            const select = document.getElementById('accommodationSelect');
            const accommodationId = parseInt(select.value);
            
            if (!accommodationId) {
                alert('ìˆ™ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (selectedAccommodations.includes(accommodationId)) {
                alert('ì´ë¯¸ ì¶”ê°€ëœ ìˆ™ì†Œì…ë‹ˆë‹¤.');
                return;
            }

            selectedAccommodations.push(accommodationId);
            renderSelectedAccommodations();
            select.value = '';
        }

        // ì„ íƒëœ ìˆ™ì†Œ ë Œë”ë§
        function renderSelectedAccommodations() {
            const container = document.getElementById('selectedAccommodations');
            container.innerHTML = '';

            selectedAccommodations.forEach(accId => {
                const acc = accommodations.find(a => a.id === accId);
                if (!acc) return;

                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-blue-50 p-3 rounded';
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">${acc.accommodationName}</div>
                        <div class="text-xs text-gray-500">${acc.buildingName || ''}</div>
                    </div>
                    <button onclick="window.removeAccommodation && window.removeAccommodation(${accId})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // ìˆ™ì†Œ ì œê±°
        window.removeAccommodation = function(accId) {
            selectedAccommodations = selectedAccommodations.filter(id => id !== accId);
            renderSelectedAccommodations();
        }

        // ëª¨ë‹¬ ì—´ê¸°
        window.openModal = function(mode, id = null) {
            console.log('openModal í˜¸ì¶œë¨, mode:', mode, 'id:', id);
            currentMode = mode;
            currentId = id;
            isEditMode = false;
            selectedAccommodations = [];

            const modal = document.getElementById('investorModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('investorForm');
            const editButton = document.getElementById('editButton');
            const deleteButton = document.getElementById('deleteButton');

            if (mode === 'add') {
                title.textContent = 'ìƒˆ íˆ¬ìì ì¶”ê°€';
                form.reset();
                editButton.style.display = 'none';
                deleteButton.style.display = 'none';
                isEditMode = true;
                document.getElementById('investorRatio').value = 70;
                document.getElementById('companyRatio').value = 30;
            } else if (mode === 'view') {
                const investor = investorData.find(inv => inv.id === id);
                if (investor) {
                    console.log('íˆ¬ìì ì •ë³´ ë¡œë“œ:', investor.name);
                    title.textContent = `íˆ¬ìì ì •ë³´ - ${investor.name}`;
                    populateForm(investor);
                    editButton.style.display = 'block';
                    deleteButton.style.display = 'block';
                    isEditMode = false;
                } else {
                    console.error('íˆ¬ììë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ID:', id);
                    console.log('í˜„ì¬ investorData:', investorData);
                    return;
                }
            }

            console.log('ëª¨ë‹¬ ì—´ê¸° ì „ isEditMode:', isEditMode);
            updateFormState();
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        function populateForm(investor) {
            document.getElementById('userId').value = investor.userId;
            document.getElementById('password').value = investor.password;
            document.getElementById('investorName').value = investor.name;
            document.getElementById('phone').value = investor.phone;
            document.getElementById('email').value = investor.email;
            document.getElementById('investmentDate').value = investor.investmentDate;
            document.getElementById('settlementDay').value = investor.settlementDay || '';
            document.getElementById('investorRatio').value = investor.investorRatio;
            document.getElementById('companyRatio').value = investor.companyRatio;
            
            selectedAccommodations = [...investor.accommodations];
            renderSelectedAccommodations();
        }

        // í¸ì§‘ ëª¨ë“œ í† ê¸€ (ì „ì—­ í•¨ìˆ˜)
        window.toggleEditMode = function() {
            console.log('ğŸ”§ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ë¨! í˜„ì¬ ìƒíƒœ:', {
                currentMode: currentMode,
                isEditMode: isEditMode,
                currentId: currentId
            });
            
            if (currentMode !== 'view') {
                console.log('âš ï¸ view ëª¨ë“œê°€ ì•„ë‹™ë‹ˆë‹¤:', currentMode);
                alert('âš ï¸ view ëª¨ë“œê°€ ì•„ë‹™ë‹ˆë‹¤!');
                return;
            }
            
            if (!currentId) {
                console.log('âš ï¸ ì„ íƒëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤');
                alert('âš ï¸ ì„ íƒëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // í¸ì§‘ ëª¨ë“œ í† ê¸€
            isEditMode = !isEditMode;
            
            console.log('âœ… í¸ì§‘ ëª¨ë“œ ë³€ê²½ë¨:', isEditMode ? 'ON' : 'OFF');
            
            // ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ í”¼ë“œë°±
            if (isEditMode) {
                console.log('ğŸ“ í¸ì§‘ ëª¨ë“œ í™œì„±í™” - í¼ í•„ë“œê°€ ìˆ˜ì • ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤');
                alert('ğŸ“ í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                console.log('ğŸ”’ í¸ì§‘ ëª¨ë“œ ë¹„í™œì„±í™” - í¼ í•„ë“œê°€ ì½ê¸° ì „ìš©ì´ ë©ë‹ˆë‹¤');
                alert('ğŸ”’ í¸ì§‘ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            // í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateFormState();
        };

        // í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateFormState() {
            console.log('ğŸ”„ í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...', {currentMode, isEditMode});
            
            const formElements = document.querySelectorAll('#investorForm input, #investorForm select');
            const isReadonly = currentMode === 'view' && !isEditMode;

            console.log(`ğŸ“ í¼ í•„ë“œ ${isReadonly ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'} (ì´ ${formElements.length}ê°œ)`);

            formElements.forEach(element => {
                element.disabled = isReadonly;
                // ì‹œê°ì  í”¼ë“œë°±ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ë³€ê²½
                if (isReadonly) {
                    element.style.backgroundColor = '#f9fafb';
                    element.style.color = '#6b7280';
                } else {
                    element.style.backgroundColor = '#ffffff';
                    element.style.color = '#374151';
                }
            });

            // ì €ì¥ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.style.display = isReadonly ? 'none' : 'block';
                console.log(`ğŸ’¾ ì €ì¥ ë²„íŠ¼ ${isReadonly ? 'ìˆ¨ê¹€' : 'í‘œì‹œ'}`);
            }
            
            // ìˆ˜ì • ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const editButtonText = document.getElementById('editButtonText');
            if (editButtonText) {
                const newText = isEditMode ? 'ì·¨ì†Œ' : 'ìˆ˜ì •';
                editButtonText.textContent = newText;
                console.log(`ğŸ”§ ìˆ˜ì • ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½: "${newText}"`);
            }
            
            console.log('âœ… í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeModal = function() {
            document.getElementById('investorModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentMode = 'view';
            currentId = null;
            isEditMode = false;
            selectedAccommodations = [];
        }

        // íˆ¬ìì ì‚­ì œ
        window.deleteInvestor = function() {
            if (!currentId) return;
            
            if (confirm('ì´ íˆ¬ììë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                investorData = investorData.filter(inv => inv.id !== currentId);
                saveInvestorData(); // localStorageì— ì €ì¥
                alert('íˆ¬ììê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                renderInvestorTable();
                closeModal();
            }
        }

        // ìˆ™ì†Œ ëª©ë¡ ë³´ê¸°
        window.showAccommodationList = function(investorId) {
            const investor = investorData.find(inv => inv.id === investorId);
            if (!investor) return;

            const accommodationList = investor.accommodations.map(id => 
                accommodations.find(acc => acc.id === id)
            ).filter(acc => acc);

            const content = document.getElementById('accommodationDetailContent');
            content.innerHTML = `
                <h4 class="font-semibold mb-4">${investor.name}ë‹˜ì˜ ë³´ìœ  ìˆ™ì†Œ</h4>
                <div class="space-y-3">
                    ${accommodationList.map(acc => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900">${acc.accommodationName}</h5>
                            <p class="text-sm text-gray-600">${acc.buildingName || ''}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('accommodationDetailModal').classList.remove('hidden');
        }

        // ìˆ™ì†Œ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        window.closeAccommodationDetailModal = function() {
            document.getElementById('accommodationDetailModal').classList.add('hidden');
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // ë‹¨ìˆœí•œ í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('investorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ:', {currentMode, isEditMode, currentId});
            
            // í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹Œ view ëª¨ë“œì—ì„œëŠ” ì œì¶œ ì°¨ë‹¨
            if (currentMode === 'view' && !isEditMode) {
                console.log('í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë¯€ë¡œ ì œì¶œ ì°¨ë‹¨ë¨');
                return;
            }
            
            const formData = {
                userId: document.getElementById('userId').value,
                password: document.getElementById('password').value,
                name: document.getElementById('investorName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                investmentDate: document.getElementById('investmentDate').value,
                settlementDay: parseInt(document.getElementById('settlementDay').value) || null,
                investorRatio: parseInt(document.getElementById('investorRatio').value),
                companyRatio: parseInt(document.getElementById('companyRatio').value),
                accommodations: [...selectedAccommodations]
            };

            console.log('í¼ ë°ì´í„°:', formData);

            if (currentMode === 'add') {
                // ìƒˆ íˆ¬ìì ì¶”ê°€
                formData.id = Math.max(...investorData.map(inv => inv.id), 0) + 1;
                console.log('ğŸ”¢ ìƒˆ íˆ¬ìì ID í• ë‹¹:', formData.id);
                
                investorData.push(formData);
                console.log('ğŸ“‹ íˆ¬ìì ë°ì´í„° ë°°ì—´ì— ì¶”ê°€:', investorData.length + 'ëª…');
                
                saveInvestorData(); // localStorageì— ì €ì¥
                console.log('ğŸ’¾ localStorage ì €ì¥ ì™„ë£Œ');
                
                console.log('ìƒˆ íˆ¬ìì ì¶”ê°€ë¨:', formData.name);
                alert('âœ… ìƒˆ íˆ¬ììê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                renderInvestorTable();
                console.log('ğŸ“Š í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§ ì™„ë£Œ');
                
                closeModal();
                console.log('ğŸšª ëª¨ë‹¬ ë‹«ê¸° ì™„ë£Œ');
                
            } else if (currentMode === 'view' && isEditMode) {
                // ê¸°ì¡´ íˆ¬ìì ìˆ˜ì •
                console.log('íˆ¬ìì ìˆ˜ì • ì‹œë„, ID:', currentId);
                
                const index = investorData.findIndex(inv => inv.id === currentId);
                console.log('íˆ¬ìì ì¸ë±ìŠ¤:', index);
                
                if (index !== -1) {
                    // ë°ì´í„° ì—…ë°ì´íŠ¸
                    const oldName = investorData[index].name;
                    investorData[index] = { ...investorData[index], ...formData };
                    saveInvestorData(); // localStorageì— ì €ì¥
                    
                    console.log(`íˆ¬ìì ì •ë³´ ì—…ë°ì´íŠ¸: ${oldName} â†’ ${formData.name}`);
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    alert(`âœ… ${formData.name}ë‹˜ì˜ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    
                    // UI ì—…ë°ì´íŠ¸
                    renderInvestorTable();
                    
                    // ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ì´ë¦„ ë°˜ì˜)
                    document.getElementById('modalTitle').textContent = `íˆ¬ìì ì •ë³´ - ${formData.name}`;
                    
                    // ìˆ˜ì • ëª¨ë“œ í•´ì œ
                    isEditMode = false;
                    updateFormState();
                    
                    console.log('íˆ¬ìì ì •ë³´ ìˆ˜ì • ì™„ë£Œ');
                    
                } else {
                    console.error('íˆ¬ììë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', currentId);
                    alert('âŒ íˆ¬ìì ì •ë³´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                console.log('ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œ:', currentMode, isEditMode);
                alert('âš ï¸ ì˜ëª»ëœ ì‘ì—… ëª¨ë“œì…ë‹ˆë‹¤.');
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('investorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeModal();
            }
        });
    </script>
</body>
</html>