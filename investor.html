<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìì ê´€ë¦¬ - Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% ì™„ì „ ì°¨ë‹¨) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        
        /* ëª¨ë‹¬ ìŠ¤í¬ë¡¤ ê°œì„  */
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë” ë‚˜ì€ ìŠ¤í¬ë¡¤ */
        @media (max-height: 700px) {
            .modal-overlay .flex.items-start {
                align-items: flex-start !important;
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .ratio-input {
            transition: all 0.2s ease-in-out;
        }
        .ratio-input:focus {
            ring-2 ring-blue-500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="systemTitle">
                    Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ
                </h1>

            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='dashboard.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> <span data-translate="dashboard">ëŒ€ì‹œë³´ë“œ</span>
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> <span data-translate="accommodations">ìˆ™ì†Œ ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> <span data-translate="reservations">ì˜ˆì•½ ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-chart-bar mr-1"></i> <span data-translate="analytics">ì§€í‘œ ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> <span data-translate="accounting">ìˆ˜ìµ ê´€ë¦¬</span>
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-users mr-1"></i> <span data-translate="investors">íˆ¬ìì ê´€ë¦¬</span>
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calculator mr-1"></i> <span data-translate="settlement">íˆ¬ìì ì •ì‚°</span>
                    </button>

                    <button onclick="window.location.href='data-migration.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-database mr-1"></i> ë°ì´í„° ê´€ë¦¬
                    </button>
                </div>
            </div>
        </div>

        <!-- íˆ¬ìì ê´€ë¦¬ í—¤ë” -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2" data-translate="investorManagement">íˆ¬ìì ê´€ë¦¬</h2>
                    <p class="text-sm text-gray-600" data-translate="investorManagementSubtitle">íˆ¬ìì ì •ë³´ ë° ìˆ˜ìµ ë°°ë¶„ ë¹„ìœ¨ ê´€ë¦¬</p>
                </div>
                <button onclick="window.openModal && window.openModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    <span data-translate="addInvestor">ìƒˆ íˆ¬ìì ì¶”ê°€</span>
                </button>
            </div>
        </div>

        <!-- íˆ¬ìì ëª©ë¡ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800" data-translate="investorList">
                    íˆ¬ìì ëª©ë¡
                </h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íˆ¬ìì ì •ë³´</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">íˆ¬ì ë¹„ìœ¨</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ë³´ìœ  ìˆ™ì†Œ</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">íˆ¬ì ì •ë³´</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="investorTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- íˆ¬ìì ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- íˆ¬ìì ëª¨ë‹¬ -->
    <div id="investorModal" class="fixed inset-0 z-50 hidden modal-overlay overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col modal-content">
                <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">íˆ¬ìì ì •ë³´</h3>
                    <div class="flex items-center gap-2">
                        <button id="editButton" onclick="window.toggleEditMode && window.toggleEditMode()" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit mr-1"></i>
                            <span id="editButtonText">ìˆ˜ì •</span>
                        </button>
                        <button onclick="window.closeModal && window.closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <form id="investorForm" class="p-6 space-y-6">
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">ê¸°ë³¸ ì •ë³´</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì•„ì´ë”” *</label>
                                <input type="text" id="userId" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ *</label>
                                <input type="text" id="password" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ *</label>
                                <input type="text" id="investorName" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                                <input type="tel" id="phone" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ ì£¼ì†Œ *</label>
                                <input type="email" id="email" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                        </div>
                    </div>

                    <!-- íˆ¬ì ì •ë³´ -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">íˆ¬ì ì •ë³´</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ìì¼ì *</label>
                                <input type="date" id="investmentDate" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì •ì‚°ì¼ (ë§¤ì›”)</label>
                                <input type="number" id="settlementDay" min="1" max="31" placeholder="ì˜ˆ: 15ì¼"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">ë§¤ì›” ì •ì‚°ì¼ (1-31ì¼)</p>
                            </div>
                        </div>
                    </div>

                    <!-- ìˆ˜ìµ ë°°ë¶„ ë¹„ìœ¨ -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">ìˆ˜ìµ ë°°ë¶„ ë¹„ìœ¨</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ìì ë¹„ìœ¨ (%)</label>
                                    <input type="number" id="investorRatio" min="0" max="100" value="70" 
                                           class="ratio-input w-full border border-gray-300 rounded-md px-3 py-2"
                                           oninput="updateCompanyRatio()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">íšŒì‚¬ ë¹„ìœ¨ (%)</label>
                                    <input type="number" id="companyRatio" min="0" max="100" value="30" readonly
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                íˆ¬ìì ë¹„ìœ¨ì„ ì¡°ì •í•˜ë©´ íšŒì‚¬ ë¹„ìœ¨ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>

                    <!-- ë³´ìœ  ìˆ™ì†Œ -->
                    <div id="accommodationsSection">
                        <h4 class="text-lg font-medium text-gray-800 mb-4">ë³´ìœ  ìˆ™ì†Œ</h4>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ ì„ íƒ</label>
                                <select id="accommodationSelect" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <button type="button" onclick="window.addAccommodation && window.addAccommodation()" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                                </button>
                            </div>
                            <div id="selectedAccommodations" class="space-y-2">
                                <!-- ì„ íƒëœ ìˆ™ì†Œ ëª©ë¡ -->
                            </div>
                        </div>
                    </div>

                    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
                    <div id="buttonGroup" class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" id="saveButton" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            ì €ì¥
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            ì·¨ì†Œ
                        </button>
                        <button type="button" id="deleteButton" onclick="window.deleteInvestor && window.deleteInvestor()" class="sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash mr-2"></i>
                            ì‚­ì œ
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ìˆ™ì†Œ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="accommodationDetailModal" class="fixed inset-0 z-50 hidden modal-overlay overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[calc(100vh-4rem)] flex flex-col">
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">ìˆ™ì†Œ ìƒì„¸ ì •ë³´</h3>
                    <button onclick="window.closeAccommodationDetailModal && window.closeAccommodationDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="accommodationDetailContent" class="p-6">
                    <!-- ìˆ™ì†Œ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentMode = 'view';
        let currentId = null;
        let isEditMode = false;
        // Firebase ì €ì¥ì†Œ í•¨ìˆ˜ë“¤ (ìˆ˜ì •ëœ ë²„ì „)
        async function loadInvestorData() {
            console.log('ğŸ“Š íˆ¬ìì ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            return await firebaseStorage.loadInvestors();
        }

        async function saveInvestorToServer(investor) {
            console.log('ğŸ’¾ íˆ¬ìì ì €ì¥ ì‹œì‘:', investor.name);
            return await firebaseStorage.saveInvestor(investor);
        }

        async function updateInvestorOnServer(id, investor) {
            console.log('ğŸ”„ íˆ¬ìì ìˆ˜ì • ì‹œì‘:', id);
            return await firebaseStorage.updateInvestor(id, investor);
        }

        async function deleteInvestorFromServer(id) {
            console.log('ğŸ—‘ï¸ íˆ¬ìì ì‚­ì œ ì‹œì‘:', id);
            return await firebaseStorage.deleteInvestor(id);
        }

        // íˆ¬ìì ë°ì´í„° (Cloudflare D1ì—ì„œ ë¡œë“œ)
        let investorData = [];
        let selectedAccommodations = [];

        // ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (Firebase ì‚¬ìš©)
        async function loadAccommodationsFromServer() {
            console.log('ğŸ  ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            return await firebaseStorage.loadAccommodations();
        }
        



        // ìˆ™ì†Œ ëª©ë¡ - Cloudflare D1ì—ì„œ ë¡œë“œ
        let accommodations = [];

        // ìƒ˜í”Œ íˆ¬ìì ë°ì´í„° - ì œê±°ë¨ (ì‚¬ìš©ìê°€ ì§ì ‘ ë“±ë¡)



        // í˜ì´ì§€ ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ)
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”„ íˆ¬ìì ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // ğŸš¨ í˜ì´í¬ ë°ì´í„° ì™„ì „ ì°¨ë‹¨ - localStorageì—ì„œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì œê±°
            console.log('ğŸ§¹ í˜ì´í¬ ë°ì´í„° ì™„ì „ ì‚­ì œ ì‹œì‘...');
            
            const keysToCheck = ['investorData', 'accommodationData', 'accountingData'];
            keysToCheck.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData)) {
                            // í…ŒìŠ¤íŠ¸/í˜ì´í¬ ë°ì´í„° í•„í„°ë§
                            const cleanData = parsedData.filter(item => {
                                const itemStr = JSON.stringify(item).toLowerCase();
                                return !itemStr.includes('í…ŒìŠ¤íŠ¸') && 
                                       !itemStr.includes('test') && 
                                       !itemStr.includes('ë”ë¯¸') && 
                                       !itemStr.includes('dummy') &&
                                       !itemStr.includes('ë°©ì½• ì‹œí‹°') &&
                                       !itemStr.includes('íŒŒíƒ€ì•¼ ë¹„ì¹˜');
                            });
                            
                            if (cleanData.length !== parsedData.length) {
                                console.log(`ğŸš¨ ${key}ì—ì„œ í˜ì´í¬ ë°ì´í„° ${parsedData.length - cleanData.length}ê°œ ì‚­ì œ`);
                                if (cleanData.length > 0) {
                                    localStorage.setItem(key, JSON.stringify(cleanData));
                                } else {
                                    localStorage.removeItem(key);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn(`âš ï¸ ${key} íŒŒì‹± ì‹¤íŒ¨:`, e);
                    }
                }
            });
            
            console.log('âœ… í˜ì´í¬ ë°ì´í„° ì™„ì „ ì‚­ì œ ì™„ë£Œ');
            
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì œê±°ë¨ - ì‹¤ì œ ë¡œê·¸ì¸ ì‹œìŠ¤í…œë§Œ ì‚¬ìš©
            
            // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
            if (!firebaseStorage.isConfigured()) {
                console.warn('âš ï¸ Firebase ì„¤ì •ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                
                // Firebase ì—°ë™ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
                const goToFirebase = confirm(`
ğŸ”¥ Firebase ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤!

PCì™€ ëª¨ë°”ì¼ ê°„ ë°ì´í„° ë™ê¸°í™”ë¥¼ ìœ„í•´ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
Firebase ì—°ë™ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                `);
                
                if (goToFirebase) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
                
                console.log('âš ï¸ Firebase ì—†ì´ localStorage ëª¨ë“œë¡œ ì‹¤í–‰');
            }
            
            if (checkLoginStatus()) {
                initializePagePermissions();
                
                // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ
                try {
                    console.log('ğŸ“¡ Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                    investorData = await loadInvestorData();
                    accommodations = await loadAccommodationsFromServer();
                    console.log('âœ… íˆ¬ìì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', investorData.length + 'ëª…');
                    console.log('âœ… ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accommodations.length + 'ê°œ');
                    
                    // ìˆ™ì†Œ ë°ì´í„° ìƒì„¸ ë¡œê¹… ë° ë”ë¯¸ ë°ì´í„° ìƒì„±
                    if (accommodations && accommodations.length > 0) {
                        console.log('ğŸ  ë¡œë“œëœ ìˆ™ì†Œ ëª©ë¡:');
                        accommodations.forEach((acc, index) => {
                            console.log(`  ${index + 1}. ${acc.accommodationName} (ID: ${acc.id})`);
                        });
                    } else {
                        console.warn('âš ï¸ ìˆ™ì†Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ - ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •');
                        
                        // ğŸš¨ í˜ì´í¬ ë°ì´í„° ì™„ì „ ì°¨ë‹¨ - ì ˆëŒ€ ìƒì„±í•˜ì§€ ì•ŠìŒ
                        accommodations = [];
                        console.log('ğŸš¨ í˜ì´í¬ ë°ì´í„° ì°¨ë‹¨: ìˆ™ì†Œ ë°ì´í„° ì—†ìŒ - ì‚¬ìš©ìê°€ ì§ì ‘ ë“±ë¡ í•„ìš”');
                    }
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    
                    // Firebase ì—°ê²° ì‹¤íŒ¨ì‹œ localStorage í´ë°± ì‹œë„ (í˜ì´í¬ ë°ì´í„° ì™„ì „ ì°¨ë‹¨)
                    try {
                        console.log('ğŸ”„ localStorage í´ë°± ì‹œë„...');
                        const localInvestors = localStorage.getItem('investorData');
                        const localAccommodations = localStorage.getItem('accommodationData');
                        
                        // ğŸš¨ í˜ì´í¬ ë°ì´í„° ì™„ì „ ì°¨ë‹¨ - ë¹ˆ ë°°ì—´ë¡œ ê°•ì œ ì„¤ì •
                        investorData = [];
                        accommodations = [];
                        
                        console.log('ğŸš¨ í˜ì´í¬ ë°ì´í„° ì°¨ë‹¨: localStorage ë°ì´í„° ë¬´ì‹œí•˜ê³  ë¹ˆ ë°°ì—´ ì‚¬ìš©');
                        console.log('ğŸ’¡ ëª¨ë“  ë°ì´í„°ëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.');
                        
                        alert('í˜ì´í¬ ë°ì´í„° ì°¨ë‹¨: ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ Firebaseë¥¼ ì—°ë™í•´ì£¼ì„¸ìš”.');
                    } catch (fallbackError) {
                        console.error('âŒ localStorage í´ë°±ë„ ì‹¤íŒ¨:', fallbackError);
                        investorData = [];
                        accommodations = [];
                    }
                }
                
                // DOM ìš”ì†Œ í™•ì¸
                const accommodationSelect = document.getElementById('accommodationSelect');
                const selectedAccommodationsContainer = document.getElementById('selectedAccommodations');
                
                if (!accommodationSelect) {
                    console.error('âŒ accommodationSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                } else {
                    console.log('âœ… accommodationSelect ìš”ì†Œ ì°¾ê¸° ì„±ê³µ');
                }
                
                if (!selectedAccommodationsContainer) {
                    console.error('âŒ selectedAccommodations ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                } else {
                    console.log('âœ… selectedAccommodations ìš”ì†Œ ì°¾ê¸° ì„±ê³µ');
                }
                
                populateAccommodationSelect();
                renderInvestorTable();
                
                console.log('ğŸ‰ íˆ¬ìì ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        });

        // íˆ¬ìì í…Œì´ë¸” ë Œë”ë§
        function renderInvestorTable() {
            const tableBody = document.getElementById('investorTableBody');
            tableBody.innerHTML = '';

            if (investorData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-users text-gray-300 text-3xl mb-3 block"></i>
                            ë“±ë¡ëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            investorData.forEach(investor => {
                // accommodationsê°€ undefinedì´ê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
                const investorAccommodationIds = investor.accommodations || [];
                const investorAccommodations = Array.isArray(investorAccommodationIds) 
                    ? investorAccommodationIds.map(id => accommodations.find(acc => acc.id === id)).filter(acc => acc)
                    : [];

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => window.openModal && window.openModal('view', investor.id);

                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${investor.name}</div>
                                <div class="text-sm text-gray-500">${investor.email}</div>
                                <div class="text-xs text-gray-400">${investor.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${investor.investorRatio}%
                            </div>
                            <div class="text-gray-400">:</div>
                            <div class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
                                ${investor.companyRatio}%
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                ${investorAccommodations.length}ê°œ
                            </span>
                            <button onclick="event.stopPropagation(); window.showAccommodationList && window.showAccommodationList(${investor.id})" 
                                    class="text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-right">
                        <div class="text-sm text-gray-900">íˆ¬ìì¼: ${formatDate(investor.investmentDate)}</div>
                        <div class="text-sm text-gray-500">ì •ì‚°ì¼: ${investor.settlementDay ? `ë§¤ì›” ${investor.settlementDay}ì¼` : 'ë¯¸ì •'}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="event.stopPropagation(); window.openModal && window.openModal('view', ${investor.id})" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // ìˆ™ì†Œ select ì˜µì…˜ ì±„ìš°ê¸°
        function populateAccommodationSelect() {
            const select = document.getElementById('accommodationSelect');
            select.innerHTML = '<option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            console.log('ğŸ  ìˆ™ì†Œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ì‹œì‘, ìˆ™ì†Œ ìˆ˜:', accommodations.length);
            
            if (accommodations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ë“±ë¡ëœ ìˆ™ì†Œê°€ ì—†ìŠµë‹ˆë‹¤';
                option.disabled = true;
                select.appendChild(option);
                console.log('âš ï¸ ë“±ë¡ëœ ìˆ™ì†Œê°€ ì—†ìŒ');
                return;
            }
            
            accommodations.forEach((acc, index) => {
                console.log(`ğŸ  ìˆ™ì†Œ ${index + 1}: ${acc.accommodationName} (ID: ${acc.id})`);
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.accommodationName} - ${acc.buildingName || ''}`;
                select.appendChild(option);
            });
            
            console.log('âœ… ìˆ™ì†Œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ì™„ë£Œ');
        }

        // íšŒì‚¬ ë¹„ìœ¨ ìë™ ê³„ì‚°
        function updateCompanyRatio() {
            const investorRatio = parseInt(document.getElementById('investorRatio').value) || 0;
            const companyRatio = 100 - investorRatio;
            document.getElementById('companyRatio').value = companyRatio;
        }

        // ìˆ™ì†Œ ì¶”ê°€
        window.addAccommodation = function() {
            const select = document.getElementById('accommodationSelect');
            const selectedValue = select.value;
            
            console.log('ğŸ“ ìˆ™ì†Œ ì¶”ê°€ ì‹œë„:', { selectedValue });
            
            if (!selectedValue || selectedValue === '') {
                alert('ìˆ™ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // IDë¥¼ ë¬¸ìì—´ë¡œ ì²˜ë¦¬ (ë”ë¯¸ ë°ì´í„°ëŠ” ë¬¸ìì—´ IDë¥¼ ì‚¬ìš©)
            const accommodationId = selectedValue;

            if (selectedAccommodations.includes(accommodationId)) {
                alert('ì´ë¯¸ ì¶”ê°€ëœ ìˆ™ì†Œì…ë‹ˆë‹¤.');
                return;
            }

            // ìˆ™ì†Œ ì •ë³´ í™•ì¸
            const accommodation = accommodations.find(acc => String(acc.id) === String(accommodationId));
            if (!accommodation) {
                alert('ì„ íƒí•œ ìˆ™ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error('âŒ ìˆ™ì†Œ ID ì°¾ì„ ìˆ˜ ì—†ìŒ:', accommodationId);
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ìˆ™ì†Œ IDs:', accommodations.map(acc => acc.id));
                return;
            }

            console.log('âœ… ìˆ™ì†Œ ì¶”ê°€ ì„±ê³µ:', accommodation.accommodationName);
            selectedAccommodations.push(accommodationId);
            renderSelectedAccommodations();
            select.value = '';
        }

        // ì„ íƒëœ ìˆ™ì†Œ ë Œë”ë§
        function renderSelectedAccommodations() {
            const container = document.getElementById('selectedAccommodations');
            if (!container) {
                console.error('âŒ selectedAccommodations ì»¸í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            console.log('ğŸ  ì„ íƒëœ ìˆ™ì†Œ ë Œë”ë§ ì‹œì‘:', selectedAccommodations);
            container.innerHTML = '';

            if (selectedAccommodations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm p-3">ì„ íƒëœ ìˆ™ì†Œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            selectedAccommodations.forEach((accId, index) => {
                const acc = accommodations.find(a => String(a.id) === String(accId));
                if (!acc) {
                    console.warn(`âš ï¸ ìˆ™ì†Œ ID ${accId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                    return;
                }

                console.log(`ğŸ  ìˆ™ì†Œ ${index + 1}: ${acc.accommodationName}`);
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-blue-50 p-3 rounded mb-2';
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">${acc.accommodationName}</div>
                        <div class="text-xs text-gray-500">${acc.buildingName || 'ë¹Œë”©ëª… ì—†ìŒ'}</div>
                    </div>
                    <button onclick="window.removeAccommodation && window.removeAccommodation(${accId})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            
            console.log('âœ… ì„ íƒëœ ìˆ™ì†Œ ë Œë”ë§ ì™„ë£Œ, ì´', selectedAccommodations.length, 'ê°œ');
        }

        // ìˆ™ì†Œ ì œê±°
        window.removeAccommodation = function(accId) {
            selectedAccommodations = selectedAccommodations.filter(id => id !== accId);
            renderSelectedAccommodations();
        }

        // ëª¨ë‹¬ ì—´ê¸°
        window.openModal = function(mode, id = null) {
            console.log('ğŸ”„ openModal í˜¸ì¶œë¨, mode:', mode, 'id:', id);
            
            // Firebase ì—°ë™ í™•ì¸ (ìƒˆ íˆ¬ìì ì¶”ê°€ì‹œ)
            if (mode === 'add' && !firebaseStorage.isConfigured()) {
                console.warn('âš ï¸ Firebaseê°€ ì—°ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                const confirmed = confirm(`
âš ï¸ Firebase ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤!

PCì™€ ëª¨ë°”ì¼ ê°„ ë°ì´í„° ë™ê¸°í™”ë¥¼ ìœ„í•´ Firebaseë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.

ì§€ê¸ˆ Firebase ì—°ë™ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                `);
                
                if (confirmed) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
                
                // ë¡œì»¬ì—ì„œë§Œ ì‚¬ìš©í•˜ê² ë‹¤ë©´ ê³„ì† ì§„í–‰
                console.log('ğŸ”§ ë¡œì»¬ ëª¨ë“œë¡œ ê³„ì† ì§„í–‰');
            }
            
            currentMode = mode;
            currentId = id;
            isEditMode = false;
            selectedAccommodations = [];

            const modal = document.getElementById('investorModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('investorForm');
            const editButton = document.getElementById('editButton');
            const deleteButton = document.getElementById('deleteButton');

            if (mode === 'add') {
                console.log('âœ… ìƒˆ íˆ¬ìì ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°');
                title.textContent = 'ìƒˆ íˆ¬ìì ì¶”ê°€';
                form.reset();
                editButton.style.display = 'none';
                deleteButton.style.display = 'none';
                isEditMode = true;
                document.getElementById('investorRatio').value = 70;
                document.getElementById('companyRatio').value = 30;
            } else if (mode === 'view') {
                console.log('ğŸ” íˆ¬ìì ì°¾ê¸° ì‹œì‘...');
                console.log('ì°¾ëŠ” ID:', id, typeof id);
                console.log('ì „ì²´ íˆ¬ìì ë°ì´í„°:', investorData);
                
                // ID íƒ€ì… ë³€í™˜í•´ì„œ ì°¾ê¸°
                const investor = investorData.find(inv => {
                    console.log('ë¹„êµ:', inv.id, typeof inv.id, '===', id, typeof id);
                    return inv.id == id || inv.id === id || inv.id === String(id) || String(inv.id) === String(id);
                });
                
                if (investor) {
                    console.log('âœ… íˆ¬ìì ì •ë³´ ë¡œë“œ:', investor.name);
                    title.textContent = `íˆ¬ìì ì •ë³´ - ${investor.name}`;
                    populateForm(investor);
                    editButton.style.display = 'block';
                    deleteButton.style.display = 'block';
                    isEditMode = false;
                } else {
                    console.error('âŒ íˆ¬ììë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ID:', id);
                    console.log('í˜„ì¬ investorData:', investorData);
                    console.log('ê° íˆ¬ìì IDë“¤:');
                    investorData.forEach((inv, index) => {
                        console.log(`${index}: ID = "${inv.id}" (${typeof inv.id}), Name = "${inv.name}"`);
                    });
                    alert('íˆ¬ìì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            console.log('ğŸ¯ ëª¨ë‹¬ ì—´ê¸° ì „ ìƒíƒœ:', {mode, isEditMode, currentId});
            updateFormState();
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            console.log('âœ… ëª¨ë‹¬ì´ ì„±ê³µì ìœ¼ë¡œ ì—´ë ¸ìŠµë‹ˆë‹¤');
        }

        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        function populateForm(investor) {
            document.getElementById('userId').value = investor.userId;
            document.getElementById('password').value = investor.password;
            document.getElementById('investorName').value = investor.name;
            document.getElementById('phone').value = investor.phone;
            document.getElementById('email').value = investor.email;
            document.getElementById('investmentDate').value = investor.investmentDate;
            document.getElementById('settlementDay').value = investor.settlementDay || '';
            document.getElementById('investorRatio').value = investor.investorRatio;
            document.getElementById('companyRatio').value = investor.companyRatio;
            
            selectedAccommodations = [...(investor.accommodations || [])];
            renderSelectedAccommodations();
        }

        // í¸ì§‘ ëª¨ë“œ í† ê¸€ (ì „ì—­ í•¨ìˆ˜)
        window.toggleEditMode = function() {
            console.log('ğŸ”§ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ë¨! í˜„ì¬ ìƒíƒœ:', {
                currentMode: currentMode,
                isEditMode: isEditMode,
                currentId: currentId
            });
            
            if (currentMode !== 'view') {
                console.log('âš ï¸ view ëª¨ë“œê°€ ì•„ë‹™ë‹ˆë‹¤:', currentMode);
                alert('âš ï¸ view ëª¨ë“œê°€ ì•„ë‹™ë‹ˆë‹¤!');
                return;
            }
            
            if (!currentId) {
                console.log('âš ï¸ ì„ íƒëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤');
                alert('âš ï¸ ì„ íƒëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // í¸ì§‘ ëª¨ë“œ í† ê¸€
            isEditMode = !isEditMode;
            
            console.log('âœ… í¸ì§‘ ëª¨ë“œ ë³€ê²½ë¨:', isEditMode ? 'ON' : 'OFF');
            
            // ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ í”¼ë“œë°±
            if (isEditMode) {
                console.log('ğŸ“ í¸ì§‘ ëª¨ë“œ í™œì„±í™” - í¼ í•„ë“œê°€ ìˆ˜ì • ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤');
                alert('ğŸ“ í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                console.log('ğŸ”’ í¸ì§‘ ëª¨ë“œ ë¹„í™œì„±í™” - í¼ í•„ë“œê°€ ì½ê¸° ì „ìš©ì´ ë©ë‹ˆë‹¤');
                alert('ğŸ”’ í¸ì§‘ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            // í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateFormState();
        };

        // í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateFormState() {
            console.log('ğŸ”„ í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...', {currentMode, isEditMode});
            
            const formElements = document.querySelectorAll('#investorForm input, #investorForm select');
            const isReadonly = currentMode === 'view' && !isEditMode;

            console.log(`ğŸ“ í¼ í•„ë“œ ${isReadonly ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'} (ì´ ${formElements.length}ê°œ)`);

            formElements.forEach(element => {
                element.disabled = isReadonly;
                // ì‹œê°ì  í”¼ë“œë°±ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ë³€ê²½
                if (isReadonly) {
                    element.style.backgroundColor = '#f9fafb';
                    element.style.color = '#6b7280';
                } else {
                    element.style.backgroundColor = '#ffffff';
                    element.style.color = '#374151';
                }
            });

            // ì €ì¥ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.style.display = isReadonly ? 'none' : 'block';
                console.log(`ğŸ’¾ ì €ì¥ ë²„íŠ¼ ${isReadonly ? 'ìˆ¨ê¹€' : 'í‘œì‹œ'}`);
            }
            
            // ìˆ˜ì • ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const editButtonText = document.getElementById('editButtonText');
            if (editButtonText) {
                const newText = isEditMode ? 'ì·¨ì†Œ' : 'ìˆ˜ì •';
                editButtonText.textContent = newText;
                console.log(`ğŸ”§ ìˆ˜ì • ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½: "${newText}"`);
            }
            
            console.log('âœ… í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeModal = function() {
            document.getElementById('investorModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentMode = 'view';
            currentId = null;
            isEditMode = false;
            selectedAccommodations = [];
        }

        // íˆ¬ìì ì‚­ì œ
        window.deleteInvestor = async function() {
            if (!currentId) return;
            
            if (confirm('ì´ íˆ¬ììë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await deleteInvestorFromServer(currentId);
                    console.log('âœ… Cloudflare D1ì—ì„œ íˆ¬ìì ì‚­ì œ ì™„ë£Œ');
                    
                    // ë¡œì»¬ ë°ì´í„°ì—ì„œ ì œê±°
                    investorData = investorData.filter(inv => inv.id !== currentId);
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('investorData', JSON.stringify(investorData));
                    console.log('ğŸ’¾ localStorageì—ë„ ì‚­ì œ ë™ê¸°í™” ì™„ë£Œ:', investorData.length + 'ëª… íˆ¬ìì');
                    
                    alert('íˆ¬ììê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    renderInvestorTable();
                    closeModal();
                } catch (error) {
                    console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ìˆ™ì†Œ ëª©ë¡ ë³´ê¸°
        window.showAccommodationList = function(investorId) {
            const investor = investorData.find(inv => inv.id === investorId);
            if (!investor) return;

            const accommodationList = investor.accommodations.map(id => 
                accommodations.find(acc => acc.id === id)
            ).filter(acc => acc);

            const content = document.getElementById('accommodationDetailContent');
            content.innerHTML = `
                <h4 class="font-semibold mb-4">${investor.name}ë‹˜ì˜ ë³´ìœ  ìˆ™ì†Œ</h4>
                <div class="space-y-3">
                    ${accommodationList.map(acc => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900">${acc.accommodationName}</h5>
                            <p class="text-sm text-gray-600">${acc.buildingName || ''}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('accommodationDetailModal').classList.remove('hidden');
        }

        // ìˆ™ì†Œ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        window.closeAccommodationDetailModal = function() {
            document.getElementById('accommodationDetailModal').classList.add('hidden');
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // ë‹¨ìˆœí•œ í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('investorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ:', {currentMode, isEditMode, currentId});
            
            // í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹Œ view ëª¨ë“œì—ì„œëŠ” ì œì¶œ ì°¨ë‹¨
            if (currentMode === 'view' && !isEditMode) {
                console.log('í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë¯€ë¡œ ì œì¶œ ì°¨ë‹¨ë¨');
                return;
            }
            
            const formData = {
                userId: document.getElementById('userId').value,
                password: document.getElementById('password').value,
                name: document.getElementById('investorName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                investmentDate: document.getElementById('investmentDate').value,
                settlementDay: parseInt(document.getElementById('settlementDay').value) || null,
                investorRatio: parseInt(document.getElementById('investorRatio').value),
                companyRatio: parseInt(document.getElementById('companyRatio').value),
                accommodations: [...selectedAccommodations]
            };

            console.log('í¼ ë°ì´í„°:', formData);

            if (currentMode === 'add') {
                // ìƒˆ íˆ¬ìì ì¶”ê°€ (Cloudflare D1)
                try {
                    console.log('ğŸš€ Cloudflare D1ì— ìƒˆ íˆ¬ìì ì¶”ê°€ ì¤‘...');
                    const savedInvestor = await saveInvestorToServer(formData);
                    console.log('âœ… D1 ì €ì¥ ì„±ê³µ:', savedInvestor);
                    
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    investorData.push(savedInvestor);
                    console.log('ğŸ“‹ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ:', investorData.length + 'ëª…');
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('investorData', JSON.stringify(investorData));
                    console.log('ğŸ’¾ localStorageì—ë„ ì €ì¥ ì™„ë£Œ:', investorData.length + 'ëª… íˆ¬ìì');
                    
                    alert('âœ… ìƒˆ íˆ¬ììê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    renderInvestorTable();
                    closeModal();
                    
                } catch (error) {
                    console.error('âŒ íˆ¬ìì ì¶”ê°€ ì‹¤íŒ¨:', error);
                    alert('íˆ¬ìì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
                
            } else if (currentMode === 'view' && isEditMode) {
                // ê¸°ì¡´ íˆ¬ìì ìˆ˜ì • (Cloudflare D1)
                try {
                    console.log('ğŸ”„ Cloudflare D1ì—ì„œ íˆ¬ìì ìˆ˜ì • ì¤‘, ID:', currentId);
                    
                    const updatedInvestor = await updateInvestorOnServer(currentId, formData);
                    console.log('âœ… D1 ìˆ˜ì • ì„±ê³µ:', updatedInvestor);
                    
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const index = investorData.findIndex(inv => inv.id === currentId);
                    if (index !== -1) {
                        const oldName = investorData[index].name;
                        investorData[index] = updatedInvestor;
                        console.log(`íˆ¬ìì ì •ë³´ ì—…ë°ì´íŠ¸: ${oldName} â†’ ${updatedInvestor.name}`);
                    }
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('investorData', JSON.stringify(investorData));
                    console.log('ğŸ’¾ localStorageì—ë„ ìˆ˜ì • ì €ì¥ ì™„ë£Œ:', investorData.length + 'ëª… íˆ¬ìì');
                    
                    alert(`âœ… ${updatedInvestor.name}ë‹˜ì˜ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    
                } catch (error) {
                    console.error('âŒ íˆ¬ìì ìˆ˜ì • ì‹¤íŒ¨:', error);
                    alert('íˆ¬ìì ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
                
                // UI ì—…ë°ì´íŠ¸
                renderInvestorTable();
                
                // ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ì´ë¦„ ë°˜ì˜)
                document.getElementById('modalTitle').textContent = `íˆ¬ìì ì •ë³´ - ${formData.name}`;
                
                // ìˆ˜ì • ëª¨ë“œ í•´ì œ
                isEditMode = false;
                updateFormState();
                
                console.log('íˆ¬ìì ì •ë³´ ìˆ˜ì • ì™„ë£Œ');
            } else {
                console.log('ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œ:', currentMode, isEditMode);
                alert('âš ï¸ ì˜ëª»ëœ ì‘ì—… ëª¨ë“œì…ë‹ˆë‹¤.');
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('investorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeModal();
            }
        });
    </script>
</body>
</html>