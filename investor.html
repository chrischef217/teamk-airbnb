<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투자자 관리 - Teamk 공유숙박 관리 시스템</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% 완전 차단) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        
        /* 모달 스크롤 개선 */
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
        
        /* 모바일에서 더 나은 스크롤 */
        @media (max-height: 700px) {
            .modal-overlay .flex.items-start {
                align-items: flex-start !important;
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .ratio-input {
            transition: all 0.2s ease-in-out;
        }
        .ratio-input:focus {
            ring-2 ring-blue-500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="systemTitle">
                    Teamk 공유숙박 관리 시스템
                </h1>

            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='dashboard.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> <span data-translate="dashboard">대시보드</span>
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> <span data-translate="accommodations">숙소 관리</span>
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> <span data-translate="reservations">예약 관리</span>
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-chart-bar mr-1"></i> <span data-translate="analytics">지표 관리</span>
                    </button>
                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> <span data-translate="accounting">수익 관리</span>
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-users mr-1"></i> <span data-translate="investors">투자자 관리</span>
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calculator mr-1"></i> <span data-translate="settlement">투자자 정산</span>
                    </button>

                    <button onclick="window.location.href='data-migration.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-database mr-1"></i> 데이터 관리
                    </button>
                </div>
            </div>
        </div>

        <!-- 투자자 관리 헤더 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2" data-translate="investorManagement">투자자 관리</h2>
                    <p class="text-sm text-gray-600" data-translate="investorManagementSubtitle">투자자 정보 및 수익 배분 비율 관리</p>
                </div>
                <button onclick="window.openModal && window.openModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    <span data-translate="addInvestor">새 투자자 추가</span>
                </button>
            </div>
        </div>

        <!-- 투자자 목록 -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800" data-translate="investorList">
                    투자자 목록
                </h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">투자자 정보</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">투자 비율</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">보유 숙소</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">투자 정보</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                        </tr>
                    </thead>
                    <tbody id="investorTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 투자자 데이터가 여기에 표시됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 투자자 모달 -->
    <div id="investorModal" class="fixed inset-0 z-50 hidden modal-overlay overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col modal-content">
                <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">투자자 정보</h3>
                    <div class="flex items-center gap-2">
                        <button id="editButton" onclick="window.toggleEditMode && window.toggleEditMode()" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit mr-1"></i>
                            <span id="editButtonText">수정</span>
                        </button>
                        <button onclick="window.closeModal && window.closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <form id="investorForm" class="p-6 space-y-6">
                    <!-- 기본 정보 -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">기본 정보</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">아이디 *</label>
                                <input type="text" id="userId" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">비밀번호 *</label>
                                <input type="text" id="password" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">이름 *</label>
                                <input type="text" id="investorName" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">연락처 *</label>
                                <input type="tel" id="phone" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">이메일 주소 *</label>
                                <input type="email" id="email" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                        </div>
                    </div>

                    <!-- 투자 정보 -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">투자 정보</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">투자일자 *</label>
                                <input type="date" id="investmentDate" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">정산일 (매월)</label>
                                <input type="number" id="settlementDay" min="1" max="31" placeholder="예: 15일"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">매월 정산일 (1-31일)</p>
                            </div>
                        </div>
                    </div>

                    <!-- 수익 배분 비율 -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-4">수익 배분 비율</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">투자자 비율 (%)</label>
                                    <input type="number" id="investorRatio" min="0" max="100" value="70" 
                                           class="ratio-input w-full border border-gray-300 rounded-md px-3 py-2"
                                           oninput="updateCompanyRatio()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">회사 비율 (%)</label>
                                    <input type="number" id="companyRatio" min="0" max="100" value="30" readonly
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                투자자 비율을 조정하면 회사 비율이 자동으로 계산됩니다.
                            </p>
                        </div>
                    </div>

                    <!-- 보유 숙소 -->
                    <div id="accommodationsSection">
                        <h4 class="text-lg font-medium text-gray-800 mb-4">보유 숙소</h4>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">숙소 선택</label>
                                <select id="accommodationSelect" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">숙소를 선택하세요</option>
                                </select>
                                <button type="button" onclick="window.addAccommodation && window.addAccommodation()" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i>추가
                                </button>
                            </div>
                            <div id="selectedAccommodations" class="space-y-2">
                                <!-- 선택된 숙소 목록 -->
                            </div>
                        </div>
                    </div>

                    <!-- 버튼 그룹 -->
                    <div id="buttonGroup" class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" id="saveButton" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            저장
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            취소
                        </button>
                        <button type="button" id="deleteButton" onclick="window.deleteInvestor && window.deleteInvestor()" class="sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash mr-2"></i>
                            삭제
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 숙소 상세보기 모달 -->
    <div id="accommodationDetailModal" class="fixed inset-0 z-50 hidden modal-overlay overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[calc(100vh-4rem)] flex flex-col">
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">숙소 상세 정보</h3>
                    <button onclick="window.closeAccommodationDetailModal && window.closeAccommodationDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="accommodationDetailContent" class="p-6">
                    <!-- 숙소 상세 정보가 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentMode = 'view';
        let currentId = null;
        let isEditMode = false;
        // Firebase 저장소 함수들 (수정된 버전)
        async function loadInvestorData() {
            console.log('📊 투자자 데이터 로드 시작...');
            return await firebaseStorage.loadInvestors();
        }

        async function saveInvestorToServer(investor) {
            console.log('💾 투자자 저장 시작:', investor.name);
            return await firebaseStorage.saveInvestor(investor);
        }

        async function updateInvestorOnServer(id, investor) {
            console.log('🔄 투자자 수정 시작:', id);
            return await firebaseStorage.updateInvestor(id, investor);
        }

        async function deleteInvestorFromServer(id) {
            console.log('🗑️ 투자자 삭제 시작:', id);
            return await firebaseStorage.deleteInvestor(id);
        }

        // 투자자 데이터 (Cloudflare D1에서 로드)
        let investorData = [];
        let selectedAccommodations = [];

        // 숙소 데이터 로드 함수 (Firebase 사용)
        async function loadAccommodationsFromServer() {
            console.log('🏠 숙소 데이터 로드 시작...');
            return await firebaseStorage.loadAccommodations();
        }
        



        // 숙소 목록 - Cloudflare D1에서 로드
        let accommodations = [];

        // 샘플 투자자 데이터 - 제거됨 (사용자가 직접 등록)



        // 페이지 초기화 (서버에서 데이터 로드)
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔄 투자자 관리 페이지 초기화 시작');
            
            // 🚨 페이크 데이터 완전 차단 - localStorage에서 테스트 데이터 제거
            console.log('🧹 페이크 데이터 완전 삭제 시작...');
            
            const keysToCheck = ['investorData', 'accommodationData', 'accountingData'];
            keysToCheck.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData)) {
                            // 테스트/페이크 데이터 필터링
                            const cleanData = parsedData.filter(item => {
                                const itemStr = JSON.stringify(item).toLowerCase();
                                return !itemStr.includes('테스트') && 
                                       !itemStr.includes('test') && 
                                       !itemStr.includes('더미') && 
                                       !itemStr.includes('dummy') &&
                                       !itemStr.includes('방콕 시티') &&
                                       !itemStr.includes('파타야 비치');
                            });
                            
                            if (cleanData.length !== parsedData.length) {
                                console.log(`🚨 ${key}에서 페이크 데이터 ${parsedData.length - cleanData.length}개 삭제`);
                                if (cleanData.length > 0) {
                                    localStorage.setItem(key, JSON.stringify(cleanData));
                                } else {
                                    localStorage.removeItem(key);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn(`⚠️ ${key} 파싱 실패:`, e);
                    }
                }
            });
            
            console.log('✅ 페이크 데이터 완전 삭제 완료');
            
            // 테스트 모드 제거됨 - 실제 로그인 시스템만 사용
            
            // Firebase 연결 상태 확인
            if (!firebaseStorage.isConfigured()) {
                console.warn('⚠️ Firebase 설정이 되지 않았습니다.');
                
                // Firebase 연동 페이지로 리다이렉션
                const goToFirebase = confirm(`
🔥 Firebase 연동이 필요합니다!

PC와 모바일 간 데이터 동기화를 위해 Firebase 설정이 필요합니다.
Firebase 연동 페이지로 이동하시겠습니까?
                `);
                
                if (goToFirebase) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
                
                console.log('⚠️ Firebase 없이 localStorage 모드로 실행');
            }
            
            if (checkLoginStatus()) {
                initializePagePermissions();
                
                // 서버에서 데이터 로드
                try {
                    console.log('📡 Firebase에서 데이터 로드 시작...');
                    investorData = await loadInvestorData();
                    accommodations = await loadAccommodationsFromServer();
                    console.log('✅ 투자자 데이터 로드 완료:', investorData.length + '명');
                    console.log('✅ 숙소 데이터 로드 완료:', accommodations.length + '개');
                    
                    // 숙소 데이터 상세 로깅 및 더미 데이터 생성
                    if (accommodations && accommodations.length > 0) {
                        console.log('🏠 로드된 숙소 목록:');
                        accommodations.forEach((acc, index) => {
                            console.log(`  ${index + 1}. ${acc.accommodationName} (ID: ${acc.id})`);
                        });
                    } else {
                        console.warn('⚠️ 숙소 데이터가 비어있음 - 빈 배열로 설정');
                        
                        // 🚨 페이크 데이터 완전 차단 - 절대 생성하지 않음
                        accommodations = [];
                        console.log('🚨 페이크 데이터 차단: 숙소 데이터 없음 - 사용자가 직접 등록 필요');
                    }
                } catch (error) {
                    console.error('❌ 데이터 로드 실패:', error);
                    
                    // Firebase 연결 실패시 localStorage 폴백 시도 (페이크 데이터 완전 차단)
                    try {
                        console.log('🔄 localStorage 폴백 시도...');
                        const localInvestors = localStorage.getItem('investorData');
                        const localAccommodations = localStorage.getItem('accommodationData');
                        
                        // 🚨 페이크 데이터 완전 차단 - 빈 배열로 강제 설정
                        investorData = [];
                        accommodations = [];
                        
                        console.log('🚨 페이크 데이터 차단: localStorage 데이터 무시하고 빈 배열 사용');
                        console.log('💡 모든 데이터는 사용자가 직접 등록해야 합니다.');
                        
                        alert('페이크 데이터 차단: 새로운 데이터를 직접 입력하거나 Firebase를 연동해주세요.');
                    } catch (fallbackError) {
                        console.error('❌ localStorage 폴백도 실패:', fallbackError);
                        investorData = [];
                        accommodations = [];
                    }
                }
                
                // DOM 요소 확인
                const accommodationSelect = document.getElementById('accommodationSelect');
                const selectedAccommodationsContainer = document.getElementById('selectedAccommodations');
                
                if (!accommodationSelect) {
                    console.error('❌ accommodationSelect 요소를 찾을 수 없음');
                } else {
                    console.log('✅ accommodationSelect 요소 찾기 성공');
                }
                
                if (!selectedAccommodationsContainer) {
                    console.error('❌ selectedAccommodations 요소를 찾을 수 없음');
                } else {
                    console.log('✅ selectedAccommodations 요소 찾기 성공');
                }
                
                populateAccommodationSelect();
                renderInvestorTable();
                
                console.log('🎉 투자자 관리 페이지 초기화 완료');
            }
        });

        // 투자자 테이블 렌더링
        function renderInvestorTable() {
            const tableBody = document.getElementById('investorTableBody');
            tableBody.innerHTML = '';

            if (investorData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-users text-gray-300 text-3xl mb-3 block"></i>
                            등록된 투자자가 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }

            investorData.forEach(investor => {
                // accommodations가 undefined이거나 배열이 아닐 경우 빈 배열로 처리
                const investorAccommodationIds = investor.accommodations || [];
                const investorAccommodations = Array.isArray(investorAccommodationIds) 
                    ? investorAccommodationIds.map(id => accommodations.find(acc => acc.id === id)).filter(acc => acc)
                    : [];

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => window.openModal && window.openModal('view', investor.id);

                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${investor.name}</div>
                                <div class="text-sm text-gray-500">${investor.email}</div>
                                <div class="text-xs text-gray-400">${investor.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${investor.investorRatio}%
                            </div>
                            <div class="text-gray-400">:</div>
                            <div class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
                                ${investor.companyRatio}%
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                ${investorAccommodations.length}개
                            </span>
                            <button onclick="event.stopPropagation(); window.showAccommodationList && window.showAccommodationList(${investor.id})" 
                                    class="text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-right">
                        <div class="text-sm text-gray-900">투자일: ${formatDate(investor.investmentDate)}</div>
                        <div class="text-sm text-gray-500">정산일: ${investor.settlementDay ? `매월 ${investor.settlementDay}일` : '미정'}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="event.stopPropagation(); window.openModal && window.openModal('view', ${investor.id})" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // 숙소 select 옵션 채우기
        function populateAccommodationSelect() {
            const select = document.getElementById('accommodationSelect');
            select.innerHTML = '<option value="">숙소를 선택하세요</option>';
            
            console.log('🏠 숙소 드롭다운 채우기 시작, 숙소 수:', accommodations.length);
            
            if (accommodations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '등록된 숙소가 없습니다';
                option.disabled = true;
                select.appendChild(option);
                console.log('⚠️ 등록된 숙소가 없음');
                return;
            }
            
            accommodations.forEach((acc, index) => {
                console.log(`🏠 숙소 ${index + 1}: ${acc.accommodationName} (ID: ${acc.id})`);
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.accommodationName} - ${acc.buildingName || ''}`;
                select.appendChild(option);
            });
            
            console.log('✅ 숙소 드롭다운 채우기 완료');
        }

        // 회사 비율 자동 계산
        function updateCompanyRatio() {
            const investorRatio = parseInt(document.getElementById('investorRatio').value) || 0;
            const companyRatio = 100 - investorRatio;
            document.getElementById('companyRatio').value = companyRatio;
        }

        // 숙소 추가
        window.addAccommodation = function() {
            const select = document.getElementById('accommodationSelect');
            const selectedValue = select.value;
            
            console.log('📝 숙소 추가 시도:', { selectedValue });
            
            if (!selectedValue || selectedValue === '') {
                alert('숙소를 선택해주세요.');
                return;
            }

            // ID를 문자열로 처리 (더미 데이터는 문자열 ID를 사용)
            const accommodationId = selectedValue;

            if (selectedAccommodations.includes(accommodationId)) {
                alert('이미 추가된 숙소입니다.');
                return;
            }

            // 숙소 정보 확인
            const accommodation = accommodations.find(acc => String(acc.id) === String(accommodationId));
            if (!accommodation) {
                alert('선택한 숙소를 찾을 수 없습니다.');
                console.error('❌ 숙소 ID 찾을 수 없음:', accommodationId);
                console.log('사용 가능한 숙소 IDs:', accommodations.map(acc => acc.id));
                return;
            }

            console.log('✅ 숙소 추가 성공:', accommodation.accommodationName);
            selectedAccommodations.push(accommodationId);
            renderSelectedAccommodations();
            select.value = '';
        }

        // 선택된 숙소 렌더링
        function renderSelectedAccommodations() {
            const container = document.getElementById('selectedAccommodations');
            if (!container) {
                console.error('❌ selectedAccommodations 컸테이너를 찾을 수 없음');
                return;
            }
            
            console.log('🏠 선택된 숙소 렌더링 시작:', selectedAccommodations);
            container.innerHTML = '';

            if (selectedAccommodations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm p-3">선택된 숙소가 없습니다</p>';
                return;
            }

            selectedAccommodations.forEach((accId, index) => {
                const acc = accommodations.find(a => String(a.id) === String(accId));
                if (!acc) {
                    console.warn(`⚠️ 숙소 ID ${accId}를 찾을 수 없음`);
                    return;
                }

                console.log(`🏠 숙소 ${index + 1}: ${acc.accommodationName}`);
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-blue-50 p-3 rounded mb-2';
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">${acc.accommodationName}</div>
                        <div class="text-xs text-gray-500">${acc.buildingName || '빌딩명 없음'}</div>
                    </div>
                    <button onclick="window.removeAccommodation && window.removeAccommodation(${accId})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            
            console.log('✅ 선택된 숙소 렌더링 완료, 총', selectedAccommodations.length, '개');
        }

        // 숙소 제거
        window.removeAccommodation = function(accId) {
            selectedAccommodations = selectedAccommodations.filter(id => id !== accId);
            renderSelectedAccommodations();
        }

        // 모달 열기
        window.openModal = function(mode, id = null) {
            console.log('🔄 openModal 호출됨, mode:', mode, 'id:', id);
            
            // Firebase 연동 확인 (새 투자자 추가시)
            if (mode === 'add' && !firebaseStorage.isConfigured()) {
                console.warn('⚠️ Firebase가 연동되지 않았습니다');
                const confirmed = confirm(`
⚠️ Firebase 연동이 필요합니다!

PC와 모바일 간 데이터 동기화를 위해 Firebase를 먼저 설정해주세요.

지금 Firebase 연동 페이지로 이동하시겠습니까?
                `);
                
                if (confirmed) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
                
                // 로컬에서만 사용하겠다면 계속 진행
                console.log('🔧 로컬 모드로 계속 진행');
            }
            
            currentMode = mode;
            currentId = id;
            isEditMode = false;
            selectedAccommodations = [];

            const modal = document.getElementById('investorModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('investorForm');
            const editButton = document.getElementById('editButton');
            const deleteButton = document.getElementById('deleteButton');

            if (mode === 'add') {
                console.log('✅ 새 투자자 추가 모달 열기');
                title.textContent = '새 투자자 추가';
                form.reset();
                editButton.style.display = 'none';
                deleteButton.style.display = 'none';
                isEditMode = true;
                document.getElementById('investorRatio').value = 70;
                document.getElementById('companyRatio').value = 30;
            } else if (mode === 'view') {
                console.log('🔍 투자자 찾기 시작...');
                console.log('찾는 ID:', id, typeof id);
                console.log('전체 투자자 데이터:', investorData);
                
                // ID 타입 변환해서 찾기
                const investor = investorData.find(inv => {
                    console.log('비교:', inv.id, typeof inv.id, '===', id, typeof id);
                    return inv.id == id || inv.id === id || inv.id === String(id) || String(inv.id) === String(id);
                });
                
                if (investor) {
                    console.log('✅ 투자자 정보 로드:', investor.name);
                    title.textContent = `투자자 정보 - ${investor.name}`;
                    populateForm(investor);
                    editButton.style.display = 'block';
                    deleteButton.style.display = 'block';
                    isEditMode = false;
                } else {
                    console.error('❌ 투자자를 찾을 수 없음, ID:', id);
                    console.log('현재 investorData:', investorData);
                    console.log('각 투자자 ID들:');
                    investorData.forEach((inv, index) => {
                        console.log(`${index}: ID = "${inv.id}" (${typeof inv.id}), Name = "${inv.name}"`);
                    });
                    alert('투자자 정보를 찾을 수 없습니다.');
                    return;
                }
            }

            console.log('🎯 모달 열기 전 상태:', {mode, isEditMode, currentId});
            updateFormState();
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            console.log('✅ 모달이 성공적으로 열렸습니다');
        }

        // 폼에 데이터 채우기
        function populateForm(investor) {
            document.getElementById('userId').value = investor.userId;
            document.getElementById('password').value = investor.password;
            document.getElementById('investorName').value = investor.name;
            document.getElementById('phone').value = investor.phone;
            document.getElementById('email').value = investor.email;
            document.getElementById('investmentDate').value = investor.investmentDate;
            document.getElementById('settlementDay').value = investor.settlementDay || '';
            document.getElementById('investorRatio').value = investor.investorRatio;
            document.getElementById('companyRatio').value = investor.companyRatio;
            
            selectedAccommodations = [...(investor.accommodations || [])];
            renderSelectedAccommodations();
        }

        // 편집 모드 토글 (전역 함수)
        window.toggleEditMode = function() {
            console.log('🔧 수정 버튼 클릭됨! 현재 상태:', {
                currentMode: currentMode,
                isEditMode: isEditMode,
                currentId: currentId
            });
            
            if (currentMode !== 'view') {
                console.log('⚠️ view 모드가 아닙니다:', currentMode);
                alert('⚠️ view 모드가 아닙니다!');
                return;
            }
            
            if (!currentId) {
                console.log('⚠️ 선택된 투자자가 없습니다');
                alert('⚠️ 선택된 투자자가 없습니다!');
                return;
            }
            
            // 편집 모드 토글
            isEditMode = !isEditMode;
            
            console.log('✅ 편집 모드 변경됨:', isEditMode ? 'ON' : 'OFF');
            
            // 사용자에게 즉시 피드백
            if (isEditMode) {
                console.log('📝 편집 모드 활성화 - 폼 필드가 수정 가능해집니다');
                alert('📝 편집 모드가 활성화되었습니다! 이제 정보를 수정할 수 있습니다.');
            } else {
                console.log('🔒 편집 모드 비활성화 - 폼 필드가 읽기 전용이 됩니다');
                alert('🔒 편집 모드가 비활성화되었습니다.');
            }
            
            // 폼 상태 업데이트
            updateFormState();
        };

        // 폼 상태 업데이트
        function updateFormState() {
            console.log('🔄 폼 상태 업데이트 중...', {currentMode, isEditMode});
            
            const formElements = document.querySelectorAll('#investorForm input, #investorForm select');
            const isReadonly = currentMode === 'view' && !isEditMode;

            console.log(`📝 폼 필드 ${isReadonly ? '비활성화' : '활성화'} (총 ${formElements.length}개)`);

            formElements.forEach(element => {
                element.disabled = isReadonly;
                // 시각적 피드백을 위한 스타일 변경
                if (isReadonly) {
                    element.style.backgroundColor = '#f9fafb';
                    element.style.color = '#6b7280';
                } else {
                    element.style.backgroundColor = '#ffffff';
                    element.style.color = '#374151';
                }
            });

            // 저장 버튼 표시/숨김
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.style.display = isReadonly ? 'none' : 'block';
                console.log(`💾 저장 버튼 ${isReadonly ? '숨김' : '표시'}`);
            }
            
            // 수정 버튼 텍스트 업데이트
            const editButtonText = document.getElementById('editButtonText');
            if (editButtonText) {
                const newText = isEditMode ? '취소' : '수정';
                editButtonText.textContent = newText;
                console.log(`🔧 수정 버튼 텍스트 변경: "${newText}"`);
            }
            
            console.log('✅ 폼 상태 업데이트 완료');
        }

        // 모달 닫기
        window.closeModal = function() {
            document.getElementById('investorModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentMode = 'view';
            currentId = null;
            isEditMode = false;
            selectedAccommodations = [];
        }

        // 투자자 삭제
        window.deleteInvestor = async function() {
            if (!currentId) return;
            
            if (confirm('이 투자자를 삭제하시겠습니까?')) {
                try {
                    await deleteInvestorFromServer(currentId);
                    console.log('✅ Cloudflare D1에서 투자자 삭제 완료');
                    
                    // 로컬 데이터에서 제거
                    investorData = investorData.filter(inv => inv.id !== currentId);
                    
                    // localStorage에도 동시 저장
                    localStorage.setItem('investorData', JSON.stringify(investorData));
                    console.log('💾 localStorage에도 삭제 동기화 완료:', investorData.length + '명 투자자');
                    
                    alert('투자자가 삭제되었습니다.');
                    renderInvestorTable();
                    closeModal();
                } catch (error) {
                    console.error('❌ 삭제 실패:', error);
                    alert('삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 숙소 목록 보기
        window.showAccommodationList = function(investorId) {
            const investor = investorData.find(inv => inv.id === investorId);
            if (!investor) return;

            const accommodationList = investor.accommodations.map(id => 
                accommodations.find(acc => acc.id === id)
            ).filter(acc => acc);

            const content = document.getElementById('accommodationDetailContent');
            content.innerHTML = `
                <h4 class="font-semibold mb-4">${investor.name}님의 보유 숙소</h4>
                <div class="space-y-3">
                    ${accommodationList.map(acc => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900">${acc.accommodationName}</h5>
                            <p class="text-sm text-gray-600">${acc.buildingName || ''}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('accommodationDetailModal').classList.remove('hidden');
        }

        // 숙소 상세 모달 닫기
        window.closeAccommodationDetailModal = function() {
            document.getElementById('accommodationDetailModal').classList.add('hidden');
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // 단순한 폼 제출 처리
        document.getElementById('investorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('폼 제출 이벤트 발생:', {currentMode, isEditMode, currentId});
            
            // 편집 모드가 아닌 view 모드에서는 제출 차단
            if (currentMode === 'view' && !isEditMode) {
                console.log('편집 모드가 아니므로 제출 차단됨');
                return;
            }
            
            const formData = {
                userId: document.getElementById('userId').value,
                password: document.getElementById('password').value,
                name: document.getElementById('investorName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                investmentDate: document.getElementById('investmentDate').value,
                settlementDay: parseInt(document.getElementById('settlementDay').value) || null,
                investorRatio: parseInt(document.getElementById('investorRatio').value),
                companyRatio: parseInt(document.getElementById('companyRatio').value),
                accommodations: [...selectedAccommodations]
            };

            console.log('폼 데이터:', formData);

            if (currentMode === 'add') {
                // 새 투자자 추가 (Cloudflare D1)
                try {
                    console.log('🚀 Cloudflare D1에 새 투자자 추가 중...');
                    const savedInvestor = await saveInvestorToServer(formData);
                    console.log('✅ D1 저장 성공:', savedInvestor);
                    
                    // 로컬 데이터 업데이트
                    investorData.push(savedInvestor);
                    console.log('📋 데이터 업데이트 완료:', investorData.length + '명');
                    
                    // localStorage에도 동시 저장
                    localStorage.setItem('investorData', JSON.stringify(investorData));
                    console.log('💾 localStorage에도 저장 완료:', investorData.length + '명 투자자');
                    
                    alert('✅ 새 투자자가 성공적으로 추가되었습니다!');
                    renderInvestorTable();
                    closeModal();
                    
                } catch (error) {
                    console.error('❌ 투자자 추가 실패:', error);
                    alert('투자자 추가 중 오류가 발생했습니다: ' + error.message);
                }
                
            } else if (currentMode === 'view' && isEditMode) {
                // 기존 투자자 수정 (Cloudflare D1)
                try {
                    console.log('🔄 Cloudflare D1에서 투자자 수정 중, ID:', currentId);
                    
                    const updatedInvestor = await updateInvestorOnServer(currentId, formData);
                    console.log('✅ D1 수정 성공:', updatedInvestor);
                    
                    // 로컬 데이터 업데이트
                    const index = investorData.findIndex(inv => inv.id === currentId);
                    if (index !== -1) {
                        const oldName = investorData[index].name;
                        investorData[index] = updatedInvestor;
                        console.log(`투자자 정보 업데이트: ${oldName} → ${updatedInvestor.name}`);
                    }
                    
                    // localStorage에도 동시 저장
                    localStorage.setItem('investorData', JSON.stringify(investorData));
                    console.log('💾 localStorage에도 수정 저장 완료:', investorData.length + '명 투자자');
                    
                    alert(`✅ ${updatedInvestor.name}님의 정보가 성공적으로 수정되었습니다!`);
                    
                } catch (error) {
                    console.error('❌ 투자자 수정 실패:', error);
                    alert('투자자 수정 중 오류가 발생했습니다: ' + error.message);
                }
                
                // UI 업데이트
                renderInvestorTable();
                
                // 모달 제목 업데이트 (수정된 이름 반영)
                document.getElementById('modalTitle').textContent = `투자자 정보 - ${formData.name}`;
                
                // 수정 모드 해제
                isEditMode = false;
                updateFormState();
                
                console.log('투자자 정보 수정 완료');
            } else {
                console.log('알 수 없는 모드:', currentMode, isEditMode);
                alert('⚠️ 잘못된 작업 모드입니다.');
            }
        });

        // 모달 외부 클릭 시 닫기
        document.getElementById('investorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeModal();
            }
        });
    </script>
</body>
</html>