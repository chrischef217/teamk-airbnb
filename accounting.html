<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒê³„ê´€ë¦¬ - Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% ì™„ì „ ì°¨ë‹¨) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        
        /* ëª¨ë‹¬ ìŠ¤í¬ë¡¤ ê°œì„  */
        #accountingModal {
            backdrop-filter: blur(4px);
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë” ë‚˜ì€ ìŠ¤í¬ë¡¤ */
        @media (max-height: 700px) {
            #accountingModal .flex.items-start {
                align-items: flex-start !important;
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">
                        Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ
                    </h1>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='index.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> ëŒ€ì‹œë³´ë“œ
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> ìˆ™ì†Œ ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='reservation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calendar-check mr-1"></i> ì˜ˆì•½ ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='analytics.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-chart-bar mr-1"></i> ì§€í‘œ ê´€ë¦¬
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-coins mr-1"></i> ìˆ˜ìµ ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='investor.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-users mr-1"></i> íˆ¬ìì ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calculator mr-1"></i> íˆ¬ìì ì •ì‚°
                    </button>
                    <button onclick="window.location.href='data-migration.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-database mr-1"></i> ë°ì´í„° ê´€ë¦¬
                    </button>
                </div>
            </div>
        </div>

        <!-- íˆ¬ììë³„ ìˆ˜ìµ ê´€ë¦¬ í—¤ë” -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">íˆ¬ììë³„ ìˆ˜ìµ ê´€ë¦¬</h2>
                    <p class="text-sm text-gray-600">íˆ¬ììë³„ ìˆ™ì†Œ ìˆ˜ì…/ì§€ì¶œ ë‚´ì—­ ë° ì†ìµ ê´€ë¦¬</p>
                </div>
                <button onclick="openAccountingModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    ìƒˆ ìˆ˜ìµ/ì§€ì¶œ ì¶”ê°€
                </button>
            </div>
            
            <!-- íˆ¬ìì ì„ íƒ -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user-tie mr-2 text-blue-600"></i>
                    íˆ¬ìì ì„ íƒ
                </label>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
                    <div class="flex-1">
                        <select id="selectedInvestor" class="w-full border border-gray-300 rounded-md px-4 py-2 text-sm bg-white">
                            <option value="">íˆ¬ììë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ì„ íƒí•œ íˆ¬ììì˜ ë³´ìœ  ìˆ™ì†Œ ìˆ˜ìµë§Œ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                    <button id="searchBtn" onclick="performSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors whitespace-nowrap">
                        <i class="fas fa-search mr-2"></i>
                        ì¡°íšŒ
                    </button>
                </div>
            </div>
            
            <!-- í•„í„° ë° ì •ë ¬ ì˜µì…˜ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì •ë ¬ ê¸°ì¤€</label>
                    <select id="accountingSortBy" onchange="performSearch()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="date_desc">ë‚ ì§œ (ìµœì‹ ìˆœ)</option>
                        <option value="date_asc">ë‚ ì§œ (ì˜¤ë˜ëœìˆœ)</option>
                        <option value="accommodation">ìˆ™ì†Œëª…</option>
                        <option value="amount_desc">ê¸ˆì•¡ (ë†’ì€ìˆœ)</option>
                        <option value="amount_asc">ê¸ˆì•¡ (ë‚®ì€ìˆœ)</option>
                        <option value="type">êµ¬ë¶„ (ìˆ˜ì…/ì§€ì¶œ)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì›”ë³„ í•„í„°</label>
                    <select id="monthFilter" onchange="performSearch()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">ì „ì²´ ì›”</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ í•„í„°</label>
                    <select id="accommodationFilter" onchange="performSearch()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">ì „ì²´ ìˆ™ì†Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ë¶„ í•„í„°</label>
                    <select id="typeFilter" onchange="performSearch()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">ì „ì²´</option>
                        <option value="income">ìˆ˜ì…</option>
                        <option value="expense">ì§€ì¶œ</option>
                    </select>
                </div>
            </div>
            
            <!-- ì¡°íšŒ ë° ì´ˆê¸°í™” ë²„íŠ¼ -->
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button onclick="performSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-search mr-2"></i>
                    ì¡°íšŒí•˜ê¸°
                </button>
                <button onclick="resetFilters()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-8 py-3 rounded-lg text-sm font-medium transition-colors border">
                    <i class="fas fa-refresh mr-2"></i>
                    í•„í„° ì´ˆê¸°í™”
                </button>
            </div>
            
            <!-- ì‚¬ìš© ì•ˆë‚´ -->
            <div class="mt-3 text-center">
                <p class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    íˆ¬ììë‚˜ í•„í„° ì¡°ê±´ì„ ì„ íƒí•œ í›„ <strong>"ì¡°íšŒí•˜ê¸°"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                </p>
            </div>
        </div>



        <!-- íšŒê³„ ëª©ë¡ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">ìˆ˜ìµ/ì§€ì¶œ ë‚´ì—­</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ìˆ™ì†Œ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">êµ¬ë¶„</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">í•­ëª©</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ê¸ˆì•¡ (THB)</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ì”ì•¡ (THB)</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="accountingTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- íšŒê³„ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
            

        </div>
    </div>

    <!-- íšŒê³„ ëª¨ë‹¬ -->
    <div id="accountingModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col">
                <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">íšŒê³„ ì •ë³´</h3>
                    <button onclick="closeAccountingModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <form id="accountingForm" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë‚ ì§œ *</label>
                            <input type="date" id="transactionDate" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ ì„ íƒ *</label>
                            <select id="accommodationId" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ë¶„ *</label>
                            <select id="type" required class="w-full border border-gray-300 rounded-md px-3 py-2" onchange="updateCategoryOptions()">
                                <option value="">êµ¬ë¶„ ì„ íƒ</option>
                                <option value="income">ìˆ˜ì…</option>
                                <option value="expense">ì§€ì¶œ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•­ëª© *</label>
                            <select id="category" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="">í•­ëª© ì„ íƒ</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê¸ˆì•¡ (THB) *</label>
                            <input type="number" id="amount" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>

                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            ì €ì¥
                        </button>
                        <button type="button" onclick="closeAccountingModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            ì·¨ì†Œ
                        </button>
                        <button type="button" id="deleteButton" onclick="deleteAccounting()" class="sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">
                            <i class="fas fa-trash mr-2"></i>
                            ì‚­ì œ
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let accountingData = [];
        let accommodations = [];
        let investors = [];
        let currentMode = 'add';
        let currentId = null;

        // ì¹´í…Œê³ ë¦¬ ì •ì˜
        const categories = {
            income: [
                { value: 'booking', text: 'ì˜ˆì•½ ìˆ˜ì…' },
                { value: 'deposit', text: 'ë³´ì¦ê¸ˆ' },
                { value: 'additional', text: 'ì¶”ê°€ ì„œë¹„ìŠ¤' },
                { value: 'other_income', text: 'ê¸°íƒ€ ìˆ˜ì…' }
            ],
            expense: [
                { value: 'cleaning', text: 'ì²­ì†Œë¹„' },
                { value: 'maintenance', text: 'ìˆ˜ë¦¬/ë³´ìˆ˜' },
                { value: 'supplies', text: 'ìš©í’ˆ êµ¬ì…' },
                { value: 'electricity', text: 'ì „ê¸°ì„¸' },
                { value: 'water', text: 'ìˆ˜ë„ì„¸' },
                { value: 'telecom', text: 'í†µì‹ ë¹„' },
                { value: 'rent', text: 'ë ŒíŠ¸ë¹„' },
                { value: 'platform_fee', text: 'ìˆ˜ìˆ˜ë£Œ' },
                { value: 'tax', text: 'ì„¸ê¸ˆ' },
                { value: 'other_expense', text: 'ê¸°íƒ€ ì§€ì¶œ' }
            ]
        };

        // === Firebase ì—°ë™ í•¨ìˆ˜ë“¤ (localStorage í´ë°± í¬í•¨) ===
        async function loadAccountingData() {
            console.log('ğŸ’° íšŒê³„ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            try {
                return await firebaseStorage.loadAccounting();
            } catch (error) {
                console.warn('íšŒê³„ ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', error);
                const localData = localStorage.getItem('accountingData');
                return localData ? JSON.parse(localData) : [];
            }
        }

        async function loadAccommodationData() {
            console.log('ğŸ  ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            console.log('ğŸ  ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì¤‘...');
            try {
                return await firebaseStorage.loadAccommodations();
            } catch (error) {
                console.warn('âš ï¸ ìˆ™ì†Œ ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', error);
                const localData = localStorage.getItem('accommodationData');
                return localData ? JSON.parse(localData) : [];
            }
        }

        async function loadInvestorData() {
            console.log('ğŸ‘¥ íˆ¬ìì ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            console.log('ğŸ“Š íˆ¬ìì ë°ì´í„° ë¡œë“œ ì¤‘...');
            try {
                return await firebaseStorage.loadInvestors();
            } catch (error) {
                console.warn('âš ï¸ íˆ¬ìì ë¡œë“œ ì‹¤íŒ¨, localStorage í´ë°±:', error);
                const localData = localStorage.getItem('investorData');
                return localData ? JSON.parse(localData) : [];
            }
        }

        async function saveAccountingToServer(accounting) {
            console.log('ğŸ’¾ íšŒê³„ ì €ì¥ ì‹œì‘:', accounting.category);
            return await firebaseStorage.saveAccounting(accounting);
        }

        async function updateAccountingOnServer(id, accounting) {
            console.log('ğŸ”„ íšŒê³„ ìˆ˜ì • ì‹œì‘:', id);
            return await firebaseStorage.updateAccounting(id, accounting);
        }

        async function deleteAccountingFromServer(id) {
            console.log('ğŸ—‘ï¸íšŒê³„ ì‚­ì œ ì‹œì‘:', id);
            return await firebaseStorage.deleteAccounting(id);
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”„ íšŒê³„ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // === ì¶”ê°€ Service Worker ë³´í˜¸ ===
            // workbox ë³€ìˆ˜ë“¤ì„ ì¦‰ì‹œ ì‚­ì œ ë° ì°¨ë‹¨
            const workboxVariables = ['workbox', '__WB_MANIFEST', '__precacheManifest', 'wb', 'WB'];
            workboxVariables.forEach(varName => {
                if (window[varName]) {
                    delete window[varName];
                    console.log(`âœ… ${varName} ë³€ìˆ˜ ì‚­ì œ ì™„ë£Œ`);
                }
            });
            
            // ì—ëŸ¬ ìºì¹˜ë¥¼ í†µí•œ ì•ˆì „í•œ ì´ˆê¸°í™”
            try {
                // Firebase ì—°ê²° ìƒíƒœ í™•ì¸ (ìë™ ì²˜ë¦¬)
                if (!firebaseStorage.isConfigured()) {
                    console.warn('âš ï¸ Firebase ì„¤ì •ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. localStorage ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âš ï¸ Firebase ì„¤ì • í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
            }

            // === ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ê°œë°œ ëª¨ë“œ ìš°íšŒ) ===
            let loginStatus = false;
            try {
                // checkLoginStatus í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ê³  ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
                if (typeof checkLoginStatus === 'function') {
                    loginStatus = checkLoginStatus();
                    console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸:', loginStatus ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
                } else {
                    console.warn('âš ï¸ checkLoginStatus í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
                    loginStatus = true; // í•¨ìˆ˜ ì—†ìœ¼ë©´ ìš°íšŒ
                }
            } catch (error) {
                console.warn('âš ï¸ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                loginStatus = true; // ì—ëŸ¬ ì‹œ ìš°íšŒ
                console.log('ğŸ”§ ê°œë°œ ëª¨ë“œ: ë¡œê·¸ì¸ í™•ì¸ ìš°íšŒ (ì˜¤ë¥˜)');
            }
            
            // ê°œë°œ ëª¨ë“œ: ë¬´ì¡°ê±´ ì§„í–‰
            if (!loginStatus) {
                console.log('ğŸ”§ ê°œë°œ ëª¨ë“œ: ê°•ì œ ë¡œê·¸ì¸ ìš°íšŒ');
                loginStatus = true;
            }
            
            if (loginStatus) {
                try {
                    initializePagePermissions();
                } catch (permError) {
                    console.warn('âš ï¸ ê¶Œí•œ ì´ˆê¸°í™” ì˜¤ë¥˜:', permError);
                }
                
                // === ì•ˆì „í•œ ë°ì´í„° ë¡œë”© ===
                console.log('ğŸ“¡ Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                
                accountingData = await loadAccountingData();
                accommodations = await loadAccommodationData();
                investors = await loadInvestorData();
                
                // ë”ë¯¸ ë°ì´í„° ìƒì„± ì œê±° - ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš©
                
                console.log('âœ… íšŒê³„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accountingData.length + 'ê±´');
                console.log('âœ… ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accommodations.length + 'ê°œ');
                console.log('âœ… íˆ¬ìì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', investors.length + 'ëª…');
                let dataLoadSuccess = true;
                
                // ë”ë¯¸ ë°ì´í„° ìƒì„± ì™„ì „ ì œê±° - ì‹¤ì œ Firebase ë°ì´í„°ë§Œ ì‚¬ìš©
                
                console.log('âœ… ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ:', accountingData.length + 'ê±´ íšŒê³„, ' + accommodations.length + 'ê°œ ìˆ™ì†Œ, ' + investors.length + 'ëª… íˆ¬ìì');
                
                // === ì•ˆì „í•œ UI ì´ˆê¸°í™” ===
                try {
                    populateAccommodationSelect();
                    populateInvestorSelect();
                    populateFilterOptions();
                    
                    // ìˆ˜ìµ ìš”ì•½ ì„¹ì…˜ ì œê±°ë¨
                    
                    // ì´ˆê¸°ì—ëŠ” íˆ¬ìì ì„ íƒ ì „ì´ë¯€ë¡œ í…Œì´ë¸” ë¹„ìš°ê¸° (íˆ¬ììë³„ ì™„ì „ ë¶„ë¦¬)
                    renderEmptyTable();
                    
                    console.log('ğŸ‰ íˆ¬ììë³„ íšŒê³„ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                    console.log('ğŸ’¡ ì‚¬ìš©ë²•: íˆ¬ììë¥¼ ì„ íƒí•œ í›„ "ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
                    
                    // ìë™ í…ŒìŠ¤íŠ¸ (3ì´ˆ í›„)
                    setTimeout(() => {
                        console.log('ğŸ¤– ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘');
                        const investorSelect = document.getElementById('selectedInvestor');
                        if (investorSelect.options.length > 1) {
                            investorSelect.selectedIndex = 1; // ì²« ë²ˆì§¸ íˆ¬ìì ì„ íƒ
                            console.log('ğŸ‘¤ íˆ¬ìì ìë™ ì„ íƒ:', investorSelect.value);
                            performSearch(); // ìë™ ì¡°íšŒ ì‹¤í–‰
                        }
                    }, 3000);
                } catch (uiError) {
                    console.error('âŒ UI ì´ˆê¸°í™” ì˜¤ë¥˜:', uiError);
                    // UI ì´ˆê¸°í™” ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ í…Œì´ë¸”ì€ í‘œì‹œ
                    try {
                        renderAccountingTable();
                    } catch (tableError) {
                        console.error('âŒ í…Œì´ë¸” ë Œë”ë§ ì˜¤ë¥˜:', tableError);
                    }
                }
            } else {
                console.log('âš ï¸ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ - ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            }
        });

        // ìˆ™ì†Œ ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
        function populateAccommodationSelect() {
            const select = document.getElementById('accommodationId');
            select.innerHTML = '<option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            accommodations.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.accommodationName || `ìˆ™ì†Œ ${acc.id}`;
                select.appendChild(option);
            });
        }

        // íˆ¬ìì ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
        function populateInvestorSelect() {
            const select = document.getElementById('selectedInvestor');
            select.innerHTML = '<option value="">íˆ¬ììë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (investors && investors.length > 0) {
                investors.forEach(investor => {
                    const option = document.createElement('option');
                    option.value = investor.id;
                    option.textContent = investor.name || `íˆ¬ìì ${investor.id}`;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ë“±ë¡ëœ íˆ¬ììê°€ ì—†ìŠµë‹ˆë‹¤';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // í•„í„° ì˜µì…˜ ì±„ìš°ê¸° (ì„ íƒëœ íˆ¬ìì ê¸°ì¤€)
        function populateFilterOptions() {
            const selectedInvestorId = document.getElementById('selectedInvestor').value;
            
            // ì›”ë³„ í•„í„° ì˜µì…˜ - ì„ íƒëœ íˆ¬ììì˜ ë°ì´í„°ë§Œ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±
            const monthFilter = document.getElementById('monthFilter');
            let filteredData = accountingData;
            
            if (selectedInvestorId) {
                const investor = investors.find(inv => inv.id === selectedInvestorId);
                if (investor && investor.accommodations) {
                    filteredData = accountingData.filter(item => 
                        investor.accommodations.includes(item.accommodationId)
                    );
                }
            }
            
            const months = [...new Set(filteredData.map(item => {
                const date = new Date(item.transactionDate);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            monthFilter.innerHTML = '<option value="">ì „ì²´ ì›”</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${month.split('-')[0]}ë…„ ${month.split('-')[1]}ì›”`;
                monthFilter.appendChild(option);
            });

            // ìˆ™ì†Œ í•„í„° ì˜µì…˜ - ì„ íƒëœ íˆ¬ììì˜ ë³´ìœ  ìˆ™ì†Œë§Œ í‘œì‹œ
            const accommodationFilter = document.getElementById('accommodationFilter');
            accommodationFilter.innerHTML = '<option value="">ì „ì²´ ìˆ™ì†Œ</option>';
            
            if (selectedInvestorId) {
                const investor = investors.find(inv => inv.id === selectedInvestorId);
                if (investor && investor.accommodations) {
                    investor.accommodations.forEach(accId => {
                        const acc = accommodations.find(a => a.id === accId);
                        if (acc) {
                            const option = document.createElement('option');
                            option.value = acc.id;
                            option.textContent = acc.accommodationName || `ìˆ™ì†Œ ${acc.id}`;
                            accommodationFilter.appendChild(option);
                        }
                    });
                }
            } else {
                accommodations.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = acc.accommodationName || `ìˆ™ì†Œ ${acc.id}`;
                    accommodationFilter.appendChild(option);
                });
            }
        }

        // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°©ì‹ - ë‹¨ìˆœí•˜ê³  íš¨ê³¼ì )
        function performSearch() {
            console.log('ğŸ” ì¡°íšŒ ì‹œì‘...');
            
            const selectedInvestorId = document.getElementById('selectedInvestor').value;
            console.log('ì„ íƒëœ íˆ¬ìì ID:', selectedInvestorId);
            
            // ìˆ˜ìµ ìš”ì•½ ì„¹ì…˜ ì œê±°ë¨ - í…Œì´ë¸”ë§Œ í‘œì‹œ
            
            // í…Œì´ë¸” ë Œë”ë§
            renderAccountingTable();
            
            console.log('âœ… ì¡°íšŒ ì™„ë£Œ');
        }

        // ì„ íƒëœ íˆ¬ììì— ë”°ë¥¸ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸ (ë‹¨ìˆœí™”ë¨)
        function updateFilterOptionsForSelectedInvestor() {
            // í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°©ì‹: ë‹¨ìˆœí•˜ê²Œ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
            populateFilterOptions();
        }

        // ìˆ˜ìµ ìš”ì•½ ê´€ë ¨ í•¨ìˆ˜ë“¤ ì œê±°ë¨ - ë‹¨ìˆœí•œ í…Œì´ë¸”ë§Œ í‘œì‹œ

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            console.log('ğŸ”„ í•„í„° ì´ˆê¸°í™”...');
            
            // ëª¨ë“  ì„ íƒê°’ ì´ˆê¸°í™”
            document.getElementById('selectedInvestor').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('accommodationFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('accountingSortBy').value = 'date_desc';
            
            // ìˆ˜ìµ ìš”ì•½ ì„¹ì…˜ ì œê±°ë¨
            
            // í•„í„° ì˜µì…˜ì„ ì „ì²´ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ìƒì„±
            populateFilterOptions();
            
            // ì „ì²´ ë°ì´í„°ë¡œ í…Œì´ë¸” ë Œë”ë§
            renderAccountingTable();
            
            console.log('âœ… í•„í„° ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // === ë””ë²„ê¹… ë° í˜¸í™˜ì„± í•¨ìˆ˜ë“¤ ===
        
        // ìˆ˜ë™ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‚¬ìš©)
        window.debugSearch = function() {
            console.log('ğŸ”§ ë””ë²„ê·¸: ìˆ˜ë™ ì¡°íšŒ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            console.log('ğŸ“Š í˜„ì¬ ë°ì´í„° ìƒíƒœ:');
            console.log('- accountingData:', accountingData ? accountingData.length + 'ê±´' : 'undefined');
            console.log('- accommodations:', accommodations ? accommodations.length + 'ê°œ' : 'undefined');
            console.log('- investors:', investors ? investors.length + 'ëª…' : 'undefined');
            
            const selectedInvestor = document.getElementById('selectedInvestor');
            if (selectedInvestor) {
                console.log('- ì„ íƒëœ íˆ¬ìì:', selectedInvestor.value || 'ì—†ìŒ');
            }
            
            try {
                performSearch();
                console.log('âœ… ìˆ˜ë™ ì¡°íšŒ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ìˆ˜ë™ ì¡°íšŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
            }
        };
        
        // êµ¬ ë²„ì „ í•¨ìˆ˜ë“¤ (í˜¸í™˜ì„±ì„ ìœ„í•´ performSearchë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
        function sortAccounting() {
            console.log('â„¹ï¸ sortAccounting í˜¸ì¶œë¨ - performSearch()ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
            performSearch();
        }

        function filterAccounting() {
            console.log('â„¹ï¸ filterAccounting í˜¸ì¶œë¨ - performSearch()ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
            performSearch();
        }

        // í•„í„° í•¨ìˆ˜
        function filterAccounting() {
            renderAccountingTable();
        }

        // ë¹ˆ í…Œì´ë¸” ë Œë”ë§ (íˆ¬ìì ì„ íƒ ì „)
        function renderEmptyTable() {
            const tableBody = document.getElementById('accountingTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                        <i class="fas fa-user-tie text-gray-300 text-4xl mb-4 block"></i>
                        <div class="text-lg font-medium mb-2">íˆ¬ììë³„ ìˆ˜ìµ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
                        <div class="text-sm">íˆ¬ììë¥¼ ì„ íƒí•œ í›„ "ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </td>
                </tr>
            `;
        }

        // í•„í„°ë§ëœ íšŒê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°©ì‹ ì ìš©)
        function getFilteredAccountingData() {
            let filtered = [...accountingData];
            
            // ì„ íƒëœ íˆ¬ìì í•„í„° (íˆ¬ììë³„ ì™„ì „ ë¶„ë¦¬)
            const selectedInvestorId = document.getElementById('selectedInvestor').value;
            if (selectedInvestorId) {
                const investor = investors.find(inv => inv.id === selectedInvestorId);
                if (investor && investor.accommodations) {
                    filtered = filtered.filter(item => 
                        investor.accommodations.includes(item.accommodationId)
                    );
                }
            } else {
                // íˆ¬ììê°€ ì„ íƒë˜ì§€ ì•Šìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜ (ì™„ì „ ë¶„ë¦¬)
                return [];
            }
            
            // ì›”ë³„ í•„í„°
            const monthFilter = document.getElementById('monthFilter').value;
            if (monthFilter) {
                filtered = filtered.filter(item => {
                    const date = new Date(item.transactionDate);
                    const itemMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return itemMonth === monthFilter;
                });
            }
            
            // ìˆ™ì†Œ í•„í„°
            const accommodationFilter = document.getElementById('accommodationFilter').value;
            if (accommodationFilter) {
                filtered = filtered.filter(item => item.accommodationId === accommodationFilter);
            }
            
            // êµ¬ë¶„ í•„í„°
            const typeFilter = document.getElementById('typeFilter').value;
            if (typeFilter) {
                filtered = filtered.filter(item => item.type === typeFilter);
            }
            
            // ì •ë ¬
            const sortBy = document.getElementById('accountingSortBy').value;
            switch (sortBy) {
                case 'date_desc':
                    filtered.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));
                    break;
                case 'date_asc':
                    filtered.sort((a, b) => new Date(a.transactionDate) - new Date(b.transactionDate));
                    break;
                case 'accommodation':
                    filtered.sort((a, b) => {
                        const accA = accommodations.find(acc => acc.id === a.accommodationId);
                        const accB = accommodations.find(acc => acc.id === b.accommodationId);
                        const nameA = accA ? accA.accommodationName : '';
                        const nameB = accB ? accB.accommodationName : '';
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'amount_desc':
                    filtered.sort((a, b) => b.amount - a.amount);
                    break;
                case 'amount_asc':
                    filtered.sort((a, b) => a.amount - b.amount);
                    break;
                case 'type':
                    filtered.sort((a, b) => a.type.localeCompare(b.type));
                    break;
            }
            
            return filtered;
        }



        // ìˆ˜ìµ ê³„ì‚° ê´€ë ¨ ë³µì¡í•œ í•¨ìˆ˜ë“¤ ì œê±°ë¨ - ë‹¨ìˆœí•œ í…Œì´ë¸”ë§Œ í‘œì‹œ

        // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateCategoryOptions() {
            const typeSelect = document.getElementById('type');
            const categorySelect = document.getElementById('category');
            const selectedType = typeSelect.value;

            categorySelect.innerHTML = '<option value="">í•­ëª© ì„ íƒ</option>';

            if (selectedType && categories[selectedType]) {
                categories[selectedType].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.value;
                    option.textContent = cat.text;
                    categorySelect.appendChild(option);
                });
            }
        }

        // íšŒê³„ í…Œì´ë¸” ë Œë”ë§ (í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°©ì‹ - ë‹¨ìˆœí•˜ê³  íš¨ê³¼ì )
        function renderAccountingTable() {
            const tableBody = document.getElementById('accountingTableBody');
            const filteredData = getFilteredAccountingData();
            
            console.log('ğŸ“‹ í…Œì´ë¸” ë Œë”ë§:', filteredData.length + 'ê±´');
            
            if (filteredData.length === 0) {
                const selectedInvestorId = document.getElementById('selectedInvestor').value;
                if (!selectedInvestorId) {
                    // íˆ¬ììê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                <i class="fas fa-user-tie text-gray-300 text-4xl mb-4 block"></i>
                                <div class="text-lg font-medium mb-2">íˆ¬ììë³„ ìˆ˜ìµ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
                                <div class="text-sm">íˆ¬ììë¥¼ ì„ íƒí•œ í›„ "ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                            </td>
                        </tr>
                    `;
                } else {
                    // íˆ¬ììëŠ” ì„ íƒí–ˆì§€ë§Œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-coins text-gray-300 text-3xl mb-3 block"></i>
                                ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            tableBody.innerHTML = '';
            
            // íˆ¬ììë³„ ì™„ì „ ë¶„ë¦¬: ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ëˆ„ì  ê³„ì‚°
            const sortedData = [...filteredData].sort((a, b) => new Date(a.transactionDate) - new Date(b.transactionDate));
            const balanceMap = new Map();
            let runningBalance = 0;
            
            // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ëœ ë°ì´í„°ë¡œ ëˆ„ì  ì”ì•¡ ê³„ì‚°
            sortedData.forEach(item => {
                if (item.type === 'income') {
                    runningBalance += item.amount;
                } else if (item.type === 'expense') {
                    runningBalance -= item.amount;
                }
                balanceMap.set(item.id, runningBalance);
            });
            
            filteredData.forEach(item => {
                const balance = balanceMap.get(item.id) || 0;
                
                const accommodation = accommodations.find(acc => acc.id === item.accommodationId);
                const accommodationName = accommodation ? accommodation.accommodationName : 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => openAccountingModal('view', item.id);
                
                const typeClass = item.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeText = item.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
                const categoryText = categories[item.type]?.find(cat => cat.value === item.category)?.text || item.category;
                
                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="text-sm font-medium text-gray-900">${formatDate(item.transactionDate)}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <span class="text-sm font-medium text-gray-900">${accommodationName}</span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <span class="text-sm font-medium ${typeClass}">${typeText}</span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="text-sm font-medium text-gray-900">${categoryText}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <span class="text-sm font-medium ${typeClass}">
                            ${item.type === 'expense' ? '-' : '+'}${formatAmountOnly(item.amount)}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <span class="text-sm font-medium ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatAmountOnly(Math.abs(balance))}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="event.stopPropagation(); openAccountingModal('view', '${item.id}')" 
                                class="text-blue-600 hover:text-blue-800 p-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // ë³µì¡í•œ ì¤‘ë³µ í•¨ìˆ˜ë“¤ ì œê±° - í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°©ì‹ ì‚¬ìš©

        // íšŒê³„ ëª¨ë‹¬ ì—´ê¸°
        function openAccountingModal(mode, id = null) {
            console.log('ğŸ”„ íšŒê³„ ëª¨ë‹¬ ì—´ê¸°:', mode, id);
            
            currentMode = mode;
            currentId = id;

            const modal = document.getElementById('accountingModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('accountingForm');
            const deleteButton = document.getElementById('deleteButton');

            if (mode === 'add') {
                title.textContent = 'ìƒˆ ìˆ˜ìµ/ì§€ì¶œ ì¶”ê°€';
                form.reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                deleteButton.classList.add('hidden');
            } else if (mode === 'view') {
                const accounting = accountingData.find(a => a.id === id);
                if (accounting) {
                    title.textContent = `íšŒê³„ ì •ë³´ - ${categories[accounting.type]?.find(cat => cat.value === accounting.category)?.text || accounting.category}`;
                    populateAccountingForm(accounting);
                    deleteButton.classList.remove('hidden');
                } else {
                    console.error('íšŒê³„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
                    alert('íšŒê³„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // íšŒê³„ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        function populateAccountingForm(accounting) {
            document.getElementById('transactionDate').value = accounting.transactionDate || '';
            document.getElementById('accommodationId').value = accounting.accommodationId || '';
            document.getElementById('type').value = accounting.type || '';
            updateCategoryOptions();
            setTimeout(() => {
                document.getElementById('category').value = accounting.category || '';
            }, 100);
            document.getElementById('amount').value = accounting.amount || '';

        }

        // íšŒê³„ ëª¨ë‹¬ ë‹«ê¸°
        function closeAccountingModal() {
            document.getElementById('accountingModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // íšŒê³„ í¼ ì œì¶œ
        document.getElementById('accountingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                transactionDate: document.getElementById('transactionDate').value,
                accommodationId: document.getElementById('accommodationId').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                description: ''
            };

            console.log('í¼ ë°ì´í„°:', formData);

            try {
                if (currentMode === 'add') {
                    console.log('ğŸš€ ìƒˆ íšŒê³„ í•­ëª© ì¶”ê°€ ì¤‘...');
                    const savedAccounting = await saveAccountingToServer(formData);
                    console.log('âœ… íšŒê³„ ì €ì¥ ì„±ê³µ:', savedAccounting);
                    
                    accountingData.push(savedAccounting);
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('accountingData', JSON.stringify(accountingData));
                    console.log('ğŸ’¾ localStorageì—ë„ ì €ì¥ ì™„ë£Œ:', accountingData.length + 'ê±´ íšŒê³„ ë°ì´í„°');
                    
                    alert('âœ… ìƒˆ íšŒê³„ í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    
                } else if (currentMode === 'view') {
                    console.log('ğŸ”„ íšŒê³„ ìˆ˜ì • ì¤‘, ID:', currentId);
                    const updatedAccounting = await updateAccountingOnServer(currentId, formData);
                    console.log('âœ… íšŒê³„ ìˆ˜ì • ì„±ê³µ:', updatedAccounting);
                    
                    const index = accountingData.findIndex(a => a.id === currentId);
                    if (index !== -1) {
                        accountingData[index] = updatedAccounting;
                    }
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('accountingData', JSON.stringify(accountingData));
                    console.log('ğŸ’¾ localStorageì—ë„ ìˆ˜ì • ì €ì¥ ì™„ë£Œ:', accountingData.length + 'ê±´ íšŒê³„ ë°ì´í„°');
                    
                    alert('âœ… íšŒê³„ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
                renderAccountingTable();
                closeAccountingModal();
                
            } catch (error) {
                console.error('âŒ íšŒê³„ ì €ì¥/ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('íšŒê³„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // íšŒê³„ ì‚­ì œ
        async function deleteAccounting() {
            if (!currentId) return;

            if (confirm('ì •ë§ë¡œ ì´ íšŒê³„ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    console.log('ğŸ—‘ï¸ íšŒê³„ ì‚­ì œ ì¤‘:', currentId);
                    await deleteAccountingFromServer(currentId);
                    
                    accountingData = accountingData.filter(a => a.id !== currentId);
                    
                    // localStorageì—ë„ ë™ì‹œ ì €ì¥
                    localStorage.setItem('accountingData', JSON.stringify(accountingData));
                    console.log('ğŸ’¾ localStorageì—ë„ ì‚­ì œ ë™ê¸°í™” ì™„ë£¼:', accountingData.length + 'ê±´ íšŒê³„ ë°ì´í„°');
                    
                    alert('âœ… íšŒê³„ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    renderAccountingTable();
                    closeAccountingModal();
                    
                } catch (error) {
                    console.error('âŒ íšŒê³„ ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('íšŒê³„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function formatCurrency(amount) {
            if (!amount) return '0 THB';
            return new Intl.NumberFormat('th-TH', { 
                style: 'currency', 
                currency: 'THB',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // ìˆ˜ìµ/ì§€ì¶œ ë‚´ì—­ìš© (ìˆ«ìë§Œ í‘œì‹œ)
        function formatAmountOnly(amount) {
            if (!amount) return '0';
            return new Intl.NumberFormat('ko-KR').format(amount);
        }
        
        // ìš”ì•½ ë° íˆ¬ììë³„ í˜„í™©ìš© (THB í‘œê¸°)
        function formatAmountWithTHB(amount) {
            if (!amount) return '0 THB';
            return new Intl.NumberFormat('ko-KR').format(amount) + ' THB';
        }
    </script>
</body>
</html>