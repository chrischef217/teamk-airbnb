<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆì•½ê´€ë¦¬ - Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- SUPER SERVICE WORKER BLOCKER (100% ì™„ì „ ì°¨ë‹¨) -->
    <script src="js/super-block-sw.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/firebase-storage.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        
        /* ëª¨ë‹¬ ìŠ¤í¬ë¡¤ ê°œì„  */
        #reservationModal {
            backdrop-filter: blur(4px);
        }
        
        #reservationModal .modal-content {
            max-height: calc(100vh - 2rem);
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë” ë‚˜ì€ ìŠ¤í¬ë¡¤ */
        @media (max-height: 700px) {
            #reservationModal .flex.items-start {
                align-items: flex-start !important;
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">
                        Teamk ê³µìœ ìˆ™ë°• ê´€ë¦¬ ì‹œìŠ¤í…œ
                    </h1>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="flex flex-wrap border-b">
                    <button onclick="window.location.href='index.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-tachometer-alt mr-1"></i> ëŒ€ì‹œë³´ë“œ
                    </button>
                    <button onclick="window.location.href='accommodation.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-home mr-1"></i> ìˆ™ì†Œ ê´€ë¦¬
                    </button>
                    <button class="px-4 py-3 text-sm font-medium text-white bg-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-calendar-check mr-1"></i> ì˜ˆì•½ ê´€ë¦¬
                    </button>

                    <button onclick="window.location.href='accounting.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-coins mr-1"></i> ìˆ˜ìµ ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='investor.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-users mr-1"></i> íˆ¬ìì ê´€ë¦¬
                    </button>
                    <button onclick="window.location.href='settlement.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-calculator mr-1"></i> íˆ¬ìì ì •ì‚°
                    </button>
                    <button onclick="window.location.href='data-migration.html'" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-database mr-1"></i> ë°ì´í„° ê´€ë¦¬
                    </button>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì•½ ê´€ë¦¬ í—¤ë” -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">ì˜ˆì•½ ê´€ë¦¬</h2>
                    <p class="text-sm text-gray-600">ì—ì–´ë¹„ì•¤ë¹„ ì˜ˆì•½ í˜„í™© ë° ê´€ë¦¬</p>
                </div>
                <button onclick="openReservationModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    ìƒˆ ì˜ˆì•½ ì¶”ê°€
                </button>
            </div>
            
            <!-- ì •ë ¬ ë° í•„í„° -->
            <div class="flex flex-col sm:flex-row gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì •ë ¬ ê¸°ì¤€</label>
                    <select id="reservationSortBy" onchange="sortReservations()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="date_desc">ë‚ ì§œ (ìµœì‹ ìˆœ)</option>
                        <option value="date_asc">ë‚ ì§œ (ì˜¤ë˜ëœìˆœ)</option>
                        <option value="accommodation">ìˆ™ì†Œëª…</option>
                        <option value="guest">ê²ŒìŠ¤íŠ¸ëª…</option>
                        <option value="amount_desc">ê¸ˆì•¡ (ë†’ì€ìˆœ)</option>
                        <option value="amount_asc">ê¸ˆì•¡ (ë‚®ì€ìˆœ)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì›”ë³„ í•„í„°</label>
                    <select id="reservationMonthFilter" onchange="filterReservations()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">ì „ì²´ ì›”</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ í•„í„°</label>
                    <select id="reservationAccommodationFilter" onchange="filterReservations()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">ì „ì²´ ìˆ™ì†Œ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì•½ ëª©ë¡ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">ì˜ˆì•½ ëª©ë¡</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì˜ˆì•½ ì •ë³´</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ìˆ™ì†Œ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ê¸ˆì•¡</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="reservationTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- ì˜ˆì•½ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
            
            <!-- ì˜ˆì•½ ìš”ì•½ í†µê³„ -->
            <div class="border-t bg-gray-50 p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ì˜ˆì•½ ìš”ì•½</h3>
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="confirmedReservations">0</div>
                        <div class="text-sm text-gray-600">í™•ì •</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="pendingReservations">0</div>
                        <div class="text-sm text-gray-600">ëŒ€ê¸°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600" id="cancelledReservations">0</div>
                        <div class="text-sm text-gray-600">ì·¨ì†Œ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="completedReservations">0</div>
                        <div class="text-sm text-gray-600">ì™„ë£Œ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="totalRevenue">â‚©0</div>
                        <div class="text-sm text-gray-600">ì´ ìˆ˜ìµ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜ˆì•½ ëª¨ë‹¬ -->
    <div id="reservationModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 overflow-y-auto">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col modal-content">
                <div class="flex justify-between items-center p-6 border-b flex-shrink-0">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">ì˜ˆì•½ ì •ë³´</h3>
                    <button onclick="closeReservationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <form id="reservationForm" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ™ì†Œ ì„ íƒ *</label>
                            <select id="accommodationId" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê²ŒìŠ¤íŠ¸ëª… *</label>
                            <input type="text" id="guestName" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì²´í¬ì¸ *</label>
                            <input type="date" id="checkIn" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì²´í¬ì•„ì›ƒ *</label>
                            <input type="date" id="checkOut" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆì•½ ê¸ˆì•¡ (THB) *</label>
                            <input type="number" id="amount" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆì•½ ìƒíƒœ</label>
                            <select id="status" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="confirmed">í™•ì •</option>
                                <option value="pending">ëŒ€ê¸°</option>
                                <option value="cancelled">ì·¨ì†Œ</option>
                                <option value="completed">ì™„ë£Œ</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            ì €ì¥
                        </button>
                        <button type="button" onclick="closeReservationModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            ì·¨ì†Œ
                        </button>
                        <button type="button" id="deleteButton" onclick="deleteReservation()" class="sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">
                            <i class="fas fa-trash mr-2"></i>
                            ì‚­ì œ
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let reservations = [];
        let accommodations = [];
        let currentMode = 'add';
        let currentId = null;

        // Firebase ì—°ë™ í•¨ìˆ˜ë“¤
        async function loadReservationData() {
            console.log('ğŸ“… ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            return await firebaseStorage.loadReservations();
        }

        async function saveReservationToServer(reservation) {
            console.log('ğŸ’¾ ì˜ˆì•½ ì €ì¥ ì‹œì‘:', reservation.guestName);
            return await firebaseStorage.saveReservation(reservation);
        }

        async function updateReservationOnServer(id, reservation) {
            console.log('ğŸ”„ ì˜ˆì•½ ìˆ˜ì • ì‹œì‘:', id);
            return await firebaseStorage.updateReservation(id, reservation);
        }

        async function deleteReservationFromServer(id) {
            console.log('ğŸ—‘ï¸ ì˜ˆì•½ ì‚­ì œ ì‹œì‘:', id);
            return await firebaseStorage.deleteReservation(id);
        }

        async function loadAccommodationData() {
            console.log('ğŸ  ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            return await firebaseStorage.loadAccommodations();
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ”„ ì˜ˆì•½ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
            if (!firebaseStorage.isConfigured()) {
                console.warn('âš ï¸ Firebase ì„¤ì •ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                
                const goToFirebase = confirm(`
ğŸ”¥ Firebase ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤!

PCì™€ ëª¨ë°”ì¼ ê°„ ë°ì´í„° ë™ê¸°í™”ë¥¼ ìœ„í•´ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
Firebase ì—°ë™ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                `);
                
                if (goToFirebase) {
                    window.location.href = 'firebase-setup.html';
                    return;
                }
            }

            if (checkLoginStatus()) {
                initializePagePermissions();
                
                try {
                    console.log('ğŸ“¡ Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                    reservations = await loadReservationData();
                    accommodations = await loadAccommodationData();
                    console.log('âœ… ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', reservations.length + 'ê±´');
                    console.log('âœ… ìˆ™ì†Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', accommodations.length + 'ê°œ');
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    
                    // Firebase ì—°ê²° ì‹¤íŒ¨ì‹œ localStorage í´ë°± ì‹œë„
                    try {
                        console.log('ğŸ”„ localStorage í´ë°± ì‹œë„...');
                        const localReservations = localStorage.getItem('reservationData');
                        const localAccommodations = localStorage.getItem('accommodationData');
                        
                        reservations = localReservations ? JSON.parse(localReservations) : [];
                        accommodations = localAccommodations ? JSON.parse(localAccommodations) : [];
                        
                        console.log('âœ… localStorageì—ì„œ ë°ì´í„° ë¡œë“œ:', reservations.length + 'ê±´ ì˜ˆì•½');
                    } catch (fallbackError) {
                        console.error('âŒ localStorage í´ë°±ë„ ì‹¤íŒ¨:', fallbackError);
                        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase ì—°ë™ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    }
                }
                
                populateAccommodationSelect();
                populateFilterOptions();
                renderReservationTable();
                
                console.log('ğŸ‰ ì˜ˆì•½ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        });

        // ìˆ™ì†Œ ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
        function populateAccommodationSelect() {
            const select = document.getElementById('accommodationId');
            select.innerHTML = '<option value="">ìˆ™ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            accommodations.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.accommodationName || `ìˆ™ì†Œ ${acc.id}`;
                select.appendChild(option);
            });
        }

        // í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
        function populateFilterOptions() {
            // ì›”ë³„ í•„í„° ì˜µì…˜
            const monthFilter = document.getElementById('reservationMonthFilter');
            const months = [...new Set(reservations.map(res => {
                const date = new Date(res.checkIn);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            monthFilter.innerHTML = '<option value="">ì „ì²´ ì›”</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${month.split('-')[0]}ë…„ ${month.split('-')[1]}ì›”`;
                monthFilter.appendChild(option);
            });

            // ìˆ™ì†Œ í•„í„° ì˜µì…˜
            const accommodationFilter = document.getElementById('reservationAccommodationFilter');
            accommodationFilter.innerHTML = '<option value="">ì „ì²´ ìˆ™ì†Œ</option>';
            accommodations.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.accommodationName || `ìˆ™ì†Œ ${acc.id}`;
                accommodationFilter.appendChild(option);
            });
        }

        // ì •ë ¬ í•¨ìˆ˜
        function sortReservations() {
            renderReservationTable();
        }

        // í•„í„° í•¨ìˆ˜
        function filterReservations() {
            renderReservationTable();
        }

        // í•„í„°ë§ëœ ì˜ˆì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getFilteredReservations() {
            let filtered = [...reservations];
            
            // ì›”ë³„ í•„í„°
            const monthFilter = document.getElementById('reservationMonthFilter').value;
            if (monthFilter) {
                filtered = filtered.filter(res => {
                    const date = new Date(res.checkIn);
                    const resMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return resMonth === monthFilter;
                });
            }
            
            // ìˆ™ì†Œ í•„í„°
            const accommodationFilter = document.getElementById('reservationAccommodationFilter').value;
            if (accommodationFilter) {
                filtered = filtered.filter(res => res.accommodationId === accommodationFilter);
            }
            
            // ì •ë ¬
            const sortBy = document.getElementById('reservationSortBy').value;
            switch (sortBy) {
                case 'date_desc':
                    filtered.sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn));
                    break;
                case 'date_asc':
                    filtered.sort((a, b) => new Date(a.checkIn) - new Date(b.checkIn));
                    break;
                case 'accommodation':
                    filtered.sort((a, b) => {
                        const accA = accommodations.find(acc => acc.id === a.accommodationId);
                        const accB = accommodations.find(acc => acc.id === b.accommodationId);
                        const nameA = accA ? accA.accommodationName : '';
                        const nameB = accB ? accB.accommodationName : '';
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'guest':
                    filtered.sort((a, b) => a.guestName.localeCompare(b.guestName));
                    break;
                case 'amount_desc':
                    filtered.sort((a, b) => b.amount - a.amount);
                    break;
                case 'amount_asc':
                    filtered.sort((a, b) => a.amount - b.amount);
                    break;
            }
            
            return filtered;
        }

        // ì˜ˆì•½ í…Œì´ë¸” ë Œë”ë§
        function renderReservationTable() {
            const tableBody = document.getElementById('reservationTableBody');
            tableBody.innerHTML = '';

            const filteredReservations = getFilteredReservations();

            if (filteredReservations.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-calendar-alt text-gray-300 text-3xl mb-3 block"></i>
                            ${reservations.length === 0 ? 'ë“±ë¡ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ì¡°ê±´ì— ë§ëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.'}
                        </td>
                    </tr>
                `;
                updateReservationSummary(filteredReservations);
                return;
            }

            filteredReservations.forEach(reservation => {
                const accommodation = accommodations.find(acc => acc.id === reservation.accommodationId);
                const accommodationName = accommodation ? accommodation.accommodationName : 'ì•Œ ìˆ˜ ì—†ìŒ';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => openReservationModal('view', reservation.id);

                const statusColors = {
                    confirmed: 'bg-green-100 text-green-800',
                    pending: 'bg-yellow-100 text-yellow-800',
                    cancelled: 'bg-red-100 text-red-800',
                    completed: 'bg-blue-100 text-blue-800'
                };

                const statusTexts = {
                    confirmed: 'í™•ì •',
                    pending: 'ëŒ€ê¸°',
                    cancelled: 'ì·¨ì†Œ',
                    completed: 'ì™„ë£Œ'
                };

                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${reservation.guestName}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <span class="text-sm font-medium text-gray-900">${accommodationName}</span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="text-sm text-gray-900">${formatDate(reservation.checkIn)}</div>
                        <div class="text-sm text-gray-500">~ ${formatDate(reservation.checkOut)}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="text-sm font-medium text-gray-900">${formatCurrency(reservation.amount)}</div>
                        ${reservation.commission ? `<div class="text-xs text-gray-500">ìˆ˜ìˆ˜ë£Œ: ${formatCurrency(reservation.commission)}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 text-center">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[reservation.status] || 'bg-gray-100 text-gray-800'}">
                            ${statusTexts[reservation.status] || reservation.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="event.stopPropagation(); openReservationModal('view', '${reservation.id}')" 
                                class="text-blue-600 hover:text-blue-800 p-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
            
            // ìš”ì•½ í†µê³„ ì—…ë°ì´íŠ¸
            updateReservationSummary(filteredReservations);
        }

        // ì˜ˆì•½ ìš”ì•½ í†µê³„ ì—…ë°ì´íŠ¸
        function updateReservationSummary(reservationData) {
            const confirmedReservations = reservationData.filter(res => res.status === 'confirmed').length;
            const pendingReservations = reservationData.filter(res => res.status === 'pending').length;
            const cancelledReservations = reservationData.filter(res => res.status === 'cancelled').length;
            const completedReservations = reservationData.filter(res => res.status === 'completed').length;
            const totalRevenue = reservationData.reduce((sum, res) => sum + (res.amount || 0), 0);
            
            document.getElementById('confirmedReservations').textContent = confirmedReservations;
            document.getElementById('pendingReservations').textContent = pendingReservations;
            document.getElementById('cancelledReservations').textContent = cancelledReservations;
            document.getElementById('completedReservations').textContent = completedReservations;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
        }

        // ì˜ˆì•½ ëª¨ë‹¬ ì—´ê¸°
        function openReservationModal(mode, id = null) {
            console.log('ğŸ”„ ì˜ˆì•½ ëª¨ë‹¬ ì—´ê¸°:', mode, id);
            
            currentMode = mode;
            currentId = id;

            const modal = document.getElementById('reservationModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('reservationForm');
            const deleteButton = document.getElementById('deleteButton');

            if (mode === 'add') {
                title.textContent = 'ìƒˆ ì˜ˆì•½ ì¶”ê°€';
                form.reset();
                document.getElementById('status').value = 'confirmed';
                deleteButton.classList.add('hidden');
            } else if (mode === 'view') {
                const reservation = reservations.find(r => r.id === id);
                if (reservation) {
                    title.textContent = `ì˜ˆì•½ ì •ë³´ - ${reservation.guestName}`;
                    populateReservationForm(reservation);
                    deleteButton.classList.remove('hidden');
                } else {
                    console.error('ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
                    alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // ì˜ˆì•½ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        function populateReservationForm(reservation) {
            document.getElementById('accommodationId').value = reservation.accommodationId || '';
            document.getElementById('guestName').value = reservation.guestName || '';
            document.getElementById('checkIn').value = reservation.checkIn || '';
            document.getElementById('checkOut').value = reservation.checkOut || '';
            document.getElementById('amount').value = reservation.amount || '';
            document.getElementById('status').value = reservation.status || 'confirmed';
        }

        // ì˜ˆì•½ ëª¨ë‹¬ ë‹«ê¸°
        function closeReservationModal() {
            document.getElementById('reservationModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ì˜ˆì•½ í¼ ì œì¶œ
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                accommodationId: document.getElementById('accommodationId').value,
                guestName: document.getElementById('guestName').value,
                checkIn: document.getElementById('checkIn').value,
                checkOut: document.getElementById('checkOut').value,
                amount: parseFloat(document.getElementById('amount').value),
                status: document.getElementById('status').value
            };

            console.log('í¼ ë°ì´í„°:', formData);

            try {
                if (currentMode === 'add') {
                    console.log('ğŸš€ ìƒˆ ì˜ˆì•½ ì¶”ê°€ ì¤‘...');
                    const savedReservation = await saveReservationToServer(formData);
                    console.log('âœ… ì˜ˆì•½ ì €ì¥ ì„±ê³µ:', savedReservation);
                    
                    reservations.push(savedReservation);
                    alert('âœ… ìƒˆ ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    
                } else if (currentMode === 'view') {
                    console.log('ğŸ”„ ì˜ˆì•½ ìˆ˜ì • ì¤‘, ID:', currentId);
                    const updatedReservation = await updateReservationOnServer(currentId, formData);
                    console.log('âœ… ì˜ˆì•½ ìˆ˜ì • ì„±ê³µ:', updatedReservation);
                    
                    const index = reservations.findIndex(r => r.id === currentId);
                    if (index !== -1) {
                        reservations[index] = updatedReservation;
                    }
                    
                    alert('âœ… ì˜ˆì•½ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
                renderReservationTable();
                closeReservationModal();
                
            } catch (error) {
                console.error('âŒ ì˜ˆì•½ ì €ì¥/ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ì˜ˆì•½ ì‚­ì œ
        async function deleteReservation() {
            if (!currentId) return;

            if (confirm('ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    console.log('ğŸ—‘ï¸ ì˜ˆì•½ ì‚­ì œ ì¤‘:', currentId);
                    await deleteReservationFromServer(currentId);
                    
                    reservations = reservations.filter(r => r.id !== currentId);
                    
                    alert('âœ… ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    renderReservationTable();
                    closeReservationModal();
                    
                } catch (error) {
                    console.error('âŒ ì˜ˆì•½ ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('ì˜ˆì•½ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        function formatCurrency(amount) {
            if (!amount) return '0 THB';
            return new Intl.NumberFormat('th-TH', { 
                style: 'currency', 
                currency: 'THB',
                minimumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>